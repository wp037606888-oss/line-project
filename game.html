<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°ŠçˆµéŠæ¨‚å ´ v6.1 - Game Suite Fixed</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans+TC:wght@400;700&family=Ma+Shan+Zheng&display=swap');

:root {
    --gold: #ffd700;
    --bg-dark: #05060a;
    --glass: rgba(16, 18, 27, 0.95);
    --border: rgba(255, 255, 255, 0.15);
    --neon-red: #ff3e3e;
    --neon-green: #00ff9d;
}

* { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
body { margin: 0; font-family: "Noto Sans TC", sans-serif; background: var(--bg-dark); color: #e0e0e0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

/* èƒŒæ™¯ */
canvas#bg { position: fixed; inset: 0; z-index: -1; }
.noise { position: fixed; inset: 0; z-index: -1; opacity: 0.05; background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJuIj48ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iMC42IiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI24pIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4='); pointer-events: none; }

/* é ‚éƒ¨å°èˆª */
header {
    padding: 15px 30px; display: flex; justify-content: space-between; align-items: center;
    background: rgba(0,0,0,0.8); border-bottom: 1px solid var(--border); backdrop-filter: blur(10px); z-index: 10;
}
.brand { font-family: 'Cinzel'; font-size: 20px; color: var(--gold); letter-spacing: 2px; }
.back-btn { background: transparent; border: 1px solid #444; color: #aaa; padding: 6px 16px; border-radius: 20px; cursor: pointer; transition: .3s; }
.back-btn:hover { border-color: #fff; color: #fff; }

/* å¤§å»³ä½ˆå±€ */
#lobby { display: flex; flex: 1; overflow: hidden; padding: 30px; gap: 30px; transition: 0.3s; }
#lobby.hidden { display: none; }

.game-section { flex: 1; display: flex; flex-direction: column; gap: 20px; min-width: 0; }
.section-title { font-size: 18px; color: var(--gold); border-bottom: 1px solid var(--border); padding-bottom: 10px; font-family: 'Cinzel'; display: flex; align-items: center; gap: 10px; }

.table-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; overflow-y: auto; padding-right: 5px; height: 100%; }

/* æ¡Œå­å¡ç‰‡ */
.table-card {
    background: var(--glass); border: 1px solid var(--border); border-radius: 16px; padding: 20px;
    display: flex; flex-direction: column; align-items: center; gap: 12px; transition: .3s; position: relative;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.table-card:hover { border-color: var(--gold); transform: translateY(-5px); }
.table-id { position: absolute; top: 12px; left: 15px; font-size: 11px; color: #555; font-family: 'Cinzel'; letter-spacing: 1px; }
.table-status { font-size: 11px; padding: 4px 8px; border-radius: 4px; background: #222; color: #777; position: absolute; top: 10px; right: 15px; }
.table-status.active { background: rgba(0,255,157,0.1); color: var(--neon-green); }
.table-status.full { background: rgba(255,215,0,0.1); color: var(--gold); }

.seat-display { display: flex; gap: 15px; align-items: center; margin: 15px 0 5px; }
.seat { width: 45px; height: 45px; border-radius: 50%; background: #111; border: 2px dashed #333; display: flex; align-items: center; justify-content: center; font-size: 20px; position: relative; }
.seat.taken { border-style: solid; border-color: #555; background: #222; color: #fff; }
.seat.taken::after { content: ''; position: absolute; inset: 0; border-radius: 50%; box-shadow: 0 0 15px rgba(255,255,255,0.05); }

.btn-join { width: 100%; padding: 12px; background: #252525; border: 1px solid #333; color: #aaa; border-radius: 8px; cursor: pointer; transition: .3s; font-weight: bold; }
.btn-join:hover:not(:disabled) { background: var(--gold); color: #000; border-color: var(--gold); }
.btn-join:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-watch { width: 100%; padding: 12px; background: transparent; border: 1px solid #444; color: #aaa; border-radius: 8px; cursor: pointer; }
.btn-watch:hover { border-color: var(--neon-green); color: var(--neon-green); }

/* --- éŠæˆ²æˆ¿é–“ --- */
#gameRoom {
    position: fixed; inset: 0; background: #080808; z-index: 20; display: none; flex-direction: column;
}
#gameRoom.show { display: flex; }

.room-header { padding: 15px 30px; display: flex; justify-content: space-between; background: #111; border-bottom: 1px solid #333; align-items: center; }
.room-info { display: flex; gap: 20px; align-items: center; }
.turn-indicator { padding: 6px 18px; border-radius: 20px; background: #222; color: #666; border: 1px solid #333; transition: .3s; font-size: 14px; font-weight: bold; }
.turn-indicator.active { border-color: var(--gold); color: var(--gold); background: rgba(255,215,0,0.1); box-shadow: 0 0 15px rgba(255,215,0,0.2); }

.game-area { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; overflow: auto; background: #0c0c0c; }

/* äº”å­æ£‹ç›¤ (ä¿®æ­£ç‰ˆ) */
#gomokuBoard {
    width: 600px; height: 600px; background: #2b2b2b; border: 5px solid #444; position: relative;
    display: grid; grid-template-columns: repeat(15, 1fr); grid-template-rows: repeat(15, 1fr);
    box-shadow: 0 30px 80px rgba(0,0,0,0.8); border-radius: 4px; padding: 20px;
    box-sizing: content-box; /* é—œéµï¼šè®“ padding ä¸å½±éŸ¿ grid å¤§å° */
}
/* äº”å­æ£‹æ ¼ç·š */
#gomokuBoard::before {
    content: ''; position: absolute; top: 20px; left: 20px; right: 20px; bottom: 20px;
    background-image: 
        linear-gradient(#666 1px, transparent 1px),
        linear-gradient(90deg, #666 1px, transparent 1px);
    background-size: 42.85px 42.85px; /* 600 / 14æ ¼ = 42.85 */
    pointer-events: none;
}
.cell { 
    position: relative; cursor: pointer; z-index: 2; 
    border-radius: 50%; /* åœ“å½¢æ„Ÿæ‡‰å€ */
}
.cell:hover::after {
    content: ''; position: absolute; width: 10px; height: 10px; background: rgba(255,255,255,0.3);
    border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%,-50%);
}
.stone {
    width: 36px; height: 36px; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    box-shadow: 2px 2px 5px rgba(0,0,0,0.6); pointer-events: none; z-index: 3;
}
.stone.black { background: radial-gradient(circle at 35% 35%, #555, #000); }
.stone.white { background: radial-gradient(circle at 35% 35%, #fff, #ddd); }
.stone.last-move { box-shadow: 0 0 15px var(--neon-red); }

/* è±¡æ£‹ç›¤ (å®Œç¾ä¿®å¾©ç‰ˆ) */
#xiangqiBoard {
    width: 550px; height: 620px; background: #1e1e1e; border: 8px solid #333; position: relative;
    box-shadow: 0 30px 80px rgba(0,0,0,0.8); border-radius: 8px; user-select: none;
}
/* æ£‹ç›¤ç·š (SVG èƒŒæ™¯ï¼Œä¿è­‰ç²¾æº–) */
.xq-grid {
    position: absolute; inset: 25px; pointer-events: none;
    background-image: 
        linear-gradient(#444 2px, transparent 2px),
        linear-gradient(90deg, #444 2px, transparent 2px);
    background-size: 62.5px 63.33px; /* (550-50)/8, (620-50)/9 */
    border: 2px solid #444; /* å¤–æ¡† */
}
/* æ²³ç•Œ */
.river {
    position: absolute; top: 278px; left: 27px; right: 27px; height: 62px; background: #1e1e1e;
    display: flex; align-items: center; justify-content: space-around;
    font-family: 'Ma Shan Zheng', cursive; font-size: 32px; color: #555; z-index: 1; pointer-events: none;
}
/* æ–œç·š (å£«è·¯) */
.slash-top { position: absolute; top: 25px; left: 213px; width: 125px; height: 126px; z-index: 0; }
.slash-top::before, .slash-top::after { content:''; position:absolute; inset:0; border-top:2px solid #444; transform-origin:top left; width:178px; }
.slash-top::before { transform: rotate(45deg); }
.slash-top::after { transform: rotate(135deg); left:125px; }

.slash-bottom { position: absolute; bottom: 25px; left: 213px; width: 125px; height: 126px; z-index: 0; }
.slash-bottom::before, .slash-bottom::after { content:''; position:absolute; inset:0; border-top:2px solid #444; transform-origin:top left; width:178px; }
.slash-bottom::before { transform: rotate(45deg); }
.slash-bottom::after { transform: rotate(135deg); left:125px; }

/* æ£‹å­ */
.chess-piece {
    width: 52px; height: 52px; border-radius: 50%; background: #111; border: 3px solid;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Ma Shan Zheng', cursive; font-size: 28px; font-weight: bold;
    cursor: pointer; position: absolute; transform: translate(-50%, -50%);
    transition: transform 0.2s, box-shadow 0.2s, top 0.2s, left 0.2s; z-index: 10;
}
.chess-piece:hover { transform: translate(-50%, -50%) scale(1.1); z-index: 20; }
.chess-piece.red { color: var(--neon-red); border-color: var(--neon-red); box-shadow: inset 0 0 15px rgba(255,62,62,0.2); text-shadow: 0 0 5px var(--neon-red); }
.chess-piece.black { color: var(--neon-green); border-color: var(--neon-green); box-shadow: inset 0 0 15px rgba(0,255,157,0.2); text-shadow: 0 0 5px var(--neon-green); }
.chess-piece.selected { box-shadow: 0 0 30px var(--gold), inset 0 0 20px var(--gold); border-color: var(--gold); z-index: 100; background: #222; }

/* æ£‹ç›¤é»æ“Šç†±å€ */
.xq-touch-layer {
    position: absolute; inset: 0; z-index: 5; display: grid;
    grid-template-columns: repeat(9, 1fr); grid-template-rows: repeat(10, 1fr);
}
.xq-point { cursor: pointer; }
/* .xq-point:hover { background: rgba(255,255,255,0.05); border-radius: 50%; } */

/* çµç®—è¦–çª— */
#resultModal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; display: none; align-items: center; justify-content: center;
}
.result-card {
    background: #111; border: 2px solid var(--gold); padding: 50px; text-align: center; border-radius: 20px; width: 400px;
    box-shadow: 0 0 80px rgba(255,215,0,0.3); animation: popIn 0.3s;
}
@keyframes popIn { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }

</style>
</head>
<body>

<canvas id="bg"></canvas>
<div class="noise"></div>

<header>
    <div class="brand">PREMIUM GAMING</div>
    <div style="display:flex; gap:15px; align-items:center;">
        <span id="userInfo" style="color:#888; font-size:14px; font-weight:bold;">GUEST</span>
        <button class="back-btn" onclick="location.href='app.html'">è¿”å›å¤§å»³</button>
    </div>
</header>

<div id="lobby">
    <div class="game-section">
        <div class="section-title"><span>âšªâš«</span> äº”å­æ£‹ GOMOKU</div>
        <div class="table-grid" id="gomokuList"></div>
    </div>
    <div class="game-section">
        <div class="section-title"><span>ğŸ”´ğŸŸ¢</span> è±¡æ£‹ XIANGQI</div>
        <div class="table-grid" id="xiangqiList"></div>
    </div>
</div>

<div id="gameRoom">
    <div class="room-header">
        <div class="room-info">
            <button class="back-btn" onclick="leaveTable()">é›¢é–‹æˆ¿é–“</button>
            <div id="roomTitle" style="color:var(--gold); font-weight:bold; font-size:18px;">TABLE</div>
        </div>
        <div class="room-info">
            <div id="p1Display" class="turn-indicator">Player 1</div>
            <span style="color:#444; font-weight:bold;">VS</span>
            <div id="p2Display" class="turn-indicator">Player 2</div>
        </div>
    </div>

    <div class="game-area" id="gameArea"></div>
</div>

<div id="resultModal">
    <div class="result-card">
        <h1 id="resultText" style="color:var(--gold); margin:0 0 30px; font-family:'Cinzel'; font-size:36px;">WINNER</h1>
        <button class="back-btn" onclick="closeResult()" style="width:100%; padding:15px; background:var(--gold); color:black; font-weight:bold; border:none;">ç¢ºèª CONFIRM</button>
    </div>
</div>

<script>
/* --- Init --- */
const config={apiKey:"AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",authDomain:"smoke-queue.firebaseapp.com",databaseURL:"https://smoke-queue-default-rtdb.firebaseio.com",projectId:"smoke-queue"};
firebase.initializeApp(config);
const db=firebase.database(), auth=firebase.auth();
const pgRef=db.ref("playground");

let me, myData, currentTableId=null;
let gameWatcher = null; // ç›£è½å™¨

/* --- Background --- */
const canvas=document.getElementById("bg"), ctx=canvas.getContext("2d");
let w,h,particles=[]; function resize(){w=canvas.width=innerWidth;h=canvas.height=innerHeight;} window.onresize=resize; resize();
for(let i=0;i<40;i++)particles.push({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-.5)*.2,vy:(Math.random()-.5)*.2,r:Math.random()*2});
function draw(){ctx.clearRect(0,0,w,h);particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0||p.x>w)p.vx*=-1;if(p.y<0||p.y>h)p.vy*=-1;ctx.fillStyle="rgba(255,215,0,0.15)";ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,6.28);ctx.fill();});requestAnimationFrame(draw);}draw();

/* --- Auth & Init --- */
auth.onAuthStateChanged(user=>{
    if(!user){location.href="login.html";return;} me=user;
    db.ref("users/"+me.uid).once("value",s=>{
        myData=s.val()||{name:"Unknown"};
        document.getElementById("userInfo").textContent = myData.name.toUpperCase();
        initLobby();
    });
});

/* --- Lobby Logic --- */
function initLobby(){
    pgRef.child("tables").on("value", s=>{
        // å¦‚æœæ­£åœ¨éŠæˆ²ä¸­ï¼Œä¸åˆ·æ–°å¤§å»³ UIï¼Œé¿å…å¹²æ“¾
        if(currentTableId) return;

        const tables = s.val() || {};
        renderTables(tables, 'gomoku', 5);
        renderTables(tables, 'xiangqi', 5);
        
        // æª¢æŸ¥è‡ªå·±æ˜¯å¦å·²ç¶“åœ¨æŸå€‹æ¡Œå­ä¸Š (æ–·ç·šé‡é€£é‚è¼¯)
        Object.keys(tables).forEach(tid => {
            if(tables[tid].p1 === me.uid || tables[tid].p2 === me.uid){
                enterTable(tid, tables[tid]);
            }
        });
    });
}

function renderTables(tables, type, count){
    const list = document.getElementById(type+"List");
    list.innerHTML = "";
    for(let i=0; i<count; i++){
        const tid = `${type}_${i}`;
        const t = tables[tid] || { p1:null, p2:null };
        const p1Name = t.p1Name || "ç©ºä½";
        const p2Name = t.p2Name || "ç©ºä½";
        const isFull = t.p1 && t.p2;
        const isMe = (t.p1===me.uid || t.p2===me.uid);
        
        let statusHtml = isFull ? `<span class="table-status full">å°æˆ°ä¸­</span>` : `<span class="table-status active">ç­‰å¾…åŠ å…¥</span>`;
        if(!t.p1 && !t.p2) statusHtml = `<span class="table-status">ç©ºé–’</span>`;

        let btnHtml = "";
        if(isMe) btnHtml = `<button class="btn-join" onclick="reEnter('${tid}')" style="background:var(--gold);color:#000;">å›åˆ°åº§ä½</button>`;
        else if(!isFull) {
            // é˜²æ­¢è‡ªå·±åŠ å…¥è‡ªå·±
            btnHtml = `<button class="btn-join" onclick="joinTable('${tid}')">åŠ å…¥å°æˆ°</button>`;
        }
        else btnHtml = `<button class="btn-watch" style="display:block" onclick="watchTable('${tid}')">è§€æˆ°</button>`;

        const div = document.createElement("div");
        div.className = "table-card";
        div.innerHTML = `
            <div class="table-id">TABLE ${i+1}</div>
            ${statusHtml}
            <div class="seat-display">
                <div class="seat ${t.p1?'taken':''}">${t.p1?'ğŸ‘¤':'+'}</div>
                <span style="font-size:12px; color:#555">VS</span>
                <div class="seat ${t.p2?'taken':''}">${t.p2?'ğŸ‘¤':'+'}</div>
            </div>
            <div style="font-size:12px; color:#666; margin-bottom:5px;">${p1Name} vs ${p2Name}</div>
            ${btnHtml}
        `;
        list.appendChild(div);
    }
}

// æ ¸å¿ƒåŠ å…¥é‚è¼¯ (ä¿®å¾©ç§’é€€å•é¡Œ)
function joinTable(tid){
    pgRef.child("tables/"+tid).transaction(t => {
        if(!t) t = { p1:null, p2:null, board:null, turn:null };
        if(t.p1 === me.uid || t.p2 === me.uid) return; // å·²ç¶“åœ¨è£¡é¢äº†
        if(t.p1 && t.p2) return; // æ»¿äº†
        
        if(!t.p1) { t.p1 = me.uid; t.p1Name = myData.name; }
        else { t.p2 = me.uid; t.p2Name = myData.name; }
        
        // Reset game if new match started
        if(t.p1 && t.p2 && !t.board) {
            t.turn = t.p1; // p1 å…ˆæ‰‹
            t.board = tid.startsWith('gomoku') ? Array(225).fill(0) : initXiangqi(); 
            t.winner = null;
        }
        return t;
    }, (err, committed, s) => {
        if(committed) {
            // æˆåŠŸå¯«å…¥å¾Œï¼Œæ‰‹å‹•è§¸ç™¼é€²å…¥æˆ¿é–“ï¼Œä¸ä¾è³´å¤§å»³ç›£è½å™¨
            enterTable(tid, s.val());
        }
    });
}

// æ–·ç·šé‡é€£æˆ–è§€æˆ°
function reEnter(tid) {
    pgRef.child("tables/"+tid).once("value", s => enterTable(tid, s.val()));
}
function watchTable(tid) {
    pgRef.child("tables/"+tid).once("value", s => enterTable(tid, s.val(), true));
}

// é€²å…¥æˆ¿é–“ (UI åˆ‡æ› + ç¶å®šç›£è½)
function enterTable(tid, tableData, isSpectator = false){
    if(currentTableId === tid) return; // å·²ç¶“åœ¨è£¡é¢
    currentTableId = tid;

    // UI åˆ‡æ›
    document.getElementById("lobby").classList.add("hidden");
    document.getElementById("gameRoom").classList.add("show");
    document.getElementById("roomTitle").textContent = (tid.includes('gomoku')?"äº”å­æ£‹":"è±¡æ£‹") + " - " + tid.split('_')[1];
    
    // æ¸²æŸ“æ£‹ç›¤çµæ§‹
    const area = document.getElementById("gameArea");
    if(tid.includes('gomoku')) {
        area.innerHTML = `<div id="gomokuBoard">${Array(225).fill('<div class="cell"></div>').join('')}</div>`;
        if(!isSpectator) bindGomokuEvents();
    } else {
        area.innerHTML = `
            <div id="xiangqiBoard">
                <div class="xq-grid"></div>
                <div class="river">æ¥šæ²³ã€€æ¼¢ç•Œ</div>
                <div class="slash-top"></div><div class="slash-bottom"></div>
                <div class="xq-touch-layer">${Array(90).fill('<div class="xq-point"></div>').join('')}</div>
                <div id="piecesLayer"></div>
            </div>`;
        if(!isSpectator) bindXiangqiEvents();
    }

    // é–‹å§‹ç›£è½æˆ¿é–“æ•¸æ“š
    if(gameWatcher) pgRef.child("tables/"+tid).off("value", gameWatcher);
    
    gameWatcher = pgRef.child("tables/"+tid).on("value", s => {
        const t = s.val();
        if(!t) { leaveTable(); return; } // æ¡Œå­è¢«æ¸…ç©º
        updateGameRoom(t);
    });
}

function leaveTable(){
    if(!currentTableId) return;
    
    // å¦‚æœæˆ‘æ˜¯ç©å®¶ï¼Œé›¢é–‹æ™‚æ¸…ç©ºåº§ä½
    pgRef.child(`tables/${currentTableId}`).transaction(t => {
        if(!t) return t;
        if(t.p1 === me.uid) { t.p1 = null; t.p1Name = null; }
        if(t.p2 === me.uid) { t.p2 = null; t.p2Name = null; }
        // åªè¦æœ‰äººé›¢é–‹ï¼Œé‡ç½®æ£‹ç›¤
        t.board = null; t.turn = null; t.winner = null;
        return t;
    });

    // æ¸…é™¤ç›£è½
    pgRef.child("tables/"+currentTableId).off("value", gameWatcher);
    gameWatcher = null;
    currentTableId = null;

    // UI é‚„åŸ
    document.getElementById("gameRoom").classList.remove("show");
    document.getElementById("lobby").classList.remove("hidden");
    document.getElementById("resultModal").style.display = "none";
}

/* --- Game Loop --- */
function updateGameRoom(t){
    // Update Header
    const p1d = document.getElementById("p1Display");
    const p2d = document.getElementById("p2Display");
    p1d.textContent = t.p1Name || "ç­‰å¾…ä¸­...";
    p2d.textContent = t.p2Name || "ç­‰å¾…ä¸­...";
    
    p1d.className = `turn-indicator ${t.turn && t.turn === t.p1 ? 'active' : ''}`;
    p2d.className = `turn-indicator ${t.turn && t.turn === t.p2 ? 'active' : ''}`;

    // Sync Board
    if(currentTableId.includes('gomoku')){
        drawGomoku(t.board);
    } else {
        drawXiangqi(t.board);
    }
    
    // Check Winner
    if(t.winner){
        const winnerName = t.winner === t.p1 ? t.p1Name : t.p2Name;
        document.getElementById("resultText").innerHTML = `<span style="color:#fff">${winnerName}</span> ç²å‹!`;
        document.getElementById("resultModal").style.display = "flex";
    }
}

function closeResult(){
    document.getElementById("resultModal").style.display = "none";
    if(currentTableId) pgRef.child(`tables/${currentTableId}/winner`).remove();
}

/* --- äº”å­æ£‹ (Logic) --- */
function bindGomokuEvents(){
    const cells = document.querySelectorAll("#gomokuBoard .cell");
    cells.forEach((cell, idx) => {
        cell.onclick = () => {
            pgRef.child(`tables/${currentTableId}`).transaction(t => {
                if(!t || !t.p1 || !t.p2 || t.winner) return; 
                if(t.turn !== me.uid) return; 
                if(!t.board) t.board = Array(225).fill(0);
                if(t.board[idx] !== 0) return; 

                const color = (me.uid === t.p1) ? 1 : 2; // 1=é»‘, 2=ç™½
                t.board[idx] = color;
                
                if(checkWin(t.board, idx, color)) t.winner = me.uid;
                else t.turn = (t.turn === t.p1) ? t.p2 : t.p1; 
                
                return t;
            });
        };
    });
}

function drawGomoku(board){
    if(!board) { document.querySelectorAll(".cell").forEach(c=>c.innerHTML=''); return; }
    const cells = document.querySelectorAll("#gomokuBoard .cell");
    board.forEach((val, idx) => {
        cells[idx].innerHTML = val===0 ? '' : `<div class="stone ${val===1?'black':'white'}"></div>`;
    });
}

function checkWin(board, idx, color){
    const r = Math.floor(idx/15), c = idx%15;
    const dirs = [[1,0], [0,1], [1,1], [1,-1]]; 
    for(let d of dirs){
        let count = 1;
        for(let k=1; k<5; k++){ 
            let nr=r+d[0]*k, nc=c+d[1]*k;
            if(nr<0||nr>=15||nc<0||nc>=15 || board[nr*15+nc]!==color) break; count++;
        }
        for(let k=1; k<5; k++){ 
            let nr=r-d[0]*k, nc=c-d[1]*k;
            if(nr<0||nr>=15||nc<0||nc>=15 || board[nr*15+nc]!==color) break; count++;
        }
        if(count >= 5) return true;
    }
    return false;
}

/* --- è±¡æ£‹ (Logic) --- */
// åº§æ¨™ç³»: 9åˆ—(x:0-8) x 10è¡Œ(y:0-9)
// åˆå§‹ä½ˆå±€ (ç´…åœ¨ä¸‹ p1ï¼Œé»‘åœ¨ä¸Š p2)
const XQ_INIT = [
    // é»‘æ–¹ (ä¸Š)
    {id:'b_c1',t:'è»Š',c:'black',x:0,y:0}, {id:'b_m1',t:'é¦¬',c:'black',x:1,y:0}, {id:'b_x1',t:'è±¡',c:'black',x:2,y:0}, {id:'b_s1',t:'å£«',c:'black',x:3,y:0}, {id:'b_k',t:'å°‡',c:'black',x:4,y:0}, {id:'b_s2',t:'å£«',c:'black',x:5,y:0}, {id:'b_x2',t:'è±¡',c:'black',x:6,y:0}, {id:'b_m2',t:'é¦¬',c:'black',x:7,y:0}, {id:'b_c2',t:'è»Š',c:'black',x:8,y:0},
    {id:'b_p1',t:'åŒ…',c:'black',x:1,y:2}, {id:'b_p2',t:'åŒ…',c:'black',x:7,y:2},
    {id:'b_z1',t:'å’',c:'black',x:0,y:3}, {id:'b_z2',t:'å’',c:'black',x:2,y:3}, {id:'b_z3',t:'å’',c:'black',x:4,y:3}, {id:'b_z4',t:'å’',c:'black',x:6,y:3}, {id:'b_z5',t:'å’',c:'black',x:8,y:3},
    
    // ç´…æ–¹ (ä¸‹)
    {id:'r_c1',t:'è»Š',c:'red',x:0,y:9}, {id:'r_m1',t:'é¦¬',c:'red',x:1,y:9}, {id:'r_x1',t:'ç›¸',c:'red',x:2,y:9}, {id:'r_s1',t:'ä»•',c:'red',x:3,y:9}, {id:'r_k',t:'å¸¥',c:'red',x:4,y:9}, {id:'r_s2',t:'ä»•',c:'red',x:5,y:9}, {id:'r_x2',t:'ç›¸',c:'red',x:6,y:9}, {id:'r_m2',t:'é¦¬',c:'red',x:7,y:9}, {id:'r_c2',t:'è»Š',c:'red',x:8,y:9},
    {id:'r_p1',t:'ç‚®',c:'red',x:1,y:7}, {id:'r_p2',t:'ç‚®',c:'red',x:7,y:7},
    {id:'r_z1',t:'å…µ',c:'red',x:0,y:6}, {id:'r_z2',t:'å…µ',c:'red',x:2,y:6}, {id:'r_z3',t:'å…µ',c:'red',x:4,y:6}, {id:'r_z4',t:'å…µ',c:'red',x:6,y:6}, {id:'r_z5',t:'å…µ',c:'red',x:8,y:6}
];

function initXiangqi(){ return JSON.parse(JSON.stringify(XQ_INIT)); }

let selectedPieceId = null;

function bindXiangqiEvents(){
    const points = document.querySelectorAll(".xq-point");
    points.forEach((pt, idx) => {
        pt.onclick = () => {
            const x = idx % 9;
            const y = Math.floor(idx / 9);
            if(selectedPieceId !== null) movePiece(selectedPieceId, x, y);
        };
    });
}

function drawXiangqi(pieces){
    const layer = document.getElementById("piecesLayer");
    layer.innerHTML = ""; // æ¸…ç©ºé‡ç¹ª
    if(!pieces) return;

    pieces.forEach(p => {
        const el = document.createElement("div");
        el.className = `chess-piece ${p.c} ${selectedPieceId===p.id ? 'selected' : ''}`;
        el.textContent = p.t;
        
        // åº§æ¨™è½‰æ› (x: 0-8, y: 0-9) -> CSS Left/Top
        // Board width 550, height 620. 
        // Grid size approx 550/9 ~ 61px, 620/10 ~ 62px
        // Padding offset: ~27px
        // Precise calc: 25px(padding) + x * 62.5
        
        el.style.left = (25 + p.x * 62.5) + "px";
        el.style.top = (25 + p.y * 63.3) + "px";

        el.onclick = (e) => {
            e.stopPropagation(); 
            pgRef.child(`tables/${currentTableId}`).once("value", s=>{
                const t = s.val();
                if(t.turn !== me.uid) return;
                
                // P1åŸ·ç´…, P2åŸ·é»‘
                const myColor = (me.uid === t.p1) ? 'red' : 'black';
                
                if(p.c === myColor) {
                    // é¸è‡ªå·±
                    selectedPieceId = p.id;
                    drawXiangqi(t.board); // é‡ç¹ªä»¥é¡¯ç¤ºé¸å–æ•ˆæœ
                } else {
                    // é»æ•µäºº -> åƒå­
                    if(selectedPieceId !== null) movePiece(selectedPieceId, p.x, p.y);
                }
            });
        };
        layer.appendChild(el);
    });
}

function movePiece(pid, tx, ty){
    pgRef.child(`tables/${currentTableId}`).transaction(t => {
        if(!t) return;
        
        // é©—è­‰æ£‹å­å­˜åœ¨
        const pIndex = t.board.findIndex(x => x.id === pid);
        if(pIndex === -1) return;

        // åƒå­é‚è¼¯
        const targetIndex = t.board.findIndex(x => x.x === tx && x.y === ty);
        let captured = null;
        if(targetIndex !== -1) {
            captured = t.board[targetIndex];
            t.board.splice(targetIndex, 1);
        }

        // æ›´æ–°ä½ç½® (é‡æŠ“ index å› ç‚ºå¯èƒ½æœ‰è®Šå‹•)
        const newPIndex = t.board.findIndex(x => x.id === pid);
        t.board[newPIndex].x = tx;
        t.board[newPIndex].y = ty;
        
        // æ›æ‰‹
        t.turn = (t.turn === t.p1) ? t.p2 : t.p1;
        
        // å‹è² 
        if(captured && (captured.t === 'å¸¥' || captured.t === 'å°‡')) {
            t.winner = me.uid;
        }

        return t;
    });
    selectedPieceId = null;
}

</script>
</body>
</html>
