<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>æŠ½è¸æ’éšŠç³»çµ± å®‰å…¨ç‰ˆ</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{font-family:Segoe UI;background:#0f172a;color:white;padding:20px;}
.card{background:#111827;border-radius:14px;padding:14px;margin-bottom:12px;}
button{padding:8px 12px;border:none;border-radius:8px;margin:4px;font-weight:bold;}
.primary{background:#22c55e;color:black;}
.warn{background:#f59e0b;}
.danger{background:#ef4444;}
.out{background:#7f1d1d;}
.queueItem{padding:12px;margin:6px 0;border-radius:8px;background:#020617;font-size:18px;}
.hidden{display:none;}
</style>
</head>

<body>

<h2>ğŸš¬ æŠ½è¸æ’éšŠç³»çµ±</h2>

<div id="loginBox" class="card">
<button class="primary" onclick="googleLogin()">Google ç™»å…¥</button>
</div>

<div id="app" class="hidden">

<div class="card">
<h3 id="who"></h3>
<button onclick="logout()">ç™»å‡º</button>
</div>

<div class="card">
<div id="actions"></div>
</div>

<div class="card">
<h3>æ’éšŠé †åº</h3>
<div id="queue"></div>
</div>

<div id="adminPanel" class="card hidden">
<h3>ç®¡ç†æ¨¡å¼</h3>
<button class="danger" onclick="forceLogout()">å¼·åˆ¶æ‰€æœ‰äººé‡æ–°ç™»å…¥</button>
</div>

</div>

<script>

//////////////// FIREBASE //////////////////

const firebaseConfig={
apiKey:"AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",
authDomain:"smoke-queue.firebaseapp.com",
databaseURL:"https://smoke-queue-default-rtdb.firebaseio.com",
projectId:"smoke-queue",
storageBucket:"smoke-queue.firebasestorage.app",
messagingSenderId:"474216861000",
appId:"1:474216861000:web:052d21df1bcdb183ebb77d"
};

firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.database();

//////////////// CONFIG //////////////////

const ADMIN="wp037606888@gmail.com";

let me=null;
let queueData={};

const queueRef=db.ref("queue");
const kickRef=db.ref("kick");

//////////////// LOGIN //////////////////

function googleLogin(){
const provider=new firebase.auth.GoogleAuthProvider();
auth.signInWithRedirect(provider);
}

function logout(){
auth.signOut();
}

auth.getRedirectResult().catch(console.error);

auth.onAuthStateChanged(user=>{
if(!user){
loginBox.classList.remove("hidden");
app.classList.add("hidden");
return;
}

me=user;

loginBox.classList.add("hidden");
app.classList.remove("hidden");

who.innerText="å·²ç™»å…¥ï¼š"+user.displayName;

if(user.email===ADMIN)
adminPanel.classList.remove("hidden");

listenQueue();
renderButtons();
});

//////////////// QUEUE //////////////////

function listenQueue(){
queueRef.on("value",s=>{
queueData=s.val()||{};
renderQueue();
renderButtons();
});
}

function reserve(){
queueRef.child(me.uid).set({
name:me.displayName,
status:"reserved",
time:Date.now()
});
}

function cancel(){
queueRef.child(me.uid).remove();
}

function goOut(){
queueRef.child(me.uid).update({
status:"out",
outTime:Date.now()
});
}

function comeBack(){
if(!confirm("ç¢ºå®šå›ä¾†ï¼Ÿ")) return;
if(!confirm("å›ä¾†å¾Œä¸èƒ½å†å‡ºå»ï¼Œç¢ºå®šï¼Ÿ")) return;
queueRef.child(me.uid).update({status:"used"});
}

//////////////// BUTTONS //////////////////

function renderButtons(){
if(!me) return;

let p=queueData[me.uid];
actions.innerHTML="";

if(!p){
btn("é ç´„","primary",reserve);
return;
}

if(p.status==="reserved"){
btn("å–æ¶ˆé ç´„","warn",cancel);
btn("å‡ºå»","primary",goOut);
}

if(p.status==="out"){
btn("å›ä¾†","danger",comeBack);
}
}

function btn(t,c,f){
let b=document.createElement("button");
b.innerText=t;
b.className=c;
b.onclick=f;
actions.appendChild(b);
}

//////////////// RENDER //////////////////

function renderQueue(){
queue.innerHTML="";

let arr=Object.values(queueData);

arr.sort((a,b)=>{
const order={out:0,reserved:1,used:2};
return order[a.status]-order[b.status];
});

arr.forEach(p=>{
let div=document.createElement("div");
div.className="queueItem";

let text=p.name+" â€” ";

if(p.status==="reserved") text+="å·²é ç´„";

if(p.status==="out"){
let sec=Math.floor((Date.now()-p.outTime)/1000);
let remain=600-sec;

if(remain>0) text+="å¤–å‡º "+remain+"ç§’";
else text+="è¶…æ™‚ "+(-remain)+"ç§’";

div.classList.add("out");
}

if(p.status==="used") text+="æœ¬å ´å·²ç”¨";

div.innerText=text;
queue.appendChild(div);
});
}

setInterval(renderQueue,1000);

//////////////// ADMIN //////////////////

function forceLogout(){
kickRef.set(Date.now());
}

kickRef.on("value",s=>{
if(!me) return;
alert("ç®¡ç†å“¡è¦æ±‚é‡æ–°ç™»å…¥");
logout();
});

</script>

</body>
</html>
