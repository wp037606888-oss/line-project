<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‘ªè‰åˆ—è»Š - çš‡å®¶VIPéœ“è™¹ç‰ˆ</title>
    <style>
        /* --- å°Šçˆµé…è‰²èˆ‡å…¨åŸŸè®Šæ•¸ --- */
        :root {
            --bg-dark: #0a0a0c;
            --machine-bg: linear-gradient(135deg, #1a1c23 0%, #0d0e12 100%);
            --gold-primary: #f9d423;
            --gold-dark: #b8860b;
            --neon-red: #ff003c;
            --neon-blue: #00f3ff;
            --neon-green: #00ff66;
            --neon-purple: #b500ff;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        @keyframes ambient-glow {
            0% { box-shadow: 0 0 50px rgba(249, 212, 35, 0.1); }
            50% { box-shadow: 0 0 80px rgba(0, 243, 255, 0.15); }
            100% { box-shadow: 0 0 50px rgba(249, 212, 35, 0.1); }
        }

        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 0%, #1a1c23 0%, transparent 70%);
            color: #fff;
            font-family: 'Segoe UI', system-ui, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            perspective: 1000px; /* å¢åŠ ç«‹é«”æ„Ÿ */
        }

        /* --- æ©Ÿå°ä¸»é«” --- */
        .machine-wrapper {
            background: var(--machine-bg);
            padding: 30px 40px;
            border-radius: 25px;
            border: 2px solid #2a2d35;
            box-shadow: 
                0 20px 50px rgba(0,0,0,0.9),
                inset 0 0 0 2px rgba(249, 212, 35, 0.2),
                inset 0 0 20px rgba(249, 212, 35, 0.05);
            max-width: 850px;
            animation: ambient-glow 4s infinite alternate;
            position: relative;
        }

        /* --- é ‚éƒ¨è¨˜åˆ†æ¿ (Cyberpunk è³ªæ„Ÿ) --- */
        .scoreboard {
            display: flex;
            justify-content: space-between;
            background: #050505;
            padding: 15px 30px;
            border-radius: 15px;
            border-bottom: 3px solid var(--gold-primary);
            box-shadow: inset 0 0 20px rgba(0,0,0,1), 0 5px 15px rgba(0,0,0,0.5);
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        /* è¨˜åˆ†æ¿æµå…‰ç‰¹æ•ˆ */
        .scoreboard::before {
            content: '';
            position: absolute;
            top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(249, 212, 35, 0.2), transparent);
            animation: scanline 3s linear infinite;
        }

        @keyframes scanline {
            0% { left: -100%; }
            100% { left: 200%; }
        }

        .score-box { text-align: center; z-index: 1; }
        .score-label { font-size: 12px; color: #8892b0; letter-spacing: 2px; }
        .score-value { 
            font-size: 32px; font-weight: 900; font-family: 'Courier New', Courier, monospace;
            color: var(--gold-primary);
            text-shadow: 0 0 15px var(--gold-primary);
            transition: 0.3s ease-out;
        }
        .win-value { color: var(--neon-green); text-shadow: 0 0 15px var(--neon-green); }

        .info-msg { 
            flex: 1; text-align: center; align-self: center;
            font-size: 20px; font-weight: bold; letter-spacing: 3px;
            color: #fff; text-shadow: 0 0 10px var(--neon-blue);
            z-index: 1;
        }

        /* --- è·‘é¦¬ç‡ˆå¤–åœˆ --- */
        .track-grid {
            display: grid;
            grid-template-columns: repeat(7, 85px);
            grid-template-rows: repeat(7, 85px);
            gap: 6px;
            margin-bottom: 25px;
            position: relative;
        }

        .track-item {
            background: rgba(20, 22, 28, 0.8);
            border: 1px solid #333;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            transition: all 0.1s;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.8);
            position: relative;
        }

        /* è·‘é¦¬ç‡ˆæ´»èºç‹€æ…‹ï¼šç™¼å¤§å…‰ + ç¨å¾®æµ®èµ· */
        .track-item.active {
            background: #fff;
            border-color: var(--gold-primary);
            box-shadow: 0 0 30px var(--gold-primary), inset 0 0 20px var(--gold-primary);
            transform: scale(1.1) translateZ(10px);
            z-index: 10;
        }

        /* æ®˜å½±æ‹–å°¾æ•ˆæœ */
        .track-item.trail-1 { box-shadow: 0 0 15px rgba(249, 212, 35, 0.6); border-color: rgba(249, 212, 35, 0.6); }
        .track-item.trail-2 { box-shadow: 0 0 8px rgba(249, 212, 35, 0.3); border-color: rgba(249, 212, 35, 0.3); }

        /* ç«è»Šçå°ˆå±¬ç‰¹æ•ˆï¼šè¡€ç´…ç‹‚æš´ */
        .track-item.train-active {
            background: #ffebee;
            border-color: var(--neon-red);
            box-shadow: 0 0 40px var(--neon-red), inset 0 0 20px var(--neon-red);
            transform: scale(1.15);
            z-index: 10;
        }

        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(-2px, 2px); }
            50% { transform: translate(2px, -2px); }
            75% { transform: translate(-2px, -2px); }
        }
        .shake-screen { animation: shake 0.3s ease-in-out infinite; }

        /* --- ä¸­å¤®é¡¯ç¤ºå¹• (Logo èˆ‡ æ¯”å€ç³»çµ±) --- */
        .center-display {
            position: absolute;
            top: 91px; left: 91px;
            width: 443px; height: 443px;
            background: radial-gradient(circle at center, #11141d 0%, #050608 100%);
            border: 2px solid #2a2d35;
            border-radius: 20px;
            box-shadow: inset 0 0 40px #000, 0 0 20px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 5;
            overflow: hidden;
        }

        #center-logo {
            font-size: 50px; font-weight: 900;
            background: linear-gradient(to bottom, #fff, #8892b0);
            -webkit-background-clip: text; color: transparent;
            text-shadow: 0 0 20px rgba(255,255,255,0.2);
            letter-spacing: 15px;
        }

        /* --- çš‡å®¶æ¯”å€ UI --- */
        #double-up-ui {
            display: none; flex-direction: column; align-items: center; width: 100%; height: 100%;
            padding: 20px; box-sizing: border-box;
        }

        .du-header {
            color: var(--gold-primary); font-size: 22px; font-weight: bold; letter-spacing: 4px;
            text-shadow: 0 0 10px var(--gold-primary); margin-bottom: 10px;
        }

        /* æ¯”å€çæ± èˆ‡ä¸‹æ³¨å€ */
        .du-pool-container {
            display: flex; justify-content: space-around; width: 100%; margin-bottom: 15px;
            background: rgba(0,0,0,0.5); border-radius: 10px; padding: 10px 0; border: 1px solid #333;
        }
        .du-pool-box { text-align: center; }
        .du-pool-label { font-size: 12px; color: #8892b0; }
        .du-pool-val { font-size: 28px; font-weight: bold; font-family: 'Courier New', Courier, monospace; }
        #du-total-win { color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green); }
        #du-current-bet { color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); }

        /* é–ƒç‡ˆå€åŸŸ (å·¦ / å³) */
        .flash-stage { display: flex; gap: 20px; margin-bottom: 20px; width: 80%; justify-content: center;}
        .flash-box {
            width: 100px; height: 100px; border-radius: 15px;
            background: #1a1a1a; border: 3px solid #333;
            display: flex; justify-content: center; align-items: center;
            font-size: 36px; font-weight: bold; color: #555;
            transition: 0.1s; position: relative;
        }
        /* é–ƒçˆç‹€æ…‹ */
        .flash-box.highlight {
            background: #fff; color: #000;
            border-color: var(--gold-primary);
            box-shadow: 0 0 40px var(--gold-primary), inset 0 0 20px var(--gold-primary);
            transform: scale(1.1);
        }
        .flash-box.winner {
            background: var(--neon-green); color: #000;
            border-color: #fff; box-shadow: 0 0 50px var(--neon-green);
        }
        .flash-box.loser {
            background: var(--neon-red); color: #fff;
            border-color: #fff; box-shadow: 0 0 50px var(--neon-red);
        }

        /* æ¯”å€æ§åˆ¶éˆ• */
        .du-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .du-adjust-btn {
            background: #222; border: 1px solid #555; color: #fff;
            padding: 5px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;
            transition: 0.2s;
        }
        .du-adjust-btn:hover { background: var(--neon-blue); color: #000; border-color: var(--neon-blue); }
        .du-adjust-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .du-action-buttons { display: flex; gap: 15px; width: 90%; justify-content: center; }
        .btn-guess {
            flex: 1; padding: 12px 0; font-size: 20px; font-weight: bold;
            background: transparent; border: 2px solid var(--neon-blue); color: var(--neon-blue);
            border-radius: 10px; cursor: pointer; box-shadow: inset 0 0 10px rgba(0,243,255,0.2);
            transition: 0.2s; letter-spacing: 2px;
        }
        .btn-guess:hover:not(:disabled) { background: var(--neon-blue); color: #000; box-shadow: 0 0 20px var(--neon-blue); }
        
        .btn-take {
            flex: 1; background: linear-gradient(180deg, var(--gold-primary), var(--gold-dark));
            border: none; color: #000; font-weight: bold; font-size: 20px; border-radius: 10px;
            cursor: pointer; box-shadow: 0 0 15px rgba(249,212,35,0.5); transition: 0.2s;
        }
        .btn-take:hover:not(:disabled) { filter: brightness(1.2); box-shadow: 0 0 25px rgba(249,212,35,0.8); }

        /* --- æŠ¼æ³¨å€ (ç»ç’ƒæ“¬æ…‹è¨­è¨ˆ) --- */
        .bet-panel { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 25px; }
        .bet-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 15px; padding: 12px; backdrop-filter: blur(10px);
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.2s;
        }
        .bet-card:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.3); }
        
        .bet-header { display: flex; justify-content: space-between; width: 100%; margin-bottom: 5px; }
        .bet-odds { font-size: 11px; color: var(--gold-primary); font-weight: bold; background: rgba(249,212,35,0.1); padding: 2px 6px; border-radius: 4px; }
        .bet-icon { font-size: 32px; margin: 5px 0; text-shadow: 0 0 10px rgba(255,255,255,0.2); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));}
        
        .bet-stepper { display: flex; align-items: center; justify-content: space-between; width: 100%; background: rgba(0,0,0,0.4); border-radius: 8px; padding: 2px; }
        .btn-step { background: transparent; border: none; color: #8892b0; font-size: 18px; width: 30px; height: 30px; cursor: pointer; transition: 0.2s; border-radius: 6px; }
        .btn-step:hover:not(:disabled) { background: rgba(255,255,255,0.1); color: #fff; }
        .bet-val { font-size: 20px; font-weight: bold; color: #fff; font-family: 'Courier New', Courier, monospace;}

        /* --- ä¸»æ§åˆ¶æŒ‰éˆ• --- */
        .master-controls { display: flex; gap: 20px; }
        .btn-master {
            flex: 1; padding: 18px; font-size: 22px; font-weight: 900;
            border-radius: 12px; cursor: pointer; border: none; letter-spacing: 4px; text-transform: uppercase;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn-master:active:not(:disabled) { transform: scale(0.95); }
        .btn-master:disabled { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; }
        
        .btn-clear { background: #2a2d35; color: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .btn-clear:hover:not(:disabled) { background: #3a3f4a; box-shadow: 0 5px 20px rgba(255,255,255,0.1); }
        
        .btn-start {
            background: linear-gradient(135deg, var(--gold-primary), #ff8c00); color: #000;
            box-shadow: 0 10px 20px rgba(249, 212, 35, 0.4), inset 0 -3px 0 rgba(0,0,0,0.2);
            text-shadow: 0 1px 2px rgba(255,255,255,0.5);
        }
        .btn-start:hover:not(:disabled) { box-shadow: 0 15px 30px rgba(249, 212, 35, 0.6), inset 0 -3px 0 rgba(0,0,0,0.2); filter: brightness(1.1); }

    </style>
</head>
<body>

<div class="machine-wrapper" id="machine">
    <div class="scoreboard">
        <div class="score-box">
            <div class="score-label">CREDITS</div>
            <div class="score-value" id="credits">10000</div>
        </div>
        <div class="info-msg" id="msg-board">è«‹ä¸‹æ³¨</div>
        <div class="score-box">
            <div class="score-label">WIN</div>
            <div class="score-value win-value" id="win-score">0</div>
        </div>
    </div>

    <div class="track-grid" id="track-container">
        <div class="center-display">
            <div id="center-logo">ROYAL MARIO</div>
            
            <div id="double-up-ui">
                <div class="du-header">â—† æ¯”å€æ¨¡å¼ â—†</div>
                
                <div class="du-pool-container">
                    <div class="du-pool-box">
                        <div class="du-pool-label">ç¸½çé‡‘æ± </div>
                        <div class="du-pool-val" id="du-total-win">0</div>
                    </div>
                    <div class="du-pool-box">
                        <div class="du-pool-label">æœ¬æ¬¡æŠ¼æ³¨</div>
                        <div class="du-pool-val" id="du-current-bet">0</div>
                    </div>
                </div>

                <div class="du-controls">
                    <button class="du-adjust-btn" onclick="adjustDUBet('min')">MIN</button>
                    <button class="du-adjust-btn" onclick="adjustDUBet(-100)">-100</button>
                    <button class="du-adjust-btn" onclick="adjustDUBet(100)">+100</button>
                    <button class="du-adjust-btn" onclick="adjustDUBet('max')">MAX</button>
                </div>

                <div class="flash-stage">
                    <div class="flash-box" id="flash-left">â—€ å·¦</div>
                    <div class="flash-box" id="flash-right">å³ â–¶</div>
                </div>

                <div class="du-action-buttons">
                    <button class="btn-guess du-btn" onclick="triggerDoubleUp('left')">æŠ¼ å·¦</button>
                    <button class="btn-take du-btn" onclick="takeScore()">æ”¶ åˆ†</button>
                    <button class="btn-guess du-btn" onclick="triggerDoubleUp('right')">æŠ¼ å³</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bet-panel" id="bet-container">
        </div>

    <div class="master-controls">
        <button class="btn-master btn-clear" onclick="clearBets()" id="btn-clear">æ¸…é™¤æŠ¼æ³¨</button>
        <button class="btn-master btn-start" onclick="startGame()" id="btn-start">é–‹å§‹è½‰å‹• (SPIN)</button>
    </div>
</div>

<script>
    // --- éŠæˆ²è¨­å®š ---
    const SYMBOLS = {
        'apple': { icon: 'ğŸ', odds: 5, name: 'è˜‹æœ' },
        'orange': { icon: 'ğŸŠ', odds: 10, name: 'æ©˜å­' },
        'papaya': { icon: 'ğŸ¥­', odds: 15, name: 'èŠ’æœ' },
        'bell': { icon: 'ğŸ””', odds: 20, name: 'éŠ…é˜' },
        'watermelon': { icon: 'ğŸ‰', odds: 20, name: 'è¥¿ç“œ' },
        'star': { icon: 'â­', odds: 30, name: 'æ˜Ÿæ˜Ÿ' },
        '77': { icon: 'ğŸ°', odds: 40, name: '77' },
        'bar': { icon: 'ğŸ’', odds: 50, name: 'BAR' },
        'train': { icon: 'ğŸš‚', odds: 0, name: 'åˆ—è»Š' }
    };

    const TRACK_LAYOUT = [
        'apple', 'orange', 'apple', 'bell', 'watermelon', 'star', '77',      
        'apple', 'papaya', 'orange', 'bell', 'apple',                        
        'bar', 'train', 'watermelon', 'papaya', 'apple', 'orange', 'bell',   
        'apple', 'star', 'watermelon', 'papaya', 'orange'                    
    ];

    // --- å…¨åŸŸç‹€æ…‹ ---
    let credits = 10000;
    let winAmount = 0;   // è´å¾—çš„ç¸½çé‡‘æ± 
    let duBet = 0;       // æ¯”å€æ¨¡å¼ä¸­æº–å‚™ä¸‹æ³¨çš„é‡‘é¡
    let bets = { apple: 0, orange: 0, papaya: 0, bell: 0, watermelon: 0, star: 0, '77': 0, bar: 0 };
    let totalBet = 0;
    let currentPos = 0;
    let isSpinning = false;
    let isDoubleUpMode = false;
    let isFlashing = false; // æ¯”å€å‹•ç•«åŸ·è¡Œä¸­

    // --- åˆå§‹åŒ– UI ---
    function initLayout() {
        const trackContainer = document.getElementById('track-container');
        document.querySelectorAll('.track-item').forEach(el => el.remove());
        
        // æ¸²æŸ“ 24 æ ¼è·‘é¦¬ç‡ˆ
        TRACK_LAYOUT.forEach((symbolKey, index) => {
            let row, col;
            if (index <= 6) { row = 1; col = index + 1; }
            else if (index <= 11) { row = index - 5; col = 7; }
            else if (index <= 18) { row = 7; col = 19 - index; }
            else { row = 25 - index; col = 1; }

            const div = document.createElement('div');
            div.className = 'track-item';
            div.id = `track-${index}`;
            div.style.gridRow = row;
            div.style.gridColumn = col;
            div.innerHTML = SYMBOLS[symbolKey].icon;
            trackContainer.appendChild(div);
        });

        // æ¸²æŸ“æŠ¼æ³¨å€
        const betContainer = document.getElementById('bet-container');
        betContainer.innerHTML = '';
        Object.keys(bets).forEach(key => {
            const card = document.createElement('div');
            card.className = 'bet-card';
            card.innerHTML = `
                <div class="bet-header">
                    <span class="bet-odds">x${SYMBOLS[key].odds}</span>
                </div>
                <div class="bet-icon">${SYMBOLS[key].icon}</div>
                <div class="bet-stepper">
                    <button class="btn-step" onclick="changeBet('${key}', -10)">-</button>
                    <span class="bet-val" id="bet-${key}">0</span>
                    <button class="btn-step" onclick="changeBet('${key}', 10)">+</button>
                </div>
            `;
            betContainer.appendChild(card);
        });

        updateUI();
        highlightPos(currentPos);
    }

    // --- è¨Šæ¯èˆ‡ UI æ›´æ–° ---
    function updateUI() {
        document.getElementById('credits').innerText = credits;
        document.getElementById('win-score').innerText = winAmount;
        document.getElementById('du-total-win').innerText = winAmount;
        document.getElementById('du-current-bet').innerText = duBet;
        
        Object.keys(bets).forEach(key => {
            document.getElementById(`bet-${key}`).innerText = bets[key];
        });
    }

    function showMessage(msg, color = '#fff') {
        const msgBoard = document.getElementById('msg-board');
        msgBoard.innerText = msg;
        msgBoard.style.color = color;
        msgBoard.style.textShadow = `0 0 15px ${color}`;
    }

    // --- ä¸»éŠæˆ²é‚è¼¯ ---
    function changeBet(key, amount) {
        if (isSpinning || isDoubleUpMode) return;
        if (winAmount > 0) takeScore(); // é»æ“ŠæŠ¼æ³¨æ™‚è‡ªå‹•æ”¶ä¸‹ä¸Šæ¬¡çé‡‘

        if (amount > 0 && credits < amount) {
            showMessage('é¤˜é¡ä¸è¶³', 'var(--neon-red)');
            return;
        }
        if (amount < 0 && bets[key] < Math.abs(amount)) return;

        credits -= amount;
        bets[key] += amount;
        totalBet += amount;
        updateUI();
        showMessage(amount > 0 ? 'åŠ æ³¨ä¸­...' : 'é€€æ³¨', '#8892b0');
    }

    function clearBets() {
        if (isSpinning || isDoubleUpMode || totalBet === 0) return;
        credits += totalBet;
        totalBet = 0;
        Object.keys(bets).forEach(k => bets[k] = 0);
        updateUI();
        showMessage('å·²æ¸…é™¤æŠ¼æ³¨', '#8892b0');
    }

    function highlightPos(pos, isTrain = false) {
        // ç§»é™¤æ‰€æœ‰ç‹€æ…‹
        document.querySelectorAll('.track-item').forEach(el => {
            el.className = 'track-item'; 
        });

        // è¨­å®šç•¶å‰ç™¼å…‰é»
        const currentEl = document.getElementById(`track-${pos}`);
        if(isTrain) {
            currentEl.classList.add('train-active');
        } else {
            currentEl.classList.add('active');
            
            // åŠ å…¥æ‹–å°¾æ®˜å½±ç‰¹æ•ˆ
            let trail1 = (pos - 1 + 24) % 24;
            let trail2 = (pos - 2 + 24) % 24;
            document.getElementById(`track-${trail1}`).classList.add('trail-1');
            document.getElementById(`track-${trail2}`).classList.add('trail-2');
        }
    }

    function startGame() {
        if (isDoubleUpMode) takeScore(); 
        else if (winAmount > 0) takeScore();

        if (totalBet === 0) {
            showMessage('è«‹å…ˆä¸‹æ³¨', 'var(--neon-red)');
            return;
        }
        
        isSpinning = true;
        setMasterButtons(true);
        showMessage('è½‰å‹•ä¸­...', 'var(--gold-primary)');

        const targetResult = Math.floor(Math.random() * 24);
        const totalSteps = 24 * 3 + ((targetResult - currentPos + 24) % 24);
        let currentStep = 0;

        function stepAnimation() {
            currentStep++;
            currentPos = (currentPos + 1) % 24;
            highlightPos(currentPos);

            if (currentStep < totalSteps) {
                // ç‰©ç†æ¸›é€Ÿ
                let progress = currentStep / totalSteps;
                let delay = 15 + Math.pow(progress, 4) * 400; 
                setTimeout(stepAnimation, delay);
            } else {
                handleResult(currentPos);
            }
        }
        stepAnimation();
    }

    function handleResult(stopPos) {
        const symbolKey = TRACK_LAYOUT[stopPos];
        if (symbolKey === 'train') {
            showMessage('ğŸš‚ ç‹‚æš´åˆ—è»Šè§¸ç™¼ï¼', 'var(--neon-red)');
            document.getElementById('machine').classList.add('shake-screen');
            triggerTrainAnimation(stopPos);
        } else {
            calculateWin([stopPos]);
        }
    }

    function triggerTrainAnimation(startPos) {
        const trainLength = 5; // å¤§ç«è»Š 5æ ¼
        let trainPositions = [];
        for(let i = 0; i < trainLength; i++) trainPositions.push((startPos + i + 1) % 24); 

        let step = 0;
        let interval = setInterval(() => {
            if (step < trainPositions.length) {
                let pos = trainPositions[step];
                document.getElementById(`track-${pos}`).classList.add('train-active');
                step++;
            } else {
                clearInterval(interval);
                document.getElementById('machine').classList.remove('shake-screen');
                calculateWin(trainPositions);
            }
        }, 300);
    }

    function calculateWin(winningPositions) {
        winAmount = 0;
        winningPositions.forEach(pos => {
            const sym = TRACK_LAYOUT[pos];
            if (sym !== 'train' && bets[sym] > 0) winAmount += bets[sym] * SYMBOLS[sym].odds;
        });

        updateUI();

        if (winAmount > 0) {
            showMessage(`ä¸­ç $${winAmount}ï¼é€²å…¥æ¯”å€`, 'var(--neon-green)');
            enterDoubleUpMode();
        } else {
            showMessage('æœªä¸­ç', '#8892b0');
            isSpinning = false;
            setMasterButtons(false);
        }
    }

    // --- æ¯”å€ç³»çµ± (é€²åŒ–ç‰ˆ) ---
    function enterDoubleUpMode() {
        isDoubleUpMode = true;
        duBet = winAmount; // é è¨­å…¨æŠ¼
        document.getElementById('center-logo').style.display = 'none';
        document.getElementById('double-up-ui').style.display = 'flex';
        resetFlashBoxes();
        updateUI();
        setMasterButtons(true);
    }

    function exitDoubleUpMode() {
        isDoubleUpMode = false;
        document.getElementById('center-logo').style.display = 'block';
        document.getElementById('double-up-ui').style.display = 'none';
        isSpinning = false;
        setMasterButtons(false);
        updateUI();
    }

    // èª¿æ•´æ¯”å€ä¸‹æ³¨é‡‘é¡
    function adjustDUBet(val) {
        if (isFlashing) return;
        
        if (val === 'max') {
            duBet = winAmount;
        } else if (val === 'min') {
            duBet = 10; // æœ€å°‘æŠ¼ 10
        } else {
            duBet += val;
        }

        // ç¢ºä¿ç¯„åœæ­£ç¢º
        if (duBet > winAmount) duBet = winAmount;
        if (duBet < 10 && winAmount >= 10) duBet = 10;
        if (winAmount === 0) duBet = 0;

        updateUI();
    }

    // è§¸ç™¼å·¦/å³é–ƒçˆå‹•ç•«
    function triggerDoubleUp(userChoice) {
        if (!isDoubleUpMode || isFlashing || duBet <= 0 || duBet > winAmount) return;

        isFlashing = true;
        setDUButtons(true); // é–å®šæ¯”å€æŒ‰éˆ•
        resetFlashBoxes();
        
        // å…ˆå¾çæ± æ‰£é™¤æœ¬æ¬¡ä¸‹æ³¨
        winAmount -= duBet;
        updateUI();
        showMessage('é–‹çä¸­...', 'var(--gold-primary)');

        const boxLeft = document.getElementById('flash-left');
        const boxRight = document.getElementById('flash-right');
        
        // é å…ˆæ±ºå®šçµæœ (50% æ©Ÿç‡)
        const finalResult = Math.random() < 0.5 ? 'left' : 'right';
        
        // é–ƒç‡ˆå‹•ç•«è¨­å®š
        let flashCount = 0;
        const maxFlashes = 15 + Math.floor(Math.random() * 10); // éš¨æ©Ÿé–ƒ 15~25 æ¬¡
        let currentFlash = 'left';

        function flashStep() {
            boxLeft.classList.remove('highlight');
            boxRight.classList.remove('highlight');

            if (currentFlash === 'left') {
                boxLeft.classList.add('highlight');
                currentFlash = 'right';
            } else {
                boxRight.classList.add('highlight');
                currentFlash = 'left';
            }

            flashCount++;

            if (flashCount < maxFlashes) {
                // é–ƒçˆæ¸›é€Ÿ
                let progress = flashCount / maxFlashes;
                let delay = 30 + Math.pow(progress, 3) * 400; 
                setTimeout(flashStep, delay);
            } else {
                // å‹•ç•«çµæŸï¼Œé¡¯ç¤ºæœ€çµ‚çµæœ
                resolveDoubleUp(userChoice, finalResult);
            }
        }
        
        flashStep();
    }

    // çµç®—æ¯”å€çµæœ
    function resolveDoubleUp(userChoice, finalResult) {
        const boxLeft = document.getElementById('flash-left');
        const boxRight = document.getElementById('flash-right');
        
        boxLeft.classList.remove('highlight');
        boxRight.classList.remove('highlight');

        const winnerBox = finalResult === 'left' ? boxLeft : boxRight;
        
        if (userChoice === finalResult) {
            // çŒœä¸­ï¼šæŠŠæŠ¼æ³¨çš„å…©å€åŠ å›çæ± 
            winnerBox.classList.add('winner');
            winAmount += (duBet * 2);
            showMessage(`çŒœä¸­ï¼è´å¾— $${duBet * 2}`, 'var(--neon-green)');
        } else {
            // çŒœéŒ¯ï¼šå‰›å‰›å·²ç¶“æ‰£éäº†ï¼Œåªè¦è®Šç´…è‰²
            winnerBox.classList.add('loser');
            showMessage(`çŒœéŒ¯ï¼æå¤± $${duBet}`, 'var(--neon-red)');
        }

        // è‡ªå‹•èª¿æ•´ä¸‹ä¸€æ¬¡çš„é è¨­ä¸‹æ³¨ç‚ºå‰©é¤˜çæ± æœ€å¤§å€¼
        duBet = winAmount; 
        updateUI();

        setTimeout(() => {
            isFlashing = false;
            resetFlashBoxes();
            
            if (winAmount <= 0) {
                // çæ± è¼¸å…‰äº†ï¼Œè‡ªå‹•é€€å‡º
                showMessage('çé‡‘æ­¸é›¶', '#8892b0');
                setTimeout(exitDoubleUpMode, 1000);
            } else {
                setDUButtons(false); // è§£é–ï¼Œè®“ç©å®¶ç¹¼çºŒçŒœæˆ–æ”¶åˆ†
                showMessage('è«‹ç¹¼çºŒæ¯”å€æˆ–æ”¶åˆ†', '#fff');
            }
        }, 1500);
    }

    function resetFlashBoxes() {
        document.getElementById('flash-left').className = 'flash-box';
        document.getElementById('flash-right').className = 'flash-box';
    }

    function takeScore() {
        if (isFlashing) return;
        if (winAmount > 0) {
            credits += winAmount;
            showMessage(`æˆåŠŸå…¥è¢‹ $${winAmount}`, 'var(--gold-primary)');
            winAmount = 0;
            updateUI();
        }
        exitDoubleUpMode();
    }

    // --- æŒ‰éˆ•é–å®šæ§åˆ¶ ---
    function setMasterButtons(disabled) {
        document.getElementById('btn-start').disabled = disabled;
        document.getElementById('btn-clear').disabled = disabled;
        document.querySelectorAll('.btn-step').forEach(btn => btn.disabled = disabled);
    }

    function setDUButtons(disabled) {
        document.querySelectorAll('.du-btn').forEach(btn => btn.disabled = disabled);
        document.querySelectorAll('.du-adjust-btn').forEach(btn => btn.disabled = disabled);
    }

    // å•Ÿå‹•
    initLayout();

</script>
</body>
</html>