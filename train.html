<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‘ªè‰åˆ—è»Š - çµ‚æ¥µå¥¢è¯ç‰ˆ</title>
    <style>
        :root {
            --bg-dark: #050508;
            --machine-bg: linear-gradient(145deg, #12141a 0%, #08090b 100%);
            --gold-primary: #ffd700;
            --gold-dark: #b8860b;
            --neon-red: #ff1e56;
            --neon-blue: #00e5ff;
            --neon-green: #00ff7f;
            --neon-purple: #bd00ff;
            --glass-bg: rgba(20, 22, 28, 0.4);
            --glass-border: rgba(255, 215, 0, 0.15);
        }

        @keyframes ambient-glow {
            0% { box-shadow: 0 0 60px rgba(255, 215, 0, 0.08); }
            50% { box-shadow: 0 0 100px rgba(0, 229, 255, 0.12); }
            100% { box-shadow: 0 0 60px rgba(255, 215, 0, 0.08); }
        }

        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 10%, #171a21 0%, transparent 80%);
            color: #fff;
            font-family: 'Segoe UI', system-ui, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .machine-wrapper {
            background: var(--machine-bg);
            padding: 35px 45px;
            border-radius: 30px;
            border: 2px solid #23262e;
            box-shadow: 
                0 30px 60px rgba(0,0,0,0.9),
                inset 0 0 0 2px rgba(255, 215, 0, 0.2),
                inset 0 0 30px rgba(255, 215, 0, 0.05);
            max-width: 900px;
            animation: ambient-glow 4s infinite alternate;
        }

        /* --- é ‚éƒ¨è¨˜åˆ†æ¿ --- */
        .scoreboard {
            display: flex; justify-content: space-between; align-items: center;
            background: #000; padding: 15px 35px; border-radius: 15px;
            border-bottom: 3px solid var(--gold-primary);
            box-shadow: inset 0 0 25px rgba(0,0,0,1), 0 8px 20px rgba(0,0,0,0.6);
            margin-bottom: 30px; position: relative;
        }

        .score-box { text-align: center; }
        .score-label { font-size: 13px; color: #6b7280; letter-spacing: 3px; margin-bottom: 4px; }
        .score-value { 
            font-size: 34px; font-weight: 900; font-family: 'Courier New', Courier, monospace;
            color: var(--gold-primary); text-shadow: 0 0 20px rgba(255,215,0,0.8);
        }
        .win-value { color: var(--neon-green); text-shadow: 0 0 20px rgba(0,255,127,0.8); }

        .info-msg { 
            flex: 1; text-align: center; font-size: 22px; font-weight: bold; letter-spacing: 4px;
            color: #fff; text-shadow: 0 0 15px var(--neon-blue);
        }

        /* --- è·‘é¦¬ç‡ˆå¤–åœˆ --- */
        .track-grid {
            display: grid; grid-template-columns: repeat(7, 88px); grid-template-rows: repeat(7, 88px);
            gap: 8px; margin-bottom: 30px; position: relative;
        }

        .track-item {
            background: rgba(10, 12, 16, 0.9); border: 2px solid #2a2d35;
            border-radius: 14px; display: flex; justify-content: center; align-items: center;
            font-size: 34px; transition: all 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.9); z-index: 1;
        }

        /* æ´»èºå…‰åœˆ */
        .track-item.active {
            background: #fff; border-color: var(--gold-primary);
            box-shadow: 0 0 35px var(--gold-primary), inset 0 0 20px var(--gold-primary);
            transform: scale(1.12); z-index: 10;
        }
        
        .track-item.trail-1 { box-shadow: 0 0 20px rgba(255,215,0,0.5); border-color: rgba(255,215,0,0.6); }
        .track-item.trail-2 { box-shadow: 0 0 10px rgba(255,215,0,0.2); border-color: rgba(255,215,0,0.3); }

        /* ä¸­çç‰¹æ•ˆï¼šå‘¼å¸æµ®ç©º */
        @keyframes winner-pulse {
            0%, 100% { transform: scale(1.15); box-shadow: 0 0 40px var(--neon-green), inset 0 0 20px var(--neon-green); border-color: #fff; background: var(--neon-green); }
            50% { transform: scale(1.2); box-shadow: 0 0 60px var(--neon-green), inset 0 0 30px #fff; background: #fff; }
        }
        .track-item.winner-anim { animation: winner-pulse 1s infinite; z-index: 20; }

        /* åˆ—è»Šç‹‚æš´ç‰¹æ•ˆ */
        .track-item.train-active {
            background: var(--neon-red); border-color: #fff;
            box-shadow: 0 0 50px var(--neon-red), inset 0 0 25px var(--neon-red);
            transform: scale(1.2); z-index: 15;
        }
        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(-3px, 3px); }
            50% { transform: translate(3px, -3px); }
            75% { transform: translate(-3px, -3px); }
        }
        .shake-screen { animation: shake 0.25s infinite; }

        /* --- ä¸­å¤®é¡¯ç¤ºå¹• --- */
        .center-display {
            position: absolute; top: 96px; left: 96px; width: 456px; height: 456px;
            background: radial-gradient(circle at center, #11141d 0%, #050608 100%);
            border: 2px solid #2a2d35; border-radius: 20px;
            box-shadow: inset 0 0 50px #000, 0 0 25px rgba(0,0,0,0.6);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 5;
        }

        #center-logo {
            font-size: 52px; font-weight: 900; letter-spacing: 12px;
            background: linear-gradient(180deg, #fff, #6b7280); -webkit-background-clip: text; color: transparent;
            text-shadow: 0 10px 20px rgba(0,0,0,0.8);
        }

        /* --- æ¯”å€ UI (Double Up) --- */
        #double-up-ui { display: none; flex-direction: column; align-items: center; width: 100%; padding: 20px; box-sizing: border-box; }
        .du-header { color: var(--gold-primary); font-size: 24px; font-weight: bold; letter-spacing: 5px; text-shadow: 0 0 15px var(--gold-primary); margin-bottom: 15px; }

        .du-pool-container {
            display: flex; justify-content: space-between; width: 90%; margin-bottom: 20px;
            background: rgba(0,0,0,0.6); border-radius: 12px; padding: 15px 25px; border: 1px solid #333;
        }
        .du-pool-box { text-align: center; }
        .du-pool-label { font-size: 13px; color: #8892b0; margin-bottom: 5px;}
        .du-pool-val { font-size: 30px; font-weight: bold; font-family: 'Courier New', Courier, monospace; }
        #du-total-win { color: var(--neon-green); text-shadow: 0 0 15px var(--neon-green); }
        #du-current-bet { color: var(--neon-blue); text-shadow: 0 0 15px var(--neon-blue); }

        .du-controls { display: flex; gap: 12px; margin-bottom: 20px; }
        .du-adjust-btn {
            background: #1a1c23; border: 1px solid #444; color: #fff; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .du-adjust-btn:hover:not(:disabled) { background: var(--neon-blue); color: #000; border-color: var(--neon-blue); box-shadow: 0 0 15px var(--neon-blue);}
        .du-adjust-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .flash-stage { display: flex; gap: 30px; margin-bottom: 25px; }
        .flash-box {
            width: 110px; height: 110px; border-radius: 20px; background: #0f1115; border: 3px solid #2a2d35;
            display: flex; justify-content: center; align-items: center; font-size: 38px; font-weight: bold; color: #444; transition: 0.1s;
        }
        .flash-box.highlight { background: #fff; color: #000; border-color: var(--gold-primary); box-shadow: 0 0 50px var(--gold-primary), inset 0 0 20px var(--gold-primary); transform: scale(1.1); }
        .flash-box.winner { background: var(--neon-green); color: #000; border-color: #fff; box-shadow: 0 0 60px var(--neon-green); transform: scale(1.15); }
        .flash-box.loser { background: var(--neon-red); color: #fff; border-color: #fff; box-shadow: 0 0 60px var(--neon-red); }

        .du-action-buttons { display: flex; gap: 20px; width: 95%; }
        .btn-guess {
            flex: 1; padding: 15px 0; font-size: 22px; font-weight: 900; background: #000; border: 2px solid var(--neon-blue); color: var(--neon-blue);
            border-radius: 12px; cursor: pointer; transition: 0.2s; letter-spacing: 3px;
        }
        .btn-guess:hover:not(:disabled) { background: var(--neon-blue); color: #000; box-shadow: 0 0 25px var(--neon-blue); }
        .btn-take {
            flex: 1; background: linear-gradient(180deg, var(--gold-primary), var(--gold-dark)); border: none; color: #000; font-weight: 900; font-size: 22px;
            border-radius: 12px; cursor: pointer; box-shadow: 0 0 20px rgba(255,215,0,0.5); transition: 0.2s; letter-spacing: 2px;
        }
        .btn-take:hover:not(:disabled) { filter: brightness(1.2); box-shadow: 0 0 35px rgba(255,215,0,0.8); }

        /* --- æŠ¼æ³¨å€ (é«˜è³ªæ„Ÿç»ç’ƒæ“¬æ…‹) --- */
        .bet-panel { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .bet-card {
            background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 15px;
            backdrop-filter: blur(10px); display: flex; flex-direction: column; align-items: center; transition: 0.2s; box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }
        .bet-header { display: flex; justify-content: space-between; width: 100%; margin-bottom: 8px; }
        .bet-odds { font-size: 12px; color: var(--gold-primary); font-weight: bold; background: rgba(255,215,0,0.1); padding: 3px 8px; border-radius: 6px; }
        .bet-icon { font-size: 38px; margin: 5px 0; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.8));}
        
        .bet-stepper { display: flex; align-items: center; justify-content: space-between; width: 100%; background: rgba(0,0,0,0.6); border-radius: 10px; padding: 4px; border: 1px solid #333;}
        .btn-step { background: transparent; border: none; color: #8892b0; font-size: 20px; font-weight: bold; width: 35px; height: 35px; cursor: pointer; transition: 0.2s; border-radius: 8px; }
        .btn-step:hover:not(:disabled) { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-step:disabled { opacity: 0.3; cursor: not-allowed; }
        .bet-val { font-size: 22px; font-weight: bold; color: #fff; font-family: 'Courier New', Courier, monospace;}

        /* --- ä¸»æ§åˆ¶æŒ‰éˆ• --- */
        .master-controls { display: flex; gap: 25px; }
        .btn-master {
            flex: 1; padding: 20px; font-size: 24px; font-weight: 900; border-radius: 15px; cursor: pointer; border: none;
            letter-spacing: 5px; text-transform: uppercase; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn-master:active:not(:disabled) { transform: scale(0.96); }
        .btn-master:disabled { filter: grayscale(1); opacity: 0.4; cursor: not-allowed; }
        
        .btn-clear { background: #2a2d35; color: #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.5); }
        .btn-clear:hover:not(:disabled) { background: #3a3f4a; box-shadow: 0 8px 25px rgba(255,255,255,0.1); }
        
        .btn-start {
            background: linear-gradient(135deg, var(--gold-primary), #ff8c00); color: #000;
            box-shadow: 0 12px 25px rgba(255, 215, 0, 0.4), inset 0 -4px 0 rgba(0,0,0,0.2);
        }
        .btn-start:hover:not(:disabled) { box-shadow: 0 15px 40px rgba(255, 215, 0, 0.6), inset 0 -4px 0 rgba(0,0,0,0.2); filter: brightness(1.15); }

    </style>
</head>
<body>

<div class="machine-wrapper" id="machine">
    <div class="scoreboard">
        <div class="score-box">
            <div class="score-label">CREDITS</div>
            <div class="score-value" id="credits">10000</div>
        </div>
        <div class="info-msg" id="msg-board">è«‹è¨­å®šæŠ¼æ³¨</div>
        <div class="score-box">
            <div class="score-label">TOTAL BET</div>
            <div class="score-value" id="total-bet-display" style="color: #fff; text-shadow: 0 0 10px #fff;">0</div>
        </div>
    </div>

    <div class="track-grid" id="track-container">
        <div class="center-display">
            <div id="center-logo">ROYAL MARIO</div>
            <div id="double-up-ui">
                <div class="du-header">â—† æ¯”å€æ¨¡å¼ â—†</div>
                <div class="du-pool-container">
                    <div class="du-pool-box">
                        <div class="du-pool-label">ç¸½çé‡‘æ± </div>
                        <div class="du-pool-val" id="du-total-win">0</div>
                    </div>
                    <div class="du-pool-box">
                        <div class="du-pool-label">æœ¬æ¬¡ä¸‹æ³¨</div>
                        <div class="du-pool-val" id="du-current-bet">0</div>
                    </div>
                </div>
                <div class="du-controls">
                    <button class="du-adjust-btn" onclick="adjustDUBet('min')">MIN</button>
                    <button class="du-adjust-btn" onclick="adjustDUBet(-100)">-100</button>
                    <button class="du-adjust-btn" onclick="adjustDUBet(100)">+100</button>
                    <button class="du-adjust-btn" onclick="adjustDUBet('max')">MAX</button>
                </div>
                <div class="flash-stage">
                    <div class="flash-box" id="flash-left">â—€ å·¦</div>
                    <div class="flash-box" id="flash-right">å³ â–¶</div>
                </div>
                <div class="du-action-buttons">
                    <button class="btn-guess du-btn" onclick="triggerDoubleUp('left')">æŠ¼ å·¦</button>
                    <button class="btn-take du-btn" onclick="takeScore()">æ”¶ åˆ†</button>
                    <button class="btn-guess du-btn" onclick="triggerDoubleUp('right')">æŠ¼ å³</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bet-panel" id="bet-container"></div>

    <div class="master-controls">
        <button class="btn-master btn-clear" onclick="clearBets()" id="btn-clear">æ¸…é™¤æŠ¼æ³¨</button>
        <button class="btn-master btn-start" onclick="startGame()" id="btn-start">é–‹å§‹è½‰å‹• (SPIN)</button>
    </div>
</div>

<script>
    const SYMBOLS = {
        'apple': { icon: 'ğŸ', odds: 5, name: 'è˜‹æœ' },
        'orange': { icon: 'ğŸŠ', odds: 10, name: 'æ©˜å­' },
        'papaya': { icon: 'ğŸ¥­', odds: 15, name: 'èŠ’æœ' },
        'bell': { icon: 'ğŸ””', odds: 20, name: 'éŠ…é˜' },
        'watermelon': { icon: 'ğŸ‰', odds: 20, name: 'è¥¿ç“œ' },
        'star': { icon: 'â­', odds: 30, name: 'æ˜Ÿæ˜Ÿ' },
        '77': { icon: 'ğŸ°', odds: 40, name: '77' },
        'bar': { icon: 'ğŸ’', odds: 50, name: 'BAR' },
        'train': { icon: 'ğŸš‚', odds: 0, name: 'åˆ—è»Š' }
    };

    const TRACK_LAYOUT = [
        'apple', 'orange', 'apple', 'bell', 'watermelon', 'star', '77',      
        'apple', 'papaya', 'orange', 'bell', 'apple',                        
        'bar', 'train', 'watermelon', 'papaya', 'apple', 'orange', 'bell',   
        'apple', 'star', 'watermelon', 'papaya', 'orange'                    
    ];

    let credits = 10000;
    let totalBet = 0;  // æŠ¼æ³¨é™£åˆ—çš„ç¸½é¡ (å°šæœªæ‰£æ¬¾)
    let winAmount = 0;
    let duBet = 0;
    let bets = { apple: 0, orange: 0, papaya: 0, bell: 0, watermelon: 0, star: 0, '77': 0, bar: 0 };
    let currentPos = 0;
    let isSpinning = false;
    let isDoubleUpMode = false;
    let isFlashing = false;

    // --- å®‰å…¨çš„éŠ€è¡Œç´šéš¨æ©Ÿæ•¸ç”Ÿæˆå™¨ (è§£æ±ºå·¦å³æ©Ÿç‡åå·®) ---
    function getSecureRandom() {
        if (window.crypto && window.crypto.getRandomValues) {
            let array = new Uint32Array(1);
            window.crypto.getRandomValues(array);
            return array[0] % 2 === 0 ? 'left' : 'right';
        }
        return Math.random() < 0.5 ? 'left' : 'right';
    }

    function initLayout() {
        const trackContainer = document.getElementById('track-container');
        document.querySelectorAll('.track-item').forEach(el => el.remove());
        
        TRACK_LAYOUT.forEach((symbolKey, index) => {
            let row = index <= 6 ? 1 : index <= 11 ? index - 5 : index <= 18 ? 7 : 25 - index;
            let col = index <= 6 ? index + 1 : index <= 11 ? 7 : index <= 18 ? 19 - index : 1;
            const div = document.createElement('div');
            div.className = 'track-item'; div.id = `track-${index}`;
            div.style.gridRow = row; div.style.gridColumn = col;
            div.innerHTML = SYMBOLS[symbolKey].icon;
            trackContainer.appendChild(div);
        });

        const betContainer = document.getElementById('bet-container');
        betContainer.innerHTML = '';
        Object.keys(bets).forEach(key => {
            const card = document.createElement('div');
            card.className = 'bet-card';
            card.innerHTML = `
                <div class="bet-header"><span class="bet-odds">x${SYMBOLS[key].odds}</span></div>
                <div class="bet-icon">${SYMBOLS[key].icon}</div>
                <div class="bet-stepper">
                    <button class="btn-step" onclick="changeBet('${key}', -10)">-</button>
                    <span class="bet-val" id="bet-${key}">0</span>
                    <button class="btn-step" onclick="changeBet('${key}', 10)">+</button>
                </div>
            `;
            betContainer.appendChild(card);
        });

        updateUI();
        highlightPos(currentPos);
    }

    function updateUI() {
        document.getElementById('credits').innerText = credits;
        document.getElementById('total-bet-display').innerText = totalBet;
        document.getElementById('du-total-win').innerText = winAmount;
        document.getElementById('du-current-bet').innerText = duBet;
        Object.keys(bets).forEach(key => { document.getElementById(`bet-${key}`).innerText = bets[key]; });
    }

    function showMessage(msg, color = '#fff') {
        const board = document.getElementById('msg-board');
        board.innerText = msg; board.style.color = color; board.style.textShadow = `0 0 15px ${color}`;
    }

    // --- ä¿®æ­£ BUG 1: æŠ¼æ³¨é‚è¼¯é‡æ§‹ (åªèª¿æ•´é™£åˆ—ï¼ŒSPINæ‰æ‰£æ¬¾) ---
    function changeBet(key, amount) {
        if (isSpinning || isDoubleUpMode) return;
        if (amount < 0 && bets[key] < Math.abs(amount)) return; // ä¸èƒ½ä½æ–¼0
        
        let newTotal = totalBet + amount;
        if (amount > 0 && credits < newTotal) {
            showMessage('é¤˜é¡ä¸è¶³', 'var(--neon-red)');
            return;
        }

        bets[key] += amount;
        totalBet = newTotal;
        updateUI();
    }

    function clearBets() {
        if (isSpinning || isDoubleUpMode || totalBet === 0) return;
        totalBet = 0;
        Object.keys(bets).forEach(k => bets[k] = 0);
        updateUI();
        showMessage('å·²æ¸…é™¤æŠ¼æ³¨', '#8892b0');
    }

    function highlightPos(pos, type = 'active') {
        document.querySelectorAll('.track-item').forEach(el => el.className = 'track-item');
        const currentEl = document.getElementById(`track-${pos}`);
        
        if (type === 'train') {
            currentEl.classList.add('train-active');
        } else if (type === 'winner') {
            currentEl.classList.add('winner-anim');
        } else {
            currentEl.classList.add('active');
            document.getElementById(`track-${(pos - 1 + 24) % 24}`).classList.add('trail-1');
            document.getElementById(`track-${(pos - 2 + 24) % 24}`).classList.add('trail-2');
        }
    }

    // --- æ ¸å¿ƒè½‰å‹•é‚è¼¯ ---
    function startGame() {
        if (isDoubleUpMode) takeScore();

        if (totalBet === 0) {
            showMessage('è«‹å…ˆè¨­å®šæŠ¼æ³¨', 'var(--neon-red)'); return;
        }
        if (credits < totalBet) {
            showMessage('é¤˜é¡ä¸è¶³ä»¥æ”¯ä»˜è½‰å‹•', 'var(--neon-red)'); return;
        }

        // æ­£å¼æ‰£é™¤æŠ¼æ³¨é¡ï¼(è§£æ±ºç¬¬äºŒè¼ªå¡ä½èˆ‡å…è²»è½‰ BUG)
        credits -= totalBet;
        updateUI();

        isSpinning = true;
        setMasterButtons(true);
        showMessage('GOOD LUCK!', 'var(--gold-primary)');

        const targetResult = Math.floor(Math.random() * 24);
        const totalSteps = 24 * 3 + ((targetResult - currentPos + 24) % 24);
        let currentStep = 0;

        function stepAnimation() {
            currentStep++; currentPos = (currentPos + 1) % 24;
            highlightPos(currentPos);

            if (currentStep < totalSteps) {
                let delay = 15 + Math.pow(currentStep / totalSteps, 4) * 400; 
                setTimeout(stepAnimation, delay);
            } else {
                handleResult(currentPos);
            }
        }
        stepAnimation();
    }

    function handleResult(stopPos) {
        const symbolKey = TRACK_LAYOUT[stopPos];
        if (symbolKey === 'train') {
            showMessage('ğŸš‚ ç‹‚æš´åˆ—è»Šè§¸ç™¼ï¼', 'var(--neon-red)');
            document.getElementById('machine').classList.add('shake-screen');
            triggerTrainAnimation(stopPos);
        } else {
            calculateWin([stopPos]);
        }
    }

    function triggerTrainAnimation(startPos) {
        const trainLength = 5; let trainPositions = [];
        for(let i = 0; i < trainLength; i++) trainPositions.push((startPos + i + 1) % 24); 

        let step = 0;
        let interval = setInterval(() => {
            if (step < trainPositions.length) {
                document.getElementById(`track-${trainPositions[step]}`).classList.add('train-active');
                step++;
            } else {
                clearInterval(interval);
                document.getElementById('machine').classList.remove('shake-screen');
                calculateWin(trainPositions);
            }
        }, 300);
    }

    function calculateWin(winningPositions) {
        winAmount = 0;
        winningPositions.forEach(pos => {
            const sym = TRACK_LAYOUT[pos];
            if (sym !== 'train' && bets[sym] > 0) {
                winAmount += bets[sym] * SYMBOLS[sym].odds;
                highlightPos(pos, 'winner'); // è§¸ç™¼ä¸­çå¿ƒè·³æµ®ç©ºç‰¹æ•ˆ
            }
        });

        if (winAmount > 0) {
            showMessage(`WIN $${winAmount}ï¼é€²å…¥æ¯”å€`, 'var(--neon-green)');
            setTimeout(enterDoubleUpMode, 1000); // å»¶é²ä¸€ä¸‹è®“ç©å®¶çœ‹æ¸…æ¥šä¸­çç‰¹æ•ˆ
        } else {
            showMessage('æœªä¸­ç', '#8892b0');
            isSpinning = false; setMasterButtons(false);
            // ç³»çµ±è²¼å¿ƒè¨­è¨ˆï¼šä¸æ¸…ç©ºæŠ¼æ³¨ï¼Œç©å®¶å¯ä»¥ç›´æ¥å†æŒ‰ä¸€æ¬¡ SPIN ç¹¼çºŒç©ï¼
        }
    }

    // --- æ¯”å€ç³»çµ± ---
    function enterDoubleUpMode() {
        isDoubleUpMode = true; duBet = winAmount;
        document.getElementById('center-logo').style.display = 'none';
        document.getElementById('double-up-ui').style.display = 'flex';
        resetFlashBoxes(); updateUI(); setMasterButtons(true);
    }

    function exitDoubleUpMode() {
        isDoubleUpMode = false;
        document.getElementById('center-logo').style.display = 'block';
        document.getElementById('double-up-ui').style.display = 'none';
        isSpinning = false; setMasterButtons(false);
        // å›åˆ°ä¸»ç•«é¢æ™‚ï¼Œæ¸…é™¤ç›¤é¢ä¸Šçš„ä¸­çç‰¹æ•ˆ
        document.querySelectorAll('.track-item').forEach(el => el.classList.remove('winner-anim', 'train-active'));
        highlightPos(currentPos); 
        updateUI();
    }

    function adjustDUBet(val) {
        if (isFlashing) return;
        if (val === 'max') duBet = winAmount;
        else if (val === 'min') duBet = 10;
        else duBet += val;

        if (duBet > winAmount) duBet = winAmount;
        if (duBet < 10 && winAmount >= 10) duBet = 10;
        if (winAmount === 0) duBet = 0;
        updateUI();
    }

    // --- ä¿®æ­£ BUG 2: å®Œç¾çš„ç„¡åå·®é–ƒç‡ˆå‹•ç•« ---
    function triggerDoubleUp(userChoice) {
        if (!isDoubleUpMode || isFlashing || duBet <= 0 || duBet > winAmount) return;

        isFlashing = true; setDUButtons(true); resetFlashBoxes();
        winAmount -= duBet; updateUI();
        showMessage('é–‹çä¸­...', 'var(--gold-primary)');

        const boxLeft = document.getElementById('flash-left');
        const boxRight = document.getElementById('flash-right');
        
        const finalResult = getSecureRandom(); // éŠ€è¡Œç´šçµ•å° 50/50 äº‚æ•¸
        let flashCount = 0;
        let speed = 40;
        let currentTarget = 'left';

        function flashStep() {
            currentTarget = currentTarget === 'left' ? 'right' : 'left';
            boxLeft.classList.toggle('highlight', currentTarget === 'left');
            boxRight.classList.toggle('highlight', currentTarget === 'right');
            
            flashCount++; speed += 15; // ç‰©ç†æ¸›é€Ÿæ„Ÿ

            if (speed < 350) {
                setTimeout(flashStep, speed);
            } else {
                // å¼·åˆ¶å°‡æœ€å¾Œä¸€æ ¼å®Œç¾å®šæ ¼åœ¨ finalResult ä¸Šï¼Œä¸ç”¢ç”Ÿè¦–è¦ºçªè·³
                boxLeft.classList.toggle('highlight', finalResult === 'left');
                boxRight.classList.toggle('highlight', finalResult === 'right');
                
                setTimeout(() => {
                    if (userChoice === finalResult) {
                        (finalResult === 'left' ? boxLeft : boxRight).classList.add('winner');
                        winAmount += (duBet * 2);
                        showMessage(`çŒœä¸­ï¼è´å¾— $${duBet * 2}`, 'var(--neon-green)');
                    } else {
                        (finalResult === 'left' ? boxLeft : boxRight).classList.add('loser');
                        showMessage(`çŒœéŒ¯ï¼æå¤± $${duBet}`, 'var(--neon-red)');
                    }
                    
                    duBet = winAmount; updateUI();

                    setTimeout(() => {
                        isFlashing = false; resetFlashBoxes();
                        if (winAmount <= 0) {
                            showMessage('çé‡‘æ­¸é›¶', '#8892b0');
                            setTimeout(exitDoubleUpMode, 1000);
                        } else {
                            setDUButtons(false); showMessage('è«‹ç¹¼çºŒæ¯”å€æˆ–æ”¶åˆ†', '#fff');
                        }
                    }, 1500);

                }, 400); // å®šæ ¼å¾Œç¨å¾®åœé “ä¸€ä¸‹å†å®£å‘Šçµæœï¼Œå¢åŠ çˆ½åº¦
            }
        }
        flashStep();
    }

    function resetFlashBoxes() {
        document.getElementById('flash-left').className = 'flash-box';
        document.getElementById('flash-right').className = 'flash-box';
    }

    function takeScore() {
        if (isFlashing) return;
        if (winAmount > 0) {
            credits += winAmount;
            showMessage(`æˆåŠŸå…¥è¢‹ $${winAmount}`, 'var(--gold-primary)');
            winAmount = 0; updateUI();
        }
        exitDoubleUpMode();
    }

    function setMasterButtons(disabled) {
        document.getElementById('btn-start').disabled = disabled;
        document.getElementById('btn-clear').disabled = disabled;
        document.querySelectorAll('.btn-step').forEach(btn => btn.disabled = disabled);
    }

    function setDUButtons(disabled) {
        document.querySelectorAll('.du-btn').forEach(btn => btn.disabled = disabled);
        document.querySelectorAll('.du-adjust-btn').forEach(btn => btn.disabled = disabled);
    }

    initLayout();
</script>
</body>
</html>
