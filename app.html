const auth=firebase.auth();
const db=firebase.database();

let me=null,myData=null;
let sendLock=false;

msg.addEventListener("keydown",e=>{if(e.key==="Enter")send()});

// å¼·åˆ¶ reload
db.ref("system/reload").on("value",s=>{
if(s.val()) location.reload();
});

// ===== ç™»å…¥ =====
auth.onAuthStateChanged(async user=>{
if(!user) location.href="login.html";
me=user;

const ref=db.ref("users/"+user.uid);
let snap=await ref.once("value");

if(!snap.exists()){
let name=prompt("è«‹è¼¸å…¥æš±ç¨±");
if(!name) name="è¨ªå®¢";

await ref.set({
name:name,
role:"user",
mute:false,
online:false
});
}

// Presence
db.ref(".info/connected").on("value",s=>{
if(s.val()){
ref.child("online").set(true);
ref.child("online").onDisconnect().set(false);
}
});

// å³æ™‚åŒæ­¥è‡ªå·±è³‡æ–™
ref.on("value",s=>{
myData=s.val();
if(myData.role==="admin"){
document.getElementById("adminPanel").style.display="block";
}
});

loadUsers();
loadChat();
});

// ===== åœ¨ç·šåå–® =====
function loadUsers(){
db.ref("users").on("value",snap=>{
userList.innerHTML="";
snap.forEach(s=>{
const u=s.val();
const uid=s.key;

const div=document.createElement("div");
div.className="user "+(u.online?"online":"offline");
div.textContent=u.name+(u.mute?" ğŸ”‡":"");

if(myData?.role==="admin"){
div.onclick=()=>adminMenu(uid,u);
}

userList.appendChild(div);
});
});
}

// ===== ç®¡ç†å“¡æ“ä½œ =====
function adminMenu(uid,u){
let a=prompt("1 æ”¹å\n2 ç¦è¨€/è§£é™¤");

if(a==="1"){
let n=prompt("æ–°åå­—",u.name);
if(n) db.ref("users/"+uid+"/name").set(n);
}
if(a==="2"){
db.ref("users/"+uid+"/mute").set(!u.mute);
}
}

// ===== èŠå¤© =====
function loadChat(){

// â­ ç›£è½æ•´å€‹ chat ç¯€é»ï¼ˆä¿®æ¸…ç©º bugï¼‰
db.ref("chat").on("value",snap=>{
chat.innerHTML="";
snap.forEach(s=>{
const m=s.val();
const time=new Date(m.time).toLocaleTimeString();

const div=document.createElement("div");
div.className="msg";
div.textContent=`${m.name} [${time}] : ${m.text}`;

chat.appendChild(div);
});
chat.scrollTop=999999;
});

}

// ===== ç™¼é€ =====
async function send(){

if(sendLock) return;
sendLock=true;
setTimeout(()=>sendLock=false,1000);

if(myData.mute){alert("ä½ è¢«ç¦è¨€");return}
if(msg.value.trim()=="") return;

await db.ref("chat").push({
uid:me.uid,
name:myData.name,
text:msg.value,
time:Date.now()
});

msg.value="";
}

// ===== ç®¡ç†å“¡å·¥å…· =====
function clearChat(){
if(confirm("ç¢ºå®šæ¸…ç©ºèŠå¤©å®¤?")) db.ref("chat").remove();
}

function forceReload(){
db.ref("system/reload").set(Date.now());
}

function logout(){auth.signOut()}
