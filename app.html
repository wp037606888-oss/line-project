<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>æŠ½è¸æ’éšŠç³»çµ±</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{box-sizing:border-box}

body{
margin:0;
font-family:Segoe UI;
background:#0a0b14;
color:white;
display:flex;
height:100vh;
overflow:hidden;
}

/* ç²’å­èƒŒæ™¯ */
canvas{
position:fixed;
inset:0;
pointer-events:none;
z-index:0;
}

/* æ»¾å‹•æ¢ */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-thumb{background:#445;border-radius:6px}

/* å·¦å´ */
#left{
width:640px;
padding:14px;
display:flex;
flex-direction:column;
overflow:auto;
z-index:1;
}

/* ç»ç’ƒå¡ç‰‡ */
.panel{
background:rgba(28,28,42,.6);
backdrop-filter:blur(16px);
border-radius:16px;
padding:14px;
margin-bottom:12px;
border:1px solid rgba(255,255,255,.08);
box-shadow:0 10px 40px rgba(0,0,0,.6);
animation:fadeUp .6s ease;
}

@keyframes fadeUp{
from{opacity:0;transform:translateY(10px)}
to{opacity:1;transform:translateY(0)}
}

h3{margin:0 0 8px;font-size:14px;color:#9ec3ff}

button{
padding:10px 12px;
margin:4px;
border:none;
border-radius:10px;
background:linear-gradient(135deg,#5c7cff,#7d5cff);
color:white;
cursor:pointer;
font-weight:600;
transition:.2s;
}

button:hover{
transform:translateY(-1px);
box-shadow:0 4px 14px rgba(92,124,255,.4);
}

button:disabled{background:#333}

.red{color:#ff5b5b}
#log{height:150px;overflow:auto;font-size:12px}

/* å³å´èŠå¤©å®¤ */
#main{
width:380px;
display:flex;
flex-direction:column;
background:rgba(0,0,0,.35);
backdrop-filter:blur(10px);
z-index:1;
}

header{
padding:14px;
text-align:center;
font-size:16px;
background:rgba(0,0,0,.4);
}

#onlineBar{
display:grid;
grid-template-columns:repeat(2,1fr);
gap:6px;
padding:10px;
background:rgba(0,0,0,.3);
}

.userBox{
padding:6px;
border-radius:8px;
font-size:12px;
text-align:center;
background:#333;
}

.onlineUser{
background:#153f2b;
border:1px solid #00ff88;
}

.offlineUser{
background:#333;
opacity:.5;
}

#chat{
flex:1;
overflow:auto;
padding:10px;
font-size:13px;
}

.msg{
background:#2c355a;
margin:4px 0;
padding:8px;
border-radius:10px;
}

footer{
display:flex;
gap:6px;
padding:10px;
background:rgba(0,0,0,.4);
}

input{
flex:1;
padding:10px;
border:none;
border-radius:10px;
background:#2c355a;
color:white;
}

.hidden{display:none}
</style>
</head>

<body>

<canvas id="bg"></canvas>

<div id="left">

<div class="panel">
<div id="who"></div>
<div id="clock"></div>
<div id="slotInfo"></div>
<div id="status"></div>
</div>

<div class="panel">
<h3>ğŸš¬ æ’éšŠ</h3>
<div id="queue"></div>
<button id="bReserve" onclick="reserve()">é ç´„</button>
<button id="bCancel" onclick="cancelReserve()">å–æ¶ˆ</button>
<button id="bOut" onclick="goOut()">å‡ºå»</button>
<button id="bBack" onclick="comeBack()">å›ä¾†</button>

<h3>ğŸš¶ æ­£åœ¨å¤–é¢</h3>
<div id="outList"></div>

<h3>ğŸ“Š æœ¬æ™‚æ®µç´€éŒ„</h3>
<div id="history"></div>
</div>

<div class="panel">
<h3>ğŸ“œ æ—¥èªŒ</h3>
<div id="log"></div>
</div>

<div id="adminPanel" class="panel hidden">
<h3>ğŸ‘‘ ç®¡ç†å“¡</h3>
<button onclick="forceReload()">å…¨é«”åˆ·æ–°</button>
<button onclick="clearChat()">æ¸…ç©ºèŠå¤©å®¤</button>
<button onclick="clearLog()">æ¸…ç©ºæ—¥èªŒ</button>
<button onclick="resetQueue()">é‡ç½®æ’éšŠ</button>
</div>

</div>

<div id="main">
<header>èŠå¤©å®¤</header>
<div id="onlineBar"></div>
<div id="chat"></div>

<footer>
<input id="msg">
<button onclick="send()">é€å‡º</button>
<button onclick="logout()">ç™»å‡º</button>
</footer>
</div>

<script>

/* ç²’å­èƒŒæ™¯ */
const canvas=document.getElementById("bg");
const ctx=canvas.getContext("2d");
let w,h;
function resize(){w=canvas.width=innerWidth;h=canvas.height=innerHeight}
onresize=resize;resize();

const P=70;
const particles=[];
for(let i=0;i<P;i++){
particles.push({
x:Math.random()*w,
y:Math.random()*h,
vx:(Math.random()-.5)*.5,
vy:(Math.random()-.5)*.5
});
}

function draw(){
ctx.clearRect(0,0,w,h);
for(let i=0;i<P;i++){
const a=particles[i];
a.x+=a.vx;a.y+=a.vy;
if(a.x<0||a.x>w)a.vx*=-1;
if(a.y<0||a.y>h)a.vy*=-1;

ctx.fillStyle="#7d8cff";
ctx.beginPath();
ctx.arc(a.x,a.y,1.5,0,6.28);
ctx.fill();

for(let j=i+1;j<P;j++){
const b=particles[j];
const dx=a.x-b.x;
const dy=a.y-b.y;
const d=Math.sqrt(dx*dx+dy*dy);
if(d<120){
ctx.strokeStyle="rgba(125,140,255,"+(1-d/120)+")";
ctx.lineWidth=.5;
ctx.beginPath();
ctx.moveTo(a.x,a.y);
ctx.lineTo(b.x,b.y);
ctx.stroke();
}
}
}
requestAnimationFrame(draw);
}
draw();

</script>
<!-- âš ï¸ ä¸‹é¢ä½ çš„åŸ JS å¼•æ“å®Œæ•´ä¿ç•™ï¼ˆæˆ‘æ²’æ”¹ä»»ä½•åŠŸèƒ½ï¼‰ -->
<script>

const config={
apiKey:"AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",
authDomain:"smoke-queue.firebaseapp.com",
databaseURL:"https://smoke-queue-default-rtdb.firebaseio.com",
projectId:"smoke-queue"
};
firebase.initializeApp(config);

const db=firebase.database();
const auth=firebase.auth();
const queueRef=db.ref("queue");
const logRef=db.ref("log");

let me,myData,engineReady=false;
let cacheQueue={};

const LIMIT=600;

queueRef.on("value",snap=>{
cacheQueue=snap.val()||{};
});

//////////////// åœ¨ç·š //////////////////

db.ref("users").on("value",snap=>{
onlineBar.innerHTML="";
snap.forEach(s=>{
let u=s.val();
let div=document.createElement("div");
div.className="userBox "+(u.online?"onlineUser":"offlineUser");
div.textContent=u.name;
onlineBar.appendChild(div);
});
});

//////////////// æ—¥èªŒ //////////////////

function addLog(t){
logRef.push({text:t,time:Date.now()});
}

logRef.limitToLast(100).on("value",snap=>{
log.innerHTML="";
snap.forEach(s=>{
let l=s.val();
let d=document.createElement("div");
d.textContent=`[${new Date(l.time).toLocaleTimeString()}] ${l.text}`;
log.appendChild(d);
});
log.scrollTop=99999;
});

//////////////// ç™»å…¥ //////////////////

auth.onAuthStateChanged(async user=>{
if(!user){location.href="login.html";return;}

me=user;
const ref=db.ref("users/"+user.uid);

let snap=await ref.once("value");
if(!snap.exists()){
let name=prompt("æš±ç¨±");
await ref.set({name:name||"è¨ªå®¢",role:"user"});
}

ref.on("value",s=>{
myData=s.val();
who.textContent="ç›®å‰ç™»å…¥ï¼š"+myData.name;

if(myData.role==="admin")
adminPanel.classList.remove("hidden");

addLog("ğŸŸ¢ "+myData.name+" ç™»å…¥");
engineReady=true;
});

ref.child("online").set(true);
ref.child("online").onDisconnect().set(false);
});

function logout(){
addLog("ğŸ”´ "+myData.name+" ç™»å‡º");
auth.signOut().then(()=>location.href="login.html");
}

//////////////// ç®¡ç†å“¡ //////////////////

function clearChat(){db.ref("chat").remove();addLog("ç®¡ç†å“¡æ¸…ç©ºèŠå¤©å®¤");}
function clearLog(){logRef.remove();}
function resetQueue(){queueRef.remove();addLog("ç®¡ç†å“¡é‡ç½®æ’éšŠ");}

//////////////// å·¥å…· //////////////////

function format(sec){
let m=Math.floor(sec/60);
let s=sec%60;
return `${m}:${s.toString().padStart(2,"0")}`;
}

function getSlot(h){
const slots=[14,16,18,20,22,24];
if(h===0) return 24;
for(let s of slots) if(h<=s) return s;
return 14;
}

//////////////// å¼•æ“ //////////////////

function tick(){
if(!engineReady) return;

let now=new Date();
let h=now.getHours();
let m=now.getMinutes();
let s=now.getSeconds();

clock.textContent=`ç¾åœ¨æ™‚é–“ï¼š${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;

let slot=getSlot(h);
slotInfo.textContent=`æ™‚æ®µï¼š${slot}:00â€“${slot}:59`;

updateState(slot,h);
}
setInterval(tick,1000);

function updateState(slot,h){

let d=cacheQueue;
let r=d.reserve||{};
let o=d.out||{};
let hist=d.history||{};
let used=d.used||{};

let state="none";

if(o[me.uid]) state="out";
else if(r[me.uid]) state="reserved";

let alreadyUsed=used[slot]?.[me.uid];
let canGo=(h==slot || (slot==24 && h==0));

status.textContent=
alreadyUsed?"æœ¬æ™‚æ®µå·²æŠ½":
state=="out"?"å¤–å‡ºä¸­":
state=="reserved"?(canGo?"å¯å‡ºå»":"å·²é ç´„"):
"æœªé ç´„";

bReserve.disabled=state!="none" || alreadyUsed;
bCancel.disabled=state!="reserved";
bOut.disabled=!(state=="reserved"&&canGo);
bBack.disabled=state!="out";

renderQueue(r);
renderOut(o,slot);
renderHistory(hist,slot);
}

function renderQueue(r){
queue.innerHTML="";
Object.entries(r).sort((a,b)=>a[1].time-b[1].time)
.forEach((u,i)=>{
let d=document.createElement("div");
d.textContent=`${i+1}. ${u[1].name} (${u[1].slot}é»)`;
queue.appendChild(d);
});
}

function renderOut(out,slot){
outList.innerHTML="";
let now=Date.now();
Object.entries(out).forEach(([uid,u])=>{
let sec=Math.floor((now-u.time)/1000);
let div=document.createElement("div");
div.textContent=`${u.name} å¤–å‡º ${format(sec)}`;
outList.appendChild(div);
});
}

function renderHistory(hist,slot){

history.innerHTML="";

Object.values(hist||{})
.filter(h=>h.slot===slot)
.sort((a,b)=>b.time-a.time)
.slice(0,30)
.forEach(h=>{

let div=document.createElement("div");

let status=h.over
?` <span class="red">è¶…é10åˆ†é˜</span>`
:` <span style="color:#00ff88">æ­£å¸¸</span>`;

div.innerHTML=
`${h.name} ï½œ ${format(h.duration)} ï½œ ${status}`;

history.appendChild(div);

});
}


//////////////// ä¿®æ­£å¾Œæ’éšŠï¼ˆæ ¸å¿ƒä¿®å¾©ï¼‰ //////////////////

function refreshCache(){
return queueRef.once("value").then(s=>cacheQueue=s.val()||{});
}

function reserve(){
let slot=getSlot(new Date().getHours());
queueRef.child("reserve/"+me.uid)
.set({name:myData.name,time:Date.now(),slot})
.then(refreshCache);

addLog(myData.name+" é ç´„ "+slot+"é»");
}

function cancelReserve(){
queueRef.child("reserve/"+me.uid)
.remove()
.then(refreshCache);

addLog(myData.name+" å–æ¶ˆé ç´„");
}

function goOut(){
queueRef.child("out/"+me.uid)
.set({name:myData.name,time:Date.now()})
.then(()=>{
queueRef.child("reserve/"+me.uid).remove();
return refreshCache();
});

addLog(myData.name+" å‡ºå»");
}

function comeBack(){

queueRef.child("out/"+me.uid).once("value").then(s=>{
let u=s.val();
if(!u) return;

let sec=Math.floor((Date.now()-u.time)/1000);
let slot=getSlot(new Date().getHours());

queueRef.child(`used/${slot}/${me.uid}`).set(true);

queueRef.child("history").push({
name:u.name,
slot:slot,
duration:sec,
over:sec>600,
outTime:u.time,
backTime:Date.now(),
time:Date.now()
});
});

queueRef.child("out/"+me.uid)
.remove()
.then(refreshCache);

addLog(myData.name+" å›ä¾†");
}


//////////////// èŠå¤© //////////////////

msg.addEventListener("keydown",e=>{
if(e.key==="Enter") send();
});

function send(){
if(!msg.value.trim()) return;
db.ref("chat").push({
name:myData.name,
text:msg.value,
time:Date.now()
});
msg.value="";
}

db.ref("chat").limitToLast(200).on("value",snap=>{
chat.innerHTML="";
snap.forEach(s=>{
let m=s.val();
let d=document.createElement("div");
d.className="msg";
d.textContent=`${m.name}: ${m.text}`;
chat.appendChild(d);
});
chat.scrollTop=99999;
});

//////////////// åˆ·æ–° //////////////////

db.ref("reload").on("value",s=>{
let t=s.val();
if(!t) return;
let h=sessionStorage.getItem("reload");
if(h==t) return;
sessionStorage.setItem("reload",t);
location.reload();
});

function forceReload(){
db.ref("reload").set(Date.now());
setTimeout(()=>db.ref("reload").remove(),3000);
}

</script>
</body>
</html>


