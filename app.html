<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°Šçˆµå¸è¸æ’éšŠç³»çµ± v3.4 Admin</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root {
    --gold: linear-gradient(135deg, #ffd700, #ff8c00);
    --primary: linear-gradient(135deg, #6e8eff, #a277ff);
    --danger: linear-gradient(135deg, #ff5b5b, #ff3e3e);
    --bg-dark: #05060a;
    --panel-bg: rgba(20, 21, 33, 0.85);
    --text-gold: #ffcc00;
}

* { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

body {
    margin: 0;
    font-family: "SF Pro Display", "PingFang TC", "Microsoft JhengHei", sans-serif;
    background: var(--bg-dark);
    color: #e0e0e0;
    display: flex;
    height: 100vh;
    overflow: hidden;
    font-size: 16px;
}

canvas { position: fixed; inset: 0; z-index: 0; filter: blur(8px); opacity: 0.6; }

#left {
    width: 62%;
    padding: 20px 30px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    z-index: 1;
}

#main {
    width: 38%;
    display: flex;
    flex-direction: column;
    background: rgba(0, 0, 0, 0.65);
    backdrop-filter: blur(40px);
    border-left: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 1;
}

.panel {
    background: var(--panel-bg);
    backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 22px;
    margin-bottom: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    animation: slideUp 0.6s ease-out;
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

h3 { 
    margin: 0 0 15px; 
    font-size: 16px; 
    color: var(--text-gold); 
    text-transform: uppercase;
    letter-spacing: 3px;
    display: flex;
    align-items: center;
    gap: 10px;
}

h3::after { content: ""; flex: 1; height: 1px; background: linear-gradient(90deg, rgba(255, 204, 0, 0.3), transparent); }

#clock { font-size: 34px; font-weight: 800; color: #fff; text-shadow: 0 0 15px rgba(110, 142, 255, 0.5); font-family: 'Monaco', monospace; }
#status { font-size: 26px; font-weight: 900; margin: 10px 0; letter-spacing: 1px; }

button {
    padding: 12px 24px;
    border: none;
    border-radius: 14px;
    background: var(--primary);
    color: white;
    cursor: pointer;
    font-weight: 700;
    font-size: 16px;
    box-shadow: 0 8px 20px rgba(110, 142, 255, 0.2);
}
button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(110, 142, 255, 0.4); }
button:disabled { background: #1a1a25; color: #444; cursor: not-allowed; box-shadow: none; }
.btn-danger { background: var(--danger); box-shadow: 0 8px 20px rgba(255, 91, 91, 0.2); }
.btn-outline { background: transparent; border: 1px solid rgba(255,255,255,0.3); box-shadow: none; padding: 6px 12px; font-size: 12px; }
.btn-outline:hover { background: rgba(255,255,255,0.1); }

/* ç®¡ç†å“¡å¼·åˆ¶å¬å›æŒ‰éˆ•æ¨£å¼ */
.btn-mini-danger {
    padding: 4px 10px;
    font-size: 11px;
    background: rgba(255, 62, 62, 0.15);
    border: 1px solid rgba(255, 62, 62, 0.4);
    color: #ff5b5b;
    border-radius: 8px;
    margin-left: 10px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: none;
}
.btn-mini-danger:hover {
    background: #ff3e3e;
    color: white;
    transform: scale(1.05);
}

.item-row {
    padding: 12px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center; /* è®“å…§å®¹å‚ç›´ç½®ä¸­ */
    font-size: 16px;
}

#chat { flex: 1; overflow-y: auto; padding: 20px; }
.msg { background: rgba(255,255,255,0.04); margin-bottom: 12px; padding: 14px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.05); }
footer { padding: 20px; display: flex; gap: 10px; background: rgba(0,0,0,0.4); }
input { flex: 1; background: #0a0b10; border: 1px solid #223; border-radius: 12px; padding: 14px; color: #fff; }

.btn-logout { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 6px 14px; font-size: 12px; border-radius: 10px; color: #888; }
.btn-logout:hover { background: #ff4444; color: #fff; }

#log { font-size: 12px; color: #667; height: 100px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; line-height: 1.6; }
.green { color: #00ffaa; text-shadow: 0 0 10px rgba(0, 255, 170, 0.3); }
.red { color: #ff5555; text-shadow: 0 0 10px rgba(255, 85, 85, 0.3); }

#adminPanel { display: none; border: 1px solid rgba(255, 215, 0, 0.3); box-shadow: 0 0 30px rgba(255, 215, 0, 0.1); }
</style>
</head>

<body>
<canvas id="bg"></canvas>

<div id="left">
    <div class="panel">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span id="who" style="font-weight: 300; color: #aaa;">ç³»çµ±é€£ç·šä¸­...</span>
                    <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
                    <button id="btnNotify" class="btn-outline" onclick="enableNotification()">ğŸ”” å•Ÿç”¨é€šçŸ¥</button>
                </div>
                <div id="clock">12:00:00 PM</div>
            </div>
            <div style="text-align: right;">
                <div id="slotDisplay" style="color: var(--text-gold); font-weight: 800; font-size: 18px;">---</div>
                <div style="font-size: 12px; color: #666; margin-top: 4px;">é™åˆ¶ï¼š3 äºº</div>
            </div>
        </div>
        
        <div id="status">åˆå§‹åŒ–ä¸­...</div>
        
        <div class="btn-group" style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="bReserve" onclick="reserve()">é ç´„æŠ½è¸</button>
            <button id="bCancel" class="btn-danger" onclick="cancelReserve()">å–æ¶ˆé ç´„</button>
            <button id="bOut" onclick="goOut()">ç¾åœ¨å‡ºå»</button>
            <button id="bBack" onclick="comeBack()">æˆ‘å›ä¾†äº†</button>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div class="panel">
            <h3>ğŸš¬ æ’éšŠåå–®</h3>
            <div id="queue" style="max-height: 120px; overflow-y: auto;"></div>
        </div>
        <div class="panel">
            <h3>ğŸš¶ å¤–å‡ºä¸­ (<span id="outCountNum">0</span>/3)</h3>
            <div id="outList" style="max-height: 120px; overflow-y: auto;"></div>
        </div>
    </div>

    <div class="panel">
        <h3>ğŸ“Š æ™‚æ®µç´€éŒ„ (12H)</h3>
        <div id="history" style="max-height: 160px; overflow-y: auto;"></div>
    </div>

    <div class="panel">
        <h3>ğŸ“œ ç³»çµ±æ—¥èªŒ</h3>
        <div id="log"></div>
    </div>

    <div id="adminPanel" class="panel">
        <h3 style="color: #ffd700;">ğŸ‘‘ ç®¡ç†å“¡æ§åˆ¶</h3>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <button onclick="forceReload()" style="font-size:12px; background: #333;">å…¨é«”åˆ·æ–°</button>
            <button onclick="resetQueue()" class="btn-danger" style="font-size:12px;">æ¸…ç©ºæ•¸æ“š</button>
            <button onclick="clearLog()" style="background:#222; font-size:12px; border:1px solid #444;">æ¸…ç©ºæ—¥èªŒ</button>
            <button onclick="clearChat()" style="background:#222; font-size:12px; border:1px solid #444;">æ¸…ç©ºèŠå¤©</button>
        </div>
    </div>
</div>

<div id="main">
    <header style="padding: 25px; text-align: center; font-weight: 900; font-size: 22px; letter-spacing: 8px; color: #fff;">å¸è¸å€ä¼‘æ¯å®¤</header>
    <div id="onlineBar" style="padding: 10px 20px; display: flex; flex-wrap: wrap; gap: 8px; background: rgba(255,255,255,0.02);"></div>
    <div id="chat"></div>
    <footer>
        <input id="msg" placeholder="è¼¸å…¥è¨Šæ¯..." onkeydown="if(event.key==='Enter')send()">
        <button onclick="send()">å‚³é€</button>
    </footer>
</div>

<script>
/* --- Firebase åˆå§‹åŒ– --- */
const config={
    apiKey: "AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",
    authDomain: "smoke-queue.firebaseapp.com",
    databaseURL: "https://smoke-queue-default-rtdb.firebaseio.com",
    projectId: "smoke-queue"
};
firebase.initializeApp(config);
const db=firebase.database(), auth=firebase.auth();
const queueRef=db.ref("queue"), userRef=db.ref("users"), chatRef=db.ref("chat"), logRef=db.ref("log");

let me, myData, engineReady=false, cacheQueue={};
let currentSlotInfo = { phase: '', slot: 0 };

/* --- å…¨é«”åˆ·æ–° --- */
let isFirstReloadCheck = true;
db.ref("reload").on("value", s => {
    if (isFirstReloadCheck) { isFirstReloadCheck = false; return; }
    location.reload();
});
function forceReload() { db.ref("reload").set(Date.now()); }

/* --- è²éŸ³èˆ‡é€šçŸ¥ --- */
let audioCtx = null;
let notifyEnabled = false;
let hasNotifiedReady = false;
let hasNotifiedOvertime = false;

function enableNotification() {
    if (!("Notification" in window)) { alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥"); return; }
    Notification.requestPermission().then(permission => {
        if (permission === "granted") {
            notifyEnabled = true;
            playBeep();
            new Notification("é€šçŸ¥å·²å•Ÿç”¨");
            document.getElementById("btnNotify").style.display = "none";
        }
    });
}

function playBeep(type = 'normal') {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    if (type === 'urgent') { 
        osc.frequency.value = 880; osc.type = 'square'; osc.start();
        setTimeout(() => { osc.stop(); }, 100);
        setTimeout(() => {
            const osc2 = audioCtx.createOscillator();
            const gain2 = audioCtx.createGain();
            osc2.connect(gain2); gain2.connect(audioCtx.destination);
            osc2.frequency.value = 880; osc2.type = 'square'; osc2.start();
            setTimeout(() => { osc2.stop(); }, 100);
        }, 150);
    } else { 
        osc.frequency.value = 523.25; osc.type = 'sine';
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
        osc.start(); osc.stop(audioCtx.currentTime + 0.5);
    }
}

function sendNotify(title, body, urgent = false) {
    if (!notifyEnabled) return;
    playBeep(urgent ? 'urgent' : 'normal');
    new Notification(title, { body: body, icon: 'https://cdn-icons-png.flaticon.com/512/3772/3772422.png' });
}

/* --- å·¥å…·å‡½æ•¸ --- */
function format12H(date) {
    return date.toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function getSlotStatus(h, m) {
    const slots = [14, 16, 18, 20, 22, 0]; 
    let target = slots.find(s => (s === 0 ? 24 : s) > h) || 14;
    let currentSlot = slots.find(s => s === h);
    
    if (currentSlot !== undefined) {
        let displayH = currentSlot === 0 ? 12 : (currentSlot > 12 ? currentSlot - 12 : currentSlot);
        return { phase: 'OUT', slot: currentSlot, display: `${displayH}:00 PM é–‹æ”¾ä¸­` };
    }
    
    let nextSlot = target;
    let diff = (nextSlot === 0 ? 24 : nextSlot) * 60 - (h * 60 + m);
    if (diff > 0 && diff <= 30) {
        let nextH = nextSlot === 0 ? 12 : (nextSlot > 12 ? nextSlot - 12 : nextSlot);
        return { phase: 'RESERVE', slot: nextSlot, display: `é ç´„ä¸­: ${nextH}:00` };
    }

    let nextReserveH = nextSlot === 14 ? 13 : (nextSlot === 0 ? 23 : nextSlot - 1);
    return { phase: 'BREAK', nextSlot, display: 'ä¼‘æ¯ä¸­', hint: `è«‹æ–¼ ${nextReserveH > 12 ? nextReserveH - 12 : nextReserveH}:30 ${nextReserveH >= 12 ? 'PM' : 'AM'} é ç´„` };
}

/* --- æ ¸å¿ƒé‚è¼¯ --- */
setInterval(() => {
    if(!engineReady) return;
    const now = new Date();
    const h = now.getHours(), m = now.getMinutes();
    document.getElementById("clock").textContent = format12H(now);

    currentSlotInfo = getSlotStatus(h, m);
    document.getElementById("slotDisplay").textContent = currentSlotInfo.display;

    if(h === 1 && m === 0 && now.getSeconds() === 0 && myData.role === "admin") resetQueue();

    updateButtonStates();
    updateOutListTimer();
    checkNotifications();
}, 1000);

queueRef.on("value", s => { 
    cacheQueue = s.val() || {}; 
    if(engineReady) {
        renderStaticLists();
        updateButtonStates();
    }
});

function checkNotifications() {
    if(!me || !cacheQueue) return;
    let r = cacheQueue.reserve || {}, o = cacheQueue.out || {};
    let sortedQueue = Object.entries(r).sort((a,b)=>a[1].time - b[1].time);
    let outCount = Object.keys(o).length;
    let isFirst = sortedQueue.length > 0 && sortedQueue[0][0] === me.uid;

    if (currentSlotInfo.phase === 'OUT' && isFirst && outCount < 3) {
        if (!hasNotifiedReady) { sendNotify("è¼ªåˆ°ä½ äº†ï¼", "æœ‰åé¡äº†ï¼Œç¾åœ¨å¯ä»¥å‡ºå»æŠ½è¸ã€‚"); hasNotifiedReady = true; }
    } else {
        hasNotifiedReady = false;
    }

    if (o[me.uid]) {
        let sec = Math.floor((Date.now() - o[me.uid].time) / 1000);
        if (sec > 600 && !hasNotifiedOvertime) { sendNotify("æ™‚é–“åˆ°å›‰ï¼", "ä½ å·²ç¶“å¤–å‡ºè¶…é 10 åˆ†é˜ï¼Œè«‹ç›¡å¿«å›ä¾†ã€‚", true); hasNotifiedOvertime = true; }
    } else {
        hasNotifiedOvertime = false;
    }
}

function updateButtonStates() {
    if(!me || !cacheQueue) return;
    let r = cacheQueue.reserve || {}, o = cacheQueue.out || {}, used = cacheQueue.used || {};
    let sortedQueue = Object.entries(r).sort((a,b)=>a[1].time - b[1].time);
    let outCount = Object.keys(o).length;
    let isFirst = sortedQueue.length > 0 && sortedQueue[0][0] === me.uid;
    let alreadyUsed = used[currentSlotInfo.slot]?.[me.uid];

    bReserve.disabled = (currentSlotInfo.phase === 'BREAK' || r[me.uid] || o[me.uid] || alreadyUsed);
    bCancel.disabled = !r[me.uid];
    bOut.disabled = !(currentSlotInfo.phase === 'OUT' && r[me.uid] && isFirst && outCount < 3);
    bBack.disabled = !o[me.uid];

    let statusBox = document.getElementById("status");
    if(alreadyUsed) statusBox.innerHTML = "<span style='color:#444'>æœ¬æ™‚æ®µå·²çµæŸ</span>";
    else if(o[me.uid]) statusBox.innerHTML = "<span class='green'>äº«å—ä¸­...</span>";
    else if(r[me.uid]) {
        if(currentSlotInfo.phase === 'OUT') {
            if(isFirst && outCount < 3) statusBox.innerHTML = "<span class='green'>è¼ªåˆ°ä½ äº†ï¼è«‹å‡ºå»</span>";
            else if(isFirst) statusBox.innerHTML = "<span style='color:#ffaa00'>æ»¿ä½ä¸­ï¼Œç­‰å€™ä½...</span>";
            else statusBox.innerHTML = `<span>éšŠåˆ—ç¬¬ ${sortedQueue.findIndex(x=>x[0]===me.uid)+1} ä½</span>`;
        } else {
            statusBox.innerHTML = "<span style='color:var(--text-gold)'>é ç´„æˆåŠŸï¼Œå¾…æ•´é»é–‹æ”¾</span>";
        }
    } else {
        if(currentSlotInfo.phase === 'BREAK') statusBox.innerHTML = `<small style='color:#555; font-size:14px;'>${currentSlotInfo.hint}</small>`;
        else if(currentSlotInfo.phase === 'RESERVE') statusBox.innerHTML = "<span style='color:#6e8eff'>é ç´„è¦–çª—å·²é–‹å•Ÿ</span>";
        else statusBox.innerHTML = "<span style='color:#333'>å°šæœªé ç´„</span>";
    }
    document.getElementById("outCountNum").textContent = outCount;
}

function renderStaticLists() {
    let d = cacheQueue, r = d.reserve || {};
    let sortedQueue = Object.entries(r).sort((a,b)=>a[1].time - b[1].time);
    
    const qBox = document.getElementById("queue");
    const newQHTML = sortedQueue.map((u, i) => `
        <div class="item-row">
            <span>${i+1}. <strong>${u[1].name}</strong></span>
            <small style='opacity:0.4'>${new Date(u[1].time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:true})}</small>
        </div>
    `).join('') || "<div style='opacity:0.2; padding:10px;'>ç›®å‰ç„¡äººæ’éšŠ</div>";
    if(qBox.innerHTML !== newQHTML) qBox.innerHTML = newQHTML;

    const hBox = document.getElementById("history");
    let activeSlot = currentSlotInfo.phase === 'OUT' ? currentSlotInfo.slot : currentSlotInfo.nextSlot;
    let hist = [];
    if(d.history) Object.values(d.history).forEach(h => { if(h.slot == activeSlot) hist.push({...h, sortT: h.backTime}); });
    
    let outObj = d.out || {};
    Object.entries(outObj).forEach(([uid, u]) => {
        if(Math.floor((Date.now()-u.time)/1000) > 600) hist.push({name: u.name, outTime: u.time, backTime: null, over: true, sortT: Date.now()});
    });

    const newHHTML = hist.sort((a,b)=>b.sortT-a.sortT).slice(0, 10).map(item => `
        <div class="item-row" style="font-size:14px;">
            <span><strong>${item.name}</strong> ${item.over?'<span class="red">!</span>':''}</span>
            <small style='opacity:0.5'>${new Date(item.outTime).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:true})} - ${item.backTime?new Date(item.backTime).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:true}):'OUT'}</small>
        </div>
    `).join('');
    if(hBox.innerHTML !== newHHTML) hBox.innerHTML = newHHTML;
}

/* --- ä¿®æ”¹ï¼šå¤–å‡ºåå–®åŠ å…¥ç®¡ç†å“¡æŒ‰éˆ• --- */
function updateOutListTimer() {
    let outObj = cacheQueue.out || {};
    const oBox = document.getElementById("outList");
    
    const newOHTML = Object.entries(outObj).map(([uid, u]) => {
        let sec = Math.floor((Date.now() - u.time)/1000);
        let timeString = `${Math.floor(sec/60)}åˆ† ${sec%60}ç§’`;
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡ï¼Œå¦‚æœæ˜¯ï¼ŒåŠ å…¥å¬å›æŒ‰éˆ•
        let adminBtn = "";
        if(myData && myData.role === "admin") {
            adminBtn = `<button onclick="forceComeBack('${uid}')" class="btn-mini-danger">å¬å›</button>`;
        }

        return `
            <div class="item-row">
                <span><strong>${u.name}</strong></span>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span class="${sec>600?'red':''}" style="font-size:14px;">${timeString}</span>
                    ${adminBtn}
                </div>
            </div>
        `;
    }).join('') || "<div style='opacity:0.2; padding:10px;'>ç›®å‰ç„¡äººå¤–å‡º</div>";

    if(oBox.innerHTML !== newOHTML) oBox.innerHTML = newOHTML;
}

/* --- æ–°å¢ï¼šç®¡ç†å“¡å¼·åˆ¶å¬å›åŠŸèƒ½ --- */
function forceComeBack(targetUid) {
    if(!confirm("ç¢ºå®šè¦å¼·åˆ¶å°‡æ­¤äººæ¨™è¨˜ç‚ºå·²å›ä¾†ï¼Ÿ")) return;
    
    queueRef.child("out/"+targetUid).once("value").then(s => {
        let u = s.val(); if(!u) return;
        let now = Date.now(), slot = new Date(u.time).getHours();
        
        queueRef.child(`used/${slot}/${targetUid}`).set(true);
        queueRef.child("history").push({ 
            name: u.name, 
            slot, 
            outTime: u.time, 
            backTime: now, 
            over: (now-u.time)>600000 
        });
        queueRef.child("out/"+targetUid).remove();
        addLog(`ç®¡ç†å“¡å¼·åˆ¶å¬å›: ${u.name}`);
    });
}

/* --- Firebase åŠŸèƒ½çµ„ --- */
auth.onAuthStateChanged(user => {
    if(!user) { location.href="login.html"; return; }
    me = user;
    userRef.child(user.uid).on("value", s => {
        myData = s.val() || {};
        document.getElementById("who").textContent = (myData.name || "ç„¡åæ°").toUpperCase();
        document.getElementById("adminPanel").style.display = (myData.role === "admin") ? "block" : "none";
        engineReady = true;
        renderStaticLists();
        updateButtonStates();
    });
    userRef.child(user.uid + "/online").set(true);
    userRef.child(user.uid + "/online").onDisconnect().set(false);
});

function addLog(txt) { logRef.push({t: txt, time: Date.now()}); }
logRef.limitToLast(12).on("value", s => {
    const box = document.getElementById("log"); box.innerHTML = "";
    s.forEach(x => {
        let d = x.val();
        let div = document.createElement("div");
        div.textContent = `[${new Date(d.time).toLocaleTimeString([],{hour12:true})}] ${d.t}`;
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
});

function reserve(){
    let h = new Date().getHours();
    let target = currentSlotInfo.phase === 'RESERVE' ? currentSlotInfo.slot : h;
    queueRef.child("reserve/"+me.uid).set({name: myData.name, time: Date.now(), slot: target});
    if (Notification.permission !== "granted") enableNotification();
    addLog(`${myData.name} é ç´„æˆåŠŸ`);
}
function cancelReserve(){ queueRef.child("reserve/"+me.uid).remove(); addLog(`${myData.name} å–æ¶ˆé ç´„`); }
function goOut(){
    queueRef.child("out/"+me.uid).set({name: myData.name, time: Date.now()}).then(()=>{
        queueRef.child("reserve/"+me.uid).remove(); addLog(`${myData.name} å‡ºç™¼`);
    });
}
function comeBack(){
    queueRef.child("out/"+me.uid).once("value").then(s => {
        let u = s.val(); if(!u) return;
        let now = Date.now(), slot = new Date(u.time).getHours();
        queueRef.child(`used/${slot}/${me.uid}`).set(true);
        queueRef.child("history").push({ name: u.name, slot, outTime: u.time, backTime: now, over: (now-u.time)>600000 });
        queueRef.child("out/"+me.uid).remove();
        addLog(`${myData.name} å·²æ­¸`);
    });
}

function send(){
    let input = document.getElementById("msg"); if(!input.value.trim()) return;
    chatRef.push({name: myData.name, text: input.value, time: Date.now()});
    input.value = "";
}
chatRef.limitToLast(20).on("value", s => {
    let box = document.getElementById("chat"); box.innerHTML="";
    s.forEach(x => {
        let m = x.val();
        let div = document.createElement("div"); div.className="msg";
        div.innerHTML = `<b style="color:var(--text-gold); font-size:12px;">${m.name}</b><br>${m.text}`;
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
});

function logout(){ auth.signOut().then(()=>location.reload()); }
function resetQueue(){ if(confirm("ç¢ºå®šé‡ç½®ç³»çµ±æ•¸æ“šï¼Ÿ")) { queueRef.remove(); addLog("ç³»çµ±é‡ç½®æ•¸æ“š"); } }
function clearLog(){ if(confirm("ç¢ºå®šæ¸…ç©ºæ—¥èªŒï¼Ÿ")) logRef.remove(); }
function clearChat(){ if(confirm("ç¢ºå®šæ¸…ç©ºèŠå¤©è¨˜éŒ„ï¼Ÿ")) chatRef.remove(); }

userRef.on("value", s => {
    let bar = document.getElementById("onlineBar"); bar.innerHTML="";
    s.forEach(u => {
        let d = u.val();
        let span = document.createElement("span");
        span.style = `padding: 5px 12px; border-radius: 10px; font-size: 11px; font-weight:bold; border: 1px solid ${d.online?'#00ff88':'#333'}; color: ${d.online?'#00ff88':'#555'}`;
        span.textContent = d.name; bar.appendChild(span);
    });
});

const canvas=document.getElementById("bg"), ctx=canvas.getContext("2d");
let w,h, particles=[];
function resize(){w=canvas.width=innerWidth; h=canvas.height=innerHeight;}
window.onresize=resize; resize();
for(let i=0;i<40;i++) particles.push({x:Math.random()*w, y:Math.random()*h, r:Math.random()*2+1, vx:(Math.random()-.5)*.3, vy:(Math.random()-.5)*.3});
function draw(){
    ctx.fillStyle = "rgba(5, 6, 10, 0.3)";
    ctx.fillRect(0,0,w,h);
    particles.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy;
        if(p.x<0||p.x>w) p.vx*=-1; if(p.y<0||p.y>h) p.vy*=-1;
        ctx.fillStyle="rgba(110,142,255,0.4)"; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,7); ctx.fill();
    });
    requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
