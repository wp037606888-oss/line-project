<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°Šçˆµå¸è¸å®¤ v4.1 - ä¸­å¤®æ§åˆ¶å°</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&family=Rajdhani:wght@500;700&display=swap');

:root {
    --gold: #ffd700;
    --gold-dim: rgba(255, 215, 0, 0.15);
    --gold-glow: rgba(255, 215, 0, 0.5);
    --bg-dark: #05060a;
    --glass: rgba(13, 14, 20, 0.75);
    --glass-border: rgba(255, 255, 255, 0.08);
    --text-main: #e0e0e0;
    --success: #00ff9d;
    --danger: #ff4757;
    --neon-blue: #2ed573;
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

body {
    margin: 0;
    font-family: "Noto Sans TC", sans-serif;
    background: var(--bg-dark);
    color: var(--text-main);
    display: flex;
    height: 100vh;
    overflow: hidden;
    font-size: 15px;
}

/* --- èƒŒæ™¯ç‰¹æ•ˆ --- */
canvas#bg { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
.overlay { position: fixed; inset: 0; background: radial-gradient(circle at center, transparent 0%, #000 95%); z-index: 0; pointer-events: none; }
.noise { position: fixed; inset: 0; z-index: 0; opacity: 0.05; background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJuIj48ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iMC42IiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI24pIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4='); pointer-events: none; }

/* --- ä¸»ä½ˆå±€ (ä¿®å¾©ç‰ˆ) --- */
#layout {
    display: flex;
    width: 100%;
    height: 100%;
    z-index: 1;
    position: relative;
    padding: 20px;
    gap: 20px;
}

/* å·¦å´å„€è¡¨æ¿ï¼šåŠ å…¥ flex:1 å’Œ min-width é˜²æ­¢æ“ å£“ï¼Œoverflow-y:auto ç¢ºä¿å¯æ»¾å‹• */
#dashboard {
    flex: 1.8;
    display: flex;
    flex-direction: column;
    gap: 16px;
    overflow-y: auto; /* é—œéµï¼šå…§å®¹éå¤šæ™‚æœƒå‡ºç¾æ»¾å‹•æ¢ï¼Œä¸æœƒè¢«åˆ‡æ‰ */
    padding-right: 6px;
    min-width: 400px;
}

/* å³å´é€šè¨Šå€ */
#comms {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0;
    min-width: 320px;
    height: 100%;
    overflow: hidden; /* å…§éƒ¨æ»¾å‹• */
}

/* --- ç»ç’ƒæ“¬æ…‹å¡ç‰‡ --- */
.glass-panel {
    background: var(--glass);
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    position: relative;
    transition: transform 0.3s ease, border-color 0.3s;
    flex-shrink: 0; /* é˜²æ­¢å¡ç‰‡è¢«å£“ç¸® */
}

.glass-panel:hover {
    border-color: rgba(255, 215, 0, 0.2);
    box-shadow: 0 12px 40px rgba(0,0,0,0.8);
}

/* å¡ç‰‡æµå…‰é‚Šæ¡†ç‰¹æ•ˆ */
.glass-panel::after {
    content: ""; position: absolute; inset: 0; border-radius: 16px; padding: 1px;
    background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent 40%, transparent 60%, rgba(255,215,0,0.1));
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor; pointer-events: none;
}

/* --- æ¨™é¡Œèˆ‡æ–‡å­— --- */
h3 {
    margin: 0 0 12px 0;
    font-size: 13px;
    color: var(--gold);
    text-transform: uppercase;
    letter-spacing: 2px;
    display: flex; align-items: center; gap: 8px;
    font-family: 'Cinzel', serif;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    padding-bottom: 8px;
}

/* --- ç‹€æ…‹é¢æ¿ (é ‚éƒ¨) --- */
.status-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
.user-badge { 
    background: linear-gradient(90deg, rgba(255,215,0,0.1), transparent); 
    padding: 4px 12px; border-radius: 4px; font-size: 12px; 
    border-left: 2px solid var(--gold); color: #fff; letter-spacing: 1px;
    font-family: 'Rajdhani', sans-serif; font-weight: 700;
}
.btn-logout { 
    background: transparent; border: 1px solid #444; color: #666; cursor: pointer; 
    padding: 4px 10px; border-radius: 6px; font-size: 10px; transition: .3s; margin-left: 10px;
}
.btn-logout:hover { border-color: var(--danger); color: var(--danger); }

#clock {
    font-family: 'Rajdhani', sans-serif;
    font-size: 48px; line-height: 1;
    font-weight: 700;
    color: #fff;
    text-shadow: 0 0 20px rgba(255,255,255,0.15);
    margin: 10px 0 5px;
    letter-spacing: 2px;
}
#slotDisplay { font-size: 14px; color: var(--gold); letter-spacing: 1px; font-weight: 500; opacity: 0.8; }
#status { font-size: 18px; font-weight: 700; margin: 5px 0 15px; min-height: 24px; letter-spacing: 1px; }

/* --- æŒ‰éˆ•ç¾¤çµ„ (ä¿®å¾©é®æ“‹å•é¡Œ) --- */
.control-grid {
    display: grid;
    grid-template-columns: 1.5fr 1fr 1fr 1fr; /* é ç´„æŒ‰éˆ•å¤§ä¸€é» */
    gap: 12px;
    margin-top: 15px;
}

button.action-btn {
    padding: 16px 8px;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    background: rgba(0,0,0,0.3);
    color: #888;
    font-size: 14px; font-weight: 700;
    cursor: pointer; transition: all 0.2s;
    font-family: "Noto Sans TC", sans-serif;
    position: relative; overflow: hidden;
}

/* é ç´„æŒ‰éˆ• (é‡‘è‰²å‘¼å¸) */
button#bReserve {
    background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%);
    color: #000; border: none;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    animation: goldPulse 3s infinite;
}
@keyframes goldPulse { 0%{box-shadow: 0 0 10px rgba(255,215,0,0.2);} 50%{box-shadow: 0 0 25px rgba(255,215,0,0.5);} 100%{box-shadow: 0 0 10px rgba(255,215,0,0.2);} }

button#bReserve:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.1); }
button#bReserve:disabled { background: #1a1a1a; color: #444; animation: none; box-shadow: none; cursor: not-allowed; }

/* å…¶ä»–æŒ‰éˆ•ç‰¹æ•ˆ */
button#bCancel:hover:not(:disabled) { border-color: var(--danger); color: var(--danger); box-shadow: 0 0 15px rgba(255, 71, 87, 0.2); }
button#bOut:hover:not(:disabled) { border-color: var(--success); color: var(--success); box-shadow: 0 0 15px rgba(0, 255, 157, 0.2); }
button#bBack:hover:not(:disabled) { border-color: #fff; color: #fff; box-shadow: 0 0 15px rgba(255, 255, 255, 0.2); }

/* --- åˆ—è¡¨æ¨£å¼ --- */
.list-container { max-height: 180px; overflow-y: auto; padding-right: 4px; }
.item-card {
    background: linear-gradient(90deg, rgba(255,255,255,0.03), transparent);
    margin-bottom: 6px; padding: 10px 14px;
    border-radius: 8px; border-left: 2px solid rgba(255,255,255,0.1);
    display: flex; justify-content: space-between; align-items: center;
    transition: .2s; font-size: 14px;
}
.item-card:hover { background: rgba(255,255,255,0.06); }
.item-card.rank-1 { border-left-color: var(--gold); background: linear-gradient(90deg, rgba(255,215,0,0.1), transparent); }
.item-card.rank-2 { border-left-color: #c0c0c0; }

.btn-mini { padding: 2px 8px; font-size: 10px; border-radius: 4px; cursor: pointer; margin-left: 8px; border: 1px solid; background: transparent; }
.btn-mini.danger { color: var(--danger); border-color: var(--danger); }
.btn-mini.danger:hover { background: var(--danger); color: #fff; }
.btn-mini.success { color: var(--success); border-color: var(--success); }
.btn-mini.success:hover { background: var(--success); color: #000; }

/* --- èŠå¤©å®¤ --- */
#chat-header {
    padding: 16px; background: rgba(0,0,0,0.2);
    border-bottom: 1px solid var(--glass-border);
    font-size: 11px; color: #666; letter-spacing: 2px;
    display: flex; justify-content: space-between; align-items: center;
}
#chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
.msg-bubble {
    max-width: 85%; padding: 8px 12px; border-radius: 12px;
    font-size: 13px; line-height: 1.5; position: relative; word-break: break-all;
}
.msg-mine {
    align-self: flex-end;
    background: linear-gradient(135deg, #ffd700, #ffaa00);
    color: #000; border-bottom-right-radius: 2px;
    box-shadow: 0 4px 10px rgba(255, 170, 0, 0.15);
}
.msg-other {
    align-self: flex-start;
    background: rgba(255,255,255,0.08);
    color: #ccc; border-bottom-left-radius: 2px;
}
.msg-name { font-size: 10px; margin-bottom: 2px; opacity: 0.7; font-weight: 700; }

.input-area {
    padding: 12px; background: rgba(0,0,0,0.2);
    border-top: 1px solid var(--glass-border);
    display: flex; gap: 8px;
}
input#msg {
    flex: 1; background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px; padding: 10px 16px; color: #fff;
    font-size: 14px; transition: .3s;
}
input#msg:focus { border-color: var(--gold); background: rgba(0,0,0,0.5); }
button.btn-send {
    background: var(--gold); border: none; color: #000;
    border-radius: 50%; width: 38px; height: 38px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: .3s; font-weight: bold;
}
button.btn-send:hover { transform: scale(1.1); box-shadow: 0 0 10px var(--gold); }

/* --- ç®¡ç†å“¡é¢æ¿ --- */
#adminPanel { display: none; margin-top: 10px; border: 1px solid rgba(255, 215, 0, 0.2); }
.admin-controls { display: flex; gap: 6px; flex-wrap: wrap; }
.btn-admin { padding: 6px 10px; font-size: 10px; background: rgba(0,0,0,0.5); border: 1px solid #444; color: #888; cursor: pointer; border-radius: 4px; }
.btn-admin:hover { border-color: #fff; color: #fff; }

/* æ²è»¸ç¾åŒ– */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

/* RWD é©é… */
@media (max-width: 900px) {
    #layout { flex-direction: column; padding: 10px; }
    #dashboard { flex: none; width: 100%; min-width: 0; max-height: 60vh; }
    #comms { flex: 1; min-width: 0; height: 40vh; }
    .control-grid { grid-template-columns: 1fr 1fr; }
    button#bReserve { grid-column: span 2; }
}
</style>
</head>

<body>
<canvas id="bg"></canvas>
<div class="overlay"></div>
<div class="noise"></div>

<div id="layout">
    <div id="dashboard">
        <div class="glass-panel" style="flex-shrink: 0;">
            <div class="status-header">
                <div style="display: flex; align-items: center;">
                    <span class="user-badge" id="who">é€£ç·šä¸­...</span>
                    <button class="btn-logout" onclick="enableNotification()" id="btnNotify" style="display:none;">ğŸ”” é–‹å•Ÿé€šçŸ¥</button>
                    <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
                </div>
                <div id="slotDisplay">---</div>
            </div>
            
            <div id="clock">00:00:00</div>
            <div id="status">ç³»çµ±åˆå§‹åŒ–...</div>

            <div class="control-grid">
                <button id="bReserve" onclick="reserve()" class="action-btn">é ç´„æ’éšŠ</button>
                <button id="bOut" onclick="goOut()" class="action-btn">ç¾åœ¨å‡ºå»</button>
                <button id="bBack" onclick="comeBack()" class="action-btn">æˆ‘å›ä¾†äº†</button>
                <button id="bCancel" onclick="cancelReserve()" class="action-btn">å–æ¶ˆé ç´„</button>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; flex-shrink: 0;">
            <div class="glass-panel">
                <h3>æ’éšŠåå–®</h3>
                <div id="queue" class="list-container"></div>
            </div>
            <div class="glass-panel">
                <h3>å¤–å‡ºä¸­ (<span id="outCountNum" style="color:var(--success)">0</span>/3)</h3>
                <div id="outList" class="list-container"></div>
            </div>
        </div>

        <div class="glass-panel" style="flex-shrink: 0;">
            <h3>è¿‘æœŸç´€éŒ„</h3>
            <div id="history" class="list-container"></div>
        </div>

        <div class="glass-panel" style="flex-shrink: 0;">
            <h3>ç³»çµ±æ—¥èªŒ</h3>
            <div id="log" class="list-container" style="font-family: 'Rajdhani', monospace; font-size: 12px; color:#666;"></div>
        </div>

        <div id="adminPanel" class="glass-panel" style="flex-shrink: 0;">
            <h3 style="color:var(--gold);">ğŸ‘‘ ADMIN</h3>
            <div class="admin-controls">
                <button onclick="forceReload()" class="btn-admin">å…¨é«”åˆ·æ–°</button>
                <button onclick="resetQueue()" class="btn-admin" style="border-color:var(--danger); color:var(--danger);">æ¸…ç©ºæ•¸æ“š</button>
                <button onclick="clearLog()" class="btn-admin">æ¸…ç©ºæ—¥èªŒ</button>
                <button onclick="clearChat()" class="btn-admin">æ¸…ç©ºèŠå¤©</button>
            </div>
        </div>
    </div>

    <div id="comms" class="glass-panel" style="padding:0;">
        <div id="chat-header">
            <span>LOUNGE CHAT</span>
            <div id="onlineBar" style="display:flex; gap:4px;"></div>
        </div>
        
        <div id="chat-box"></div>
        
        <div class="input-area">
            <input id="msg" placeholder="è¼¸å…¥è¨Šæ¯..." onkeydown="if(event.key==='Enter')send()" autocomplete="off">
            <button onclick="send()" class="btn-send">â¤</button>
        </div>
    </div>
</div>

<script>
/* --- ç²’å­èƒŒæ™¯ --- */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
let w, h;
function resize() { w = canvas.width = innerWidth; h = canvas.height = innerHeight; }
window.onresize = resize; resize();

const particles = [];
for (let i = 0; i < 50; i++) {
    particles.push({
        x: Math.random() * w, y: Math.random() * h,
        vx: (Math.random() - 0.5) * 0.2, vy: (Math.random() - 0.5) * 0.2,
        size: Math.random() * 2 + 0.5, alpha: Math.random() * 0.5 + 0.1
    });
}
function draw() {
    ctx.clearRect(0, 0, w, h);
    for (let i = 0; i < particles.length; i++) {
        let p = particles[i];
        p.x += p.vx; p.y += p.vy;
        if (p.x < 0 || p.x > w) p.vx *= -1; if (p.y < 0 || p.y > h) p.vy *= -1;
        
        ctx.fillStyle = `rgba(255, 215, 0, ${p.alpha})`;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();

        for (let j = i + 1; j < particles.length; j++) {
            let p2 = particles[j];
            let dist = Math.sqrt((p.x-p2.x)**2 + (p.y-p2.y)**2);
            if (dist < 120) {
                ctx.strokeStyle = `rgba(255, 215, 0, ${0.08 * (1 - dist / 120)})`;
                ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
            }
        }
    }
    requestAnimationFrame(draw);
}
draw();

/* --- Firebase Config --- */
const config={
    apiKey: "AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",
    authDomain: "smoke-queue.firebaseapp.com",
    databaseURL: "https://smoke-queue-default-rtdb.firebaseio.com",
    projectId: "smoke-queue"
};
firebase.initializeApp(config);
const db=firebase.database(), auth=firebase.auth();
const queueRef=db.ref("queue"), userRef=db.ref("users"), chatRef=db.ref("chat"), logRef=db.ref("log");

let me, myData, engineReady=false, cacheQueue={};
let currentSlotInfo = { phase: '', slot: 0 };
let audioCtx = null, notifyEnabled = false;
let hasNotifiedReady = false, hasNotifiedOvertime = false;

/* --- é€šçŸ¥ç³»çµ± --- */
function enableNotification() {
    if (!("Notification" in window)) return;
    Notification.requestPermission().then(p => {
        if (p === "granted") {
            notifyEnabled = true; playBeep();
            document.getElementById("btnNotify").style.display = "none";
        }
    });
}
if (Notification.permission !== "granted") document.getElementById("btnNotify").style.display = "inline-block";

function playBeep(type='normal') {
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    if(type==='urgent'){
        osc.frequency.value=880; osc.type='square'; osc.start(); setTimeout(()=>osc.stop(),100);
        setTimeout(()=>{
            const o2=audioCtx.createOscillator(); const g2=audioCtx.createGain();
            o2.connect(g2); g2.connect(audioCtx.destination);
            o2.frequency.value=880; o2.type='square'; o2.start(); setTimeout(()=>o2.stop(),100);
        },150);
    } else {
        osc.frequency.value=523.25; osc.type='sine';
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime+0.5);
        osc.start(); osc.stop(audioCtx.currentTime+0.5);
    }
}
function sendNotify(title,body,urgent=false){
    if(!notifyEnabled) return;
    playBeep(urgent?'urgent':'normal');
    new Notification(title, { body, icon: 'https://cdn-icons-png.flaticon.com/512/3772/3772422.png' });
}

/* --- æ ¸å¿ƒé‚è¼¯ --- */
function format12H(d) { return d.toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'}); }
function getSlotStatus(h, m) {
    const slots = [14, 16, 18, 20, 22, 0]; 
    let target = slots.find(s => (s === 0 ? 24 : s) > h) || 14;
    let currentSlot = slots.find(s => s === h);
    if (currentSlot !== undefined) {
        let displayH = currentSlot === 0 ? 12 : (currentSlot > 12 ? currentSlot - 12 : currentSlot);
        return { phase: 'OUT', slot: currentSlot, display: `${displayH}:00 PM é–‹æ”¾æ™‚æ®µ` };
    }
    let nextSlot = target;
    let diff = (nextSlot === 0 ? 24 : nextSlot) * 60 - (h * 60 + m);
    if (diff > 0 && diff <= 30) {
        let nextH = nextSlot === 0 ? 12 : (nextSlot > 12 ? nextSlot - 12 : nextSlot);
        return { phase: 'RESERVE', slot: nextSlot, display: `é ç´„ä¸­ ${nextH}:00` };
    }
    return { phase: 'BREAK', nextSlot, display: 'å¸è¸å€ä¼‘æ¯ä¸­', hint: 'éé–‹æ”¾æ™‚æ®µ' };
}

setInterval(() => {
    if(!engineReady) return;
    const now = new Date();
    const h = now.getHours(), m = now.getMinutes();
    document.getElementById("clock").textContent = format12H(now);
    currentSlotInfo = getSlotStatus(h, m);
    document.getElementById("slotDisplay").textContent = currentSlotInfo.display;
    if(h === 1 && m === 0 && now.getSeconds() === 0 && myData.role === "admin") resetQueue();
    updateButtonStates(); updateOutListTimer(); checkNotifications();
}, 1000);

queueRef.on("value", s => { cacheQueue = s.val() || {}; if(engineReady) { renderStaticLists(); updateButtonStates(); }});

function checkNotifications() {
    if(!me || !cacheQueue) return;
    let r = cacheQueue.reserve || {}, o = cacheQueue.out || {};
    let sortedQueue = Object.entries(r).sort((a,b)=>a[1].time - b[1].time);
    let outCount = Object.keys(o).length;
    let myRank = sortedQueue.findIndex(x=>x[0]===me.uid);

    if (currentSlotInfo.phase === 'OUT' && myRank >= 0 && myRank <= 1 && outCount < 3) {
        if (!hasNotifiedReady) { sendNotify("VIP é€šè¡Œè¨±å¯", "æ‚¨åœ¨å‰å…©é †ä½ï¼Œç¾åœ¨å¯ä»¥å‰å¾€å¸è¸å€ã€‚", false); hasNotifiedReady = true; }
    } else { hasNotifiedReady = false; }

    if (o[me.uid]) {
        let sec = Math.floor((Date.now() - o[me.uid].time) / 1000);
        if (sec > 600 && !hasNotifiedOvertime) { sendNotify("è¶…æ™‚è­¦å‘Š", "æ‚¨å·²å¤–å‡ºè¶…é 10 åˆ†é˜ï¼Œè«‹ç›¡é€Ÿè¿”å›ã€‚", true); hasNotifiedOvertime = true; }
    } else { hasNotifiedOvertime = false; }
}

function updateButtonStates() {
    if(!me || !cacheQueue) return;
    let r = cacheQueue.reserve || {}, o = cacheQueue.out || {}, used = cacheQueue.used || {};
    let sortedQueue = Object.entries(r).sort((a,b)=>a[1].time - b[1].time);
    let outCount = Object.keys(o).length;
    let myRank = sortedQueue.findIndex(x=>x[0]===me.uid);
    let alreadyUsed = used[currentSlotInfo.slot]?.[me.uid];

    // æŒ‰éˆ•é‚è¼¯
    bReserve.disabled = (currentSlotInfo.phase === 'BREAK' || r[me.uid] || o[me.uid] || alreadyUsed);
    bCancel.disabled = !r[me.uid];
    
    // ç¬¬ 1 åå’Œç¬¬ 2 ååœ¨æœ‰ç©ºä½æ™‚éƒ½å¯ä»¥å‡ºå»
    let canGoOut = (currentSlotInfo.phase === 'OUT' && r[me.uid] && myRank <= 1 && outCount < 3);
    bOut.disabled = !canGoOut;
    bBack.disabled = !o[me.uid];

    // ç‹€æ…‹æ–‡å­—é¡¯ç¤º
    let statusBox = document.getElementById("status");
    if(alreadyUsed) statusBox.innerHTML = "<span style='color:#666'>æœ¬æ™‚æ®µå·²çµæŸ</span>";
    else if(o[me.uid]) statusBox.innerHTML = "<span style='color:var(--success)'>æŠ½è¸ä¸­ ENJOYING...</span>";
    else if(r[me.uid]) {
        if(currentSlotInfo.phase === 'OUT') {
            if(myRank <= 1 && outCount < 3) statusBox.innerHTML = "<span style='color:var(--success)'>åé¡é–‹æ”¾ï¼Œè«‹å‡ºç™¼</span>";
            else if(outCount >= 3) statusBox.innerHTML = "<span style='color:var(--gold)'>æ»¿ä½ç­‰å€™ä¸­...</span>";
            else statusBox.innerHTML = `<span style='color:var(--text-main)'>ç­‰å¾…é †ä½: ${myRank+1}</span>`;
        } else {
            statusBox.innerHTML = "<span style='color:var(--gold)'>é ç´„æˆåŠŸ (å¾…é–‹æ”¾)</span>";
        }
    } else {
        if(currentSlotInfo.phase === 'BREAK') statusBox.innerHTML = "<span style='color:#555'>ç­‰å¾…ä¸‹ä¸€æ™‚æ®µ</span>";
        else if(currentSlotInfo.phase === 'RESERVE') statusBox.innerHTML = "<span style='color:#2ed573'>é–‹æ”¾é ç´„ä¸­</span>";
        else statusBox.innerHTML = "<span style='color:#444'>å°šæœªé ç´„</span>";
    }
    document.getElementById("outCountNum").textContent = outCount;
}

function renderStaticLists() {
    let d = cacheQueue, r = d.reserve || {};
    let sortedQueue = Object.entries(r).sort((a,b)=>a[1].time - b[1].time);
    
    const qBox = document.getElementById("queue");
    qBox.innerHTML = sortedQueue.map((u, i) => {
        let forceOutBtn = (myData && myData.role === "admin") ? `<button onclick="forceGoOut('${u[0]}')" class="btn-mini success">å»æŠ½</button>` : "";
        let rankClass = i===0 ? 'rank-1' : (i===1 ? 'rank-2' : '');
        return `
        <div class="item-card ${rankClass}">
            <div>
                <span style="font-family:'Rajdhani'; color:var(--gold); margin-right:8px; font-weight:bold;">#${i+1}</span>
                <strong>${u[1].name}</strong>
            </div>
            <div style="display:flex; align-items:center;">
                <small style='opacity:0.4; margin-right:5px; font-family:"Rajdhani"'>${new Date(u[1].time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false})}</small>
                ${forceOutBtn}
            </div>
        </div>`;
    }).join('') || "<div style='opacity:0.3; padding:10px; text-align:center;'>ç›®å‰ç©ºé–’</div>";

    const hBox = document.getElementById("history");
    let hist = [];
    if(d.history) Object.values(d.history).forEach(h => hist.push({...h, sortT: h.backTime}));
    let outObj = d.out || {};
    Object.entries(outObj).forEach(([uid, u]) => {
        if(Math.floor((Date.now()-u.time)/1000) > 600) hist.push({name: u.name, outTime: u.time, backTime: null, over: true, sortT: Date.now()});
    });

    hBox.innerHTML = hist.sort((a,b)=>b.sortT-a.sortT).slice(0, 20).map(item => `
        <div class="item-card" style="padding:8px 12px; min-height:0; border:none; background:rgba(255,255,255,0.02);">
            <span>${item.name} ${item.over?'<span style="color:var(--danger)">!</span>':''}</span>
            <small style='opacity:0.5; font-family:"Rajdhani"'>${new Date(item.outTime).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false})} - ${item.backTime?new Date(item.backTime).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false}):'OUT'}</small>
        </div>
    `).join('');
}

function updateOutListTimer() {
    let outObj = cacheQueue.out || {};
    const oBox = document.getElementById("outList");
    oBox.innerHTML = Object.entries(outObj).map(([uid, u]) => {
        let sec = Math.floor((Date.now() - u.time)/1000);
        let timeString = `${Math.floor(sec/60)}åˆ† ${sec%60}ç§’`;
        let adminBtn = (myData && myData.role === "admin") ? `<button onclick="forceComeBack('${uid}')" class="btn-mini danger">å¬å›</button>` : "";
        return `
            <div class="item-card" style="border-left-color:var(--success);">
                <strong>${u.name}</strong>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span class="${sec>600?'text-danger':''}" style="font-family:'Rajdhani'; color:${sec>600?'var(--danger)':'#aaa'}">${timeString}</span>
                    ${adminBtn}
                </div>
            </div>
        `;
    }).join('') || "<div style='opacity:0.3; padding:10px; text-align:center;'>ç„¡äººå¤–å‡º</div>";
}

/* Firebase Admin & User */
function forceComeBack(uid) { if(confirm("å¼·åˆ¶å¬å›ï¼Ÿ")) queueRef.child("out/"+uid).once("value").then(s=>{ let u=s.val(); if(u){ let now=Date.now(), slot=new Date(u.time).getHours(); queueRef.child(`used/${slot}/${uid}`).set(true); queueRef.child("history").push({name:u.name,slot,outTime:u.time,backTime:now,over:(now-u.time)>600000}); queueRef.child("out/"+uid).remove(); addLog(`ADMIN å¬å›: ${u.name}`); }}); }
function forceGoOut(uid) { if(confirm("å¼·åˆ¶æ´¾ç™¼ï¼Ÿ")) queueRef.child("reserve/"+uid).once("value").then(s=>{ let u=s.val(); if(u){ queueRef.child("out/"+uid).set({name:u.name,time:Date.now()}).then(()=>{ queueRef.child("reserve/"+uid).remove(); addLog(`ADMIN æ´¾ç™¼: ${u.name}`); }); }}); }
function forceReload() { db.ref("reload").set(Date.now()); }
function resetQueue(){ if(confirm("âš ï¸ ç¢ºå®šæ¸…ç©ºæ•¸æ“š? (ä¿ç•™æ—¥èªŒ)")) { queueRef.child("reserve").remove(); queueRef.child("out").remove(); queueRef.child("used").remove(); addLog("ADMIN é‡ç½®æ•¸æ“š"); } }
function clearLog(){ if(confirm("æ¸…ç©ºæ—¥èªŒ?")) logRef.remove(); }
function clearChat(){ if(confirm("æ¸…ç©ºèŠå¤©?")) chatRef.remove(); }
function logout(){ auth.signOut().then(()=>location.reload()); }

/* åŸºæœ¬åŠŸèƒ½ */
auth.onAuthStateChanged(user => {
    if(!user) { location.href="index.html"; return; }
    me = user;
    userRef.child(user.uid).on("value", s => {
        myData = s.val() || {};
        document.getElementById("who").textContent = (myData.name || "GUEST").toUpperCase();
        document.getElementById("adminPanel").style.display = (myData.role === "admin") ? "block" : "none";
        engineReady = true; renderStaticLists(); updateButtonStates();
    });
    userRef.child(user.uid + "/online").set(true);
    userRef.child(user.uid + "/online").onDisconnect().set(false);
});

function addLog(txt) { logRef.push({t: txt, time: Date.now()}); }
logRef.limitToLast(15).on("value", s => {
    const box = document.getElementById("log"); box.innerHTML = "";
    s.forEach(x => {
        let d = x.val(); let div = document.createElement("div"); 
        div.innerHTML = `<span style="opacity:0.5; font-family:'Rajdhani'">[${new Date(d.time).toLocaleTimeString([],{hour12:false})}]</span> ${d.t}`;
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
});

function reserve(){ let h=new Date().getHours(); let t=currentSlotInfo.phase==='RESERVE'?currentSlotInfo.slot:h; queueRef.child("reserve/"+me.uid).set({name:myData.name,time:Date.now(),slot:t}); if(Notification.permission!=="granted")enableNotification(); addLog(`${myData.name} é ç´„`); }
function cancelReserve(){ queueRef.child("reserve/"+me.uid).remove(); addLog(`${myData.name} å–æ¶ˆ`); }
function goOut(){ queueRef.child("out/"+me.uid).set({name:myData.name,time:Date.now()}).then(()=>{queueRef.child("reserve/"+me.uid).remove(); addLog(`${myData.name} å‡ºç™¼`);}); }
function comeBack(){ queueRef.child("out/"+me.uid).once("value").then(s=>{let u=s.val();if(u){let now=Date.now(),slot=new Date(u.time).getHours();queueRef.child(`used/${slot}/${me.uid}`).set(true);queueRef.child("history").push({name:u.name,slot,outTime:u.time,backTime:now,over:(now-u.time)>600000});queueRef.child("out/"+me.uid).remove();addLog(`${myData.name} è¿”å›`);}}); }

function send(){ let i=document.getElementById("msg"); if(!i.value.trim())return; chatRef.push({name:myData.name,uid:me.uid,text:i.value,time:Date.now()}); i.value=""; }
chatRef.limitToLast(30).on("value", s => {
    let box = document.getElementById("chat-box"); box.innerHTML="";
    s.forEach(x => {
        let m = x.val(); let isMe = m.uid === me.uid;
        let div = document.createElement("div"); div.className = `msg-bubble ${isMe ? 'msg-mine' : 'msg-other'}`;
        div.innerHTML = `<div class="msg-name">${m.name}</div>${m.text}`;
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
});

userRef.on("value", s => { 
    let bar = document.getElementById("onlineBar"); bar.innerHTML=""; let count=0;
    s.forEach(u => { let d=u.val(); if(d.online){ count++; bar.innerHTML+=`<span style="font-size:9px; padding:2px 6px; background:rgba(255,255,255,0.1); border-radius:4px; color:${d.role==='admin'?var(--gold):'#aaa'}; border:1px solid ${d.role==='admin'?var(--gold):'transparent'};">${d.name}</span>`; }});
});

let isFirstReloadCheck = true;
db.ref("reload").on("value", s => { if(isFirstReloadCheck){isFirstReloadCheck=false;return;} location.reload(); });
</script>
</body>
</html>
