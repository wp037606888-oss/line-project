<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¬è±ªç³»çµ± v12.2</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* å¼•å…¥é ‚ç´šå­—é«” */
@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500;700&family=Noto+Sans+TC:wght@300;400;500&family=Rajdhani:wght@500;600;700&family=Ma+Shan+Zheng&display=swap');

:root {
    /* è¬è±ªè¡Œæ”¿é…è‰² */
    --champagne: #F3E5AB;
    --gold-luxury: #C5A059;
    --gold-dark: #8A6E3E;
    
    --bg-deep: #050608;
    --glass-panel: rgba(18, 20, 24, 0.9); /* æé«˜ä¸é€æ˜åº¦ï¼Œä¿®å¾©è¦–è¦ºæ··äº‚ */
    --border-edge: rgba(255, 255, 255, 0.08);
    
    --text-primary: #ECECEC;
    --text-secondary: #9aa0a6;
    
    --success: #4caf50;
    --danger: #d32f2f;
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

body {
    margin: 0; font-family: "Noto Sans TC", sans-serif;
    background: var(--bg-deep); color: var(--text-primary);
    display: flex; height: 100vh; overflow: hidden; font-size: 15px;
}

/* --- èƒŒæ™¯èˆ‡æ°›åœ --- */
.noise {
    position: fixed; inset: 0; z-index: 0; opacity: 0.03; pointer-events: none;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='2' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
}
.ambient-light {
    position: fixed; top: -30%; left: 50%; width: 100vw; height: 100vh;
    background: radial-gradient(ellipse at center, rgba(197, 160, 89, 0.08) 0%, transparent 70%);
    transform: translateX(-50%); pointer-events: none; z-index: 0;
}
canvas#bg { position: fixed; inset: 0; z-index: 1; pointer-events: none; }

/* --- ä½ˆå±€ --- */
#layout { display: flex; width: 100%; height: 100%; z-index: 10; position: relative; padding: 20px; gap: 20px; }
#dashboard { flex: 1.8; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-right: 5px; min-width: 400px; }
#comms { flex: 1; display: flex; flex-direction: column; gap: 0; min-width: 350px; height: 100%; overflow: hidden; position: relative; }

/* --- æ°´æ™¶é¢æ¿ (Crystal Panel) --- */
.glass-panel {
    background: var(--glass-panel);
    backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
    border: 1px solid var(--border-edge);
    border-top: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 4px;
    padding: 20px;
    box-shadow: 0 15px 40px -10px rgba(0,0,0,0.8);
    position: relative; flex-shrink: 0;
    transition: border-color 0.3s;
}
.glass-panel:hover { border-color: rgba(197, 160, 89, 0.2); }

/* --- æ¨™é¡Œä¿®æ­£ (å·¦å´æ’ç‰ˆ) --- */
h3 { 
    margin: 0 0 12px 0; font-size: 14px; 
    color: var(--gold-luxury); font-family: 'Noto Serif TC', serif; 
    letter-spacing: 2px; font-weight: 700;
    display: flex; align-items: center; justify-content: space-between; /* æ¨™é¡Œé å·¦ï¼Œæ•¸å­—é å³ */
    border-bottom: 1px solid rgba(255,255,255,0.08); padding-bottom: 10px;
}
/* å¼·åˆ¶æ¨™é¡Œå…§çš„æ•¸å­—æ¨£å¼ */
h3 span { font-family: 'Rajdhani', sans-serif; font-weight: 600; font-size: 16px; color: #fff; }

/* --- ç‹€æ…‹å€ --- */
.status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.user-badge { 
    font-family: 'Noto Serif TC', serif; font-weight: 700; font-size: 18px;
    color: #fff; text-shadow: 0 0 15px rgba(255,255,255,0.2);
    display: flex; align-items: center; gap: 8px;
}
.user-badge::before { content: 'â—ˆ'; color: var(--gold-luxury); font-size: 16px; }

.btn-logout { 
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary); 
    cursor: pointer; padding: 6px 14px; border-radius: 2px; font-size: 11px; 
    transition: .3s; font-family: "Noto Sans TC"; letter-spacing: 1px;
}
.btn-logout:hover { border-color: var(--gold-luxury); color: var(--gold-luxury); background: rgba(20,20,20,0.8); }

#clock {
    font-family: 'Rajdhani', sans-serif; font-size: 50px; line-height: 1;
    font-weight: 600; color: #fff; 
    margin: 10px 0 5px; letter-spacing: 2px;
    background: linear-gradient(180deg, #fff 20%, #999 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
#slotDisplay { font-size: 14px; color: var(--gold-luxury); letter-spacing: 2px; font-family: "Noto Serif TC"; opacity: 0.9; margin-bottom: 5px; }
#status { font-size: 15px; font-weight: 400; margin: 5px 0 20px; min-height: 24px; letter-spacing: 1px; color: var(--text-secondary); }

/* --- æŒ‰éˆ•ç³»çµ± --- */
.control-grid { display: flex; gap: 12px; margin-top: 20px; }
button.action-btn {
    flex: 1; padding: 16px 10px; 
    border: 1px solid rgba(255,255,255,0.1); border-radius: 2px;
    font-size: 14px; font-weight: 500; font-family: "Noto Sans TC"; letter-spacing: 2px;
    cursor: pointer; transition: all 0.3s;
    background: linear-gradient(145deg, rgba(35,35,40,0.9), rgba(25,25,30,0.9));
    color: var(--text-primary);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
button.action-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.5); filter: brightness(1.2); }

.btn-gold { border-color: var(--gold-luxury) !important; color: var(--gold-luxury) !important; }
.btn-gold:hover { background: rgba(197, 160, 89, 0.1) !important; color: #fff !important; }
.btn-green:hover { border-color: var(--success) !important; color: var(--success) !important; }
.btn-red:hover { border-color: var(--danger) !important; color: var(--danger) !important; }

/* --- ğŸŸ¢ ç·šä¸Šåå–®ä¿®å¾© (Wrap Layout) --- */
#onlineUserList {
    display: flex; gap: 8px; flex-wrap: wrap; /* é—œéµï¼šå…è¨±æ›è¡Œ */
    padding-bottom: 8px; align-items: center;
}

.online-pill {
    padding: 4px 10px; border-radius: 50px; font-size: 11px; 
    background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.15); 
    color: #ccc; display: flex; align-items: center; gap: 6px; 
    transition: 0.3s; margin-bottom: 4px; /* å¢åŠ è¡Œè· */
}
.online-dot { width: 6px; height: 6px; border-radius: 50%; background: #444; }
.online-pill.online .online-dot { background: var(--success); box-shadow: 0 0 5px var(--success); }
.online-pill.admin { 
    border-color: var(--gold-dark); color: var(--gold-luxury); 
    background: rgba(197, 160, 89, 0.08); padding-left: 10px;
}
.online-pill.admin::after { content: 'â™›'; font-size: 10px; margin-left: 2px; } 

/* --- åˆ—è¡¨é …ç›® (List Item) --- */
.list-container { max-height: 200px; overflow-y: auto; padding-right: 5px; }

.item-card { 
    background: linear-gradient(90deg, rgba(30,30,35,0.8), transparent); /* èƒŒæ™¯åŠ æ·±ï¼Œä¿®å¾©ç©ºæ´æ„Ÿ */
    margin-bottom: 6px; padding: 12px 16px; border-radius: 2px;
    border-left: 3px solid rgba(255,255,255,0.1); 
    display: flex; justify-content: space-between; align-items: center; 
    font-size: 14px; transition: 0.3s;
    border-bottom: 1px solid rgba(255,255,255,0.02);
}
.item-card:hover { background: rgba(255,255,255,0.08); transform: translateX(2px); border-left-color: var(--gold-luxury); }
.item-card.rank-1 { border-left-color: var(--gold-luxury); background: linear-gradient(90deg, rgba(197, 160, 89, 0.15), transparent); }
.item-card.rank-2 { border-left-color: #aaa; }

.btn-mini { padding: 3px 8px; font-size: 10px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: #aaa; cursor: pointer; margin-left: 8px; border-radius: 2px; }
.btn-mini:hover { color: #fff; border-color: #fff; background: rgba(255,255,255,0.1); }
.btn-arrow { background:none; border:none; color:#666; cursor:pointer; font-size:10px; transition:0.2s; margin-left:2px; }
.btn-arrow:hover { color:var(--gold-luxury); transform:scale(1.2); }

/* --- èŠå¤©å®¤ --- */
#comms.glass-panel { padding: 0; display: flex; flex-direction: column; }
#chat-header { 
    padding: 15px 20px; background: rgba(0,0,0,0.3); 
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.chat-title { 
    font-family: 'Noto Serif TC'; font-size: 13px; color: var(--gold-luxury); 
    letter-spacing: 2px; font-weight: 700; margin-bottom: 10px; display: block;
}

#chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }

.msg-bubble { 
    max-width: 85%; padding: 10px 14px; border-radius: 12px; 
    font-size: 13px; line-height: 1.5; position: relative; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.msg-mine { 
    align-self: flex-end; 
    background: linear-gradient(135deg, #333, #222); 
    border: 1px solid var(--gold-dark);
    color: var(--champagne); 
    border-bottom-right-radius: 2px;
}
.msg-other { 
    align-self: flex-start; 
    background: rgba(255,255,255,0.08); /* ç¨å¾®åŠ äº®å°è©±æ¡† */
    border: 1px solid rgba(255,255,255,0.05);
    color: #eee; 
    border-bottom-left-radius: 2px;
}
.msg-name { font-size: 10px; margin-bottom: 3px; opacity: 0.6; font-family: 'Noto Serif TC'; letter-spacing: 1px; }
.msg-img { max-width: 100%; border-radius: 4px; margin-top: 5px; border: 1px solid rgba(255,255,255,0.1); }

/* è¼¸å…¥å€ */
.input-area { padding: 15px; background: rgba(0,0,0,0.3); border-top: 1px solid rgba(255,255,255,0.05); display: flex; gap: 10px; align-items: center; }
input#msg { 
    flex: 1; background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.2);
    border-radius: 0; padding: 8px 0; color: #fff; font-family: "Noto Serif TC"; font-size: 14px;
    transition: .3s; 
}
input#msg:focus { border-bottom-color: var(--gold-luxury); }
.btn-tool { background: transparent; border: none; font-size: 18px; cursor: pointer; color: #666; transition: .3s; }
.btn-tool:hover { color: var(--gold-luxury); }
button.btn-send { 
    background: var(--gold-luxury); border: none; color: #000; 
    width: 36px; height: 36px; border-radius: 2px; cursor: pointer; 
    font-weight: bold; flex-shrink: 0; transition:0.3s;
}
button.btn-send:hover { background: #fff; transform: scale(1.05); }

/* --- ç°½åæ°´å° --- */
.kid-seal {
    position: fixed; bottom: 20px; right: 20px; z-index: 0;
    font-family: 'Ma Shan Zheng', cursive; font-size: 16px;
    color: rgba(255,255,255,0.03); writing-mode: vertical-rl;
    pointer-events: none;
}

/* --- Admin UI --- */
#adminModal { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); display: none; align-items: center; justify-content: center; }
#adminModal.show { display: flex; }
.admin-card { width: 450px; background: #0c0c0e; border: 1px solid var(--gold-dark); border-radius: 4px; padding: 35px; box-shadow: 0 0 60px rgba(0,0,0,0.9); }
select#adminUserSelect {
    appearance: none; -webkit-appearance: none;
    background: #1a1a1a url("data:image/svg+xml;utf8,<svg fill='gray' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>") no-repeat right 10px center;
    color: #fff; border: 1px solid #333; padding: 10px 15px; border-radius: 2px; font-family: "Noto Sans TC"; width: 100%;
}
select#adminUserSelect:focus { border-color: var(--gold-luxury); }

/* RWD */
@media (max-width: 900px) {
    #layout { flex-direction: column; padding: 10px; gap: 10px; }
    #dashboard { flex: none; width: 100%; min-width: 0; max-height: 55vh; }
    #comms { flex: 1; min-width: 0; height: 45vh; }
    .monitor-grid { grid-template-columns: 1fr; }
    .kid-seal { display: none; }
}
</style>
</head>

<body>
<div class="ambient-light"></div>
<canvas id="bg"></canvas>
<div class="noise"></div>

<div id="imgModal" onclick="this.style.display='none'" style="position: fixed; inset: 0; z-index: 300; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
    <img id="imgModalSrc" src="" style="max-width: 90%; max-height: 90%; border: 1px solid var(--gold-luxury); box-shadow: 0 0 50px rgba(0,0,0,0.5);">
</div>

<div id="broadcastBanner" style="position: fixed; top: -200px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; z-index: 9999; background: rgba(10, 10, 12, 0.95); border: 1px solid var(--gold-luxury); border-radius: 2px; padding: 25px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.9); transition: top 0.6s cubic-bezier(0.22, 1, 0.36, 1);">
    <h3 style="border:none; justify-content:center; color:var(--gold-luxury); margin-bottom:10px;">ğŸ“¢ é…’åº—è¡Œæ”¿å…¬å‘Š</h3>
    <p id="broadcastText" style="font-size:18px; font-weight:500; color:#fff; margin:0; font-family:'Noto Serif TC';">---</p>
</div>

<button id="btnAdminFloat" onclick="openAdmin()" style="display:none; position: fixed; bottom: 80px; left: 20px; z-index: 100; width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--gold-luxury); font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; backdrop-filter: blur(10px);">âš™ï¸</button>
<button id="btnGame" onclick="location.href='game.html'" title="å‰å¾€éŠæ¨‚å ´" style="position: fixed; bottom: 20px; left: 20px; z-index: 100; width: 45px; height: 45px; border-radius: 50%; background: rgba(0,0,0,0.6); border: 1px solid var(--success); color: var(--success); font-size: 20px; cursor: pointer; display: none; align-items: center; justify-content: center; transition: 0.3s; backdrop-filter: blur(10px);">ğŸ®</button>

<div class="kid-seal">KID ARCHITECT</div>

<div id="adminModal" onclick="if(event.target===this)closeAdmin()">
    <div class="admin-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h2 style="margin:0; color:var(--gold-luxury); font-family:'Noto Serif TC'; font-size:20px;">è¡Œæ”¿ç®¡ç†å°</h2>
            <button onclick="closeAdmin()" style="background:none; border:none; color:#666; cursor:pointer;">âœ•</button>
        </div>
        
        <div style="margin-bottom: 30px;">
            <h4 style="color:#888; font-size:11px; margin-bottom:12px; letter-spacing:1px;">QUEUE æ’éšŠç®¡ç†</h4>
            <div style="display:flex; gap:10px;">
                <select id="adminUserSelect"></select>
                <button onclick="adminForceAdd()" style="background:var(--gold-luxury); color:#000; border:none; padding:0 20px; font-weight:bold; cursor:pointer; border-radius:2px; flex-shrink:0;">åŠ å…¥</button>
            </div>
        </div>

        <div style="margin-bottom: 30px;">
            <h4 style="color:#888; font-size:11px; margin-bottom:12px; letter-spacing:1px;">BROADCAST å»£æ’­</h4>
            <div style="display:flex; gap:10px;">
                <input id="broadcastInput" style="flex:1; background:#1a1a1a; border:1px solid #333; padding:10px; color:#fff; border-radius:2px;" placeholder="è¼¸å…¥å…§å®¹...">
                <button onclick="sendBroadcast()" style="background:#333; color:#fff; border:1px solid #444; padding:0 15px; font-weight:bold; cursor:pointer; border-radius:2px; flex-shrink:0;">ç™¼é€</button>
            </div>
        </div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <button id="btnTogglePg" onclick="togglePlayground()" style="grid-column: span 2; padding: 14px; border-radius: 2px; border: 1px solid #333; background: #151515; color: #ccc; cursor: pointer;">éŠæ¨‚å ´é–‹é—œ</button>
            <button onclick="resetQueue()" style="padding: 14px; border-radius: 2px; border: 1px solid var(--danger); background: rgba(211, 47, 47, 0.05); color: var(--danger); cursor: pointer;">é‡ç½®ç³»çµ±</button>
            <button onclick="clearChat()" style="padding: 14px; border-radius: 2px; border: 1px solid #333; background: #151515; color: #ccc; cursor: pointer;">æ¸…ç©ºèŠå¤©</button>
            <button onclick="forceReload()" style="grid-column: span 2; padding: 14px; border-radius: 2px; border: 1px solid #333; background: #151515; color: #fff; cursor: pointer;">å…¨é«”å¼·åˆ¶åˆ·æ–°</button>
        </div>
    </div>
</div>

<div id="layout">
    <div id="dashboard">
        <div class="glass-panel" style="flex-shrink: 0;">
            <div class="status-header">
                <div class="user-badge" id="who">GUEST</div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-logout" onclick="enableNotification()" id="btnNotify" style="display:none;">ğŸ””</button>
                    <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
                </div>
            </div>
            <div id="clock">00:00:00</div>
            <div id="slotDisplay">---</div>
            <div id="status">ç³»çµ±é€£ç·šä¸­...</div>
            <div class="control-grid">
                <button id="bReserve" onclick="reserve()" class="action-btn btn-gold">é ç´„æ’éšŠ</button>
                <button id="bOut" onclick="goOut()" class="action-btn btn-green">ç¾åœ¨å‰å¾€</button>
                <button id="bBack" onclick="comeBack()" class="action-btn btn-red">ç¢ºèªè¿”å›</button>
                <button id="bCancel" onclick="cancelReserve()" class="action-btn">å–æ¶ˆé ç´„</button>
            </div>
        </div>

        <div class="monitor-grid">
            <div class="monitor-left">
                <div class="glass-panel">
                    <h3><span>å¤–å‡ºè²´è³“</span><span id="outCountNum" style="color:var(--success)">0 / 3</span></h3>
                    <div id="outList" class="list-container"></div>
                </div>
                <div class="glass-panel">
                    <h3><span>æ­·å²ç´€éŒ„</span></h3>
                    <div id="history" class="list-container"></div>
                </div>
            </div>
            <div class="monitor-right">
                <div class="glass-panel">
                    <h3><span>å€™ä½åå–®</span></h3>
                    <div id="queue" class="list-container"></div>
                </div>
            </div>
        </div>

        <div class="glass-panel" style="flex-shrink: 0;">
            <h3><span>SYSTEM LOG</span></h3>
            <div id="log" class="list-container" style="font-family: 'Rajdhani', monospace; font-size: 12px; color:#666; max-height:100px;"></div>
        </div>
    </div>

    <div id="comms" class="glass-panel">
        <div id="chat-header">
            <div class="chat-title">EXECUTIVE LOUNGE CHAT</div>
            <div id="onlineUserList"></div>
        </div>
        <div id="chat-box"></div>
        <div id="emojiPicker" style="position: absolute; bottom: 70px; left: 15px; width: 300px; background: rgba(15, 15, 20, 0.95); border: 1px solid var(--gold-dark); border-radius: 4px; padding: 10px; display: none; grid-template-columns: repeat(6, 1fr); gap: 5px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); backdrop-filter: blur(20px); z-index: 50;"></div>
        <div class="input-area">
            <input type="file" id="imgInput" hidden accept="image/*" onchange="handleFile(event)">
            <button class="btn-tool" onclick="document.getElementById('imgInput').click()" title="åœ–ç‰‡">ğŸ“·</button>
            <button class="btn-tool" onclick="toggleEmoji()" title="è¡¨æƒ…">ğŸ˜€</button>
            <input id="msg" placeholder="è¼¸å…¥è¨Šæ¯..." onkeydown="if(event.key==='Enter')send()" autocomplete="off">
            <button onclick="send()" class="btn-send">â¤</button>
        </div>
    </div>
</div>

<script>
/* --- Init --- */
const config={apiKey:"AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",authDomain:"smoke-queue.firebaseapp.com",databaseURL:"https://smoke-queue-default-rtdb.firebaseio.com",projectId:"smoke-queue"};
firebase.initializeApp(config);
const db=firebase.database(), auth=firebase.auth();
const queueRef=db.ref("queue"), userRef=db.ref("users"), chatRef=db.ref("chat"), logRef=db.ref("log"), broadcastRef=db.ref("broadcast"), configRef=db.ref("config");

let me, myData, engineReady=false, cacheQueue={}, currentSlotInfo={phase:'',slot:0}, allUsers={};
let audioCtx=null, notifyEnabled=false;
let playgroundEnabled = false;

function escapeHtml(text) {
    if (!text) return text;
    return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

/* --- é¦™æª³æ°£æ³¡ç²’å­ --- */
const canvas=document.getElementById("bg"), ctx=canvas.getContext("2d");
let w,h; function resize(){w=canvas.width=innerWidth;h=canvas.height=innerHeight;} window.onresize=resize; resize();
const particles=[]; 
for(let i=0;i<40;i++) particles.push({x:Math.random()*w, y:Math.random()*h, vy:Math.random()*0.3+0.1, size:Math.random()*1.5, alpha:Math.random()*0.5+0.1});
function draw(){
    ctx.clearRect(0,0,w,h);
    particles.forEach(p=>{
        p.y-=p.vy; if(p.y<0){p.y=h;p.x=Math.random()*w;}
        ctx.fillStyle=`rgba(197, 160, 89, ${p.alpha})`;
        ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
    });
    requestAnimationFrame(draw);
}
draw();

/* --- Auth --- */
auth.onAuthStateChanged(user=>{
    if(!user){location.href="login.html";return;} me=user;
    userRef.child(user.uid).on("value",s=>{
        myData=s.val()||{};
        document.getElementById("who").textContent=`${(myData.name||"GUEST").toUpperCase()}`;
        document.getElementById("btnAdminFloat").style.display=(myData.role==="admin")?"flex":"none";
        engineReady=true;
        
        // ğŸŸ¢ ä¿®å¾©ï¼šç¢ºä¿åå–®åŠ è¼‰é‚è¼¯æ­£ç¢º
        if(myData.role === "admin") { 
            userRef.on("value", snap => { 
                allUsers = snap.val() || {}; 
                // å¦‚æœç®¡ç†å“¡ Modal é–‹å•Ÿï¼Œå¯¦æ™‚æ›´æ–°é¸å–®
                if(document.getElementById('adminModal').classList.contains('show')){
                    updateAdminUserSelect(); 
                }
            }); 
        }
        
        renderStaticLists(); updateButtonStates(); renderOutList(); 
    });
    userRef.child(user.uid+"/online").set(true);
    userRef.child(user.uid+"/online").onDisconnect().set(false);
});
function logout(){auth.signOut().then(()=>{location.href="login.html";});}

/* --- Admin Logic --- */
function updateAdminUserSelect() {
    const sel = document.getElementById("adminUserSelect"); 
    sel.innerHTML = "<option value=''>é¸æ“‡è²´è³“...</option>";
    
    const userArray = Object.entries(allUsers).map(([uid, u]) => ({uid, ...u})).sort((a,b) => (a.name || "").localeCompare(b.name || ""));
    
    userArray.forEach(u => {
        let isReserved = cacheQueue.reserve && cacheQueue.reserve[u.uid];
        let isOut = cacheQueue.out && cacheQueue.out[u.uid];
        if(!isReserved && !isOut) { 
            let opt=document.createElement("option"); 
            opt.value=u.uid; 
            opt.textContent=u.name; 
            sel.appendChild(opt); 
        }
    });
}

function adminForceAdd() {
    const sel = document.getElementById("adminUserSelect");
    const uid = sel.value; 
    if(!uid) { alert("è«‹å…ˆé¸æ“‡ä¸€ä½è²´è³“"); return; }
    
    const u = allUsers[uid];
    if(u) {
        let h=new Date().getHours(), t=currentSlotInfo.phase==='RESERVE'?currentSlotInfo.slot:h;
        queueRef.child("reserve/"+uid).set({name: u.name, time: Date.now(), slot: t});
        addLog(`ADMIN é‚€è«‹: ${u.name}`); 
        closeAdmin();
    }
}

function openAdmin(){
    document.getElementById('adminModal').classList.add('show'); 
    // ğŸŸ¢ ç¢ºä¿æ¯æ¬¡æ‰“é–‹æ™‚åå–®éƒ½æ˜¯æœ€æ–°çš„
    if(Object.keys(allUsers).length > 0) {
        updateAdminUserSelect();
    } else {
        // å¦‚æœåå–®å°šæœªåŠ è¼‰ï¼Œå˜—è©¦æ‰‹å‹•æŠ“å–ä¸€æ¬¡
        userRef.once("value").then(snap => {
            allUsers = snap.val() || {};
            updateAdminUserSelect();
        });
    }
}
function closeAdmin(){document.getElementById('adminModal').classList.remove('show');}

function moveQueue(uid, direction) {
    if(!myData || myData.role !== 'admin') return;
    let r = cacheQueue.reserve || {};
    let sorted = Object.entries(r).sort((a,b) => a[1].time - b[1].time);
    let idx = sorted.findIndex(x => x[0] === uid);
    if (idx === -1) return;
    let targetIdx = idx + direction;
    if (targetIdx < 0 || targetIdx >= sorted.length) return;
    let targetUid = sorted[targetIdx][0];
    let myTime = sorted[idx][1].time; let targetTime = sorted[targetIdx][1].time;
    if (myTime === targetTime) { if(direction < 0) targetTime -= 1; else targetTime += 1; }
    queueRef.child('reserve/' + uid).update({ time: targetTime });
    queueRef.child('reserve/' + targetUid).update({ time: myTime });
}

function sendBroadcast(){const i=document.getElementById('broadcastInput');if(!i.value.trim())return;broadcastRef.set({text:i.value,t:Date.now()});i.value="";closeAdmin();}
broadcastRef.on("value",s=>{
    const v=s.val(); if(!v||Date.now()-v.t>10000)return;
    const b=document.getElementById('broadcastBanner');
    document.getElementById('broadcastText').textContent=v.text;
    b.style.top="30px"; playBeep('urgent'); setTimeout(()=>b.style.top="-200px",5000);
});

/* --- Chat --- */
const emojis = ["ğŸ˜€","ğŸ˜‚","ğŸ˜","ğŸ˜","ğŸ¤”","ğŸ˜­","ğŸ˜¡","ğŸ‘","ğŸ‘","ğŸš¬","ğŸ”¥","â˜•","ğŸº","ğŸ’¨","ğŸ‘€","â¤ï¸","âœ…","âŒ"];
const emojiPicker = document.getElementById("emojiPicker");
emojis.forEach(e => { const btn = document.createElement("button"); btn.className = "emoji-btn"; btn.textContent = e; btn.onclick = () => { document.getElementById("msg").value += e; toggleEmoji(); document.getElementById("msg").focus(); }; emojiPicker.appendChild(btn); });
function toggleEmoji() { emojiPicker.classList.toggle("show"); }
function handleFile(e) {
    const file = e.target.files[0]; if(!file) return;
    if(file.size > 2 * 1024 * 1024) { alert("åœ–ç‰‡éå¤§ (Max 2MB)"); return; }
    const reader = new FileReader();
    reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width, height = img.height;
            if (width > 400) { height *= 400 / width; width = 400; }
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
            chatRef.push({ name: myData.name, uid: me.uid, text: canvas.toDataURL('image/jpeg', 0.7), type: 'image', time: Date.now() });
        }
        img.src = event.target.result;
    }
    reader.readAsDataURL(file); e.target.value = '';
}
function send(){ let i=document.getElementById("msg"); if(!i.value.trim())return; chatRef.push({ name:myData.name, uid:me.uid, text:i.value, type: 'text', time:Date.now() }); i.value=""; emojiPicker.classList.remove("show"); }
chatRef.limitToLast(30).on("value",s=>{
    let b=document.getElementById("chat-box"); b.innerHTML="";
    s.forEach(x=>{
        let m=x.val(), meMsg=m.uid===me.uid;
        let div=document.createElement("div"); div.className=`msg-bubble ${meMsg?'msg-mine':'msg-other'}`;
        let content = m.type === 'image' ? `<img src="${m.text}" class="msg-img" onclick="showImg(this.src)">` : escapeHtml(m.text);
        div.innerHTML=`<div class="msg-name">${m.name}</div>${content}`;
        b.appendChild(div);
    });
    b.scrollTop=b.scrollHeight;
});
function showImg(src) { document.getElementById("imgModalSrc").src = src; document.getElementById("imgModal").style.display = "flex"; }

/* --- Core --- */
function format12H(d){return d.toLocaleTimeString('en-US',{hour12:true,hour:'2-digit',minute:'2-digit',second:'2-digit'});}
function getSlotStatus(h,m){
    const slots=[14,16,18,20,22,0];
    let currentSlot=slots.find(s=>s===h);
    const to12HStr = (hr) => { let suffix = (hr >= 12 && hr < 24) ? "PM" : "AM"; let dH = (hr % 12) || 12; return `${dH}:00 ${suffix}`; };
    if(currentSlot!==undefined){ return {phase:'OUT',slot:currentSlot,display:`${to12HStr(currentSlot)} é–‹æ”¾æ™‚æ®µ`}; }
    let target=slots.find(s=>(s===0?24:s)>h)||14;
    let diff=(target===0?24:target)*60-(h*60+m);
    if(diff>0&&diff<=30){ return {phase:'RESERVE',slot:target,display:`é ç´„ä¸­ ${to12HStr(target)}`}; }
    return {phase:'BREAK',nextSlot:target,display:`ä¸‹å€‹æ™‚æ®µ ${to12HStr(target)}`, hint:''};
}
setInterval(()=>{
    if(!engineReady)return;
    const now=new Date(), h=now.getHours(), m=now.getMinutes();
    document.getElementById("clock").textContent=format12H(now);
    currentSlotInfo=getSlotStatus(h,m);
    let dText = currentSlotInfo.display;
    if(currentSlotInfo.phase === 'BREAK') dText += ` (ä¼‘æ¯ä¸­)`;
    document.getElementById("slotDisplay").textContent=dText;
    if(h===1&&m===0&&now.getSeconds()===0&&myData.role==="admin") resetQueue();
    updateButtonStates(); renderOutList(); 
},1000);
queueRef.on("value",s=>{ cacheQueue=s.val()||{}; if(engineReady){ renderStaticLists(); updateButtonStates(); renderOutList(); } });

function updateButtonStates(){
    if(!me||!cacheQueue)return;
    let r=cacheQueue.reserve||{},o=cacheQueue.out||{},used=cacheQueue.used||{};
    let sorted=Object.entries(r).sort((a,b)=>a[1].time-b[1].time);
    let outCount=Object.keys(o).length;
    let myRank=sorted.findIndex(x=>x[0]===me.uid);
    let alreadyUsed = used[currentSlotInfo.slot]?.[me.uid];
    const hideAll = () => { bReserve.style.display='none'; bOut.style.display='none'; bBack.style.display='none'; bCancel.style.display='none'; }; hideAll();
    if(alreadyUsed) {} 
    else if(o[me.uid]) { bBack.style.display='block'; } 
    else if(r[me.uid]) { bCancel.style.display='block'; if(currentSlotInfo.phase==='OUT' && myRank<=1 && outCount<3){ bOut.style.display='block'; } } 
    else { bReserve.style.display='block'; }
    let st=document.getElementById("status");
    if(alreadyUsed) st.innerHTML="<span style='color:#666'>æœ¬æ™‚æ®µå·²äº«ç”¨</span>";
    else if(o[me.uid]) st.innerHTML="<span style='color:var(--success)'>â— ä½¿ç”¨ä¸­ (ENJOYING)</span>";
    else if(r[me.uid]) {
        if(currentSlotInfo.phase==='OUT'){
            if(myRank<=1&&outCount<3) st.innerHTML="<span style='color:var(--success)'>åé¡é–‹æ”¾ï¼Œè«‹å‡ºç™¼</span>";
            else if(outCount>=3) st.innerHTML="<span style='color:var(--gold-luxury)'>æ»¿ä½ç­‰å€™ä¸­...</span>";
            else st.innerHTML=`<span>ç­‰å¾…é †ä½: ${myRank+1}</span>`;
        } else st.innerHTML="<span style='color:var(--gold-luxury)'>é ç´„æˆåŠŸ (å¾…é–‹æ”¾)</span>";
    } else {
        if(currentSlotInfo.phase==='BREAK') st.innerHTML="<span style='color:#555'>ç­‰å¾…ä¸‹ä¸€æ™‚æ®µ</span>";
        else if(currentSlotInfo.phase==='RESERVE') st.innerHTML="<span style='color:var(--success)'>é–‹æ”¾é ç´„ä¸­</span>";
        else st.innerHTML="<span style='color:#666'>å°šæœªé ç´„</span>";
    }
    document.getElementById("outCountNum").textContent=`${outCount} / 3`;
}

function renderStaticLists(){
    let r=cacheQueue.reserve||{}, sorted=Object.entries(r).sort((a,b)=>a[1].time-b[1].time);
    document.getElementById("queue").innerHTML=sorted.map((u,i)=>{
        let btn=(myData&&myData.role==="admin")?`<button onclick="forceGoOut('${u[0]}')" class="btn-mini" style="color:var(--success);border-color:var(--success);">æ´¾ç™¼</button>`:"";
        let moveBtns = (myData&&myData.role==="admin")?`<button onclick="moveQueue('${u[0]}',-1)" class="btn-arrow">â–²</button><button onclick="moveQueue('${u[0]}',1)" class="btn-arrow">â–¼</button>`:"";
        let rc=i===0?'rank-1':(i===1?'rank-2':'');
        return `<div class="item-card ${rc}"><div><span style="font-family:'Rajdhani';color:var(--gold-luxury);margin-right:8px;font-weight:bold;">${i+1}</span><strong>${u[1].name}</strong></div><div style="display:flex;align-items:center;"><small style='opacity:0.4;margin-right:5px;font-family:"Rajdhani"'>${new Date(u[1].time).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'})}</small>${btn}${moveBtns}</div></div>`;
    }).join('')||"<div style='opacity:0.3;padding:10px;text-align:center;'>ç›®å‰ç©ºé–’</div>";

    let hist=[]; if(cacheQueue.history)Object.values(cacheQueue.history).forEach(h=>hist.push({...h,sortT:h.backTime}));
    let o=cacheQueue.out||{}; 
    Object.entries(o).forEach(([uid,u])=>{if(Math.floor((Date.now()-u.time)/1000)>600)hist.push({name:u.name,outTime:u.time,backTime:null,over:true,sortT:Date.now()});});
    document.getElementById("history").innerHTML=hist.sort((a,b)=>b.sortT-a.sortT).slice(0,20).map(i=>`<div class="item-card" style="padding:10px 16px;border:none;background:rgba(255,255,255,0.01);"><span>${i.name} ${i.over?'<span style="color:var(--danger)">!</span>':''}</span><small style='opacity:0.5;font-family:"Rajdhani"'>${new Date(i.outTime).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'})} - ${i.backTime?new Date(i.backTime).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'}):'OUT'}</small></div>`).join('');
}

function renderOutList(){
    let o=cacheQueue.out||{}; 
    document.getElementById("outList").innerHTML=Object.entries(o).map(([uid,u])=>{
        let s=Math.floor((Date.now()-u.time)/1000);
        let btn=(myData&&myData.role==="admin")?`<button onclick="forceComeBack('${uid}')" class="btn-mini" style="color:var(--danger);border-color:var(--danger);">å¬å›</button>`:"";
        return `<div class="item-card" style="border-left-color:var(--success);"><strong>${u.name}</strong><div style="display:flex;align-items:center;gap:8px;"><span class="${s>600?'text-danger':''}" style="font-family:'Rajdhani';color:${s>600?'var(--danger)':'#aaa'}">${Math.floor(s/60)}m ${s%60}s</span>${btn}</div></div>`;
    }).join('')||"<div style='opacity:0.3;padding:10px;text-align:center;'>ç„¡äººå¤–å‡º</div>";
}

/* --- Misc --- */
function enableNotification(){if(!("Notification" in window))return;Notification.requestPermission().then(p=>{if(p==="granted"){notifyEnabled=true;playBeep();document.getElementById("btnNotify").style.display="none";}});}
if(Notification.permission!=="granted") document.getElementById("btnNotify").style.display="inline-block";
function playBeep(t='normal'){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);if(t==='urgent'){o.frequency.value=880;o.type='square';o.start();setTimeout(()=>o.stop(),100);setTimeout(()=>{const o2=audioCtx.createOscillator(),g2=audioCtx.createGain();o2.connect(g2);g2.connect(audioCtx.destination);o2.frequency.value=880;o2.type='square';o2.start();setTimeout(()=>o2.stop(),100);},150);}else{o.frequency.value=523.25;o.type='sine';g.gain.setValueAtTime(0.05,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.00001,audioCtx.currentTime+0.5);o.start();o.stop(audioCtx.currentTime+0.5);}}
function forceComeBack(uid){if(confirm("å¼·åˆ¶å¬å›ï¼Ÿ"))queueRef.child("out/"+uid).once("value").then(s=>{let u=s.val();if(u){let now=Date.now(),slot=new Date(u.time).getHours();queueRef.child(`used/${slot}/${uid}`).set(true);queueRef.child("history").push({name:u.name,slot,outTime:u.time,backTime:now,over:(now-u.time)>600000});queueRef.child("out/"+uid).remove();addLog(`ADMIN å¬å›: ${u.name}`);}});}
function forceGoOut(uid){if(confirm("å¼·åˆ¶æ´¾ç™¼ï¼Ÿ"))queueRef.child("reserve/"+uid).once("value").then(s=>{let u=s.val();if(u){queueRef.child("out/"+uid).set({name:u.name,time:Date.now()}).then(()=>{queueRef.child("reserve/"+uid).remove();addLog(`ADMIN æ´¾ç™¼: ${u.name}`);});}});}
function forceReload(){db.ref("reload").set(Date.now());}
function resetQueue(){ if(confirm("ç¢ºå®šæ¸…ç©ºç‹€æ…‹ï¼Ÿ")) { queueRef.child("reserve").remove(); queueRef.child("out").remove(); queueRef.child("used").remove(); addLog("ADMIN é‡ç½®ç³»çµ±"); } }
function clearChat(){ if(confirm("æ¸…ç©ºèŠå¤©å®¤ï¼Ÿ")) chatRef.remove(); }
function clearHistory(){ if(confirm("æ¸…ç©ºæ­·å²ç´€éŒ„ï¼Ÿ")) queueRef.child("history").remove(); }
function clearLog(){ if(confirm("æ¸…ç©ºç³»çµ±æ—¥èªŒï¼Ÿ")) logRef.remove(); }
function addLog(t){logRef.push({t,time:Date.now()});}
logRef.limitToLast(15).on("value",s=>{const b=document.getElementById("log");b.innerHTML="";s.forEach(x=>{let d=x.val();let dv=document.createElement("div");dv.innerHTML=`<span style="opacity:0.5;font-family:'Rajdhani'">[${new Date(d.time).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'})}]</span> ${d.t}`;b.appendChild(dv);});b.scrollTop=b.scrollHeight;});
function reserve(){ if(currentSlotInfo.phase === 'BREAK'){ alert(`å°šæœªé–‹æ”¾é ç´„`); return; } let h=new Date().getHours(),t=currentSlotInfo.phase==='RESERVE'?currentSlotInfo.slot:h; queueRef.child("reserve/"+me.uid).set({name:myData.name,time:Date.now(),slot:t}); if(Notification.permission!=="granted")enableNotification(); addLog(`${myData.name} é ç´„`); }
function cancelReserve(){queueRef.child("reserve/"+me.uid).remove();addLog(`${myData.name} å–æ¶ˆ`);}
function goOut(){queueRef.child("out/"+me.uid).set({name:myData.name,time:Date.now()}).then(()=>{queueRef.child("reserve/"+me.uid).remove();addLog(`${myData.name} å‡ºç™¼`);});}
function comeBack(){queueRef.child("out/"+me.uid).once("value").then(s=>{let u=s.val();if(u){let now=Date.now(),slot=new Date(u.time).getHours();queueRef.child(`used/${slot}/${me.uid}`).set(true);queueRef.child("history").push({name:u.name,slot,outTime:u.time,backTime:now,over:(now-u.time)>600000});queueRef.child("out/"+me.uid).remove();addLog(`${myData.name} è¿”å›`);}});}
configRef.child("playground_status").on("value", s => { playgroundEnabled = s.val() || false; document.getElementById("btnGame").style.display = playgroundEnabled ? "flex" : "none"; document.getElementById("btnTogglePg").textContent = playgroundEnabled ? "éŠæ¨‚å ´ç‹€æ…‹: é–‹å•Ÿ" : "éŠæ¨‚å ´ç‹€æ…‹: é—œé–‰"; });
function togglePlayground() { configRef.child("playground_status").set(!playgroundEnabled); }
userRef.on("value",s=>{ const list=document.getElementById("onlineUserList"); list.innerHTML=""; s.forEach(u=>{ let d=u.val(); if(d.online){ let pill = document.createElement("div"); pill.className = `online-pill online ${d.role==='admin' ? 'admin' : ''}`; pill.innerHTML = `<div class="online-dot"></div>${d.name}`; list.appendChild(pill); }}); });
let fR=true;db.ref("reload").on("value",s=>{if(fR){fR=false;return;}location.reload();});
</script>
</body>
</html>
