<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°Šçˆµå¸è¸å®¤ v5.4 - Button Logic</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&family=Rajdhani:wght@500;600;700&display=swap');

:root {
    --gold: #ffd700;
    --gold-glow: rgba(255, 215, 0, 0.5);
    --bg-dark: #05060a;
    --glass: rgba(13, 14, 20, 0.85);
    --glass-border: rgba(255, 255, 255, 0.08);
    --text-main: #e0e0e0;
    --success: #00ff9d;
    --danger: #ff4757;
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

body {
    margin: 0;
    font-family: "Noto Sans TC", sans-serif;
    background: var(--bg-dark);
    color: var(--text-main);
    display: flex;
    height: 100vh;
    overflow: hidden;
    font-size: 15px;
}

/* --- èƒŒæ™¯ç‰¹æ•ˆ --- */
canvas#bg { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
.overlay { position: fixed; inset: 0; background: radial-gradient(circle at center, transparent 0%, #000 95%); z-index: 0; pointer-events: none; }
.noise { position: fixed; inset: 0; z-index: 0; opacity: 0.05; background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJuIj48ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iMC42IiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI24pIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4='); pointer-events: none; }

/* --- ä¸»ä½ˆå±€ --- */
#layout {
    display: flex; width: 100%; height: 100%;
    z-index: 1; position: relative; padding: 20px; gap: 20px;
}

#dashboard {
    flex: 1.8; display: flex; flex-direction: column; gap: 16px;
    overflow-y: auto; padding-right: 6px; min-width: 400px;
}

#comms {
    flex: 1; display: flex; flex-direction: column; gap: 0;
    min-width: 320px; height: 100%; overflow: hidden;
}

/* --- ç›£æ§ç¶²æ ¼ --- */
.monitor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.monitor-left { display: flex; flex-direction: column; gap: 16px; }
.monitor-right { display: flex; flex-direction: column; }
.monitor-right .glass-panel { flex: 1; display: flex; flex-direction: column; }
.monitor-right .list-container { flex: 1; max-height: none; }

/* --- ç»ç’ƒå¡ç‰‡ --- */
.glass-panel {
    background: var(--glass);
    backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
    border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6); position: relative; flex-shrink: 0;
}
.glass-panel:hover { border-color: rgba(255, 215, 0, 0.2); }
.glass-panel::after {
    content: ""; position: absolute; inset: 0; border-radius: 16px; padding: 1px;
    background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent 40%, transparent 60%, rgba(255,215,0,0.1));
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor; pointer-events: none;
}

/* --- ç‹€æ…‹åˆ— --- */
.status-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
.user-badge { 
    background: linear-gradient(90deg, rgba(255,215,0,0.1), transparent); 
    padding: 4px 12px; border-radius: 4px; font-size: 13px; 
    border-left: 3px solid var(--gold); color: #fff; letter-spacing: 1px;
    font-weight: 500; display: flex; align-items: center;
}
.btn-logout { 
    background: transparent; border: 1px solid #444; color: #888; cursor: pointer; 
    padding: 4px 10px; border-radius: 6px; font-size: 10px; transition: .3s; margin-left: 10px;
}
.btn-logout:hover { border-color: var(--danger); color: var(--danger); }

#clock {
    font-family: 'Rajdhani', sans-serif; font-size: 44px; line-height: 1;
    font-weight: 700; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.15);
    margin: 12px 0 8px; letter-spacing: 2px;
}
#slotDisplay { font-size: 14px; color: var(--gold); letter-spacing: 1px; font-weight: 500; opacity: 0.9; }
#status { font-size: 18px; font-weight: 700; margin: 5px 0 15px; min-height: 24px; letter-spacing: 1px; }

/* --- æŒ‰éˆ•ç³»çµ± (Core Update) --- */
.control-grid { display: grid; grid-template-columns: 1.5fr 1fr 1fr 1fr; gap: 12px; margin-top: 15px; }

button.action-btn {
    padding: 16px 8px; border-radius: 10px; font-size: 14px; font-weight: 700;
    cursor: pointer; transition: all 0.2s; font-family: "Noto Sans TC", sans-serif;
    position: relative; overflow: hidden; border: 1px solid transparent;
}

/* 1. é‡‘è‰² (é ç´„ - é–’ç½®ç‹€æ…‹) */
.btn-gold {
    background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%);
    color: #000 !important; border: none;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    animation: goldPulse 3s infinite;
}
@keyframes goldPulse { 0%{box-shadow: 0 0 10px rgba(255,215,0,0.2);} 50%{box-shadow: 0 0 25px rgba(255,215,0,0.5);} 100%{box-shadow: 0 0 10px rgba(255,215,0,0.2);} }
.btn-gold:hover { transform: translateY(-2px); filter: brightness(1.1); }

/* 2. é»‘è‰² (åœç”¨/ç­‰å¾…/å·²é ç´„) */
.btn-black {
    background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
    color: #666 !important; cursor: not-allowed;
}

/* 3. ç´…è‰² (å–æ¶ˆ/å›ä¾† - å¼·èª¿å‹•ä½œ) */
.btn-red {
    background: rgba(255, 71, 87, 0.15); border: 1px solid var(--danger);
    color: var(--danger) !important;
}
.btn-red:hover { background: var(--danger); color: #fff !important; box-shadow: 0 0 15px rgba(255, 71, 87, 0.4); }

/* 4. ç¶ è‰² (å¯ä»¥å‡ºå» - é€šè¡Œ) */
.btn-green {
    background: rgba(0, 255, 157, 0.15); border: 1px solid var(--success);
    color: var(--success) !important;
}
.btn-green:hover { background: var(--success); color: #000 !important; box-shadow: 0 0 15px rgba(0, 255, 157, 0.4); }

/* 5. ç°è‰² (æœ¬æ™‚æ®µå·²çµæŸ) */
.btn-grey {
    background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);
    color: #444 !important; pointer-events: none;
}

/* --- åˆ—è¡¨èˆ‡æ¨™é¡Œ --- */
h3 {
    margin: 0 0 12px 0; font-size: 13px; color: var(--gold); text-transform: uppercase;
    letter-spacing: 2px; display: flex; align-items: center; gap: 8px;
    font-family: 'Cinzel', serif; border-bottom: 1px solid rgba(255,255,255,0.06); padding-bottom: 8px;
}
.list-container { max-height: 150px; overflow-y: auto; padding-right: 4px; }
.item-card {
    background: linear-gradient(90deg, rgba(255,255,255,0.03), transparent);
    margin-bottom: 6px; padding: 10px 14px; border-radius: 8px; 
    border-left: 2px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between;
    align-items: center; font-size: 14px;
}
.item-card.rank-1 { border-left-color: var(--gold); background: linear-gradient(90deg, rgba(255,215,0,0.1), transparent); }
.item-card.rank-2 { border-left-color: #c0c0c0; }

.btn-mini { padding: 2px 8px; font-size: 10px; border-radius: 4px; cursor: pointer; margin-left: 8px; border: 1px solid; background: transparent; }
.btn-mini.danger { color: var(--danger); border-color: var(--danger); }
.btn-mini.danger:hover { background: var(--danger); color: #fff; }
.btn-mini.success { color: var(--success); border-color: var(--success); }
.btn-mini.success:hover { background: var(--success); color: #000; }

/* --- èŠå¤©å®¤ --- */
#chat-header {
    padding: 16px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--glass-border);
    font-size: 12px; letter-spacing: 2px; display: flex; flex-direction: column; gap: 10px;
}
#chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
.msg-bubble { max-width: 85%; padding: 8px 12px; border-radius: 12px; font-size: 13px; line-height: 1.5; word-break: break-all; }
.msg-mine { align-self: flex-end; background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; border-bottom-right-radius: 2px; }
.msg-other { align-self: flex-start; background: rgba(255,255,255,0.08); color: #ccc; border-bottom-left-radius: 2px; }
.msg-name { font-size: 10px; margin-bottom: 2px; opacity: 0.7; font-weight: 700; }
.input-area { padding: 12px; background: rgba(0,0,0,0.2); border-top: 1px solid var(--glass-border); display: flex; gap: 8px; }
input#msg { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 10px 16px; color: #fff; transition: .3s; }
input#msg:focus { border-color: var(--gold); }
button.btn-send { background: var(--gold); border: none; color: #000; border-radius: 50%; width: 38px; height: 38px; cursor: pointer; font-weight: bold; }

/* --- Admin UI --- */
#btnAdminFloat {
    position: fixed; bottom: 20px; left: 20px; z-index: 100;
    width: 45px; height: 45px; border-radius: 50%;
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    color: var(--gold); font-size: 20px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: 0.3s; backdrop-filter: blur(10px);
}
#btnAdminFloat:hover { background: var(--gold); color: #000; transform: rotate(90deg); box-shadow: 0 0 20px var(--gold-glow); }

#adminModal {
    position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
    display: none; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.3s;
}
#adminModal.show { display: flex; opacity: 1; }

.admin-card {
    width: 420px; background: #111; border: 1px solid var(--gold);
    border-radius: 20px; padding: 30px;
    box-shadow: 0 0 50px rgba(255, 215, 0, 0.15);
    transform: translateY(20px); transition: transform 0.3s;
}
#adminModal.show .admin-card { transform: translateY(0); }

.admin-section { margin-bottom: 25px; }
.admin-section h4 { color: #888; font-size: 11px; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 5px; }
.admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

.btn-admin-action {
    padding: 12px; border-radius: 8px; border: 1px solid #333;
    background: #1a1a1a; color: #ccc; cursor: pointer; transition: 0.2s; font-size: 13px;
}
.btn-admin-action:hover { border-color: #fff; color: #fff; background: #222; }
.btn-admin-action.danger { color: var(--danger); border-color: rgba(255, 71, 87, 0.3); }
.btn-admin-action.danger:hover { background: var(--danger); color: #fff; }

.broadcast-input { width: 100%; background: #222; border: 1px solid #444; padding: 10px; color: #fff; border-radius: 6px; margin-bottom: 8px; }
.btn-broadcast { width: 100%; background: var(--gold); color: #000; border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; }

/* --- å»£æ’­æ©«å¹… --- */
#broadcastBanner {
    position: fixed; top: -200px; left: 50%; transform: translateX(-50%);
    width: 90%; max-width: 600px; z-index: 9999;
    background: rgba(10, 10, 10, 0.95); border: 2px solid var(--gold);
    border-radius: 12px; padding: 25px; text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.9), 0 0 40px rgba(255, 215, 0, 0.2);
    transition: top 0.6s cubic-bezier(0.22, 1, 0.36, 1);
}
#broadcastBanner.active { top: 30px; }
#broadcastBanner h3 { color: var(--gold); justify-content: center; font-size: 16px; margin-bottom: 10px; border:none; }
#broadcastBanner p { font-size: 20px; color: #fff; margin: 0; font-weight: 700; line-height: 1.4; }

/* --- Online List --- */
#onlineUserList { display: flex; gap: 6px; flex-wrap: wrap; width: 100%; }
.online-pill {
    padding: 4px 10px; border-radius: 20px; font-size: 11px;
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
    color: #aaa; white-space: nowrap; transition: 0.3s; display: flex; align-items: center; gap: 5px;
}
.online-pill.admin { border-color: var(--gold); color: var(--gold); background: rgba(255,215,0,0.05); }
.online-pill:hover { background: rgba(255,255,255,0.1); transform: translateY(-1px); }
.online-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; }
.online-pill.online .online-dot { background: var(--success); box-shadow: 0 0 5px var(--success); }

::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

@media (max-width: 900px) {
    #layout { flex-direction: column; padding: 10px; }
    #dashboard { flex: none; width: 100%; min-width: 0; max-height: 60vh; }
    #comms { flex: 1; min-width: 0; height: 40vh; }
    .control-grid { grid-template-columns: 1fr 1fr; }
    button#bReserve { grid-column: span 2; }
    .monitor-grid { grid-template-columns: 1fr; }
}
</style>
</head>

<body>
<canvas id="bg"></canvas>
<div class="overlay"></div>
<div class="noise"></div>

<div id="broadcastBanner">
    <h3><i class="icon">ğŸ“¢</i> ç³»çµ±å…¬å‘Š BROADCAST</h3>
    <p id="broadcastText">---</p>
</div>

<button id="btnAdminFloat" onclick="openAdmin()" style="display:none;">âš™ï¸</button>

<div id="adminModal" onclick="if(event.target===this)closeAdmin()">
    <div class="admin-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; color:var(--gold); font-family:'Cinzel'">Admin Console</h2>
            <button onclick="closeAdmin()" style="background:none; border:none; color:#666; cursor:pointer;">âœ•</button>
        </div>

        <div class="admin-section">
            <h4>Broadcast å»£æ’­ç³»çµ±</h4>
            <input id="broadcastInput" class="broadcast-input" placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹...">
            <button onclick="sendBroadcast()" class="btn-broadcast">ç™¼é€å…¨åŸŸå»£æ’­</button>
        </div>

        <div class="admin-section">
            <h4>System Control ç³»çµ±ç¶­è­·</h4>
            <div class="admin-grid">
                <button onclick="resetQueue()" class="btn-admin-action danger">é‡ç½®ç³»çµ± (å«æ’éšŠ)</button>
                <button onclick="clearChat()" class="btn-admin-action">æ¸…ç©ºèŠå¤©å®¤</button>
                <button onclick="clearHistory()" class="btn-admin-action">æ¸…ç©ºæ­·å²ç´€éŒ„</button>
                <button onclick="clearLog()" class="btn-admin-action">æ¸…ç©ºç³»çµ±æ—¥èªŒ</button>
                <button onclick="forceReload()" class="btn-admin-action" style="grid-column: span 2;">å…¨é«”å¼·åˆ¶åˆ·æ–°</button>
            </div>
        </div>
    </div>
</div>

<div id="layout">
    <div id="dashboard">
        <div class="glass-panel" style="flex-shrink: 0;">
            <div class="status-header">
                <div style="display: flex; align-items: center;">
                    <span class="user-badge" id="who">é€£ç·šä¸­...</span>
                    <button class="btn-logout" onclick="enableNotification()" id="btnNotify" style="display:none;">ğŸ”” é€šçŸ¥</button>
                    <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
                </div>
                <div id="slotDisplay">---</div>
            </div>
            
            <div id="clock">00:00:00 PM</div>
            <div id="status">ç³»çµ±åˆå§‹åŒ–...</div>

            <div class="control-grid">
                <button id="bReserve" onclick="reserve()" class="action-btn">é ç´„æ’éšŠ</button>
                <button id="bOut" onclick="goOut()" class="action-btn">ç¾åœ¨å‡ºå»</button>
                <button id="bBack" onclick="comeBack()" class="action-btn">æˆ‘å›ä¾†äº†</button>
                <button id="bCancel" onclick="cancelReserve()" class="action-btn">å–æ¶ˆé ç´„</button>
            </div>
        </div>

        <div class="monitor-grid">
            <div class="monitor-left">
                <div class="glass-panel">
                    <h3>å¤–å‡ºä¸­ (<span id="outCountNum" style="color:var(--success)">0</span>/3)</h3>
                    <div id="outList" class="list-container"></div>
                </div>
                
                <div class="glass-panel">
                    <h3>è¿‘æœŸç´€éŒ„</h3>
                    <div id="history" class="list-container"></div>
                </div>
            </div>

            <div class="monitor-right">
                <div class="glass-panel">
                    <h3>æ’éšŠåå–®</h3>
                    <div id="queue" class="list-container"></div>
                </div>
            </div>
        </div>

        <div class="glass-panel" style="flex-shrink: 0;">
            <h3>ç³»çµ±æ—¥èªŒ</h3>
            <div id="log" class="list-container" style="font-family: 'Rajdhani', monospace; font-size: 12px; color:#666; max-height:100px;"></div>
        </div>
    </div>

    <div id="comms" class="glass-panel" style="padding:0;">
        <div id="chat-header">
            <div style="font-weight:bold; color:#888; margin-bottom:5px;">LOUNGE CHAT</div>
            <div id="onlineUserList"></div>
        </div>
        
        <div id="chat-box"></div>
        
        <div class="input-area">
            <input id="msg" placeholder="è¼¸å…¥è¨Šæ¯..." onkeydown="if(event.key==='Enter')send()" autocomplete="off">
            <button onclick="send()" class="btn-send">â¤</button>
        </div>
    </div>
</div>

<script>
/* --- Canvas & Setup --- */
const canvas=document.getElementById("bg"), ctx=canvas.getContext("2d");
let w,h; function resize(){w=canvas.width=innerWidth;h=canvas.height=innerHeight;} window.onresize=resize; resize();
const particles=[]; for(let i=0;i<50;i++)particles.push({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-.5)*.2,vy:(Math.random()-.5)*.2,size:Math.random()*2+.5,alpha:Math.random()*.5+.1});
function draw(){ctx.clearRect(0,0,w,h);for(let p of particles){p.x+=p.vx;p.y+=p.vy;if(p.x<0||p.x>w)p.vx*=-1;if(p.y<0||p.y>h)p.vy*=-1;ctx.fillStyle=`rgba(255,215,0,${p.alpha})`;ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,6.28);ctx.fill();}requestAnimationFrame(draw);}draw();

/* --- Firebase --- */
const config={apiKey:"AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",authDomain:"smoke-queue.firebaseapp.com",databaseURL:"https://smoke-queue-default-rtdb.firebaseio.com",projectId:"smoke-queue"};
firebase.initializeApp(config);
const db=firebase.database(), auth=firebase.auth();
const queueRef=db.ref("queue"), userRef=db.ref("users"), chatRef=db.ref("chat"), logRef=db.ref("log"), broadcastRef=db.ref("broadcast");

let me, myData, engineReady=false, cacheQueue={};
let currentSlotInfo={phase:'',slot:0};
let audioCtx=null, notifyEnabled=false;
let hasNotifiedReady=false, hasNotifiedOvertime=false;

/* --- Admin Logic --- */
function openAdmin(){ document.getElementById('adminModal').classList.add('show'); }
function closeAdmin(){ document.getElementById('adminModal').classList.remove('show'); }

/* --- Broadcast --- */
function sendBroadcast(){
    const input = document.getElementById('broadcastInput');
    if(!input.value.trim()) return;
    broadcastRef.set({ text: input.value, t: Date.now() });
    input.value = "";
    closeAdmin();
}
broadcastRef.on("value", s => {
    const val = s.val();
    if(!val) return;
    if(Date.now() - val.t > 10000) return;
    
    const banner = document.getElementById('broadcastBanner');
    document.getElementById('broadcastText').textContent = val.text;
    banner.classList.add('active');
    playBeep('urgent');
    setTimeout(() => { banner.classList.remove('active'); }, 5000);
});

/* --- Notifications --- */
function enableNotification(){
    if(!("Notification" in window))return;
    Notification.requestPermission().then(p=>{if(p==="granted"){notifyEnabled=true;playBeep();document.getElementById("btnNotify").style.display="none";}});
}
if(Notification.permission!=="granted") document.getElementById("btnNotify").style.display="inline-block";

function playBeep(type='normal'){
    if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);
    if(type==='urgent'){o.frequency.value=880;o.type='square';o.start();setTimeout(()=>o.stop(),100);setTimeout(()=>{const o2=audioCtx.createOscillator(),g2=audioCtx.createGain();o2.connect(g2);g2.connect(audioCtx.destination);o2.frequency.value=880;o2.type='square';o2.start();setTimeout(()=>o2.stop(),100);},150);}
    else{o.frequency.value=523.25;o.type='sine';g.gain.setValueAtTime(0.05,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.00001,audioCtx.currentTime+0.5);o.start();o.stop(audioCtx.currentTime+0.5);}
}
function sendNotify(t,b,u=false){if(notifyEnabled){playBeep(u?'urgent':'normal');new Notification(t,{body:b});}}

/* --- Core Logic --- */
function format12H(d){ return d.toLocaleTimeString('en-US',{hour12:true,hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
function getSlotStatus(h,m){
    const slots=[14,16,18,20,22,0];
    let currentSlot=slots.find(s=>s===h);
    const to12HStr = (hr) => { let suffix = (hr >= 12 && hr < 24) ? "PM" : "AM"; let dH = (hr % 12) || 12; return `${dH}:00 ${suffix}`; };
    const toOpenStr = (hr) => { let openH = (hr === 0) ? 23 : hr - 1; let suffix = (openH >= 12 && openH < 24) ? "PM" : "AM"; let dH = (openH % 12) || 12; return `${dH}:30 ${suffix}`; };

    if(currentSlot!==undefined){ return {phase:'OUT',slot:currentSlot,display:`${to12HStr(currentSlot)} é–‹æ”¾æ™‚æ®µ`}; }
    let target=slots.find(s=>(s===0?24:s)>h)||14;
    let diff=(target===0?24:target)*60-(h*60+m);
    if(diff>0&&diff<=30){ return {phase:'RESERVE',slot:target,display:`é ç´„ä¸­ ${to12HStr(target)}`}; }
    return {phase:'BREAK',nextSlot:target,display:`ä¸‹å€‹æ™‚æ®µ ${to12HStr(target)}`, hint:`${toOpenStr(target)} é–‹æ”¾é ç´„`};
}

setInterval(()=>{
    if(!engineReady)return;
    const now=new Date(), h=now.getHours(), m=now.getMinutes();
    document.getElementById("clock").textContent=format12H(now);
    currentSlotInfo=getSlotStatus(h,m);
    let dText = currentSlotInfo.display;
    if(currentSlotInfo.phase === 'BREAK') dText += ` (${currentSlotInfo.hint})`;
    document.getElementById("slotDisplay").textContent=dText;
    if(h===1&&m===0&&now.getSeconds()===0&&myData.role==="admin") resetQueue();
    updateButtonStates(); updateOutListTimer(); checkNotifications();
},1000);

queueRef.on("value",s=>{cacheQueue=s.val()||{};if(engineReady){renderStaticLists();updateButtonStates();}});

function checkNotifications(){
    if(!me||!cacheQueue)return;
    let r=cacheQueue.reserve||{},o=cacheQueue.out||{};
    let sorted=Object.entries(r).sort((a,b)=>a[1].time-b[1].time);
    let myRank=sorted.findIndex(x=>x[0]===me.uid);
    let outCount=Object.keys(o).length;
    if(currentSlotInfo.phase==='OUT'&&myRank>=0&&myRank<=1&&outCount<3){
        if(!hasNotifiedReady){sendNotify("VIP é€šè¡Œ","æ‚¨å¯å‰å¾€å¸è¸å€",false);hasNotifiedReady=true;}
    }else{hasNotifiedReady=false;}
    if(o[me.uid]){
        let sec=Math.floor((Date.now()-o[me.uid].time)/1000);
        if(sec>600&&!hasNotifiedOvertime){sendNotify("è¶…æ™‚è­¦å‘Š","å¤–å‡ºè¶…é10åˆ†é˜",true);hasNotifiedOvertime=true;}
    }else{hasNotifiedOvertime=false;}
}

/* --- Button Logic Update (v5.4) --- */
function updateButtonStates(){
    if(!me||!cacheQueue)return;
    let r=cacheQueue.reserve||{},o=cacheQueue.out||{},used=cacheQueue.used||{};
    let sorted=Object.entries(r).sort((a,b)=>a[1].time-b[1].time);
    let outCount=Object.keys(o).length;
    let myRank=sorted.findIndex(x=>x[0]===me.uid);
    let alreadyUsed = used[currentSlotInfo.slot]?.[me.uid];

    // Helper to set button style
    const setBtn = (btn, cls, txt, disabled) => {
        btn.className = `action-btn ${cls}`;
        if(txt) btn.textContent = txt;
        btn.disabled = disabled;
    };

    if(alreadyUsed) {
        // State 4: Used
        setBtn(bReserve, 'btn-grey', 'ç­‰å¾…ä¸‹å€‹æ™‚æ®µ', true);
        setBtn(bOut, 'btn-grey', 'ç¾åœ¨å‡ºå»', true);
        setBtn(bBack, 'btn-grey', 'æˆ‘å›ä¾†äº†', true);
        setBtn(bCancel, 'btn-grey', 'å–æ¶ˆé ç´„', true);
    } else if(o[me.uid]) {
        // State 3: Outside
        setBtn(bReserve, 'btn-black', 'é ç´„æ’éšŠ', true);
        setBtn(bOut, 'btn-black', 'ç¾åœ¨å‡ºå»', true);
        setBtn(bBack, 'btn-red', 'æˆ‘å›ä¾†äº†', false);
        setBtn(bCancel, 'btn-black', 'å–æ¶ˆé ç´„', true);
    } else if(r[me.uid]) {
        // State 2: Reserved
        setBtn(bReserve, 'btn-black', 'å·²é ç´„', true);
        setBtn(bCancel, 'btn-red', 'å–æ¶ˆé ç´„', false);
        setBtn(bBack, 'btn-black', 'æˆ‘å›ä¾†äº†', true);
        
        // Go Out Logic
        if(currentSlotInfo.phase==='OUT' && myRank<=1 && outCount<3){
            setBtn(bOut, 'btn-green', 'ç¾åœ¨å‡ºå»', false);
        } else {
            setBtn(bOut, 'btn-black', 'ç­‰å¾…ä¸­...', true);
        }
    } else {
        // State 1: Idle
        if(currentSlotInfo.phase==='BREAK'){
            setBtn(bReserve, 'btn-black', 'ä¼‘æ¯ä¸­', true);
        } else {
            setBtn(bReserve, 'btn-gold', 'é ç´„æ’éšŠ', false);
        }
        setBtn(bOut, 'btn-black', 'ç¾åœ¨å‡ºå»', true);
        setBtn(bBack, 'btn-black', 'æˆ‘å›ä¾†äº†', true);
        setBtn(bCancel, 'btn-black', 'å–æ¶ˆé ç´„', true);
    }

    let st=document.getElementById("status");
    if(alreadyUsed) st.innerHTML="<span style='color:#666'>æœ¬æ™‚æ®µå·²çµæŸ</span>";
    else if(o[me.uid]) st.innerHTML="<span style='color:var(--success)'>æŠ½è¸ä¸­ ENJOYING...</span>";
    else if(r[me.uid]) {
        if(currentSlotInfo.phase==='OUT'){
            if(myRank<=1&&outCount<3) st.innerHTML="<span style='color:var(--success)'>åé¡é–‹æ”¾ï¼Œè«‹å‡ºç™¼</span>";
            else if(outCount>=3) st.innerHTML="<span style='color:var(--gold)'>æ»¿ä½ç­‰å€™ä¸­...</span>";
            else st.innerHTML=`<span>ç­‰å¾…é †ä½: ${myRank+1}</span>`;
        } else st.innerHTML="<span style='color:var(--gold)'>é ç´„æˆåŠŸ (å¾…é–‹æ”¾)</span>";
    } else {
        if(currentSlotInfo.phase==='BREAK') st.innerHTML="<span style='color:#555'>ç­‰å¾…ä¸‹ä¸€æ™‚æ®µ</span>";
        else if(currentSlotInfo.phase==='RESERVE') st.innerHTML="<span style='color:#2ed573'>é–‹æ”¾é ç´„ä¸­</span>";
        else st.innerHTML="<span style='color:#444'>å°šæœªé ç´„</span>";
    }
    document.getElementById("outCountNum").textContent=outCount;
}

function renderStaticLists(){
    let r=cacheQueue.reserve||{}, sorted=Object.entries(r).sort((a,b)=>a[1].time-b[1].time);
    const qBox=document.getElementById("queue");
    qBox.innerHTML=sorted.map((u,i)=>{
        let btn=(myData&&myData.role==="admin")?`<button onclick="forceGoOut('${u[0]}')" class="btn-mini success">å»æŠ½</button>`:"";
        let rc=i===0?'rank-1':(i===1?'rank-2':'');
        return `<div class="item-card ${rc}"><div><span style="font-family:'Rajdhani';color:var(--gold);margin-right:8px;font-weight:bold;">#${i+1}</span><strong>${u[1].name}</strong></div><div style="display:flex;align-items:center;"><small style='opacity:0.4;margin-right:5px;font-family:"Rajdhani"'>${new Date(u[1].time).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'})}</small>${btn}</div></div>`;
    }).join('')||"<div style='opacity:0.3;padding:10px;text-align:center;'>ç›®å‰ç©ºé–’</div>";

    const hBox=document.getElementById("history");
    let hist=[]; if(cacheQueue.history)Object.values(cacheQueue.history).forEach(h=>hist.push({...h,sortT:h.backTime}));
    let oObj=cacheQueue.out||{}; Object.entries(oObj).forEach(([uid,u])=>{if(Math.floor((Date.now()-u.time)/1000)>600)hist.push({name:u.name,outTime:u.time,backTime:null,over:true,sortT:Date.now()});});
    hBox.innerHTML=hist.sort((a,b)=>b.sortT-a.sortT).slice(0,20).map(i=>`<div class="item-card" style="padding:8px 12px;min-height:0;border:none;background:rgba(255,255,255,0.02);"><span>${i.name} ${i.over?'<span style="color:var(--danger)">!</span>':''}</span><small style='opacity:0.5;font-family:"Rajdhani"'>${new Date(i.outTime).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'})} - ${i.backTime?new Date(i.backTime).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'}):'OUT'}</small></div>`).join('');
}

function updateOutListTimer(){
    let o=cacheQueue.out||{};
    document.getElementById("outList").innerHTML=Object.entries(o).map(([uid,u])=>{
        let s=Math.floor((Date.now()-u.time)/1000);
        let btn=(myData&&myData.role==="admin")?`<button onclick="forceComeBack('${uid}')" class="btn-mini danger">å¬å›</button>`:"";
        return `<div class="item-card" style="border-left-color:var(--success);"><strong>${u.name}</strong><div style="display:flex;align-items:center;gap:8px;"><span class="${s>600?'text-danger':''}" style="font-family:'Rajdhani';color:${s>600?'var(--danger)':'#aaa'}">${Math.floor(s/60)}åˆ† ${s%60}ç§’</span>${btn}</div></div>`;
    }).join('')||"<div style='opacity:0.3;padding:10px;text-align:center;'>ç„¡äººå¤–å‡º</div>";
}

/* --- Firebase Actions --- */
function forceComeBack(uid){if(confirm("å¼·åˆ¶å¬å›ï¼Ÿ"))queueRef.child("out/"+uid).once("value").then(s=>{let u=s.val();if(u){let now=Date.now(),slot=new Date(u.time).getHours();queueRef.child(`used/${slot}/${uid}`).set(true);queueRef.child("history").push({name:u.name,slot,outTime:u.time,backTime:now,over:(now-u.time)>600000});queueRef.child("out/"+uid).remove();addLog(`ADMIN å¬å›: ${u.name}`);}});}
function forceGoOut(uid){if(confirm("å¼·åˆ¶æ´¾ç™¼ï¼Ÿ"))queueRef.child("reserve/"+uid).once("value").then(s=>{let u=s.val();if(u){queueRef.child("out/"+uid).set({name:u.name,time:Date.now()}).then(()=>{queueRef.child("reserve/"+uid).remove();addLog(`ADMIN æ´¾ç™¼: ${u.name}`);});}});}
function forceReload(){db.ref("reload").set(Date.now());}
function resetQueue(){ if(confirm("ç¢ºå®šæ¸…ç©ºã€æ’éšŠã€å¤–å‡ºã€å·²æŠ½éã€‘ç‹€æ…‹ï¼Ÿ")) { queueRef.child("reserve").remove(); queueRef.child("out").remove(); queueRef.child("used").remove(); addLog("ADMIN é‡ç½®ç³»çµ±"); } }
function clearChat(){ if(confirm("æ¸…ç©ºèŠå¤©å®¤ï¼Ÿ")) chatRef.remove(); }
function clearHistory(){ if(confirm("æ¸…ç©ºæ­·å²ç´€éŒ„ï¼Ÿ")) queueRef.child("history").remove(); }
function clearLog(){ if(confirm("æ¸…ç©ºç³»çµ±æ—¥èªŒï¼Ÿ")) logRef.remove(); }

function logout(){
    auth.signOut().then(() => {
        location.href = "https://wp037606888-oss.github.io/line-project/login.html";
    });
}

auth.onAuthStateChanged(user=>{
    if(!user){
        location.href = "https://wp037606888-oss.github.io/line-project/login.html";
        return;
    } 
    me=user;
    userRef.child(user.uid).on("value",s=>{
        myData=s.val()||{};
        document.getElementById("who").textContent= `æ­¡è¿ ${(myData.name||"GUEST").toUpperCase()}`;
        document.getElementById("btnAdminFloat").style.display=(myData.role==="admin")?"flex":"none";
        engineReady=true;renderStaticLists();updateButtonStates();
    });
    userRef.child(user.uid+"/online").set(true);
    userRef.child(user.uid+"/online").onDisconnect().set(false);
});

function addLog(t){logRef.push({t,time:Date.now()});}
logRef.limitToLast(15).on("value",s=>{const b=document.getElementById("log");b.innerHTML="";s.forEach(x=>{let d=x.val();let dv=document.createElement("div");dv.innerHTML=`<span style="opacity:0.5;font-family:'Rajdhani'">[${new Date(d.time).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'})}]</span> ${d.t}`;b.appendChild(dv);});b.scrollTop=b.scrollHeight;});

function reserve(){let h=new Date().getHours(),t=currentSlotInfo.phase==='RESERVE'?currentSlotInfo.slot:h;queueRef.child("reserve/"+me.uid).set({name:myData.name,time:Date.now(),slot:t});if(Notification.permission!=="granted")enableNotification();addLog(`${myData.name} é ç´„`);}
function cancelReserve(){queueRef.child("reserve/"+me.uid).remove();addLog(`${myData.name} å–æ¶ˆ`);}
function goOut(){queueRef.child("out/"+me.uid).set({name:myData.name,time:Date.now()}).then(()=>{queueRef.child("reserve/"+me.uid).remove();addLog(`${myData.name} å‡ºç™¼`);});}
function comeBack(){queueRef.child("out/"+me.uid).once("value").then(s=>{let u=s.val();if(u){let now=Date.now(),slot=new Date(u.time).getHours();queueRef.child(`used/${slot}/${me.uid}`).set(true);queueRef.child("history").push({name:u.name,slot,outTime:u.time,backTime:now,over:(now-u.time)>600000});queueRef.child("out/"+me.uid).remove();addLog(`${myData.name} è¿”å›`);}});}

function send(){let i=document.getElementById("msg");if(!i.value.trim())return;chatRef.push({name:myData.name,uid:me.uid,text:i.value,time:Date.now()});i.value="";}
chatRef.limitToLast(30).on("value",s=>{
    let b=document.getElementById("chat-box");b.innerHTML="";
    s.forEach(x=>{let m=x.val(),meMsg=m.uid===me.uid,d=document.createElement("div");d.className=`msg-bubble ${meMsg?'msg-mine':'msg-other'}`;d.innerHTML=`<div class="msg-name">${m.name}</div>${m.text}`;b.appendChild(d);});
    b.scrollTop=b.scrollHeight;
});

userRef.on("value",s=>{
    const list=document.getElementById("onlineUserList");
    list.innerHTML="";
    s.forEach(u=>{
        let d=u.val();
        if(d.online){
            let isAdmin = d.role === 'admin';
            let pill = document.createElement("div");
            pill.className = `online-pill online ${isAdmin ? 'admin' : ''}`;
            pill.innerHTML = `<div class="online-dot"></div>${d.name}`;
            list.appendChild(pill);
        }
    });
});

let fR=true;db.ref("reload").on("value",s=>{if(fR){fR=false;return;}location.reload();});
</script>
</body>
</html>
