<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°Šçˆµå¸è¸å®¤ - ä¸­å¤®æ§åˆ¶å°</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&display=swap');

:root {
    --gold: #ffd700;
    --gold-dim: rgba(255, 215, 0, 0.2);
    --gold-glow: rgba(255, 215, 0, 0.6);
    --bg-dark: #05060a;
    --glass: rgba(16, 18, 27, 0.65);
    --glass-border: rgba(255, 255, 255, 0.08);
    --text-main: #e0e0e0;
    --text-muted: #888;
    --success: #00ff88;
    --danger: #ff3e3e;
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

body {
    margin: 0;
    font-family: "Noto Sans TC", sans-serif;
    background: var(--bg-dark);
    color: var(--text-main);
    display: flex;
    height: 100vh;
    overflow: hidden;
    font-size: 15px;
}

/* èƒŒæ™¯ç‰¹æ•ˆ */
canvas#bg { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
.overlay { position: fixed; inset: 0; background: radial-gradient(circle at center, transparent 0%, #000 90%); z-index: 0; pointer-events: none; }
.noise { position: fixed; inset: 0; z-index: 0; opacity: 0.04; background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJuIj48ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iMC42IiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI24pIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4='); pointer-events: none; }

/* ä½ˆå±€å®¹å™¨ */
#layout {
    display: flex;
    width: 100%;
    height: 100%;
    z-index: 1;
    position: relative;
    padding: 20px;
    gap: 20px;
}

/* å·¦å´å„€è¡¨æ¿ */
#dashboard {
    flex: 1.6;
    display: flex;
    flex-direction: column;
    gap: 20px;
    overflow-y: auto;
    padding-right: 5px; /* çµ¦æ»¾å‹•æ¢ç©ºé–“ */
}

/* å³å´é€šè¨Šå€ */
#comms {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 15px;
    min-width: 350px;
}

/* é€šç”¨ç»ç’ƒå¡ç‰‡ */
.glass-panel {
    background: var(--glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 24px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    position: relative;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.glass-panel:hover {
    box-shadow: 0 15px 50px rgba(0,0,0,0.7);
    border-color: rgba(255, 215, 0, 0.15);
}

/* å¡ç‰‡æ¨™é¡Œ */
h3 {
    margin: 0 0 16px 0;
    font-size: 14px;
    color: var(--gold);
    text-transform: uppercase;
    letter-spacing: 3px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: 'Cinzel', serif;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    padding-bottom: 10px;
}
h3 i { font-size: 18px; }

/* é ‚éƒ¨ç‹€æ…‹å€ */
.status-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.user-info { display: flex; align-items: center; gap: 15px; }
.user-badge { 
    background: rgba(255,255,255,0.1); 
    padding: 6px 14px; 
    border-radius: 50px; 
    font-size: 12px; 
    border: 1px solid rgba(255,255,255,0.1);
    color: #fff;
    letter-spacing: 1px;
}
.btn-logout { background: transparent; border: 1px solid #444; color: #666; cursor: pointer; padding: 5px 12px; border-radius: 8px; font-size: 11px; transition: .3s; }
.btn-logout:hover { border-color: var(--danger); color: var(--danger); }

#clock {
    font-family: 'JetBrains Mono', monospace;
    font-size: 42px;
    font-weight: 700;
    background: linear-gradient(to bottom, #fff, #888);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 30px rgba(255,255,255,0.1);
    margin: 10px 0;
}

#slotDisplay { font-size: 16px; color: var(--gold); letter-spacing: 2px; font-weight: 500; }
#status { font-size: 20px; font-weight: 700; margin: 15px 0 0; min-height: 30px; }

/* æŒ‰éˆ•ç¾¤çµ„ */
.control-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-top: 20px;
}

button.action-btn {
    padding: 16px 10px;
    border: none;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.1);
    color: #aaa;
}

/* ä¸»æŒ‰éˆ•ç‰¹æ•ˆ */
button#bReserve {
    background: linear-gradient(135deg, #ffd700, #b8860b);
    color: #000;
    border: none;
    box-shadow: 0 5px 15px rgba(255, 215, 0, 0.2);
}
button#bReserve:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4); }
button#bReserve:disabled { background: #222; color: #555; box-shadow: none; cursor: not-allowed; }

button#bCancel:hover { background: rgba(255, 62, 62, 0.2); color: var(--danger); border-color: var(--danger); }
button#bOut:hover:not(:disabled) { background: rgba(0, 255, 136, 0.2); color: var(--success); border-color: var(--success); }
button#bBack:hover:not(:disabled) { background: rgba(255,255,255,0.1); color: #fff; border-color: #fff; }

/* åˆ—è¡¨æ¨£å¼ */
.list-container { max-height: 150px; overflow-y: auto; padding-right: 5px; }
.item-card {
    background: rgba(255,255,255,0.03);
    margin-bottom: 8px;
    padding: 12px 16px;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-left: 3px solid transparent;
    transition: .2s;
}
.item-card:hover { background: rgba(255,255,255,0.06); }
.item-card.rank-1 { border-left-color: var(--gold); background: linear-gradient(90deg, rgba(255,215,0,0.05), transparent); }
.item-card.rank-2 { border-left-color: silver; }
.item-card.rank-3 { border-left-color: #cd7f32; }

/* ç®¡ç†å“¡æŒ‰éˆ• */
.btn-mini { padding: 4px 10px; font-size: 11px; border-radius: 6px; cursor: pointer; margin-left: 8px; border: 1px solid; background: transparent; }
.btn-mini.danger { color: var(--danger); border-color: rgba(255,62,62,0.5); }
.btn-mini.danger:hover { background: var(--danger); color: #fff; }
.btn-mini.success { color: var(--success); border-color: rgba(0,255,136,0.5); }
.btn-mini.success:hover { background: var(--success); color: #000; }

/* èŠå¤©å®¤ */
#chat-header {
    padding: 15px;
    background: rgba(0,0,0,0.2);
    border-bottom: 1px solid rgba(255,255,255,0.05);
    font-size: 12px;
    color: #888;
    text-align: center;
    letter-spacing: 2px;
}
#chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
.msg-bubble {
    max-width: 80%;
    padding: 10px 14px;
    border-radius: 18px;
    font-size: 14px;
    line-height: 1.5;
    position: relative;
    word-break: break-all;
}
.msg-mine {
    align-self: flex-end;
    background: linear-gradient(135deg, #ffd700, #ffaa00);
    color: #000;
    border-bottom-right-radius: 4px;
    box-shadow: 0 4px 15px rgba(255, 170, 0, 0.2);
}
.msg-other {
    align-self: flex-start;
    background: rgba(255,255,255,0.1);
    color: #fff;
    border-bottom-left-radius: 4px;
}
.msg-name { font-size: 11px; margin-bottom: 4px; opacity: 0.7; font-weight: 700; }
.msg-time { font-size: 10px; opacity: 0.5; margin-top: 4px; text-align: right; }

/* è¼¸å…¥æ¡†å€ */
.input-area {
    padding: 15px;
    background: rgba(0,0,0,0.3);
    border-top: 1px solid rgba(255,255,255,0.05);
    display: flex;
    gap: 10px;
}
input#msg {
    flex: 1;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px;
    padding: 10px 16px;
    color: #fff;
    transition: .3s;
}
input#msg:focus { background: rgba(0,0,0,0.5); border-color: var(--gold); }
button.btn-send {
    background: transparent;
    border: 1px solid var(--gold-dim);
    color: var(--gold);
    border-radius: 50%;
    width: 40px; height: 40px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: .3s;
}
button.btn-send:hover { background: var(--gold); color: #000; }

/* æ²è»¸ç¾åŒ– */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

/* ç®¡ç†å“¡é¢æ¿ */
#adminPanel { display: none; margin-top: 20px; border: 1px solid rgba(255, 215, 0, 0.3); }
.admin-controls { display: flex; gap: 8px; flex-wrap: wrap; }
.btn-admin { padding: 8px 12px; font-size: 11px; background: rgba(0,0,0,0.4); border: 1px solid #444; color: #aaa; cursor: pointer; border-radius: 6px; }
.btn-admin:hover { border-color: #fff; color: #fff; }

/* ç·šä¸Šäººå“¡æ¨™ç±¤ */
.online-tag { display: inline-block; width: 6px; height: 6px; background: var(--success); border-radius: 50%; margin-right: 5px; box-shadow: 0 0 10px var(--success); }

/* RWD */
@media (max-width: 900px) {
    #layout { flex-direction: column; overflow-y: auto; }
    #dashboard, #comms { flex: none; width: 100%; }
    #comms { height: 500px; }
    .control-grid { grid-template-columns: 1fr 1fr; }
}
</style>
</head>

<body>
<canvas id="bg"></canvas>
<div class="overlay"></div>
<div class="noise"></div>

<div id="layout">
    <div id="dashboard">
        <div class="glass-panel">
            <div class="status-header">
                <div class="user-info">
                    <span class="user-badge" id="who">é€£ç·šä¸­...</span>
                    <button class="btn-logout" onclick="enableNotification()" id="btnNotify" style="display:none;">ğŸ”” é–‹å•Ÿé€šçŸ¥</button>
                    <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
                </div>
                <div id="slotDisplay">---</div>
            </div>
            
            <div id="clock">12:00:00</div>
            <div id="status">ç³»çµ±åˆå§‹åŒ–...</div>

            <div class="control-grid">
                <button id="bReserve" onclick="reserve()" class="action-btn">é ç´„æ’éšŠ</button>
                <button id="bCancel" onclick="cancelReserve()" class="action-btn">å–æ¶ˆ</button>
                <button id="bOut" onclick="goOut()" class="action-btn">ç¾åœ¨å‡ºå»</button>
                <button id="bBack" onclick="comeBack()" class="action-btn">æˆ‘å›ä¾†äº†</button>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="glass-panel">
                <h3><i class="icon">ğŸš¬</i> æ’éšŠåå–®</h3>
                <div id="queue" class="list-container"></div>
            </div>
            <div class="glass-panel">
                <h3><i class="icon">ğŸš¶</i> å¤–å‡ºä¸­ (<span id="outCountNum">0</span>/3)</h3>
                <div id="outList" class="list-container"></div>
            </div>
        </div>

        <div class="glass-panel">
            <h3><i class="icon">ğŸ“Š</i> è¿‘æœŸç´€éŒ„</h3>
            <div id="history" class="list-container"></div>
        </div>

        <div class="glass-panel" style="flex:1;">
            <h3><i class="icon">ğŸ“œ</i> ç³»çµ±æ—¥èªŒ</h3>
            <div id="log" class="list-container" style="font-family: 'JetBrains Mono'; font-size: 12px; color:#666;"></div>
        </div>

        <div id="adminPanel" class="glass-panel">
            <h3 style="color:var(--gold);">ğŸ‘‘ ADMIN CONSOLE</h3>
            <div class="admin-controls">
                <button onclick="forceReload()" class="btn-admin">å…¨é«”åˆ·æ–°</button>
                <button onclick="resetQueue()" class="btn-admin" style="border-color:var(--danger); color:var(--danger);">æ¸…ç©ºæ•¸æ“š</button>
                <button onclick="clearLog()" class="btn-admin">æ¸…ç©ºæ—¥èªŒ</button>
                <button onclick="clearChat()" class="btn-admin">æ¸…ç©ºèŠå¤©</button>
            </div>
        </div>
    </div>

    <div id="comms" class="glass-panel" style="padding:0;">
        <div id="chat-header">
            LOUNGE CHAT <span id="onlineCount" style="color:var(--success); margin-left:10px;">â— 0</span>
        </div>
        <div id="onlineBar" style="padding:10px; display:flex; gap:5px; flex-wrap:wrap; background:rgba(255,255,255,0.02); min-height:40px;"></div>
        
        <div id="chat-box"></div>
        
        <div class="input-area">
            <input id="msg" placeholder="è¼¸å…¥è¨Šæ¯..." onkeydown="if(event.key==='Enter')send()">
            <button onclick="send()" class="btn-send">â¤</button>
        </div>
    </div>
</div>

<script>
/* --- ç²’å­èƒŒæ™¯ (åŒç™»å…¥é é¢) --- */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
let w, h;
function resize() { w = canvas.width = innerWidth; h = canvas.height = innerHeight; }
window.onresize = resize; resize();

const particles = [];
for (let i = 0; i < 60; i++) {
    particles.push({
        x: Math.random() * w, y: Math.random() * h,
        vx: (Math.random() - 0.5) * 0.3, vy: (Math.random() - 0.5) * 0.3,
        size: Math.random() * 2 + 0.5, alpha: Math.random() * 0.5 + 0.1
    });
}
function draw() {
    ctx.clearRect(0, 0, w, h);
    for (let i = 0; i < particles.length; i++) {
        let p = particles[i];
        p.x += p.vx; p.y += p.vy;
        if (p.x < 0 || p.x > w) p.vx *= -1; if (p.y < 0 || p.y > h) p.vy *= -1;
        
        ctx.fillStyle = `rgba(255, 215, 0, ${p.alpha})`;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();

        for (let j = i + 1; j < particles.length; j++) {
            let p2 = particles[j];
            let dist = Math.sqrt((p.x-p2.x)**2 + (p.y-p2.y)**2);
            if (dist < 150) {
                ctx.strokeStyle = `rgba(255, 215, 0, ${0.1 * (1 - dist / 150)})`;
                ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
            }
        }
    }
    requestAnimationFrame(draw);
}
draw();

/* --- Firebase Config & Logic (v3.5 Admin+) --- */
const config={
    apiKey: "AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",
    authDomain: "smoke-queue.firebaseapp.com",
    databaseURL: "https://smoke-queue-default-rtdb.firebaseio.com",
    projectId: "smoke-queue"
};
firebase.initializeApp(config);
const db=firebase.database(), auth=firebase.auth();
const queueRef=db.ref("queue"), userRef=db.ref("users"), chatRef=db.ref("chat"), logRef=db.ref("log");

let me, myData, engineReady=false, cacheQueue={};
let currentSlotInfo = { phase: '', slot: 0 };

/* éŸ³æ•ˆèˆ‡é€šçŸ¥ */
let audioCtx = null;
let notifyEnabled = false;
let hasNotifiedReady = false, hasNotifiedOvertime = false;

function enableNotification() {
    if (!("Notification" in window)) { alert("ç€è¦½å™¨ä¸æ”¯æ´"); return; }
    Notification.requestPermission().then(p => {
        if (p === "granted") {
            notifyEnabled = true; playBeep();
            new Notification("é€šçŸ¥å·²å•Ÿç”¨");
            document.getElementById("btnNotify").style.display = "none";
        }
    });
}
if (Notification.permission !== "granted") document.getElementById("btnNotify").style.display = "inline-block";

function playBeep(type='normal') {
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    if(type==='urgent'){
        osc.frequency.value=880; osc.type='square'; osc.start();
        setTimeout(()=>osc.stop(),100);
        setTimeout(()=>{
            const o2=audioCtx.createOscillator(); const g2=audioCtx.createGain();
            o2.connect(g2); g2.connect(audioCtx.destination);
            o2.frequency.value=880; o2.type='square'; o2.start(); setTimeout(()=>o2.stop(),100);
        },150);
    } else {
        osc.frequency.value=523.25; osc.type='sine';
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime+0.5);
        osc.start(); osc.stop(audioCtx.currentTime+0.5);
    }
}
function sendNotify(title,body,urgent=false){
    if(!notifyEnabled) return;
    playBeep(urgent?'urgent':'normal');
    new Notification(title, { body, icon: 'https://cdn-icons-png.flaticon.com/512/3772/3772422.png' });
}

/* æ ¸å¿ƒé‚è¼¯ */
function format12H(d) { return d.toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'}); }
function getSlotStatus(h, m) {
    const slots = [14, 16, 18, 20, 22, 0]; 
    let target = slots.find(s => (s === 0 ? 24 : s) > h) || 14;
    let currentSlot = slots.find(s => s === h);
    
    if (currentSlot !== undefined) {
        let displayH = currentSlot === 0 ? 12 : (currentSlot > 12 ? currentSlot - 12 : currentSlot);
        return { phase: 'OUT', slot: currentSlot, display: `${displayH}:00 PM é–‹æ”¾æ™‚æ®µ` };
    }
    
    let nextSlot = target;
    let diff = (nextSlot === 0 ? 24 : nextSlot) * 60 - (h * 60 + m);
    if (diff > 0 && diff <= 30) {
        let nextH = nextSlot === 0 ? 12 : (nextSlot > 12 ? nextSlot - 12 : nextSlot);
        return { phase: 'RESERVE', slot: nextSlot, display: `é ç´„ä¸­: ${nextH}:00` };
    }
    return { phase: 'BREAK', nextSlot, display: 'å¸è¸å€ä¼‘æ¯ä¸­', hint: 'éé–‹æ”¾æ™‚æ®µ' };
}

setInterval(() => {
    if(!engineReady) return;
    const now = new Date();
    const h = now.getHours(), m = now.getMinutes();
    document.getElementById("clock").textContent = format12H(now);

    currentSlotInfo = getSlotStatus(h, m);
    document.getElementById("slotDisplay").textContent = currentSlotInfo.display;

    if(h === 1 && m === 0 && now.getSeconds() === 0 && myData.role === "admin") resetQueue();

    updateButtonStates();
    updateOutListTimer();
    checkNotifications();
}, 1000);

/* è³‡æ–™ç›£è½èˆ‡æ¸²æŸ“ */
queueRef.on("value", s => { 
    cacheQueue = s.val() || {}; 
    if(engineReady) { renderStaticLists(); updateButtonStates(); }
});

function checkNotifications() {
    if(!me || !cacheQueue) return;
    let r = cacheQueue.reserve || {}, o = cacheQueue.out || {};
    let sortedQueue = Object.entries(r).sort((a,b)=>a[1].time - b[1].time);
    let outCount = Object.keys(o).length;
    let myRank = sortedQueue.findIndex(x=>x[0]===me.uid);

    if (currentSlotInfo.phase === 'OUT' && myRank >= 0 && myRank <= 1 && outCount < 3) {
        if (!hasNotifiedReady) { sendNotify("VIP é€šè¡Œè¨±å¯", "æ‚¨åœ¨å‰å…©é †ä½ï¼Œç¾åœ¨å¯ä»¥å‰å¾€å¸è¸å€ã€‚", false); hasNotifiedReady = true; }
    } else { hasNotifiedReady = false; }

    if (o[me.uid]) {
        let sec = Math.floor((Date.now() - o[me.uid].time) / 1000);
        if (sec > 600 && !hasNotifiedOvertime) { sendNotify("è¶…æ™‚è­¦å‘Š", "æ‚¨å·²å¤–å‡ºè¶…é 10 åˆ†é˜ï¼Œè«‹ç›¡é€Ÿè¿”å›ã€‚", true); hasNotifiedOvertime = true; }
    } else { hasNotifiedOvertime = false; }
}

function updateButtonStates() {
    if(!me || !cacheQueue) return;
    let r = cacheQueue.reserve || {}, o = cacheQueue.out || {}, used = cacheQueue.used || {};
    let sortedQueue = Object.entries(r).sort((a,b)=>a[1].time - b[1].time);
    let outCount = Object.keys(o).length;
    let myRank = sortedQueue.findIndex(x=>x[0]===me.uid);
    let alreadyUsed = used[currentSlotInfo.slot]?.[me.uid];

    bReserve.disabled = (currentSlotInfo.phase === 'BREAK' || r[me.uid] || o[me.uid] || alreadyUsed);
    bCancel.disabled = !r[me.uid];
    let canGoOut = (currentSlotInfo.phase === 'OUT' && r[me.uid] && myRank <= 1 && outCount < 3);
    bOut.disabled = !canGoOut;
    bBack.disabled = !o[me.uid];

    let statusBox = document.getElementById("status");
    if(alreadyUsed) statusBox.innerHTML = "<span style='color:#666'>æœ¬æ™‚æ®µå·²çµæŸ</span>";
    else if(o[me.uid]) statusBox.innerHTML = "<span style='color:var(--success)'>ENJOYING...</span>";
    else if(r[me.uid]) {
        if(currentSlotInfo.phase === 'OUT') {
            if(myRank <= 1 && outCount < 3) statusBox.innerHTML = "<span style='color:var(--success)'>å¯ä»¥å‡ºç™¼äº†</span>";
            else if(outCount >= 3) statusBox.innerHTML = "<span style='color:var(--gold)'>æ»¿ä½ç­‰å€™ä¸­</span>";
            else statusBox.innerHTML = `<span>ç­‰å¾…é †ä½: ${myRank+1}</span>`;
        } else {
            statusBox.innerHTML = "<span style='color:var(--gold)'>é ç´„æˆåŠŸ (å¾…é–‹æ”¾)</span>";
        }
    } else {
        if(currentSlotInfo.phase === 'BREAK') statusBox.innerHTML = "<span style='color:#555'>ç­‰å¾…ä¸‹ä¸€æ™‚æ®µ</span>";
        else if(currentSlotInfo.phase === 'RESERVE') statusBox.innerHTML = "<span style='color:#00aaff'>é–‹æ”¾é ç´„ä¸­</span>";
        else statusBox.innerHTML = "<span style='color:#444'>å°šæœªé ç´„</span>";
    }
    document.getElementById("outCountNum").textContent = outCount;
}

function renderStaticLists() {
    let d = cacheQueue, r = d.reserve || {};
    let sortedQueue = Object.entries(r).sort((a,b)=>a[1].time - b[1].time);
    
    // æ’éšŠåå–®æ¸²æŸ“
    const qBox = document.getElementById("queue");
    qBox.innerHTML = sortedQueue.map((u, i) => {
        let forceOutBtn = (myData && myData.role === "admin") ? `<button onclick="forceGoOut('${u[0]}')" class="btn-mini success">å»æŠ½</button>` : "";
        let rankClass = i===0 ? 'rank-1' : (i===1 ? 'rank-2' : (i===2 ? 'rank-3' : ''));
        return `
        <div class="item-card ${rankClass}">
            <div>
                <span style="font-family:'Cinzel'; color:var(--gold); margin-right:8px;">#${i+1}</span>
                <strong>${u[1].name}</strong>
            </div>
            <div style="display:flex; align-items:center;">
                <small style='opacity:0.4; margin-right:5px;'>${new Date(u[1].time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false})}</small>
                ${forceOutBtn}
            </div>
        </div>`;
    }).join('') || "<div style='opacity:0.3; padding:10px; text-align:center;'>ç›®å‰ç©ºé–’</div>";

    // æ­·å²ç´€éŒ„
    const hBox = document.getElementById("history");
    let hist = [];
    if(d.history) Object.values(d.history).forEach(h => hist.push({...h, sortT: h.backTime}));
    let outObj = d.out || {};
    Object.entries(outObj).forEach(([uid, u]) => {
        if(Math.floor((Date.now()-u.time)/1000) > 600) hist.push({name: u.name, outTime: u.time, backTime: null, over: true, sortT: Date.now()});
    });

    hBox.innerHTML = hist.sort((a,b)=>b.sortT-a.sortT).slice(0, 20).map(item => `
        <div class="item-card" style="padding:8px 12px; min-height:0;">
            <span>${item.name} ${item.over?'<span style="color:var(--danger)">!</span>':''}</span>
            <small style='opacity:0.5; font-family:"JetBrains Mono"'>${new Date(item.outTime).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false})} - ${item.backTime?new Date(item.backTime).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false}):'OUT'}</small>
        </div>
    `).join('');
}

function updateOutListTimer() {
    let outObj = cacheQueue.out || {};
    const oBox = document.getElementById("outList");
    oBox.innerHTML = Object.entries(outObj).map(([uid, u]) => {
        let sec = Math.floor((Date.now() - u.time)/1000);
        let timeString = `${Math.floor(sec/60)}åˆ† ${sec%60}ç§’`;
        let adminBtn = (myData && myData.role === "admin") ? `<button onclick="forceComeBack('${uid}')" class="btn-mini danger">å¬å›</button>` : "";
        
        return `
            <div class="item-card" style="border-left-color:var(--success);">
                <strong>${u.name}</strong>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span class="${sec>600?'text-danger':''}" style="color:${sec>600?'var(--danger)':'#aaa'}">${timeString}</span>
                    ${adminBtn}
                </div>
            </div>
        `;
    }).join('') || "<div style='opacity:0.3; padding:10px; text-align:center;'>ç„¡äººå¤–å‡º</div>";
}

/* Firebase Admin & User */
function forceComeBack(uid) { if(confirm("å¼·åˆ¶å¬å›ï¼Ÿ")) queueRef.child("out/"+uid).once("value").then(s=>{ let u=s.val(); if(u){ let now=Date.now(), slot=new Date(u.time).getHours(); queueRef.child(`used/${slot}/${uid}`).set(true); queueRef.child("history").push({name:u.name,slot,outTime:u.time,backTime:now,over:(now-u.time)>600000}); queueRef.child("out/"+uid).remove(); addLog(`ADMIN å¬å›: ${u.name}`); }}); }
function forceGoOut(uid) { if(confirm("å¼·åˆ¶æ´¾ç™¼ï¼Ÿ")) queueRef.child("reserve/"+uid).once("value").then(s=>{ let u=s.val(); if(u){ queueRef.child("out/"+uid).set({name:u.name,time:Date.now()}).then(()=>{ queueRef.child("reserve/"+uid).remove(); addLog(`ADMIN æ´¾ç™¼: ${u.name}`); }); }}); }
function forceReload() { db.ref("reload").set(Date.now()); }
function resetQueue(){ if(confirm("é‡ç½®æ•¸æ“š?")) { queueRef.remove(); addLog("ç³»çµ±é‡ç½®"); } }
function clearLog(){ if(confirm("æ¸…ç©ºæ—¥èªŒ?")) logRef.remove(); }
function clearChat(){ if(confirm("æ¸…ç©ºèŠå¤©?")) chatRef.remove(); }
function logout(){ auth.signOut().then(()=>location.reload()); }

/* åŸºæœ¬åŠŸèƒ½ */
auth.onAuthStateChanged(user => {
    if(!user) { location.href="index.html"; return; }
    me = user;
    userRef.child(user.uid).on("value", s => {
        myData = s.val() || {};
        document.getElementById("who").textContent = (myData.name || "GUEST").toUpperCase();
        document.getElementById("adminPanel").style.display = (myData.role === "admin") ? "block" : "none";
        engineReady = true; renderStaticLists(); updateButtonStates();
    });
    userRef.child(user.uid + "/online").set(true);
    userRef.child(user.uid + "/online").onDisconnect().set(false);
});

function addLog(txt) { logRef.push({t: txt, time: Date.now()}); }
logRef.limitToLast(15).on("value", s => {
    const box = document.getElementById("log"); box.innerHTML = "";
    s.forEach(x => {
        let d = x.val(); let div = document.createElement("div"); 
        div.innerHTML = `<span style="opacity:0.5">[${new Date(d.time).toLocaleTimeString([],{hour12:false})}]</span> ${d.t}`;
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
});

function reserve(){ let h=new Date().getHours(); let t=currentSlotInfo.phase==='RESERVE'?currentSlotInfo.slot:h; queueRef.child("reserve/"+me.uid).set({name:myData.name,time:Date.now(),slot:t}); if(Notification.permission!=="granted")enableNotification(); addLog(`${myData.name} é ç´„`); }
function cancelReserve(){ queueRef.child("reserve/"+me.uid).remove(); addLog(`${myData.name} å–æ¶ˆ`); }
function goOut(){ queueRef.child("out/"+me.uid).set({name:myData.name,time:Date.now()}).then(()=>{queueRef.child("reserve/"+me.uid).remove(); addLog(`${myData.name} å‡ºç™¼`);}); }
function comeBack(){ queueRef.child("out/"+me.uid).once("value").then(s=>{let u=s.val();if(u){let now=Date.now(),slot=new Date(u.time).getHours();queueRef.child(`used/${slot}/${me.uid}`).set(true);queueRef.child("history").push({name:u.name,slot,outTime:u.time,backTime:now,over:(now-u.time)>600000});queueRef.child("out/"+me.uid).remove();addLog(`${myData.name} è¿”å›`);}}); }

function send(){ let i=document.getElementById("msg"); if(!i.value.trim())return; chatRef.push({name:myData.name,uid:me.uid,text:i.value,time:Date.now()}); i.value=""; }
chatRef.limitToLast(30).on("value", s => {
    let box = document.getElementById("chat-box"); box.innerHTML="";
    s.forEach(x => {
        let m = x.val();
        let isMe = m.uid === me.uid;
        let div = document.createElement("div"); 
        div.className = `msg-bubble ${isMe ? 'msg-mine' : 'msg-other'}`;
        div.innerHTML = `<div class="msg-name">${m.name}</div>${m.text}<div class="msg-time">${new Date(m.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false})}</div>`;
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
});

userRef.on("value", s => { 
    let bar = document.getElementById("onlineBar"); bar.innerHTML=""; let count=0;
    s.forEach(u => { let d=u.val(); if(d.online){ count++; bar.innerHTML+=`<span style="font-size:10px; padding:3px 8px; background:rgba(255,255,255,0.1); border-radius:10px; border:1px solid #555;">${d.name}</span>`; }});
    document.getElementById("onlineCount").textContent = `â— ${count}`;
});

let isFirstReloadCheck = true;
db.ref("reload").on("value", s => { if(isFirstReloadCheck){isFirstReloadCheck=false;return;} location.reload(); });
</script>
</body>
</html>
