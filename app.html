<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>æŠ½è¸æ’éšŠç³»çµ±</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
margin:0;
font-family:Segoe UI;
background:linear-gradient(145deg,#0c0c12,#1a1a28);
color:white;
display:flex;
height:100vh;
}

/* å·¦å´é¢æ¿ */
#left{
width:280px;
background:rgba(20,20,30,.9);
backdrop-filter:blur(12px);
display:flex;
flex-direction:column;
padding:10px;
overflow:hidden;
}

.panel{
background:#161624;
border-radius:12px;
padding:10px;
margin-bottom:10px;
box-shadow:0 0 15px rgba(0,0,0,.4);
}

h3{margin:0 0 6px 0;font-size:14px;color:#8aaaff}

/* æ’éšŠ */
#queue div{
padding:4px 0;
font-size:13px;
}

/* æ—¥èªŒ */
#log{
height:160px;
overflow:auto;
font-size:12px;
opacity:.8;
}

/* åœ¨ç·š */
.user{
padding:5px;
border-radius:6px;
background:#252538;
margin:3px 0;
font-size:13px;
}
.online{border-left:3px solid #00ff88}
.offline{opacity:.4}

/* ä¸»å€ */
#main{flex:1;display:flex;flex-direction:column}

header{
background:#141422;
padding:12px;
text-align:center;
font-weight:bold;
}

#chat{flex:1;overflow:auto;padding:12px}
.msg{
background:#222236;
margin:5px 0;
padding:8px;
border-radius:8px;
font-size:13px;
}

footer{
display:flex;
padding:10px;
background:#141422;
}

input{
flex:1;
padding:10px;
border:none;
border-radius:8px;
background:#2b2b40;
color:white;
}

button{
padding:8px 10px;
margin:2px;
border:none;
border-radius:8px;
background:#5c7cff;
color:white;
cursor:pointer;
font-size:12px;
}

button:hover{opacity:.9}
</style>
</head>

<body>

<div id="left">

<div class="panel">
<h3>ğŸš¬ æŠ½è¸æ’éšŠ</h3>
<div id="queue"></div>
<button onclick="reserve()">é ç´„</button>
<button onclick="cancelReserve()">å–æ¶ˆ</button>
<button onclick="goOut()">å‡ºå»</button>
<button onclick="comeBack()">å›ä¾†</button>
</div>

<div class="panel">
<h3>ğŸ“œ æ—¥èªŒ</h3>
<div id="log"></div>
</div>

<div class="panel">
<h3>åœ¨ç·š</h3>
<div id="userList"></div>
</div>

</div>

<div id="main">

<header>æŠ½è¸æ’éšŠèŠå¤©å®¤</header>

<div id="chat"></div>

<footer>
<input id="msg">
<button onclick="send()">é€å‡º</button>
<button onclick="forceReload()">å…¨é«”åˆ·æ–°</button>
</footer>

</div>

<script>

//////////////////// Firebase ////////////////////

const config={
apiKey:"AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",
authDomain:"smoke-queue.firebaseapp.com",
databaseURL:"https://smoke-queue-default-rtdb.firebaseio.com",
projectId:"smoke-queue"
};
firebase.initializeApp(config);

const db=firebase.database();
const auth=firebase.auth();

//////////////////// å…¨åŸŸ ////////////////////

let me,myData;
const queueRef=db.ref("queue");
const logRef=db.ref("log");

//////////////////// å¼·åˆ¶åˆ·æ–° ////////////////////

let lastReload=0;
db.ref("reload").on("value",s=>{
let t=s.val();
if(t && t>lastReload){
lastReload=t;
location.reload(true);
}
});

function forceReload(){
db.ref("reload").set(Date.now());
}

//////////////////// æ—¥èªŒ ////////////////////

function addLog(text){
logRef.push({
text:text,
time:Date.now()
});
}

logRef.limitToLast(100).on("value",snap=>{
log.innerHTML="";
snap.forEach(s=>{
let l=s.val();
let time=new Date(l.time).toLocaleTimeString();
let d=document.createElement("div");
d.textContent=`[${time}] ${l.text}`;
log.appendChild(d);
});
log.scrollTop=99999;
});

//////////////////// æ’éšŠ ////////////////////

function reserve(){
queueRef.child("reserve/"+me.uid).set({
name:myData.name,time:Date.now()
});
addLog(myData.name+" é ç´„");
}

function cancelReserve(){
queueRef.child("reserve/"+me.uid).remove();
addLog(myData.name+" å–æ¶ˆé ç´„");
}

async function goOut(){

if(!confirm("ç¢ºå®šå‡ºå»?")) return;

let snap=await queueRef.child("out").once("value");
let out=snap.val()||{};

if(Object.keys(out).length>=3){
alert("å·²æ»¿3äºº");
return;
}

queueRef.child("out/"+me.uid).set({
name:myData.name,time:Date.now()
});
queueRef.child("reserve/"+me.uid).remove();
addLog(myData.name+" å‡ºå»");
}

function comeBack(){
if(!confirm("ç¢ºå®šå›ä¾†?")) return;
queueRef.child("out/"+me.uid).remove();
addLog(myData.name+" å›ä¾†");
}

queueRef.on("value",snap=>{
let data=snap.val()||{};
let r=data.reserve||{};
let o=data.out||{};

queue.innerHTML="";

Object.entries(r)
.sort((a,b)=>a[1].time-b[1].time)
.forEach((u,i)=>{
let d=document.createElement("div");
d.textContent=`${i+1}. ${u[1].name}`;
queue.appendChild(d);
});

Object.entries(o).forEach(([uid,u])=>{
let t=(Date.now()-u.time)/1000;
let left=600-t;

let d=document.createElement("div");

if(left<=0){
queueRef.child("out/"+uid).remove();
addLog(u.name+" è¶…æ™‚è‡ªå‹•å›ä¾†");
return;
}

d.textContent=`ğŸš¬ ${u.name} å‰© ${Math.floor(left/60)}:${Math.floor(left%60).toString().padStart(2,"0")}`;
queue.appendChild(d);
});
});

//////////////////// èŠå¤© ////////////////////

function send(){
if(!msg.value.trim()) return;

db.ref("chat").push({
name:myData.name,
text:msg.value,
time:Date.now()
});
msg.value="";
}

db.ref("chat").limitToLast(200).on("value",snap=>{
chat.innerHTML="";
snap.forEach(s=>{
let m=s.val();
let time=new Date(m.time).toLocaleTimeString();
let d=document.createElement("div");
d.className="msg";
d.textContent=`${m.name} [${time}] ${m.text}`;
chat.appendChild(d);
});
chat.scrollTop=99999;
});

//////////////////// ç™»å…¥ ////////////////////

auth.signInAnonymously();

auth.onAuthStateChanged(async user=>{
me=user;
let ref=db.ref("users/"+user.uid);

let snap=await ref.once("value");
if(!snap.exists()){
let name=prompt("æš±ç¨±");
await ref.set({name:name||"è¨ªå®¢"});
}

ref.on("value",s=>myData=s.val());

ref.child("online").set(true);
ref.child("online").onDisconnect().set(false);

db.ref("users").on("value",snap=>{
userList.innerHTML="";
snap.forEach(s=>{
let u=s.val();
let d=document.createElement("div");
d.className="user "+(u.online?"online":"offline");
d.textContent=u.name;
userList.appendChild(d);
});
});
});

</script>
</body>
</html>
