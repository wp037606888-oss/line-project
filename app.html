<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¬è±ª - é›²çŸ³ä¸»æ§å° v14.2</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* å¼•å…¥ v14.1 çš„é ‚ç´šå­—é«” */
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Noto+Serif+TC:wght@500;700;900&family=Noto+Sans+TC:wght@400;500;700&family=Rajdhani:wght@600;700&family=Monsieur+La+Doulaise&display=swap');

:root {
    /* --- é›²çŸ³é…è‰²ç³»çµ± (Light Mode) --- */
    --stone-bg: #f2f2f2;
    --stone-card: rgba(255, 255, 255, 0.75);
    --border-stone: rgba(200, 200, 200, 0.6);
    
    /* éˆ¦é‡‘å±¬æ·±è‰² (ç”¨æ–¼æ–‡å­—) */
    --titanium-dark: #1a1a1a;
    --titanium-grey: #4a4a4a;
    --titanium-light: #888888;

    /* é»ç¶´è‰² (ä½èª¿å¥¢è¯) */
    --gold-accent: #8c7b75; /* å¤éŠ…é‡‘ */
    --gold-active: #b8860b; /* äº®é‡‘ */
    
    /* åŠŸèƒ½è‰² (æ·±è‰²ç‰ˆï¼Œåœ¨ç™½åº•æ‰æ¸…æ¥š) */
    --success: #2e7d32; /* æ·±ç¶  */
    --danger: #c62828;  /* æ·±ç´… */
    
    /* é™°å½± */
    --shadow-soft: 0 10px 30px rgba(0,0,0,0.08);
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

body {
    margin: 0; font-family: "Noto Serif TC", serif; /* ä¸»é«”æ”¹ç‚ºå®‹é«”ï¼Œæ›´æœ‰æ°£è³ª */
    background-color: var(--stone-bg);
    color: var(--titanium-dark);
    display: flex; height: 100vh; overflow: hidden; font-size: 15px;
}

/* --- èƒŒæ™¯ï¼šçœŸå¯¦å¤§ç†çŸ³ç´‹ç† (SVG) --- */
.marble-bg {
    position: fixed; inset: 0; z-index: 0; pointer-events: none;
    background-image: url("data:image/svg+xml,%3Csvg width='2000' height='2000' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.002' numOctaves='5' stitchTiles='stitch'/%3E%3CfeColorMatrix type='matrix' values='1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 25 -15' result='contrastNoise'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.12'/%3E%3C/svg%3E");
    background-size: cover; opacity: 0.8;
}
canvas#bg { position: fixed; inset: 0; z-index: 1; pointer-events: none; mix-blend-mode: multiply; opacity: 0.3; }

/* --- ä¸»ä½ˆå±€ (ä¿æŒä¸è®Š) --- */
#layout { display: flex; width: 100%; height: 100%; z-index: 10; position: relative; padding: 25px; gap: 20px; }
#dashboard { flex: 1.8; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-right: 5px; min-width: 400px; }
#comms { flex: 1; display: flex; flex-direction: column; gap: 0; min-width: 320px; height: 100%; overflow: hidden; position: relative; }

/* --- ç™½ç‰ç»ç’ƒé¢æ¿ (White Jade Panel) --- */
.glass-panel {
    background: var(--stone-card);
    backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
    border: 1px solid #fff;
    border-bottom: 1px solid #d1d1d1;
    border-radius: 6px; 
    padding: 25px;
    box-shadow: var(--shadow-soft);
    position: relative; flex-shrink: 0;
    transition: box-shadow 0.3s;
}
.glass-panel:hover { box-shadow: 0 15px 40px rgba(0,0,0,0.12); }

/* --- æ¨™é¡Œèˆ‡æ–‡å­— --- */
h3 { 
    margin: 0 0 15px 0; font-size: 15px; 
    color: var(--titanium-dark); font-family: 'Noto Serif TC', serif; 
    letter-spacing: 2px; font-weight: 700;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 2px solid rgba(0,0,0,0.05); padding-bottom: 8px;
}
/* æ•¸å­—å­—é«” */
h3 span { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 18px; color: var(--gold-active); }

/* --- ç‹€æ…‹å€ --- */
.status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.user-badge { 
    font-family: 'Noto Serif TC', serif; font-weight: 700; font-size: 18px;
    color: var(--titanium-dark); 
    display: flex; align-items: center; gap: 8px;
}
/* çš‡å† åœ–æ¨™ */
.user-badge::before { content: 'IV'; font-family: 'Cormorant Garamond'; font-weight:bold; color: var(--gold-accent); font-size: 20px; border:1px solid var(--gold-accent); padding:0 4px; border-radius:2px; }

.btn-logout { 
    background: transparent; border: 1px solid #ccc; color: #666; 
    cursor: pointer; padding: 5px 12px; border-radius: 2px; font-size: 11px; 
    transition: .3s; font-family: "Noto Sans TC"; letter-spacing: 1px;
}
.btn-logout:hover { border-color: var(--titanium-dark); color: #000; background: #fff; }

#clock {
    font-family: 'Rajdhani', sans-serif; font-size: 54px; line-height: 1;
    font-weight: 700; color: var(--titanium-dark); 
    margin: 10px 0 5px; letter-spacing: 2px;
}
#slotDisplay { font-size: 14px; color: var(--gold-accent); letter-spacing: 2px; font-family: "Noto Serif TC"; font-weight: 600; }
#status { font-size: 16px; font-weight: 500; margin: 10px 0 20px; min-height: 24px; letter-spacing: 1px; color: var(--titanium-grey); }

/* --- å¯¦é«”æŒ‰éˆ•ç³»çµ± (Solid Buttons) --- */
.control-grid { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; }
button.action-btn {
    flex: 1; min-width: 120px; padding: 18px 10px; 
    border: none; border-radius: 3px;
    font-size: 14px; font-weight: 600; font-family: "Noto Sans TC"; letter-spacing: 1px;
    cursor: pointer; transition: all 0.3s;
    background: #e0e0e0; color: #555; /* é è¨­ç° */
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}
button.action-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }

/* é¡è‰²å®šç¾© */
.btn-gold { background: var(--titanium-dark) !important; color: #fff !important; } /* é»‘åº•ç™½å­— */
.btn-gold:hover { background: #000 !important; }

.btn-green { background: #fff !important; border: 1px solid var(--success) !important; color: var(--success) !important; }
.btn-green:hover { background: var(--success) !important; color: #fff !important; }

.btn-red { background: #fff !important; border: 1px solid var(--danger) !important; color: var(--danger) !important; }
.btn-red:hover { background: var(--danger) !important; color: #fff !important; }

/* --- ç›£æ§ç¶²æ ¼ --- */
.monitor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.monitor-left { display: flex; flex-direction: column; gap: 16px; }
.monitor-right { display: flex; flex-direction: column; }
.monitor-right .glass-panel { flex: 1; display: flex; flex-direction: column; }
.monitor-right .list-container { flex: 1; max-height: none; }

/* --- åˆ—è¡¨é …ç›® (Paper Card Style) --- */
.item-card { 
    background: #fff; /* ç´”ç™½å¡ç‰‡ */
    margin-bottom: 8px; padding: 12px 16px; border-radius: 3px;
    border: 1px solid #eee;
    border-left: 3px solid #ccc; 
    display: flex; justify-content: space-between; align-items: center; 
    font-size: 14px; transition: 0.3s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.02);
}
.item-card:hover { transform: translateX(3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
.item-card.rank-1 { border-left-color: var(--titanium-dark); background: #fdfdfd; }
.item-card.rank-2 { border-left-color: var(--gold-accent); }

.btn-mini { padding: 3px 8px; font-size: 11px; border: 1px solid #ccc; background: transparent; color: #666; cursor: pointer; margin-left: 8px; border-radius: 2px; transition: 0.2s; }
.btn-mini:hover { background: #333; color: #fff; border-color: #333; }
.btn-arrow { background:none; border:none; color:#999; cursor:pointer; font-size:10px; margin-left:2px; transition:0.2s; }
.btn-arrow:hover { color:#000; transform: scale(1.2); }

/* --- èŠå¤©å®¤ --- */
#comms.glass-panel { padding: 0; display: flex; flex-direction: column; background: rgba(255,255,255,0.85); }
#chat-header { 
    padding: 15px 20px; background: rgba(240,240,240,0.5); 
    border-bottom: 1px solid rgba(0,0,0,0.05);
}
.chat-title { 
    font-family: 'Cormorant Garamond'; font-size: 16px; color: var(--titanium-dark); 
    letter-spacing: 3px; font-weight: 700; margin-bottom: 10px; display: block; text-transform: uppercase;
}

#onlineUserList { display: flex; gap: 6px; flex-wrap: wrap; width: 100%; }
.online-pill { 
    padding: 4px 10px; border-radius: 20px; font-size: 11px; 
    background: #fff; border: 1px solid #ddd; 
    color: #666; white-space: nowrap; display: flex; align-items: center; gap: 5px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.online-dot { width: 6px; height: 6px; border-radius: 50%; background: #ccc; }
.online-pill.online .online-dot { background: var(--success); }
.online-pill.admin { border-color: var(--titanium-dark); color: #000; font-weight: bold; }

#chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }

/* è¨Šæ¯æ°£æ³¡ (Clean Style) */
.msg-bubble { 
    max-width: 85%; padding: 10px 14px; border-radius: 8px; 
    font-size: 13px; line-height: 1.5; position: relative; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.msg-mine { 
    align-self: flex-end; 
    background: var(--titanium-dark); /* æ·±é»‘æ°£æ³¡ */
    color: #fff; 
    border-bottom-right-radius: 2px;
}
.msg-other { 
    align-self: flex-start; 
    background: #fff; 
    border: 1px solid #eee;
    color: #333; 
    border-bottom-left-radius: 2px;
}
.msg-name { font-size: 10px; margin-bottom: 3px; opacity: 0.6; font-family: 'Noto Serif TC'; letter-spacing: 1px; }
.msg-img { max-width: 100%; border-radius: 4px; margin-top: 5px; border: 1px solid #eee; }

/* è¼¸å…¥å€ */
.input-area { padding: 15px; background: #fff; border-top: 1px solid rgba(0,0,0,0.05); display: flex; gap: 10px; align-items: center; }
input#msg { 
    flex: 1; background: transparent; border: none; border-bottom: 1px solid #ddd;
    border-radius: 0; padding: 8px 0; color: #333; font-family: "Noto Serif TC"; font-size: 15px;
    transition: .3s; 
}
input#msg:focus { border-bottom-color: var(--titanium-dark); }
.btn-tool { background: transparent; border: none; font-size: 18px; cursor: pointer; color: #999; transition: .3s; }
.btn-tool:hover { color: #333; }
button.btn-send { 
    background: var(--titanium-dark); border: none; color: #fff; 
    width: 36px; height: 36px; border-radius: 50%; cursor: pointer; 
    font-weight: bold; flex-shrink: 0; transition:0.3s;
}
button.btn-send:hover { background: #000; transform: scale(1.1); }

/* --- ç°½åæ°´å° --- */
.kid-seal {
    position: fixed; bottom: 20px; right: 20px; z-index: 0;
    font-family: 'Monsieur La Doulaise', cursive; font-size: 24px;
    color: rgba(0,0,0,0.1); transform: rotate(-5deg);
    pointer-events: none;
}

/* --- Admin & Modals --- */
#adminModal { position: fixed; inset: 0; z-index: 200; background: rgba(255,255,255,0.6); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; }
#adminModal.show { display: flex; }
.admin-card { width: 450px; background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 35px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
select#adminUserSelect {
    appearance: none; -webkit-appearance: none;
    background: #f9f9f9 url("data:image/svg+xml;utf8,<svg fill='black' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>") no-repeat right 10px center;
    color: #333; border: 1px solid #ddd; padding: 10px 15px; border-radius: 2px; font-family: "Noto Sans TC"; width: 100%;
}

/* RWD */
@media (max-width: 900px) {
    #layout { flex-direction: column; padding: 10px; gap: 10px; }
    #dashboard { flex: none; width: 100%; min-width: 0; max-height: 55vh; }
    #comms { flex: 1; min-width: 0; height: 45vh; }
    .monitor-grid { grid-template-columns: 1fr; }
}
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 2px; }
</style>
</head>

<body>
<div class="marble-bg"></div>
<canvas id="bg"></canvas>

<div id="imgModal" onclick="this.style.display='none'" style="position: fixed; inset: 0; z-index: 300; background: rgba(255,255,255,0.95); display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
    <img id="imgModalSrc" src="" style="max-width: 90%; max-height: 90%; border: 5px solid #fff; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
</div>

<div id="broadcastBanner" style="position: fixed; top: -200px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; z-index: 9999; background: #fff; border: 1px solid #000; border-radius: 2px; padding: 25px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.15); transition: top 0.6s cubic-bezier(0.22, 1, 0.36, 1);">
    <h3 style="border:none; justify-content:center; color:#000; margin-bottom:10px;">ğŸ“¢ é…’åº—è¡Œæ”¿å…¬å‘Š</h3>
    <p id="broadcastText" style="font-size:18px; font-weight:500; color:#333; margin:0; font-family:'Noto Serif TC';">---</p>
</div>

<button id="btnAdminFloat" onclick="openAdmin()" style="display:none; position: fixed; bottom: 80px; left: 20px; z-index: 100; width: 45px; height: 45px; border-radius: 50%; background: #fff; border: 1px solid #ccc; color: #333; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">âš™ï¸</button>
<button id="btnGame" onclick="location.href='game.html'" title="å‰å¾€éŠæ¨‚å ´" style="position: fixed; bottom: 20px; left: 20px; z-index: 100; width: 45px; height: 45px; border-radius: 50%; background: #1a1a1a; border: 1px solid #1a1a1a; color: #fff; font-size: 20px; cursor: pointer; display: none; align-items: center; justify-content: center; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">ğŸ®</button>

<div class="kid-seal">Designed by KID</div>

<div id="adminModal" onclick="if(event.target===this)closeAdmin()">
    <div class="admin-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h2 style="margin:0; color:#000; font-family:'Noto Serif TC'; font-size:22px;">è¡Œæ”¿ç®¡ç†å°</h2>
            <button onclick="closeAdmin()" style="background:none; border:none; color:#999; cursor:pointer; font-size:20px;">âœ•</button>
        </div>
        
        <div style="margin-bottom: 30px;">
            <h4 style="color:#888; font-size:11px; margin-bottom:12px; letter-spacing:1px;">æ’éšŠç®¡ç†</h4>
            <div style="display:flex; gap:10px;">
                <select id="adminUserSelect"></select>
                <button onclick="adminForceAdd()" style="background:#000; color:#fff; border:none; padding:0 20px; font-weight:bold; cursor:pointer; border-radius:2px; flex-shrink:0;">åŠ å…¥</button>
            </div>
        </div>

        <div style="margin-bottom: 30px;">
            <h4 style="color:#888; font-size:11px; margin-bottom:12px; letter-spacing:1px;">å…¨åŸŸå»£æ’­</h4>
            <div style="display:flex; gap:10px;">
                <input id="broadcastInput" style="flex:1; background:#f9f9f9; border:1px solid #ddd; padding:10px; color:#333; border-radius:2px;" placeholder="è¼¸å…¥å…§å®¹...">
                <button onclick="sendBroadcast()" style="background:#666; color:#fff; border:none; padding:0 15px; font-weight:bold; cursor:pointer; border-radius:2px; flex-shrink:0;">ç™¼é€</button>
            </div>
        </div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <button id="btnTogglePg" onclick="togglePlayground()" style="grid-column: span 2; padding: 14px; border-radius: 2px; border: 1px solid #ccc; background: #fff; color: #333; cursor: pointer;">éŠæ¨‚å ´é–‹é—œ</button>
            <button onclick="resetQueue()" style="padding: 14px; border-radius: 2px; border: 1px solid #c62828; background: #fff; color: #c62828; cursor: pointer;">é‡ç½®ç³»çµ±</button>
            <button onclick="clearChat()" style="padding: 14px; border-radius: 2px; border: 1px solid #ccc; background: #fff; color: #666; cursor: pointer;">æ¸…ç©ºèŠå¤©</button>
            <button onclick="forceReload()" style="grid-column: span 2; padding: 14px; border-radius: 2px; border: 1px solid #000; background: #000; color: #fff; cursor: pointer;">å…¨é«”å¼·åˆ¶åˆ·æ–°</button>
        </div>
    </div>
</div>

<div id="layout">
    <div id="dashboard">
        <div class="glass-panel" style="flex-shrink: 0;">
            <div class="status-header">
                <div class="user-badge" id="who">GUEST</div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-logout" onclick="enableNotification()" id="btnNotify" style="display:none;">ğŸ””</button>
                    <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
                </div>
            </div>
            <div id="clock">00:00:00</div>
            <div id="slotDisplay">---</div>
            <div id="status">ç³»çµ±é€£ç·šä¸­...</div>
            <div class="control-grid">
                <button id="bReserve" onclick="reserve()" class="action-btn btn-gold">é ç´„æ’éšŠ</button>
                <button id="bOut" onclick="goOut()" class="action-btn btn-green">ç¾åœ¨å‰å¾€</button>
                <button id="bBack" onclick="comeBack()" class="action-btn btn-red">ç¢ºèªè¿”å›</button>
                <button id="bCancel" onclick="cancelReserve()" class="action-btn">å–æ¶ˆé ç´„</button>
            </div>
        </div>

        <div class="monitor-grid">
            <div class="monitor-left">
                <div class="glass-panel">
                    <h3><span>å¤–å‡ºè²´è³“</span><span id="outCountNum" style="color:var(--success)">0 / 3</span></h3>
                    <div id="outList" class="list-container"></div>
                </div>
                <div class="glass-panel">
                    <h3><span>æ­·å²ç´€éŒ„</span></h3>
                    <div id="history" class="list-container"></div>
                </div>
            </div>
            <div class="monitor-right">
                <div class="glass-panel">
                    <h3><span>å€™ä½åå–®</span></h3>
                    <div id="queue" class="list-container"></div>
                </div>
            </div>
        </div>

        <div class="glass-panel" style="flex-shrink: 0;">
            <h3><span>SYSTEM LOG</span></h3>
            <div id="log" class="list-container" style="font-family: 'Rajdhani', monospace; font-size: 12px; color:#888; max-height:100px;"></div>
        </div>
    </div>

    <div id="comms" class="glass-panel">
        <div id="chat-header">
            <div class="chat-title">Executive Chat</div>
            <div id="onlineUserList"></div>
        </div>
        <div id="chat-box"></div>
        <div id="emojiPicker" style="position: absolute; bottom: 70px; left: 15px; width: 300px; background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 10px; display: none; grid-template-columns: repeat(6, 1fr); gap: 5px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); z-index: 50;"></div>
        <div class="input-area">
            <input type="file" id="imgInput" hidden accept="image/*" onchange="handleFile(event)">
            <button class="btn-tool" onclick="document.getElementById('imgInput').click()" title="åœ–ç‰‡">ğŸ“·</button>
            <button class="btn-tool" onclick="toggleEmoji()" title="è¡¨æƒ…">ğŸ˜€</button>
            <input id="msg" placeholder="è¼¸å…¥è¨Šæ¯..." onkeydown="if(event.key==='Enter')send()" autocomplete="off">
            <button onclick="send()" class="btn-send">â¤</button>
        </div>
    </div>
</div>

<script>
/* --- Init --- */
const config={apiKey:"AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",authDomain:"smoke-queue.firebaseapp.com",databaseURL:"https://smoke-queue-default-rtdb.firebaseio.com",projectId:"smoke-queue"};
firebase.initializeApp(config);
const db=firebase.database(), auth=firebase.auth();
const queueRef=db.ref("queue"), userRef=db.ref("users"), chatRef=db.ref("chat"), logRef=db.ref("log"), broadcastRef=db.ref("broadcast"), configRef=db.ref("config");

let me, myData, engineReady=false, cacheQueue={}, currentSlotInfo={phase:'',slot:0}, allUsers={};
let audioCtx=null, notifyEnabled=false;
let playgroundEnabled = false;

function escapeHtml(text) {
    if (!text) return text;
    return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

/* --- æ·±ç°å¾®å¡µç²’å­ --- */
const canvas=document.getElementById("bg"), ctx=canvas.getContext("2d");
let w,h; function resize(){w=canvas.width=innerWidth;h=canvas.height=innerHeight;} window.onresize=resize; resize();
const particles=[]; 
for(let i=0;i<30;i++) particles.push({x:Math.random()*w, y:Math.random()*h, vy:Math.random()*0.2+0.1, size:Math.random()*1.5, alpha:Math.random()*0.3+0.1});
function draw(){
    ctx.clearRect(0,0,w,h);
    particles.forEach(p=>{
        p.y-=p.vy; if(p.y<0){p.y=h;p.x=Math.random()*w;}
        ctx.fillStyle=`rgba(80, 80, 80, ${p.alpha})`; // æ·±ç°è‰²ç²’å­
        ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
    });
    requestAnimationFrame(draw);
}
draw();

/* --- Auth --- */
auth.onAuthStateChanged(user=>{
    if(!user){location.href="login.html";return;} me=user;
    userRef.child(user.uid).on("value",s=>{
        myData=s.val()||{};
        document.getElementById("who").textContent=`${(myData.name||"GUEST").toUpperCase()}`;
        document.getElementById("btnAdminFloat").style.display=(myData.role==="admin")?"flex":"none";
        engineReady=true;
        
        // ğŸŸ¢ ç®¡ç†å“¡åŠŸèƒ½ä¿®å¾©ï¼šç¢ºä¿ä¸‹æ‹‰é¸å–®æœ‰è³‡æ–™
        if(myData.role === "admin") { 
            userRef.on("value", snap => { 
                allUsers = snap.val() || {}; 
                if(document.getElementById('adminModal').classList.contains('show')) updateAdminUserSelect();
            }); 
        }
        
        renderStaticLists(); updateButtonStates(); renderOutList(); 
    });
    userRef.child(user.uid+"/online").set(true);
    userRef.child(user.uid+"/online").onDisconnect().set(false);
});
function logout(){auth.signOut().then(()=>{location.href="login.html";});}

/* --- Admin Logic --- */
function updateAdminUserSelect() {
    const sel = document.getElementById("adminUserSelect"); 
    sel.innerHTML = "<option value=''>é¸æ“‡è²´è³“...</option>";
    const userArray = Object.entries(allUsers).map(([uid, u]) => ({uid, ...u})).sort((a,b) => (a.name || "").localeCompare(b.name || ""));
    userArray.forEach(u => {
        let isReserved = cacheQueue.reserve && cacheQueue.reserve[u.uid];
        let isOut = cacheQueue.out && cacheQueue.out[u.uid];
        if(!isReserved && !isOut) { let opt=document.createElement("option"); opt.value=u.uid; opt.textContent=u.name; sel.appendChild(opt); }
    });
}
function adminForceAdd() {
    const uid = document.getElementById("adminUserSelect").value; if(!uid) return;
    const u = allUsers[uid];
    if(u) {
        let h=new Date().getHours(), t=currentSlotInfo.phase==='RESERVE'?currentSlotInfo.slot:h;
        queueRef.child("reserve/"+uid).set({name: u.name, time: Date.now(), slot: t});
        addLog(`ADMIN é‚€è«‹: ${u.name}`); closeAdmin();
    }
}
function moveQueue(uid, direction) {
    if(!myData || myData.role !== 'admin') return;
    let r = cacheQueue.reserve || {};
    let sorted = Object.entries(r).sort((a,b) => a[1].time - b[1].time);
    let idx = sorted.findIndex(x => x[0] === uid);
    if (idx === -1) return;
    let targetIdx = idx + direction;
    if (targetIdx < 0 || targetIdx >= sorted.length) return;
    let targetUid = sorted[targetIdx][0];
    let myTime = sorted[idx][1].time; let targetTime = sorted[targetIdx][1].time;
    if (myTime === targetTime) { if(direction < 0) targetTime -= 1; else targetTime += 1; }
    queueRef.child('reserve/' + uid).update({ time: targetTime });
    queueRef.child('reserve/' + targetUid).update({ time: myTime });
}
function openAdmin(){ document.getElementById('adminModal').classList.add('show'); if(Object.keys(allUsers).length > 0) updateAdminUserSelect(); else userRef.once("value").then(snap => { allUsers = snap.val() || {}; updateAdminUserSelect(); }); }
function closeAdmin(){document.getElementById('adminModal').classList.remove('show');}
function sendBroadcast(){const i=document.getElementById('broadcastInput');if(!i.value.trim())return;broadcastRef.set({text:i.value,t:Date.now()});i.value="";closeAdmin();}
broadcastRef.on("value",s=>{
    const v=s.val(); if(!v||Date.now()-v.t>10000)return;
    const b=document.getElementById('broadcastBanner');
    document.getElementById('broadcastText').textContent=v.text;
    b.style.top="30px"; playBeep('urgent'); setTimeout(()=>b.style.top="-200px",5000);
});

/* --- Chat --- */
const emojis = ["ğŸ˜€","ğŸ˜‚","ğŸ˜","ğŸ˜","ğŸ¤”","ğŸ˜­","ğŸ˜¡","ğŸ‘","ğŸ‘","ğŸš¬","ğŸ”¥","â˜•","ğŸº","ğŸ’¨","ğŸ‘€","â¤ï¸","âœ…","âŒ"];
const emojiPicker = document.getElementById("emojiPicker");
emojis.forEach(e => { const btn = document.createElement("button"); btn.className = "emoji-btn"; btn.textContent = e; btn.onclick = () => { document.getElementById("msg").value += e; toggleEmoji(); document.getElementById("msg").focus(); }; emojiPicker.appendChild(btn); });
function toggleEmoji() { emojiPicker.classList.toggle("show"); }
function handleFile(e) {
    const file = e.target.files[0]; if(!file) return;
    if(file.size > 2 * 1024 * 1024) { alert("åœ–ç‰‡éå¤§ (Max 2MB)"); return; }
    const reader = new FileReader();
    reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width, height = img.height;
            if (width > 400) { height *= 400 / width; width = 400; }
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
            chatRef.push({ name: myData.name, uid: me.uid, text: canvas.toDataURL('image/jpeg', 0.7), type: 'image', time: Date.now() });
        }
        img.src = event.target.result;
    }
    reader.readAsDataURL(file); e.target.value = '';
}
function send(){ let i=document.getElementById("msg"); if(!i.value.trim())return; chatRef.push({ name:myData.name, uid:me.uid, text:i.value, type: 'text', time:Date.now() }); i.value=""; emojiPicker.classList.remove("show"); }
chatRef.limitToLast(30).on("value",s=>{
    let b=document.getElementById("chat-box"); b.innerHTML="";
    s.forEach(x=>{
        let m=x.val(), meMsg=m.uid===me.uid;
        let div=document.createElement("div"); div.className=`msg-bubble ${meMsg?'msg-mine':'msg-other'}`;
        let content = m.type === 'image' ? `<img src="${m.text}" class="msg-img" onclick="showImg(this.src)">` : escapeHtml(m.text);
        div.innerHTML=`<div class="msg-name">${m.name}</div>${content}`;
        b.appendChild(div);
    });
    b.scrollTop=b.scrollHeight;
});
function showImg(src) { document.getElementById("imgModalSrc").src = src; document.getElementById("imgModal").style.display = "flex"; }

/* --- Core --- */
function format12H(d){return d.toLocaleTimeString('en-US',{hour12:true,hour:'2-digit',minute:'2-digit',second:'2-digit'});}
function getSlotStatus(h,m){
    const slots=[14,16,18,20,22,0];
    let currentSlot=slots.find(s=>s===h);
    const to12HStr = (hr) => { let suffix = (hr >= 12 && hr < 24) ? "PM" : "AM"; let dH = (hr % 12) || 12; return `${dH}:00 ${suffix}`; };
    if(currentSlot!==undefined){ return {phase:'OUT',slot:currentSlot,display:`${to12HStr(currentSlot)} é–‹æ”¾æ™‚æ®µ`}; }
    let target=slots.find(s=>(s===0?24:s)>h)||14;
    let diff=(target===0?24:target)*60-(h*60+m);
    if(diff>0&&diff<=30){ return {phase:'RESERVE',slot:target,display:`é ç´„ä¸­ ${to12HStr(target)}`}; }
    return {phase:'BREAK',nextSlot:target,display:`ä¸‹å€‹æ™‚æ®µ ${to12HStr(target)}`, hint:''};
}
setInterval(()=>{
    if(!engineReady)return;
    const now=new Date(), h=now.getHours(), m=now.getMinutes();
    document.getElementById("clock").textContent=format12H(now);
    currentSlotInfo=getSlotStatus(h,m);
    let dText = currentSlotInfo.display;
    if(currentSlotInfo.phase === 'BREAK') dText += ` (ä¼‘æ¯ä¸­)`;
    document.getElementById("slotDisplay").textContent=dText;
    if(h===1&&m===0&&now.getSeconds()===0&&myData.role==="admin") resetQueue();
    updateButtonStates(); renderOutList(); 
},1000);
queueRef.on("value",s=>{ cacheQueue=s.val()||{}; if(engineReady){ renderStaticLists(); updateButtonStates(); renderOutList(); } });

function updateButtonStates(){
    if(!me||!cacheQueue)return;
    let r=cacheQueue.reserve||{},o=cacheQueue.out||{},used=cacheQueue.used||{};
    let sorted=Object.entries(r).sort((a,b)=>a[1].time-b[1].time);
    let outCount=Object.keys(o).length;
    let myRank=sorted.findIndex(x=>x[0]===me.uid);
    let alreadyUsed = used[currentSlotInfo.slot]?.[me.uid];
    const hideAll = () => { bReserve.style.display='none'; bOut.style.display='none'; bBack.style.display='none'; bCancel.style.display='none'; }; hideAll();
    if(alreadyUsed) {} 
    else if(o[me.uid]) { bBack.style.display='block'; } 
    else if(r[me.uid]) { bCancel.style.display='block'; if(currentSlotInfo.phase==='OUT' && myRank<=1 && outCount<3){ bOut.style.display='block'; } } 
    else { bReserve.style.display='block'; }
    let st=document.getElementById("status");
    if(alreadyUsed) st.innerHTML="<span style='color:#999'>æœ¬æ™‚æ®µå·²äº«ç”¨</span>";
    else if(o[me.uid]) st.innerHTML="<span style='color:var(--success)'>â— ä½¿ç”¨ä¸­ (ENJOYING)</span>";
    else if(r[me.uid]) {
        if(currentSlotInfo.phase==='OUT'){
            if(myRank<=1&&outCount<3) st.innerHTML="<span style='color:var(--success)'>åé¡é–‹æ”¾ï¼Œè«‹å‡ºç™¼</span>";
            else if(outCount>=3) st.innerHTML="<span style='color:var(--gold-accent)'>æ»¿ä½ç­‰å€™ä¸­...</span>";
            else st.innerHTML=`<span>ç­‰å¾…é †ä½: ${myRank+1}</span>`;
        } else st.innerHTML="<span style='color:var(--gold-accent)'>é ç´„æˆåŠŸ (å¾…é–‹æ”¾)</span>";
    } else {
        if(currentSlotInfo.phase==='BREAK') st.innerHTML="<span style='color:#999'>ç­‰å¾…ä¸‹ä¸€æ™‚æ®µ</span>";
        else if(currentSlotInfo.phase==='RESERVE') st.innerHTML="<span style='color:var(--success)'>é–‹æ”¾é ç´„ä¸­</span>";
        else st.innerHTML="<span style='color:#999'>å°šæœªé ç´„</span>";
    }
    document.getElementById("outCountNum").textContent=`${outCount} / 3`;
}

function renderStaticLists(){
    let r=cacheQueue.reserve||{}, sorted=Object.entries(r).sort((a,b)=>a[1].time-b[1].time);
    document.getElementById("queue").innerHTML=sorted.map((u,i)=>{
        let btn=(myData&&myData.role==="admin")?`<button onclick="forceGoOut('${u[0]}')" class="btn-mini" style="color:var(--success);border-color:var(--success);">æ´¾ç™¼</button>`:"";
        let moveBtns = (myData&&myData.role==="admin")?`<button onclick="moveQueue('${u[0]}',-1)" class="btn-arrow">â–²</button><button onclick="moveQueue('${u[0]}',1)" class="btn-arrow">â–¼</button>`:"";
        let rc=i===0?'rank-1':(i===1?'rank-2':'');
        return `<div class="item-card ${rc}"><div><span style="font-family:'Rajdhani';color:var(--titanium-dark);margin-right:8px;font-weight:bold;">${i+1}</span><strong>${u[1].name}</strong></div><div style="display:flex;align-items:center;"><small style='opacity:0.6;margin-right:5px;font-family:"Rajdhani"'>${new Date(u[1].time).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'})}</small>${btn}${moveBtns}</div></div>`;
    }).join('')||"<div style='opacity:0.5;padding:10px;text-align:center;'>ç›®å‰ç©ºé–’</div>";

    let hist=[]; if(cacheQueue.history)Object.values(cacheQueue.history).forEach(h=>hist.push({...h,sortT:h.backTime}));
    let o=cacheQueue.out||{}; 
    Object.entries(o).forEach(([uid,u])=>{if(Math.floor((Date.now()-u.time)/1000)>600)hist.push({name:u.name,outTime:u.time,backTime:null,over:true,sortT:Date.now()});});
    document.getElementById("history").innerHTML=hist.sort((a,b)=>b.sortT-a.sortT).slice(0,20).map(i=>`<div class="item-card" style="padding:10px 16px;border:none;background:rgba(0,0,0,0.02);box-shadow:none;"><span>${i.name} ${i.over?'<span style="color:var(--danger)">!</span>':''}</span><small style='opacity:0.6;font-family:"Rajdhani"'>${new Date(i.outTime).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'})} - ${i.backTime?new Date(i.backTime).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'}):'OUT'}</small></div>`).join('');
}

function renderOutList(){
    let o=cacheQueue.out||{}; 
    document.getElementById("outList").innerHTML=Object.entries(o).map(([uid,u])=>{
        let s=Math.floor((Date.now()-u.time)/1000);
        let btn=(myData&&myData.role==="admin")?`<button onclick="forceComeBack('${uid}')" class="btn-mini" style="color:var(--danger);border-color:var(--danger);">å¬å›</button>`:"";
        return `<div class="item-card" style="border-left-color:var(--success);"><strong>${u.name}</strong><div style="display:flex;align-items:center;gap:8px;"><span class="${s>600?'text-danger':''}" style="font-family:'Rajdhani';color:${s>600?'var(--danger)':'#666'}">${Math.floor(s/60)}m ${s%60}s</span>${btn}</div></div>`;
    }).join('')||"<div style='opacity:0.5;padding:10px;text-align:center;'>ç„¡äººå¤–å‡º</div>";
}

/* --- Misc --- */
function enableNotification(){if(!("Notification" in window))return;Notification.requestPermission().then(p=>{if(p==="granted"){notifyEnabled=true;playBeep();document.getElementById("btnNotify").style.display="none";}});}
if(Notification.permission!=="granted") document.getElementById("btnNotify").style.display="inline-block";
function playBeep(t='normal'){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);if(t==='urgent'){o.frequency.value=880;o.type='square';o.start();setTimeout(()=>o.stop(),100);setTimeout(()=>{const o2=audioCtx.createOscillator(),g2=audioCtx.createGain();o2.connect(g2);g2.connect(audioCtx.destination);o2.frequency.value=880;o2.type='square';o2.start();setTimeout(()=>o2.stop(),100);},150);}else{o.frequency.value=523.25;o.type='sine';g.gain.setValueAtTime(0.05,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.00001,audioCtx.currentTime+0.5);o.start();o.stop(audioCtx.currentTime+0.5);}}
function forceComeBack(uid){if(confirm("å¼·åˆ¶å¬å›ï¼Ÿ"))queueRef.child("out/"+uid).once("value").then(s=>{let u=s.val();if(u){let now=Date.now(),slot=new Date(u.time).getHours();queueRef.child(`used/${slot}/${uid}`).set(true);queueRef.child("history").push({name:u.name,slot,outTime:u.time,backTime:now,over:(now-u.time)>600000});queueRef.child("out/"+uid).remove();addLog(`ADMIN å¬å›: ${u.name}`);}});}
function forceGoOut(uid){if(confirm("å¼·åˆ¶æ´¾ç™¼ï¼Ÿ"))queueRef.child("reserve/"+uid).once("value").then(s=>{let u=s.val();if(u){queueRef.child("out/"+uid).set({name:u.name,time:Date.now()}).then(()=>{queueRef.child("reserve/"+uid).remove();addLog(`ADMIN æ´¾ç™¼: ${u.name}`);});}});}
function forceReload(){db.ref("reload").set(Date.now());}
function resetQueue(){ if(confirm("ç¢ºå®šæ¸…ç©ºç‹€æ…‹ï¼Ÿ")) { queueRef.child("reserve").remove(); queueRef.child("out").remove(); queueRef.child("used").remove(); addLog("ADMIN é‡ç½®ç³»çµ±"); } }
function clearChat(){ if(confirm("æ¸…ç©ºèŠå¤©å®¤ï¼Ÿ")) chatRef.remove(); }
function clearHistory(){ if(confirm("æ¸…ç©ºæ­·å²ç´€éŒ„ï¼Ÿ")) queueRef.child("history").remove(); }
function clearLog(){ if(confirm("æ¸…ç©ºç³»çµ±æ—¥èªŒï¼Ÿ")) logRef.remove(); }
function addLog(t){logRef.push({t,time:Date.now()});}
logRef.limitToLast(15).on("value",s=>{const b=document.getElementById("log");b.innerHTML="";s.forEach(x=>{let d=x.val();let dv=document.createElement("div");dv.innerHTML=`<span style="opacity:0.5;font-family:'Rajdhani'">[${new Date(d.time).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'})}]</span> ${d.t}`;b.appendChild(dv);});b.scrollTop=b.scrollHeight;});
function reserve(){ if(currentSlotInfo.phase === 'BREAK'){ alert(`å°šæœªé–‹æ”¾é ç´„`); return; } let h=new Date().getHours(),t=currentSlotInfo.phase==='RESERVE'?currentSlotInfo.slot:h; queueRef.child("reserve/"+me.uid).set({name:myData.name,time:Date.now(),slot:t}); if(Notification.permission!=="granted")enableNotification(); addLog(`${myData.name} é ç´„`); }
function cancelReserve(){queueRef.child("reserve/"+me.uid).remove();addLog(`${myData.name} å–æ¶ˆ`);}
function goOut(){queueRef.child("out/"+me.uid).set({name:myData.name,time:Date.now()}).then(()=>{queueRef.child("reserve/"+me.uid).remove();addLog(`${myData.name} å‡ºç™¼`);});}
function comeBack(){queueRef.child("out/"+me.uid).once("value").then(s=>{let u=s.val();if(u){let now=Date.now(),slot=new Date(u.time).getHours();queueRef.child(`used/${slot}/${me.uid}`).set(true);queueRef.child("history").push({name:u.name,slot,outTime:u.time,backTime:now,over:(now-u.time)>600000});queueRef.child("out/"+me.uid).remove();addLog(`${myData.name} è¿”å›`);}});}
configRef.child("playground_status").on("value", s => { playgroundEnabled = s.val() || false; document.getElementById("btnGame").style.display = playgroundEnabled ? "flex" : "none"; document.getElementById("btnTogglePg").textContent = playgroundEnabled ? "éŠæ¨‚å ´ç‹€æ…‹: é–‹å•Ÿ" : "éŠæ¨‚å ´ç‹€æ…‹: é—œé–‰"; });
function togglePlayground() { configRef.child("playground_status").set(!playgroundEnabled); }
userRef.on("value",s=>{ const list=document.getElementById("onlineUserList"); list.innerHTML=""; s.forEach(u=>{ let d=u.val(); if(d.online){ let pill = document.createElement("div"); pill.className = `online-pill online ${d.role==='admin' ? 'admin' : ''}`; pill.innerHTML = `<div class="online-dot"></div>${d.name}`; list.appendChild(pill); }}); });
let fR=true;db.ref("reload").on("value",s=>{if(fR){fR=false;return;}location.reload();});
</script>
</body>
</html>
