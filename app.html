<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>æŠ½è¸æ’éšŠç³»çµ± èŠå¤©å®¤</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;font-family:Segoe UI;background:#12121a;color:white;display:flex;height:100vh}

#users{width:240px;background:#1a1a28;padding:10px;overflow:auto}
.user{padding:6px;margin:4px 0;background:#2a2a3a;border-radius:6px;cursor:pointer}
.online{border-left:4px solid #00ff88}
.offline{opacity:.4}

#queueBox{background:#101018;padding:8px;border-radius:8px;margin-bottom:10px}

#main{flex:1;display:flex;flex-direction:column}
header{background:#1f1f2e;padding:12px;text-align:center}

#adminPanel{background:#300;padding:6px;text-align:center;display:none}

#chat{flex:1;overflow:auto;padding:10px}
.msg{background:#2a2a3a;margin:6px 0;padding:8px;border-radius:8px}

footer{display:flex;padding:10px;background:#1f1f2e}
input{flex:1;padding:10px;border:none;border-radius:8px;background:#2b2b3d;color:white}
button{margin:4px 2px;padding:8px;border:none;border-radius:8px;background:#5c7cff;color:white;cursor:pointer}
</style>
</head>

<body>

<div id="users">

<div id="queueBox">
<h3>ğŸš¬ æŠ½è¸æ’éšŠ</h3>
<div id="queue"></div>
<button onclick="reserve()">é ç´„</button>
<button onclick="cancelReserve()">å–æ¶ˆ</button>
<button onclick="goOut()">å‡ºå»</button>
<button onclick="comeBack()">å›ä¾†</button>
</div>

<h3>åœ¨ç·šåå–®</h3>
<div id="userList"></div>

</div>

<div id="main">
<header>æŠ½è¸æ’éšŠç³»çµ± èŠå¤©å®¤</header>

<div id="adminPanel">
<button onclick="clearChat()">æ¸…ç©ºèŠå¤©å®¤</button>
<button onclick="forceReload()">å¼·åˆ¶å…¨é«”åˆ·æ–°</button>
</div>

<div id="chat"></div>

<footer>
<input id="msg" placeholder="è¼¸å…¥è¨Šæ¯">
<button onclick="send()">é€å‡º</button>
<button onclick="logout()">ç™»å‡º</button>
</footer>
</div>

<script>

const config={
apiKey:"AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",
authDomain:"smoke-queue.firebaseapp.com",
databaseURL:"https://smoke-queue-default-rtdb.firebaseio.com",
projectId:"smoke-queue"
};

firebase.initializeApp(config);

const auth=firebase.auth();
const db=firebase.database();

let me=null,myData=null;
let sendLock=false;

msg.addEventListener("keydown",e=>{if(e.key==="Enter")send()});

/////////////////////////////
// å¼·åˆ¶å…¨é«”åˆ·æ–° ä¿®æ­£ç‰ˆ
/////////////////////////////

let lastReload=0;

db.ref("system/reload").on("value",s=>{
const t=s.val();
if(!t) return;
if(t>lastReload){
lastReload=t;
location.reload();
}
});

/////////////////////////////
// ç™»å…¥æµç¨‹
/////////////////////////////

auth.onAuthStateChanged(async user=>{
if(!user) location.href="login.html";
me=user;

const ref=db.ref("users/"+user.uid);
let snap=await ref.once("value");

if(!snap.exists()){
let name=prompt("è«‹è¼¸å…¥ä½ çš„æš±ç¨±");
if(!name) name="è¨ªå®¢";

await ref.set({
name:name,
role:"user",
mute:false,
online:false
});
}

db.ref(".info/connected").on("value",s=>{
if(s.val()){
ref.child("online").set(true);
ref.child("online").onDisconnect().set(false);
}
});

ref.on("value",s=>{
myData=s.val();
if(myData.role==="admin"){
adminPanel.style.display="block";
}
});

loadUsers();
loadChat();
loadQueue();
});

/////////////////////////////
// åœ¨ç·šåå–®
/////////////////////////////

function loadUsers(){
db.ref("users").on("value",snap=>{
userList.innerHTML="";
snap.forEach(s=>{
const u=s.val();
const uid=s.key;

const div=document.createElement("div");
div.className="user "+(u.online?"online":"offline");
div.textContent=u.name+(u.mute?" ğŸ”‡":"");

if(myData?.role==="admin"){
div.onclick=()=>adminMenu(uid,u);
}

userList.appendChild(div);
});
});
}

function adminMenu(uid,u){
let a=prompt("1 æ”¹å\n2 ç¦è¨€/è§£é™¤");

if(a==="1"){
let n=prompt("æ–°åå­—",u.name);
if(n) db.ref("users/"+uid+"/name").set(n);
}
if(a==="2"){
db.ref("users/"+uid+"/mute").set(!u.mute);
}
}

/////////////////////////////
// èŠå¤©
/////////////////////////////

function loadChat(){
db.ref("chat").on("value",snap=>{
chat.innerHTML="";
snap.forEach(s=>{
const m=s.val();
const time=new Date(m.time).toLocaleTimeString();

const div=document.createElement("div");
div.className="msg";
div.textContent=`${m.name} [${time}] : ${m.text}`;

chat.appendChild(div);
});
chat.scrollTop=999999;
});
}

async function send(){

if(sendLock) return;
sendLock=true;
setTimeout(()=>sendLock=false,1000);

if(myData.mute){alert("ä½ è¢«ç¦è¨€");return}
if(msg.value.trim()=="") return;

await db.ref("chat").push({
uid:me.uid,
name:myData.name,
text:msg.value,
time:Date.now()
});

msg.value="";
}

function clearChat(){
if(confirm("ç¢ºå®šæ¸…ç©ºèŠå¤©å®¤?")) db.ref("chat").remove();
}

function forceReload(){
db.ref("system/reload").set(Date.now());
}

function logout(){auth.signOut()}

/////////////////////////////
// æŠ½è¸æ’éšŠç³»çµ±
/////////////////////////////

const queueRef=db.ref("smokeQueue");

function reserve(){
queueRef.child("reserve/"+me.uid).set({
name:myData.name,
time:Date.now()
});
}

function cancelReserve(){
queueRef.child("reserve/"+me.uid).remove();
}

async function goOut(){

if(!confirm("ç¢ºå®šå‡ºå»æŠ½è¸?")) return;

const snap=await queueRef.child("out").once("value");
let out=snap.val()||{};

if(Object.keys(out).length>=3){
alert("å·²æ»¿3äºº");
return;
}

queueRef.child("out/"+me.uid).set({
name:myData.name,
time:Date.now()
});

queueRef.child("reserve/"+me.uid).remove();
}

function comeBack(){
if(!confirm("ç¢ºå®šå›ä¾†?")) return;
queueRef.child("out/"+me.uid).remove();
}

function loadQueue(){

queueRef.on("value",snap=>{
const data=snap.val()||{};
const reserve=data.reserve||{};
const out=data.out||{};

let arr=Object.entries(reserve)
.sort((a,b)=>a[1].time-b[1].time);

queue.innerHTML="";

arr.forEach((u,i)=>{
const div=document.createElement("div");
div.textContent=`${i+1}. ${u[1].name}`;
queue.appendChild(div);
});

Object.entries(out).forEach(([uid,u])=>{
const t=Math.floor((Date.now()-u.time)/1000);
const left=600-t;

let status=left>0
?`å‰© ${Math.floor(left/60)}:${(left%60).toString().padStart(2,"0")}`
:"è¶…æ™‚";

const div=document.createElement("div");
div.textContent=`ğŸš¬ ${u.name} ${status}`;
queue.appendChild(div);

if(left<=0){
queueRef.child("out/"+uid).remove();
}
});
});
}

setInterval(()=>{},1000);

</script>
</body>
</html>
