<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>æŠ½è¸æ’éšŠç³»çµ±</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;font-family:Segoe UI;background:#0e0e16;color:white;display:flex;height:100vh}
#left{width:340px;background:#161625;padding:10px;display:flex;flex-direction:column}
.panel{background:#202035;border-radius:12px;padding:10px;margin-bottom:10px}
h3{margin:0 0 6px;font-size:14px;color:#8aaaff}
#queue div,#log div{font-size:12px;margin:2px 0}
#log{height:180px;overflow:auto}
button{padding:8px;margin:2px;border:none;border-radius:8px;background:#5c7cff;color:white;cursor:pointer}
button:disabled{background:#444;cursor:not-allowed}
#main{flex:1;display:flex;flex-direction:column}
header{background:#141422;padding:12px;text-align:center}
#chat{flex:1;overflow:auto;padding:12px}
.msg{background:#222236;margin:5px 0;padding:8px;border-radius:8px;font-size:13px}
footer{display:flex;padding:10px;background:#141422}
input{flex:1;padding:10px;border:none;border-radius:8px;background:#2b2b40;color:white}
.hidden{display:none}
</style>
</head>

<body>

<div id="left">

<div class="panel">
<div id="who"></div>
<div id="slotInfo"></div>
</div>

<div class="panel">
<h3>ğŸš¬ æ’éšŠ</h3>
<div id="queue"></div>
<button id="bReserve" onclick="reserve()">é ç´„</button>
<button id="bCancel" onclick="cancelReserve()">å–æ¶ˆé ç´„</button>
<button id="bOut" onclick="goOut()">å‡ºå»</button>
<button id="bBack" onclick="comeBack()">å›ä¾†</button>
</div>

<div class="panel">
<h3>ğŸ“œ æ—¥èªŒ</h3>
<div id="log"></div>
</div>

</div>

<div id="main">
<header>èŠå¤©å®¤</header>
<div id="chat"></div>
<footer>
<input id="msg">
<button onclick="send()">é€å‡º</button>
<button id="reloadBtn" class="hidden" onclick="forceReload()">å…¨é«”åˆ·æ–°</button>
<button onclick="logout()">ç™»å‡º</button>
</footer>
</div>

<script>

//////////////// Firebase //////////////////

const config={
apiKey:"AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",
authDomain:"smoke-queue.firebaseapp.com",
databaseURL:"https://smoke-queue-default-rtdb.firebaseio.com",
projectId:"smoke-queue"
};
firebase.initializeApp(config);

const db=firebase.database();
const auth=firebase.auth();

const queueRef=db.ref("queue");
const logRef=db.ref("log");

let me,myData,ready=false;

//////////////// æ™‚æ®µè¨ˆç®— //////////////////

function getSlot(){
let h=new Date().getHours();
let slots=[2,4,6,8,10,12];
for(let s of slots){
if(h<=s) return s;
}
return 2;
}

function slotText(s){
return `${s}:00â€“${s}:59`;
}

//////////////// æŒ‰éˆ•ç‹€æ…‹ //////////////////

function setButtons(state){
bReserve.disabled=state!="none";
bCancel.disabled=state!="reserved";
bOut.disabled=state!="reserved";
bBack.disabled=state!="out";
}

//////////////// èŠå¤© Enter //////////////////

msg.addEventListener("keydown",e=>{
if(e.key==="Enter") send();
});

//////////////// æ—¥èªŒ //////////////////

function addLog(t){
logRef.push({text:t,time:Date.now()});
}

logRef.limitToLast(100).on("value",snap=>{
log.innerHTML="";
snap.forEach(s=>{
let l=s.val();
let d=document.createElement("div");
d.textContent=`[${new Date(l.time).toLocaleTimeString()}] ${l.text}`;
log.appendChild(d);
});
log.scrollTop=99999;
});

//////////////// ç™»å…¥ //////////////////

auth.onAuthStateChanged(async user=>{
if(!user){location.href="login.html";return;}

me=user;
const ref=db.ref("users/"+user.uid);

let snap=await ref.once("value");
if(!snap.exists()){
let name=prompt("æš±ç¨±");
await ref.set({name:name||"è¨ªå®¢",role:"user"});
}

ref.on("value",s=>{
myData=s.val();
who.textContent="ç›®å‰ç™»å…¥ï¼š"+myData.name;
ready=true;
});

addLog(myData?.name+" ç™»å…¥");
updateUI();
});

function logout(){
addLog(myData.name+" ç™»å‡º");
auth.signOut().then(()=>location.href="login.html");
}

//////////////// æ’éšŠ //////////////////

function reserve(){
let s=getSlot();
queueRef.child("reserve/"+me.uid).set({
name:myData.name,
slot:s,
time:Date.now()
});
addLog(`${myData.name} é ç´„ ${s}é»`);
updateUI();
}

function cancelReserve(){
queueRef.child("reserve/"+me.uid).remove();
addLog(myData.name+" å–æ¶ˆé ç´„");
updateUI();
}

function goOut(){
queueRef.child("out/"+me.uid).set({
name:myData.name,
time:Date.now()
});
queueRef.child("reserve/"+me.uid).remove();
addLog(myData.name+" å‡ºå»");
updateUI();
}

function comeBack(){
queueRef.child("out/"+me.uid).remove();
addLog(myData.name+" å›ä¾†");
updateUI();
}

//////////////// UI æ›´æ–° //////////////////

function updateUI(){

let slot=getSlot();
slotInfo.textContent=`ç›®å‰æ™‚æ®µï¼š${slotText(slot)}`;

queueRef.once("value").then(snap=>{
let d=snap.val()||{};
let r=d.reserve||{};
let o=d.out||{};

let state="none";

if(o[me.uid]) state="out";
else if(r[me.uid]) state="reserved";

setButtons(state);

queue.innerHTML="";
Object.entries(r)
.sort((a,b)=>a[1].time-b[1].time)
.forEach((u,i)=>{
let d=document.createElement("div");
d.textContent=`${i+1}. ${u[1].name} (${u[1].slot}é»)`;
queue.appendChild(d);
});
});
}

setInterval(updateUI,2000);

//////////////// èŠå¤© //////////////////

function send(){
if(!msg.value.trim()) return;
db.ref("chat").push({
name:myData.name,
text:msg.value,
time:Date.now()
});
msg.value="";
}

db.ref("chat").limitToLast(200).on("value",snap=>{
chat.innerHTML="";
snap.forEach(s=>{
let m=s.val();
let d=document.createElement("div");
d.className="msg";
d.textContent=`${m.name}: ${m.text}`;
chat.appendChild(d);
});
chat.scrollTop=99999;
});

//////////////// åˆ·æ–° //////////////////

db.ref("reload").on("value",s=>{
let t=s.val();
if(!t) return;
let h=sessionStorage.getItem("reload");
if(h==t) return;
sessionStorage.setItem("reload",t);
location.reload();
});

function forceReload(){
db.ref("reload").set(Date.now());
setTimeout(()=>db.ref("reload").remove(),3000);
}

</script>
</body>
</html>
