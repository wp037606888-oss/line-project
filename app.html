<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>é«˜ç´šç…™éœ§æ’éšŠç³»çµ± v2.3</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* --- å…¨åŸŸè³ªæ„Ÿè¨­å®š --- */
:root {
    --primary: linear-gradient(135deg, #6e8eff, #a277ff);
    --danger: #ff5b5b;
    --success: #00ff88;
    --bg-dark: #0a0b14;
    --panel-bg: rgba(28, 28, 42, 0.65);
    --text-main: #f0f0f0;
    --text-dim: #9ec3ff;
}

* { box-sizing: border-box; transition: all 0.2s ease; }

body {
    margin: 0;
    font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
    background: var(--bg-dark);
    color: var(--text-main);
    display: flex;
    height: 100vh;
    overflow: hidden;
    font-size: 17px;
}

canvas { position: fixed; inset: 0; pointer-events: none; z-index: 0; }

#left {
    width: 60%;
    padding: 15px 20px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    z-index: 1;
}

#main {
    width: 40%;
    display: flex;
    flex-direction: column;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(20px);
    border-left: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 1;
}

.panel {
    background: var(--panel-bg);
    backdrop-filter: blur(25px);
    border-radius: 18px;
    padding: 15px 20px;
    margin-bottom: 12px;
    border: 1px solid rgba(255, 255, 255, 0.08);
}

h3 { margin: 0 0 10px; font-size: 18px; color: var(--text-dim); border-left: 4px solid #7d5cff; padding-left: 10px; }

/* é ‚éƒ¨åå­èˆ‡ç™»å‡º */
.header-row { display: flex; align-items: center; gap: 15px; margin-bottom: 5px; }
#who { font-size: 19px; font-weight: 600; color: #fff; }
.btn-logout { 
    padding: 4px 10px; font-size: 12px; background: rgba(255,255,255,0.1); 
    border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer; color: #ccc;
}
.btn-logout:hover { background: var(--danger); color: #fff; border-color: transparent; }

#status { font-size: 24px; font-weight: 800; margin: 5px 0; text-shadow: 0 0 15px rgba(110, 142, 255, 0.5); }
#clock { font-size: 15px; opacity: 0.6; font-family: monospace; }

/* æŒ‰éˆ•æ¨£å¼ */
.btn-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
button { padding: 8px 18px; border: none; border-radius: 8px; background: var(--primary); color: white; cursor: pointer; font-weight: 700; font-size: 15px; }
button:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.1); }
button:disabled { background: #333; color: #666; cursor: not-allowed; opacity: 0.5; }
.btn-danger { background: linear-gradient(135deg, #ff5b5b, #ff3e3e); }

/* åˆ—è¡¨æ¨£å¼ */
.item-row { padding: 6px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); display: flex; justify-content: space-between; font-size: 16px; }
.red { color: var(--danger); font-weight: bold; }
.green { color: var(--success); font-weight: bold; }

/* èŠå¤©èˆ‡æ—¥èªŒ */
#chat { flex: 1; overflow-y: auto; padding: 15px; font-size: 16px; }
.msg { background: rgba(255,255,255,0.06); margin-bottom: 8px; padding: 10px; border-radius: 12px; }
footer { padding: 10px; display: flex; gap: 8px; background: rgba(0,0,0,0.3); }
input { flex: 1; background: #1a1b26; border: 1px solid #445; border-radius: 8px; padding: 10px; color: #fff; font-size: 15px; }

/* æ—¥èªŒå€åŸŸ */
#log { font-size: 13px; color: #aaa; height: 80px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px; }

#adminPanel { display: none; border: 1px solid rgba(255, 187, 0, 0.4); }
</style>
</head>

<body>
<canvas id="bg"></canvas>

<div id="left">
    <div class="panel">
        <div class="header-row">
            <div id="who">é€£ç·šä¸­...</div>
            <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
        </div>
        <div id="clock">00:00:00</div>
        <div id="slotInfo" style="font-size: 13px; color: var(--text-dim);">æ™‚æ®µè®€å–ä¸­...</div>
        <div id="status">å–å¾—ç‹€æ…‹ä¸­...</div>
        
        <div class="btn-group">
            <button id="bReserve" onclick="reserve()">é ç´„æ’éšŠ</button>
            <button id="bCancel" class="btn-danger" onclick="cancelReserve()">å–æ¶ˆé ç´„</button>
            <button id="bOut" onclick="goOut()">ç¾åœ¨å‡ºå»</button>
            <button id="bBack" onclick="comeBack()">æˆ‘å›ä¾†äº†</button>
        </div>
    </div>

    <div class="panel">
        <h3>ğŸš¬ æ’éšŠéšŠåˆ—</h3>
        <div id="queue" style="max-height: 100px; overflow-y: auto;"></div>
    </div>

    <div class="panel">
        <h3>ğŸš¶ æ­£åœ¨å¤–é¢ (<span id="outCountNum">0</span>/3)</h3>
        <div id="outList" style="max-height: 100px; overflow-y: auto;"></div>
    </div>

    <div class="panel">
        <h3>ğŸ“Š æœ¬æ™‚æ®µç´€éŒ„</h3>
        <div id="history" style="max-height: 140px; overflow-y: auto;"></div>
    </div>

    <div class="panel">
        <h3>ğŸ“œ ç³»çµ±æ—¥èªŒ</h3>
        <div id="log"></div>
    </div>

    <div id="adminPanel" class="panel">
        <h3 style="color: #ffbb00; font-size: 16px;">ğŸ‘‘ ç®¡ç†å“¡åŠŸèƒ½</h3>
        <button onclick="forceReload()" style="font-size: 13px; padding: 5px 10px;">å…¨é«”åˆ·æ–°</button>
        <button onclick="resetQueue()" class="btn-danger" style="font-size: 13px; padding: 5px 10px;">é‡ç½®æ’éšŠ</button>
        <button onclick="clearLog()" style="background: #444; font-size: 13px; padding: 5px 10px;">æ¸…ç©ºæ—¥èªŒ</button>
        <button onclick="clearChat()" style="background: #444; font-size: 13px; padding: 5px 10px;">æ¸…ç©ºèŠå¤©</button>
    </div>
</div>

<div id="main">
    <header style="padding: 15px; text-align: center; font-weight: bold; font-size: 18px;">äº¤æµç©ºé–“</header>
    <div id="onlineBar" style="padding: 8px; display: flex; flex-wrap: wrap; gap: 6px; background: rgba(0,0,0,0.2);"></div>
    <div id="chat"></div>
    <footer>
        <input id="msg" placeholder="è¼¸å…¥è¨Šæ¯..." onkeydown="if(event.key==='Enter')send()">
        <button onclick="send()">é€å‡º</button>
    </footer>
</div>

<script>
/* --- Firebase åˆå§‹åŒ– --- */
const config={
    apiKey: "AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",
    authDomain: "smoke-queue.firebaseapp.com",
    databaseURL: "https://smoke-queue-default-rtdb.firebaseio.com",
    projectId: "smoke-queue"
};
firebase.initializeApp(config);
const db=firebase.database(), auth=firebase.auth();
const queueRef=db.ref("queue"), userRef=db.ref("users"), chatRef=db.ref("chat"), logRef=db.ref("log");

let me, myData, engineReady=false, cacheQueue={};

// å¼·åˆ¶é‡æ–°æ•´ç†
db.ref("reload").on("value", s => {
    let t = s.val(); if(!t) return;
    if(sessionStorage.getItem("lastReload") != t) {
        sessionStorage.setItem("lastReload", t);
        location.reload();
    }
});

auth.onAuthStateChanged(async user => {
    if(!user){ location.href="login.html"; return; }
    me = user;
    userRef.child(user.uid).on("value", s => {
        myData = s.val() || {};
        document.getElementById("who").textContent = "Hi, " + (myData.name || "è¨ªå®¢");
        document.getElementById("adminPanel").style.display = (myData.role === "admin") ? "block" : "none";
        engineReady = true;
    });
    userRef.child(user.uid + "/online").set(true);
    userRef.child(user.uid + "/online").onDisconnect().set(false);
});

function getSlot(h){
    const slots=[14,16,18,20,22,24];
    if(h===0) return 24;
    for(let s of slots) if(h<=s) return s;
    return 14;
}

queueRef.on("value", s => { cacheQueue = s.val() || {}; });

// ä¸»å¼•æ“
setInterval(() => {
    if(!engineReady) return;
    let now = new Date(), h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
    document.getElementById("clock").textContent = now.toLocaleTimeString();
    
    // æ¯å¤©å‡Œæ™¨ 1:00 è‡ªå‹•æ¸…ç©ºæ—¥èªŒé‚è¼¯ (ç”±ç®¡ç†å“¡ç«¯è§¸ç™¼ä¸€æ¬¡å³å¯)
    if(h === 1 && m === 0 && s === 0 && myData.role === "admin") {
        clearLog();
    }

    let slot = getSlot(h);
    document.getElementById("slotInfo").textContent = `ç•¶å‰æ™‚æ®µï¼š${slot}:00 ~ ${slot}:59`;
    
    let d = cacheQueue, r = d.reserve || {}, o = d.out || {}, used = d.used || {};
    let sortedQueue = Object.entries(r).sort((a,b)=>a[1].time - b[1].time);
    let outCount = Object.keys(o).length;
    let isFirst = sortedQueue.length > 0 && sortedQueue[0][0] === me.uid;
    let alreadyUsed = used[slot]?.[me.uid];

    // æŒ‰éˆ•
    bReserve.disabled = (r[me.uid] || o[me.uid] || alreadyUsed);
    bCancel.disabled = !r[me.uid];
    bOut.disabled = !(r[me.uid] && (h==slot || (slot==24&&h==0)) && isFirst && outCount < 3);
    bBack.disabled = !o[me.uid];

    let statusBox = document.getElementById("status");
    if(alreadyUsed) statusBox.innerHTML = "<span style='color:#666'>æœ¬æ™‚æ®µå·²çµæŸ</span>";
    else if(o[me.uid]) statusBox.innerHTML = "<span class='green'>Enjoy! æ­£åœ¨å¤–é¢</span>";
    else if(r[me.uid]) {
        if(isFirst && outCount < 3) statusBox.innerHTML = "<span class='green'>â˜… è¼ªåˆ°ä½ äº†ï¼Œè«‹å‡ºå» â˜…</span>";
        else if(isFirst) statusBox.innerHTML = "<span style='color:#ffcc00'>ç­‰å€™ä½é‡‹å‡ºä¸­...</span>";
        else statusBox.innerHTML = `<span>æ’éšŠä¸­ (å‰æ–¹é‚„æœ‰ ${sortedQueue.findIndex(x=>x[0]===me.uid)} äºº)</span>`;
    } else statusBox.innerHTML = "å°šæœªé ç´„";

    document.getElementById("outCountNum").textContent = outCount;
    renderAll(sortedQueue, o, d.history, slot);
}, 1000);

function renderAll(queueArr, outObj, historyObj, slot) {
    const qBox = document.getElementById("queue");
    qBox.innerHTML = queueArr.length ? "" : "<div style='opacity:0.4; font-size:13px;'>ç„¡äººæ’éšŠ</div>";
    queueArr.forEach((u, i) => {
        let div = document.createElement("div"); div.className="item-row";
        div.innerHTML = `<span>${i+1}. <strong>${u[1].name}</strong></span> <small style='opacity:0.5; font-size:12px;'>${new Date(u[1].time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</small>`;
        qBox.appendChild(div);
    });

    const oBox = document.getElementById("outList");
    oBox.innerHTML = Object.keys(outObj).length ? "" : "<div style='opacity:0.4; font-size:13px;'>ç„¡äººå¤–å‡º</div>";
    Object.entries(outObj).forEach(([uid, u]) => {
        let sec = Math.floor((Date.now() - u.time)/1000);
        let div = document.createElement("div"); div.className="item-row";
        div.innerHTML = `<span><strong>${u.name}</strong></span> <span class="${sec>600?'red':''}" style="font-size:14px;">å¾… ${Math.floor(sec/60)}åˆ†${sec%60}ç§’</span>`;
        oBox.appendChild(div);
    });

    const hBox = document.getElementById("history");
    hBox.innerHTML = "";
    let list = [];
    if(historyObj) Object.values(historyObj).forEach(h => { if(h.slot === slot) list.push({...h, sortT: h.backTime}); });
    if(outObj) Object.values(outObj).forEach(u => {
        let sec = Math.floor((Date.now() - u.time)/1000);
        if(sec > 600) list.push({name: u.name, outTime: u.time, backTime: null, over: true, sortT: Date.now()});
    });
    list.sort((a,b)=>b.sortT - a.sortT);
    list.slice(0, 10).forEach(item => {
        let div = document.createElement("div"); div.className="item-row"; div.style.fontSize="14px";
        let outT = new Date(item.outTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        let backT = item.backTime ? new Date(item.backTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "<span class='red'>æœªæ­¸</span>";
        div.innerHTML = `<span><strong>${item.name}</strong> ${item.over?'<span class="red">[è¶…æ™‚]</span>':''}</span> <small style='opacity:0.6'>${outT}-${backT}</small>`;
        hBox.appendChild(div);
    });
}

/* --- åŠŸèƒ½å‡½æ•¸ --- */
function addLog(txt) { logRef.push({t: txt, time: Date.now()}); }

logRef.limitToLast(15).on("value", s => {
    const box = document.getElementById("log"); box.innerHTML = "";
    s.forEach(x => {
        let d = x.val(); let div = document.createElement("div");
        div.textContent = `[${new Date(d.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}] ${d.t}`;
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
});

function reserve(){
    let slot = getSlot(new Date().getHours());
    queueRef.child("reserve/"+me.uid).set({name: myData.name, time: Date.now(), slot});
    addLog(myData.name + " å·²é ç´„æ’éšŠ");
}
function cancelReserve(){ 
    queueRef.child("reserve/"+me.uid).remove(); 
    addLog(myData.name + " å–æ¶ˆäº†é ç´„");
}
function goOut(){
    queueRef.child("out/"+me.uid).set({name: myData.name, time: Date.now()}).then(()=>{
        queueRef.child("reserve/"+me.uid).remove();
        addLog(myData.name + " ç¾åœ¨å‡ºå»äº†");
    });
}
function comeBack(){
    queueRef.child("out/"+me.uid).once("value").then(s => {
        let u = s.val(); if(!u) return;
        let now = Date.now(), sec = Math.floor((now - u.time)/1000);
        let slot = getSlot(new Date(u.time).getHours());
        queueRef.child(`used/${slot}/${me.uid}`).set(true);
        queueRef.child("history").push({ name: u.name, slot, outTime: u.time, backTime: now, over: sec > 600 });
        queueRef.child("out/"+me.uid).remove();
        addLog(myData.name + " å·²å›ä¾† (è€—æ™‚ "+Math.floor(sec/60)+"åˆ†)");
    });
}

function send(){
    let input = document.getElementById("msg"); if(!input.value.trim()) return;
    chatRef.push({name: myData.name, text: input.value, time: Date.now()});
    input.value = "";
}
chatRef.limitToLast(20).on("value", s => {
    let box = document.getElementById("chat"); box.innerHTML="";
    s.forEach(x => {
        let m = x.val(), div = document.createElement("div"); div.className="msg";
        div.innerHTML = `<b style="color:#a277ff">${m.name}:</b> ${m.text}`;
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
});

function logout(){ auth.signOut().then(()=>location.reload()); }
function forceReload(){ db.ref("reload").set(Date.now()); }
function resetQueue(){ if(confirm("ç¢ºå®šé‡ç½®æ’éšŠï¼Ÿ")) { queueRef.remove(); addLog("ç®¡ç†å“¡é‡ç½®äº†éšŠåˆ—"); }}
function clearLog(){ if(confirm("ç¢ºå®šæ¸…ç©ºæ—¥èªŒï¼Ÿ")) logRef.remove(); }
function clearChat(){ if(confirm("ç¢ºå®šæ¸…ç©ºèŠå¤©ï¼Ÿ")) chatRef.remove(); }

userRef.on("value", s => {
    let bar = document.getElementById("onlineBar"); bar.innerHTML="";
    s.forEach(u => {
        let d = u.val(), span = document.createElement("span");
        span.style = `padding: 4px 10px; border-radius: 15px; font-size: 11px; border: 1px solid ${d.online?'#00ff88':'#444'}; color: ${d.online?'#00ff88':'#888'}`;
        span.textContent = d.name; bar.appendChild(span);
    });
});

/* --- èƒŒæ™¯å‹•ç•« --- */
const canvas=document.getElementById("bg"), ctx=canvas.getContext("2d");
let w,h, particles=[];
function resize(){w=canvas.width=innerWidth; h=canvas.height=innerHeight;}
window.onresize=resize; resize();
for(let i=0;i<40;i++) particles.push({x:Math.random()*w, y:Math.random()*h, vx:(Math.random()-.5)*.3, vy:(Math.random()-.5)*.3});
function draw(){
    ctx.clearRect(0,0,w,h);
    particles.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy;
        if(p.x<0||p.x>w) p.vx*=-1; if(p.y<0||p.y>h) p.vy*=-1;
        ctx.fillStyle="rgba(110,142,255,0.2)"; ctx.beginPath(); ctx.arc(p.x,p.y,1.2,0,7); ctx.fill();
    });
    requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
