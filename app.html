<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Premium Smoke Queue System v3.0</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* --- å¥¢è¯è³½åšé¢¨é…è‰² --- */
:root {
    --gold: linear-gradient(135deg, #ffd700, #ff8c00);
    --primary: linear-gradient(135deg, #6e8eff, #a277ff);
    --danger: linear-gradient(135deg, #ff5b5b, #ff3e3e);
    --bg-dark: #05060a;
    --panel-bg: rgba(20, 21, 33, 0.75);
    --text-gold: #ffcc00;
}

* { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

body {
    margin: 0;
    font-family: "SF Pro Display", "PingFang TC", "Microsoft JhengHei", sans-serif;
    background: var(--bg-dark);
    color: #e0e0e0;
    display: flex;
    height: 100vh;
    overflow: hidden;
    font-size: 16px;
}

/* å‹•æ…‹æµé«”èƒŒæ™¯ */
canvas { position: fixed; inset: 0; z-index: 0; filter: blur(5px); }

#left {
    width: 62%;
    padding: 20px 30px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    z-index: 1;
}

#main {
    width: 38%;
    display: flex;
    flex-direction: column;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(30px);
    border-left: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 1;
}

/* é¢æ¿ç²¾ç·»è³ªæ„Ÿ */
.panel {
    background: var(--panel-bg);
    backdrop-filter: blur(20px);
    border-radius: 22px;
    padding: 20px;
    margin-bottom: 15px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
    animation: slideIn 0.8s ease-out;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(-30px); }
    to { opacity: 1; transform: translateX(0); }
}

h3 { 
    margin: 0 0 15px; 
    font-size: 17px; 
    color: var(--text-gold); 
    text-transform: uppercase;
    letter-spacing: 2px;
    display: flex;
    align-items: center;
    gap: 8px;
}

h3::after { content: ""; flex: 1; height: 1px; background: rgba(255, 204, 0, 0.2); }

/* ç‹€æ…‹é¡¯ç¤º */
#who { font-size: 18px; font-weight: 300; letter-spacing: 1px; }
#clock { font-size: 32px; font-weight: 800; background: var(--primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-family: 'Courier New', monospace; }
#status { font-size: 26px; font-weight: 900; margin: 10px 0; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.3); }

/* é«˜ç´šæŒ‰éˆ• */
.btn-group { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 15px; }
button {
    padding: 12px 24px;
    border: none;
    border-radius: 12px;
    background: var(--primary);
    color: white;
    cursor: pointer;
    font-weight: 700;
    font-size: 16px;
    box-shadow: 0 4px 15px rgba(110, 142, 255, 0.3);
}
button:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 8px 25px rgba(110, 142, 255, 0.5); }
button:disabled { background: #222; color: #555; cursor: not-allowed; box-shadow: none; opacity: 0.5; }
.btn-danger { background: var(--danger); box-shadow: 0 4px 15px rgba(255, 91, 91, 0.3); }
.btn-logout { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 5px 12px; font-size: 12px; color: #aaa; border-radius: 8px; }

/* åˆ—è¡¨æ•ˆæœ */
.item-row {
    padding: 10px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 16px;
}
.red { color: #ff5b5b; font-weight: bold; }
.green { color: #00ff88; font-weight: bold; }

/* èŠå¤©èˆ‡æ—¥èªŒ */
#chat { flex: 1; overflow-y: auto; padding: 20px; }
.msg { background: rgba(255,255,255,0.05); margin-bottom: 10px; padding: 12px 18px; border-radius: 15px; border-left: 3px solid #7d5cff; }
footer { padding: 15px; display: flex; gap: 10px; background: rgba(0,0,0,0.3); }
input { flex: 1; background: #0f1016; border: 1px solid #334; border-radius: 10px; padding: 12px; color: #fff; }

#log { font-size: 12px; color: #888; height: 90px; overflow-y: auto; font-family: monospace; }
#adminPanel { display: none; border: 1px solid #ffcc00; background: rgba(255, 204, 0, 0.05); }

/* è‡ªå®šç¾©æ»¾å‹•æ¢ */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-thumb { background: #334; border-radius: 10px; }
</style>
</head>

<body>
<canvas id="bg"></canvas>

<div id="left">
    <div class="panel">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="who">é‘‘å®šèº«ä»½ä¸­...</span>
                    <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
                </div>
                <div id="clock">00:00:00 AM</div>
            </div>
            <div style="text-align: right;">
                <div id="slotDisplay" style="color: var(--text-gold); font-weight: bold;">--:--</div>
                <div id="limitInfo" style="font-size: 12px; opacity: 0.6;">ä¸Šé™ 3 äººåŒæ™‚åœ¨å¤–</div>
            </div>
        </div>
        
        <div id="status">æ­£åœ¨åŒæ­¥é›²ç«¯æ•¸æ“š...</div>
        
        <div class="btn-group">
            <button id="bReserve" onclick="reserve()">é ç´„æŠ½è¸</button>
            <button id="bCancel" class="btn-danger" onclick="cancelReserve()">å–æ¶ˆé ç´„</button>
            <button id="bOut" onclick="goOut()">ç¾åœ¨å‡ºå»</button>
            <button id="bBack" onclick="comeBack()">æˆ‘å›ä¾†äº†</button>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div class="panel">
            <h3>ğŸš¬ ç›®å‰éšŠåˆ—</h3>
            <div id="queue" style="max-height: 120px; overflow-y: auto;"></div>
        </div>
        <div class="panel">
            <h3>ğŸš¶ æ­£åœ¨å¤–é¢ (<span id="outCountNum">0</span>/3)</h3>
            <div id="outList" style="max-height: 120px; overflow-y: auto;"></div>
        </div>
    </div>

    <div class="panel">
        <h3>ğŸ“Š æœ¬æ™‚æ®µæ­·å²ç´€éŒ„ (12H)</h3>
        <div id="history" style="max-height: 150px; overflow-y: auto;"></div>
    </div>

    <div class="panel">
        <h3>ğŸ“œ ç³»çµ±æ“ä½œæ—¥èªŒ</h3>
        <div id="log"></div>
    </div>

    <div id="adminPanel" class="panel">
        <h3 style="color: #ffcc00;">ğŸ‘‘ ç®¡ç†å“¡æ§åˆ¶å°</h3>
        <div class="btn-group" style="margin-top:0">
            <button onclick="forceReload()" style="font-size:12px">å…¨é«”åˆ·æ–°</button>
            <button onclick="resetQueue()" class="btn-danger" style="font-size:12px">æ¸…ç©ºæ’éšŠ</button>
            <button onclick="clearLog()" style="background:#444; font-size:12px">æ¸…ç©ºæ—¥èªŒ</button>
            <button onclick="clearChat()" style="background:#444; font-size:12px">æ¸…ç©ºèŠå¤©</button>
        </div>
    </div>
</div>

<div id="main">
    <header style="padding: 20px; text-align: center; font-weight: bold; font-size: 20px; letter-spacing: 4px;">LOUNGE</header>
    <div id="onlineBar" style="padding: 10px; display: flex; flex-wrap: wrap; gap: 8px; background: rgba(0,0,0,0.2);"></div>
    <div id="chat"></div>
    <footer>
        <input id="msg" placeholder="è¼¸å…¥è¨Šæ¯..." onkeydown="if(event.key==='Enter')send()">
        <button onclick="send()" style="padding: 10px 20px;">ç™¼é€</button>
    </footer>
</div>

<script>
/* --- Firebase åˆå§‹åŒ– --- */
const config={
    apiKey: "AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",
    authDomain: "smoke-queue.firebaseapp.com",
    databaseURL: "https://smoke-queue-default-rtdb.firebaseio.com",
    projectId: "smoke-queue"
};
firebase.initializeApp(config);
const db=firebase.database(), auth=firebase.auth();
const queueRef=db.ref("queue"), userRef=db.ref("users"), chatRef=db.ref("chat"), logRef=db.ref("log");

let me, myData, engineReady=false, cacheQueue={};

/* --- 12 å°æ™‚åˆ¶æ ¼å¼åŒ–å·¥å…· --- */
function format12H(date) {
    return date.toLocaleTimeString('zh-TW', { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

/* --- æ™‚æ®µé‚è¼¯æ§åˆ¶ --- */
function getSlotStatus(h, m) {
    const slots = [14, 16, 18, 20, 22, 0]; // 24H æ ¼å¼
    // æ‰¾å‡ºä¸‹ä¸€å€‹æˆ–ç›®å‰çš„æ•´é»æŠ½è¸æ™‚é–“
    let target = slots.find(s => (s === 0 ? 24 : s) > h) || 14;
    if (target === 0) target = 24;

    // æª¢æŸ¥æ˜¯å¦åœ¨ç•¶å‰æ™‚æ®µå…§ (ä¾‹å¦‚ 14:00~14:59)
    let currentSlot = slots.find(s => s === h);
    
    // æƒ…æ³ Aï¼šæ­£åœ¨æŠ½è¸æ™‚æ®µ (XX:00 ~ XX:59)
    if (currentSlot !== undefined) {
        return { phase: 'OUT', slot: currentSlot, display: `${currentSlot==0?12:currentSlot>12?currentSlot-12:currentSlot}:00 æ™‚æ®µä¸­` };
    }
    
    // æƒ…æ³ Bï¼šæº–å‚™é ç´„æ™‚æ®µ (ä¸‹å€‹æ•´é»çš„å‰ 30 åˆ†é˜)
    let nextSlot = target;
    let diff = (nextSlot * 60) - (h * 60 + m);
    if (diff > 0 && diff <= 30) {
        return { phase: 'RESERVE', slot: nextSlot, display: `æº–å‚™ä¸­ï¼š${nextSlot==24?12:nextSlot>12?nextSlot-12:nextSlot}:00` };
    }

    // æƒ…æ³ Cï¼šä¼‘æ¯æ™‚é–“
    let nextReserveH = nextSlot === 14 ? 13 : nextSlot - 1;
    let nextReserveM = 30;
    return { 
        phase: 'BREAK', 
        nextSlot, 
        display: 'ä¼‘æ¯ä¸­', 
        hint: `è«‹æ–¼ ${nextReserveH>12?nextReserveH-12:nextReserveH}:${nextReserveM} ${nextReserveH>=12?'PM':'AM'} é€²è¡Œé ç´„` 
    };
}

/* --- æ ¸å¿ƒå¼•æ“ --- */
setInterval(() => {
    if(!engineReady) return;
    const now = new Date();
    const h = now.getHours(), m = now.getMinutes();
    document.getElementById("clock").textContent = format12H(now);

    const info = getSlotStatus(h, m);
    document.getElementById("slotDisplay").textContent = info.display;

    // å‡Œæ™¨ 1 é»è‡ªå‹•æ¸…ç©ºæ—¥èªŒ (ç®¡ç†å“¡è§¸ç™¼)
    if(h === 1 && m === 0 && now.getSeconds() === 0 && myData.role === "admin") clearLog();

    let d = cacheQueue, r = d.reserve || {}, o = d.out || {}, used = d.used || {};
    let sortedQueue = Object.entries(r).sort((a,b)=>a[1].time - b[1].time);
    let outCount = Object.keys(o).length;
    let isFirst = sortedQueue.length > 0 && sortedQueue[0][0] === me.uid;
    let alreadyUsed = used[info.slot]?.[me.uid];

    // æŒ‰éˆ•é‚è¼¯
    bReserve.disabled = (info.phase === 'BREAK' || r[me.uid] || o[me.uid] || alreadyUsed);
    bCancel.disabled = !r[me.uid];
    bOut.disabled = !(info.phase === 'OUT' && r[me.uid] && isFirst && outCount < 3);
    bBack.disabled = !o[me.uid];

    // ç‹€æ…‹æ–‡å­—
    let statusBox = document.getElementById("status");
    if(alreadyUsed) statusBox.innerHTML = "<span style='color:#666'>æœ¬æ™‚æ®µå·²çµæŸ</span>";
    else if(o[me.uid]) statusBox.innerHTML = "<span class='green'>Enjoy! å¤–å‡ºä¸­</span>";
    else if(r[me.uid]) {
        if(info.phase === 'OUT') {
            if(isFirst && outCount < 3) statusBox.innerHTML = "<span class='green'>â˜… è¼ªåˆ°ä½ äº†ï¼Œè«‹å‡ºå» â˜…</span>";
            else if(isFirst) statusBox.innerHTML = "<span style='color:#ffcc00'>ç­‰å€™ä½é‡‹å‡ºä¸­...</span>";
            else statusBox.innerHTML = `<span>æ’éšŠä¸­ (å‰æ–¹é‚„æœ‰ ${sortedQueue.findIndex(x=>x[0]===me.uid)} äºº)</span>`;
        } else {
            statusBox.innerHTML = `<span style='color:var(--text-gold)'>é ç´„æˆåŠŸï¼Œç­‰å€™æ•´é»é–‹æ”¾</span>`;
        }
    } else {
        if(info.phase === 'BREAK') statusBox.innerHTML = `<small style='font-size:16px; color:#888'>${info.hint}</small>`;
        else if(info.phase === 'RESERVE') statusBox.innerHTML = "<span style='color:#6e8eff'>é ç´„è¦–çª—å·²é–‹å•Ÿ</span>";
        else statusBox.innerHTML = "å°šæœªé ç´„";
    }

    document.getElementById("outCountNum").textContent = outCount;
    renderAll(sortedQueue, o, d.history, info.phase === 'OUT' ? info.slot : (info.nextSlot || info.slot));
}, 1000);

/* --- æ¸²æŸ“å‡½æ•¸ --- */
function renderAll(queueArr, outObj, historyObj, currentSlot) {
    const qBox = document.getElementById("queue");
    qBox.innerHTML = queueArr.length ? "" : "<div style='opacity:0.4; font-size:14px; padding:10px;'>å°šæœªæœ‰äººé ç´„</div>";
    queueArr.forEach((u, i) => {
        let div = document.createElement("div"); div.className="item-row";
        div.innerHTML = `<span>${i+1}. <strong>${u[1].name}</strong></span> <small style='opacity:0.5; font-size:12px;'>${new Date(u[1].time).toLocaleTimeString('zh-TW',{hour12:true, hour:'2-digit', minute:'2-digit'})}</small>`;
        qBox.appendChild(div);
    });

    const oBox = document.getElementById("outList");
    oBox.innerHTML = Object.keys(outObj).length ? "" : "<div style='opacity:0.4; font-size:14px; padding:10px;'>å¤–é¢ç›®å‰ç„¡äºº</div>";
    Object.entries(outObj).forEach(([uid, u]) => {
        let sec = Math.floor((Date.now() - u.time)/1000);
        let div = document.createElement("div"); div.className="item-row";
        div.innerHTML = `<span><strong>${u.name}</strong></span> <span class="${sec>600?'red':''}" style="font-size:14px;">å·²å¾… ${Math.floor(sec/60)}åˆ†${sec%60}ç§’</span>`;
        oBox.appendChild(div);
    });

    const hBox = document.getElementById("history");
    hBox.innerHTML = "";
    let list = [];
    if(historyObj) Object.values(historyObj).forEach(h => { if(h.slot === currentSlot) list.push({...h, sortT: h.backTime}); });
    if(outObj) Object.values(outObj).forEach(u => {
        let sec = Math.floor((Date.now() - u.time)/1000);
        if(sec > 600) list.push({name: u.name, outTime: u.time, backTime: null, over: true, sortT: Date.now()});
    });
    list.sort((a,b)=>b.sortT - a.sortT).slice(0, 10).forEach(item => {
        let div = document.createElement("div"); div.className="item-row";
        let outT = new Date(item.outTime).toLocaleTimeString('zh-TW', {hour12:true, hour:'2-digit', minute:'2-digit'});
        let backT = item.backTime ? new Date(item.backTime).toLocaleTimeString('zh-TW', {hour12:true, hour:'2-digit', minute:'2-digit'}) : "<span class='red'>æœªæ­¸</span>";
        div.innerHTML = `<span><strong>${item.name}</strong> ${item.over?'<span class="red">!</span>':''}</span> <small style='opacity:0.6'>${outT} ~ ${backT}</small>`;
        hBox.appendChild(div);
    });
}

/* --- Firebase æ“ä½œ --- */
auth.onAuthStateChanged(async user => {
    if(!user){ location.href="login.html"; return; }
    me = user;
    userRef.child(user.uid).on("value", s => {
        myData = s.val() || {};
        document.getElementById("who").textContent = "Verified: " + (myData.name || "Guest");
        document.getElementById("adminPanel").style.display = (myData.role === "admin") ? "block" : "none";
        engineReady = true;
    });
    userRef.child(user.uid + "/online").set(true);
    userRef.child(user.uid + "/online").onDisconnect().set(false);
});

function addLog(txt) { logRef.push({t: txt, time: Date.now()}); }
logRef.limitToLast(12).on("value", s => {
    const box = document.getElementById("log"); box.innerHTML = "";
    s.forEach(x => {
        let d = x.val(); let div = document.createElement("div");
        div.textContent = `[${new Date(d.time).toLocaleTimeString('zh-TW',{hour12:true})}] ${d.t}`;
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
});

queueRef.on("value", s => { cacheQueue = s.val() || {}; });

function reserve(){
    let now = new Date();
    let slotInfo = getSlotStatus(now.getHours(), now.getMinutes());
    let target = slotInfo.phase === 'RESERVE' ? slotInfo.slot : now.getHours();
    queueRef.child("reserve/"+me.uid).set({name: myData.name, time: Date.now(), slot: target});
    addLog(`${myData.name} é ç´„äº† ${target}:00 æ™‚æ®µ`);
}
function cancelReserve(){ queueRef.child("reserve/"+me.uid).remove(); addLog(`${myData.name} å–æ¶ˆé ç´„`); }
function goOut(){
    queueRef.child("out/"+me.uid).set({name: myData.name, time: Date.now()}).then(()=>{
        queueRef.child("reserve/"+me.uid).remove();
        addLog(`${myData.name} å·²å¤–å‡º`);
    });
}
function comeBack(){
    queueRef.child("out/"+me.uid).once("value").then(s => {
        let u = s.val(); if(!u) return;
        let now = Date.now(), sec = Math.floor((now - u.time)/1000);
        let slot = new Date(u.time).getHours();
        queueRef.child(`used/${slot}/${me.uid}`).set(true);
        queueRef.child("history").push({ name: u.name, slot, outTime: u.time, backTime: now, over: sec > 600 });
        queueRef.child("out/"+me.uid).remove();
        addLog(`${myData.name} å›ä¾†äº† (å¾…äº† ${Math.floor(sec/60)}åˆ†)`);
    });
}

function send(){
    let input = document.getElementById("msg"); if(!input.value.trim()) return;
    chatRef.push({name: myData.name, text: input.value, time: Date.now()});
    input.value = "";
}
chatRef.limitToLast(20).on("value", s => {
    let box = document.getElementById("chat"); box.innerHTML="";
    s.forEach(x => {
        let m = x.val(), div = document.createElement("div"); div.className="msg";
        div.innerHTML = `<b style="color:var(--text-gold)">${m.name}:</b> ${m.text}`;
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
});

function logout(){ auth.signOut().then(()=>location.reload()); }
function forceReload(){ db.ref("reload").set(Date.now()); }
function resetQueue(){ if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) queueRef.remove(); }
function clearLog(){ if(myData.role==='admin') logRef.remove(); }
function clearChat(){ if(myData.role==='admin') chatRef.remove(); }

userRef.on("value", s => {
    let bar = document.getElementById("onlineBar"); bar.innerHTML="";
    s.forEach(u => {
        let d = u.val(), span = document.createElement("span");
        span.style = `padding: 4px 10px; border-radius: 12px; font-size: 11px; border: 1px solid ${d.online?'#00ff88':'#444'}; color: ${d.online?'#00ff88':'#888'}`;
        span.textContent = d.name; bar.appendChild(span);
    });
});

/* --- å‹•æ…‹èƒŒæ™¯å‹•ç•« --- */
const canvas=document.getElementById("bg"), ctx=canvas.getContext("2d");
let w,h, particles=[];
function resize(){w=canvas.width=innerWidth; h=canvas.height=innerHeight;}
window.onresize=resize; resize();
for(let i=0;i<30;i++) particles.push({x:Math.random()*w, y:Math.random()*h, r: Math.random()*2, vx:(Math.random()-.5)*.2, vy:(Math.random()-.5)*.2});
function draw(){
    ctx.fillStyle = "rgba(5, 6, 10, 0.2)";
    ctx.fillRect(0,0,w,h);
    particles.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy;
        if(p.x<0||p.x>w) p.vx*=-1; if(p.y<0||p.y>h) p.vy*=-1;
        ctx.fillStyle="rgba(110,142,255,0.3)"; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,7); ctx.fill();
    });
    requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
