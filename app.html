<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¬è±ªå¸è¸å®¤ v8.2 - Admin Power</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&family=Rajdhani:wght@500;600;700&display=swap');

:root {
    --gold: #ffd700;
    --bg-dark: #05060a;
    --glass: rgba(13, 14, 20, 0.85);
    --glass-border: rgba(255, 255, 255, 0.08);
    --text-main: #e0e0e0;
    --success: #00ff9d;
    --danger: #ff4757;
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

body {
    margin: 0; font-family: "Noto Sans TC", sans-serif;
    background: var(--bg-dark); color: var(--text-main);
    display: flex; height: 100vh; overflow: hidden; font-size: 15px;
}

/* --- èƒŒæ™¯ç‰¹æ•ˆ --- */
canvas#bg { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
.overlay { position: fixed; inset: 0; background: radial-gradient(circle at center, transparent 0%, #000 95%); z-index: 0; pointer-events: none; }
.noise { position: fixed; inset: 0; z-index: 0; opacity: 0.05; background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJuIj48ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iMC42IiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI24pIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4='); pointer-events: none; }

/* --- ä¸»ä½ˆå±€ --- */
#layout { display: flex; width: 100%; height: 100%; z-index: 1; position: relative; padding: 20px; gap: 20px; }
#dashboard { flex: 1.8; display: flex; flex-direction: column; gap: 16px; overflow-y: auto; padding-right: 6px; min-width: 400px; }
#comms { flex: 1; display: flex; flex-direction: column; gap: 0; min-width: 320px; height: 100%; overflow: hidden; position: relative; }

/* --- ç›£æ§ç¶²æ ¼ --- */
.monitor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.monitor-left { display: flex; flex-direction: column; gap: 16px; }
.monitor-right { display: flex; flex-direction: column; }
.monitor-right .glass-panel { flex: 1; display: flex; flex-direction: column; }
.monitor-right .list-container { flex: 1; max-height: none; }

/* --- ç»ç’ƒå¡ç‰‡ --- */
.glass-panel {
    background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
    border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6); position: relative; flex-shrink: 0;
}
.glass-panel:hover { border-color: rgba(255, 215, 0, 0.2); }

/* --- ç‹€æ…‹åˆ— --- */
.status-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
.user-badge { 
    background: linear-gradient(90deg, rgba(255,215,0,0.1), transparent); padding: 4px 12px; 
    border-radius: 4px; font-size: 13px; border-left: 3px solid var(--gold); 
    color: #fff; letter-spacing: 1px; font-weight: 500; display: flex; align-items: center;
}
.btn-logout { 
    background: transparent; border: 1px solid #444; color: #888; cursor: pointer; 
    padding: 4px 10px; border-radius: 6px; font-size: 10px; transition: .3s; margin-left: 10px;
}
.btn-logout:hover { border-color: var(--danger); color: var(--danger); }

#clock {
    font-family: 'Rajdhani', sans-serif; font-size: 44px; line-height: 1;
    font-weight: 700; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.15);
    margin: 12px 0 8px; letter-spacing: 2px;
}
#slotDisplay { font-size: 14px; color: var(--gold); letter-spacing: 1px; font-weight: 500; opacity: 0.9; }
#status { font-size: 18px; font-weight: 700; margin: 5px 0 15px; min-height: 24px; letter-spacing: 1px; }

/* --- æŒ‰éˆ•ç³»çµ± --- */
.control-grid { display: flex; gap: 12px; margin-top: 15px; flex-wrap: wrap; }
button.action-btn {
    flex: 1; min-width: 120px; padding: 18px 10px; border-radius: 12px; font-size: 15px; font-weight: 700;
    cursor: pointer; transition: all 0.3s; font-family: "Noto Sans TC", sans-serif;
    position: relative; overflow: hidden; border: 1px solid transparent;
}
.btn-gold { background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); color: #000 !important; border: none; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); animation: goldPulse 3s infinite; }
@keyframes goldPulse { 0%{box-shadow: 0 0 10px rgba(255,215,0,0.2);} 50%{box-shadow: 0 0 30px rgba(255,215,0,0.6);} 100%{box-shadow: 0 0 10px rgba(255,215,0,0.2);} }
.btn-gold:hover { transform: translateY(-2px); filter: brightness(1.1); }
.btn-red { background: rgba(255, 71, 87, 0.15); border: 1px solid var(--danger); color: var(--danger) !important; }
.btn-red:hover { background: var(--danger); color: #fff !important; box-shadow: 0 0 20px rgba(255, 71, 87, 0.4); }
.btn-green { background: rgba(0, 255, 157, 0.15); border: 1px solid var(--success); color: var(--success) !important; }
.btn-green:hover { background: var(--success); color: #000 !important; box-shadow: 0 0 20px rgba(0, 255, 157, 0.4); }

/* --- åˆ—è¡¨èˆ‡æ¨™é¡Œ --- */
h3 { margin: 0 0 12px 0; font-size: 13px; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; display: flex; align-items: center; gap: 8px; font-family: 'Cinzel', serif; border-bottom: 1px solid rgba(255,255,255,0.06); padding-bottom: 8px; }
.list-container { max-height: 150px; overflow-y: auto; padding-right: 4px; }
.item-card { background: linear-gradient(90deg, rgba(255,255,255,0.03), transparent); margin-bottom: 6px; padding: 10px 14px; border-radius: 8px; border-left: 2px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
.item-card.rank-1 { border-left-color: var(--gold); background: linear-gradient(90deg, rgba(255,215,0,0.1), transparent); }
.item-card.rank-2 { border-left-color: #c0c0c0; }
.btn-mini { padding: 2px 8px; font-size: 10px; border-radius: 4px; cursor: pointer; margin-left: 8px; border: 1px solid; background: transparent; }
.btn-mini.danger { color: var(--danger); border-color: var(--danger); }
.btn-mini.danger:hover { background: var(--danger); color: #fff; }
.btn-mini.success { color: var(--success); border-color: var(--success); }
.btn-mini.success:hover { background: var(--success); color: #000; }
.btn-arrow { width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border:none; border-radius:4px; color:#aaa; cursor:pointer; margin-left:4px; font-size:10px; transition:0.2s; }
.btn-arrow:hover { background: var(--gold); color:#000; }

/* --- èŠå¤©å®¤ --- */
#chat-header { padding: 16px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--glass-border); font-size: 12px; letter-spacing: 2px; display: flex; flex-direction: column; gap: 10px; }
#chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
.msg-bubble { max-width: 85%; padding: 8px 12px; border-radius: 12px; font-size: 13px; line-height: 1.5; word-break: break-all; }
.msg-mine { align-self: flex-end; background: linear-gradient(135deg, #ffd700, #ffaa00); color: #000; border-bottom-right-radius: 2px; }
.msg-other { align-self: flex-start; background: rgba(255,255,255,0.08); color: #ccc; border-bottom-left-radius: 2px; }
.msg-name { font-size: 10px; margin-bottom: 2px; opacity: 0.7; font-weight: 700; }
.msg-img { max-width: 100%; border-radius: 8px; cursor: pointer; margin-top: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

/* è¼¸å…¥å€ */
.input-area { padding: 10px; background: rgba(0,0,0,0.3); border-top: 1px solid var(--glass-border); display: flex; gap: 8px; align-items: center; position: relative; }
input#msg { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 10px 16px; color: #fff; transition: .3s; }
input#msg:focus { border-color: var(--gold); background: rgba(0,0,0,0.5); }
.btn-tool { background: transparent; border: none; font-size: 18px; cursor: pointer; padding: 5px; border-radius: 50%; width: 36px; height: 36px; transition: .2s; display: flex; align-items: center; justify-content: center; color: #888; }
.btn-tool:hover { background: rgba(255,255,255,0.1); color: #fff; }
button.btn-send { background: var(--gold); border: none; color: #000; border-radius: 50%; width: 38px; height: 38px; cursor: pointer; font-weight: bold; flex-shrink: 0; }

/* è¡¨æƒ…é¢æ¿ */
#emojiPicker { 
    position: absolute; bottom: 65px; left: 10px; width: 280px; background: rgba(20,20,20,0.95); 
    border: 1px solid var(--glass-border); border-radius: 12px; padding: 10px; 
    display: none; grid-template-columns: repeat(6, 1fr); gap: 5px; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.5); backdrop-filter: blur(10px); z-index: 50;
}
#emojiPicker.show { display: grid; }
.emoji-btn { font-size: 20px; background: transparent; border: none; cursor: pointer; padding: 5px; border-radius: 6px; }
.emoji-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.2); }

/* Admin & Floating UI */
#btnAdminFloat { position: fixed; bottom: 80px; left: 20px; z-index: 100; width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: var(--gold); font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; backdrop-filter: blur(10px); }
#btnAdminFloat:hover { background: var(--gold); color: #000; transform: rotate(90deg); box-shadow: 0 0 20px rgba(255,215,0,0.5); }

/* éŠæ¨‚å ´æŒ‰éˆ• (é è¨­éš±è—) */
#btnGame { 
    position: fixed; bottom: 20px; left: 20px; z-index: 100; 
    width: 45px; height: 45px; border-radius: 50%; 
    background: rgba(0,0,0,0.6); border: 1px solid var(--success); 
    color: var(--success); font-size: 20px; cursor: pointer; 
    display: none; /* é è¨­éš±è— */
    align-items: center; justify-content: center; transition: 0.3s; backdrop-filter: blur(10px); 
}
#btnGame:hover { background: var(--success); color: #000; box-shadow: 0 0 20px var(--success); transform: scale(1.1); }

/* Admin Modal */
#adminModal { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
#adminModal.show { display: flex; opacity: 1; }
.admin-card { width: 420px; background: #111; border: 1px solid var(--gold); border-radius: 20px; padding: 30px; box-shadow: 0 0 50px rgba(255, 215, 0, 0.15); transform: translateY(20px); transition: transform 0.3s; }
#adminModal.show .admin-card { transform: translateY(0); }
.admin-section { margin-bottom: 25px; }
.admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.btn-admin-action { padding: 12px; border-radius: 8px; border: 1px solid #333; background: #1a1a1a; color: #ccc; cursor: pointer; transition: 0.2s; font-size: 13px; }
.btn-admin-action:hover { border-color: #fff; color: #fff; background: #222; }
.btn-admin-action.danger:hover { background: var(--danger); color: #fff; }
.btn-toggle { width:100%; border:1px solid var(--success); color:var(--success); font-weight:bold; }
.btn-toggle.off { border-color:var(--danger); color:var(--danger); }

#broadcastBanner { position: fixed; top: -200px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; z-index: 9999; background: rgba(10, 10, 10, 0.95); border: 2px solid var(--gold); border-radius: 12px; padding: 25px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.9); transition: top 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
#broadcastBanner.active { top: 30px; }

/* Image Modal */
#imgModal { position: fixed; inset: 0; z-index: 300; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; }
#imgModal img { max-width: 90%; max-height: 90%; border: 2px solid var(--gold); border-radius: 10px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }

/* Online List */
#onlineUserList { display: flex; gap: 6px; flex-wrap: wrap; width: 100%; }
.online-pill { padding: 4px 10px; border-radius: 20px; font-size: 11px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #aaa; white-space: nowrap; transition: 0.3s; display: flex; align-items: center; gap: 5px; }
.online-pill.admin { border-color: var(--gold); color: var(--gold); background: rgba(255,215,0,0.05); }
.online-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; }
.online-pill.online .online-dot { background: var(--success); box-shadow: 0 0 5px var(--success); }

::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

@media (max-width: 900px) {
    #layout { flex-direction: column; padding: 10px; }
    #dashboard { flex: none; width: 100%; min-width: 0; max-height: 60vh; }
    #comms { flex: 1; min-width: 0; height: 40vh; }
    .monitor-grid { grid-template-columns: 1fr; }
}
</style>
</head>

<body>
<canvas id="bg"></canvas>
<div class="overlay"></div>
<div class="noise"></div>

<div id="imgModal" onclick="this.style.display='none'">
    <img id="imgModalSrc" src="">
</div>

<div id="broadcastBanner">
    <h3 style="border:none; justify-content:center; color:var(--gold);">ğŸ“¢ SYSTEM BROADCAST</h3>
    <p id="broadcastText" style="font-size:20px; font-weight:700; color:#fff; margin:0;">---</p>
</div>

<button id="btnAdminFloat" onclick="openAdmin()" style="display:none;">âš™ï¸</button>
<button id="btnGame" onclick="location.href='game.html'" title="å‰å¾€éŠæ¨‚å ´">ğŸ®</button>

<div id="adminModal" onclick="if(event.target===this)closeAdmin()">
    <div class="admin-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; color:var(--gold); font-family:'Cinzel'">Admin Console</h2>
            <button onclick="closeAdmin()" style="background:none; border:none; color:#666; cursor:pointer;">âœ•</button>
        </div>
        
        <div class="admin-section">
            <h4>Queue Management æ’éšŠç®¡ç†</h4>
            <div style="display:flex; gap:10px;">
                <select id="adminUserSelect" style="flex:1; background:#222; color:#fff; padding:10px; border-radius:8px; border:1px solid #444; font-family:'Noto Sans TC';"></select>
                <button onclick="adminForceAdd()" class="btn-mini success" style="padding:0 15px; font-size:13px; font-weight:bold;">åŠ å…¥</button>
            </div>
        </div>

        <div class="admin-section">
            <h4>Global Switch å…¨åŸŸé–‹é—œ</h4>
            <button id="btnTogglePg" class="btn-admin-action btn-toggle" onclick="togglePlayground()">éŠæ¨‚å ´ç‹€æ…‹: è®€å–ä¸­...</button>
        </div>

        <div class="admin-section">
            <h4>Broadcast å»£æ’­ç³»çµ±</h4>
            <input id="broadcastInput" class="broadcast-input" style="width:100%;background:#222;border:1px solid #444;padding:10px;color:#fff;border-radius:6px;margin-bottom:8px;" placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹...">
            <button onclick="sendBroadcast()" style="width:100%;background:var(--gold);color:#000;border:none;padding:10px;border-radius:6px;font-weight:bold;cursor:pointer;">ç™¼é€å…¨åŸŸå»£æ’­</button>
        </div>
        <div class="admin-section">
            <h4>System Control ç³»çµ±ç¶­è­·</h4>
            <div class="admin-grid">
                <button onclick="resetQueue()" class="btn-admin-action danger">é‡ç½®ç³»çµ± (å«æ’éšŠ)</button>
                <button onclick="clearChat()" class="btn-admin-action">æ¸…ç©ºèŠå¤©å®¤</button>
                <button onclick="clearHistory()" class="btn-admin-action">æ¸…ç©ºæ­·å²ç´€éŒ„</button>
                <button onclick="clearLog()" class="btn-admin-action">æ¸…ç©ºç³»çµ±æ—¥èªŒ</button>
                <button onclick="forceReload()" class="btn-admin-action" style="grid-column: span 2;">å…¨é«”å¼·åˆ¶åˆ·æ–°</button>
            </div>
        </div>
    </div>
</div>

<div id="layout">
    <div id="dashboard">
        <div class="glass-panel" style="flex-shrink: 0;">
            <div class="status-header">
                <div style="display: flex; align-items: center;">
                    <span class="user-badge" id="who">é€£ç·šä¸­...</span>
                    <button class="btn-logout" onclick="enableNotification()" id="btnNotify" style="display:none;">ğŸ”” é€šçŸ¥</button>
                    <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
                </div>
                <div id="slotDisplay">---</div>
            </div>
            <div id="clock">00:00:00 PM</div>
            <div id="status">ç³»çµ±åˆå§‹åŒ–...</div>
            <div class="control-grid">
                <button id="bReserve" onclick="reserve()" class="action-btn">é ç´„æ’éšŠ</button>
                <button id="bOut" onclick="goOut()" class="action-btn">ç¾åœ¨å‡ºå»</button>
                <button id="bBack" onclick="comeBack()" class="action-btn">æˆ‘å›ä¾†äº†</button>
                <button id="bCancel" onclick="cancelReserve()" class="action-btn">å–æ¶ˆé ç´„</button>
            </div>
        </div>

        <div class="monitor-grid">
            <div class="monitor-left">
                <div class="glass-panel">
                    <h3>å¤–å‡ºä¸­ (<span id="outCountNum" style="color:var(--success)">0</span>/3)</h3>
                    <div id="outList" class="list-container"></div>
                </div>
                <div class="glass-panel">
                    <h3>è¿‘æœŸç´€éŒ„</h3>
                    <div id="history" class="list-container"></div>
                </div>
            </div>
            <div class="monitor-right">
                <div class="glass-panel">
                    <h3>æ’éšŠåå–®</h3>
                    <div id="queue" class="list-container"></div>
                </div>
            </div>
        </div>

        <div class="glass-panel" style="flex-shrink: 0;">
            <h3>ç³»çµ±æ—¥èªŒ</h3>
            <div id="log" class="list-container" style="font-family: 'Rajdhani', monospace; font-size: 12px; color:#aaa; max-height:100px;"></div>
        </div>
    </div>

    <div id="comms" class="glass-panel" style="padding:0;">
        <div id="chat-header">
            <div style="font-weight:bold; color:#888; margin-bottom:5px;">LOUNGE CHAT</div>
            <div id="onlineUserList"></div>
        </div>
        <div id="chat-box"></div>
        
        <div id="emojiPicker"></div>

        <div class="input-area">
            <input type="file" id="imgInput" hidden accept="image/*" onchange="handleFile(event)">
            <button class="btn-tool" onclick="document.getElementById('imgInput').click()" title="å‚³é€åœ–ç‰‡">ğŸ“·</button>
            <button class="btn-tool" onclick="toggleEmoji()" title="è¡¨æƒ…ç¬¦è™Ÿ">ğŸ˜€</button>
            <input id="msg" placeholder="è¼¸å…¥è¨Šæ¯..." onkeydown="if(event.key==='Enter')send()" autocomplete="off">
            <button onclick="send()" class="btn-send">â¤</button>
        </div>
    </div>
</div>

<script>
/* --- Init --- */
const config={apiKey:"AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",authDomain:"smoke-queue.firebaseapp.com",databaseURL:"https://smoke-queue-default-rtdb.firebaseio.com",projectId:"smoke-queue"};
firebase.initializeApp(config);
const db=firebase.database(), auth=firebase.auth();
const queueRef=db.ref("queue"), userRef=db.ref("users"), chatRef=db.ref("chat"), logRef=db.ref("log"), broadcastRef=db.ref("broadcast"), configRef=db.ref("config");

let me, myData, engineReady=false, cacheQueue={}, currentSlotInfo={phase:'',slot:0}, allUsers={};
let audioCtx=null, notifyEnabled=false;
let playgroundEnabled = false;

/* --- ğŸŸ¢ XSS é˜²ç¦¦ï¼šHTML è·³è„«å‡½æ•¸ --- */
function escapeHtml(text) {
    if (!text) return text;
    return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

/* --- Background --- */
const canvas=document.getElementById("bg"), ctx=canvas.getContext("2d");
let w,h,particles=[]; function resize(){w=canvas.width=innerWidth;h=canvas.height=innerHeight;} window.onresize=resize; resize();
for(let i=0;i<50;i++)particles.push({x:Math.random()*w,y:Math.random()*h,vx:(Math.random()-.5)*.2,vy:(Math.random()-.5)*.2,size:Math.random()*2+.5,alpha:Math.random()*.5+.1});
function draw(){ctx.clearRect(0,0,w,h);particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0||p.x>w)p.vx*=-1;if(p.y<0||p.y>h)p.vy*=-1;ctx.fillStyle=`rgba(255,215,0,${p.alpha})`;ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,6.28);ctx.fill();});requestAnimationFrame(draw);}draw();

/* --- Auth --- */
auth.onAuthStateChanged(user=>{
    if(!user){location.href="login.html";return;} me=user;
    userRef.child(user.uid).on("value",s=>{
        myData=s.val()||{};
        document.getElementById("who").textContent=`æ­¡è¿ ${(myData.name||"GUEST").toUpperCase()}`;
        document.getElementById("btnAdminFloat").style.display=(myData.role==="admin")?"flex":"none";
        engineReady=true;
        
        // ğŸŸ¢ å¦‚æœæ˜¯ Adminï¼ŒåŠ è¼‰æ‰€æœ‰ç”¨æˆ¶æ¸…å–®ä»¥ä¾›ç®¡ç†
        if(myData.role === "admin") {
            userRef.on("value", snap => {
                allUsers = snap.val() || {};
                updateAdminUserSelect();
            });
        }
        
        renderStaticLists();
        updateButtonStates();
        renderOutList(); 
    });
    userRef.child(user.uid+"/online").set(true);
    userRef.child(user.uid+"/online").onDisconnect().set(false);
});
function logout(){auth.signOut().then(()=>{location.href="login.html";});}

/* --- ğŸŸ¢ Admin Feature: Populate User Select --- */
function updateAdminUserSelect() {
    const sel = document.getElementById("adminUserSelect");
    sel.innerHTML = "<option value=''>é¸æ“‡ä½¿ç”¨è€…...</option>";
    Object.entries(allUsers).forEach(([uid, u]) => {
        // æ’é™¤å·²åœ¨æ’éšŠæˆ–å¤–å‡ºçš„äºº
        let isReserved = cacheQueue.reserve && cacheQueue.reserve[uid];
        let isOut = cacheQueue.out && cacheQueue.out[uid];
        if(!isReserved && !isOut) {
            let opt = document.createElement("option");
            opt.value = uid;
            opt.textContent = u.name;
            sel.appendChild(opt);
        }
    });
}

/* --- ğŸŸ¢ Admin Feature: Force Add & Reorder --- */
function adminForceAdd() {
    const sel = document.getElementById("adminUserSelect");
    const uid = sel.value;
    if(!uid) return;
    const u = allUsers[uid];
    if(u) {
        let h=new Date().getHours(), t=currentSlotInfo.phase==='RESERVE'?currentSlotInfo.slot:h;
        // å¯«å…¥éšŠåˆ—
        queueRef.child("reserve/"+uid).set({
            name: u.name,
            time: Date.now(), // æ’åœ¨æœ€å¾Œ
            slot: t
        });
        addLog(`ADMIN åŠ å…¥: ${u.name}`);
        // é—œé–‰ Modal
        closeAdmin();
    }
}

function moveQueue(uid, direction) {
    if(!myData || myData.role !== 'admin') return;
    
    let r = cacheQueue.reserve || {};
    // å–å¾—ç•¶å‰æ’åºå¾Œçš„é™£åˆ—
    let sorted = Object.entries(r).sort((a,b) => a[1].time - b[1].time);
    let idx = sorted.findIndex(x => x[0] === uid);
    
    if (idx === -1) return;
    let targetIdx = idx + direction;
    
    // é‚Šç•Œæª¢æŸ¥
    if (targetIdx < 0 || targetIdx >= sorted.length) return;

    let targetUid = sorted[targetIdx][0];
    let myTime = sorted[idx][1].time;
    let targetTime = sorted[targetIdx][1].time;

    // è‹¥æ™‚é–“æˆ³ç›¸åŒï¼Œå¾®èª¿ 1ms ä»¥ç¢ºä¿é †åºäº¤æ›
    if (myTime === targetTime) {
        if(direction < 0) targetTime -= 1; // å¾€ä¸Šç§»ï¼Œç›®æ¨™æ™‚é–“è¦è®Šå°
        else targetTime += 1;
    }

    // äº¤æ›æ™‚é–“æˆ³ (é€™æ˜¯æœ€ç©©å®šçš„æ’åºäº¤æ›æ³•)
    queueRef.child('reserve/' + uid).update({ time: targetTime });
    queueRef.child('reserve/' + targetUid).update({ time: myTime });
}

/* --- Playground Control --- */
configRef.child("playground_status").on("value", s => {
    playgroundEnabled = s.val() || false;
    const btn = document.getElementById("btnGame");
    if(playgroundEnabled) { btn.style.display = "flex"; playBeep(); } else { btn.style.display = "none"; }
    const toggleBtn = document.getElementById("btnTogglePg");
    if(toggleBtn) {
        toggleBtn.textContent = playgroundEnabled ? "éŠæ¨‚å ´ç‹€æ…‹: é–‹å•Ÿ (OPEN)" : "éŠæ¨‚å ´ç‹€æ…‹: é—œé–‰ (CLOSED)";
        toggleBtn.className = playgroundEnabled ? "btn-admin-action btn-toggle" : "btn-admin-action btn-toggle off";
    }
});
function togglePlayground() { configRef.child("playground_status").set(!playgroundEnabled); }

/* --- Admin --- */
function openAdmin(){document.getElementById('adminModal').classList.add('show'); updateAdminUserSelect();}
function closeAdmin(){document.getElementById('adminModal').classList.remove('show');}
function sendBroadcast(){const i=document.getElementById('broadcastInput');if(!i.value.trim())return;broadcastRef.set({text:i.value,t:Date.now()});i.value="";closeAdmin();}
broadcastRef.on("value",s=>{
    const v=s.val(); if(!v||Date.now()-v.t>10000)return;
    const b=document.getElementById('broadcastBanner');
    document.getElementById('broadcastText').textContent=v.text;
    b.classList.add('active'); playBeep('urgent');
    setTimeout(()=>b.classList.remove('active'),5000);
});

/* --- Chat System (ğŸŸ¢ XSS Fix) --- */
const emojis = ["ğŸ˜€","ğŸ˜‚","ğŸ˜","ğŸ˜","ğŸ¤”","ğŸ˜­","ğŸ˜¡","ğŸ‘","ğŸ‘","ğŸš¬","ğŸ”¥","â˜•","ğŸº","ğŸ’¨","ğŸ‘€","â¤ï¸","âœ…","âŒ"];
const emojiPicker = document.getElementById("emojiPicker");
emojis.forEach(e => {
    const btn = document.createElement("button"); btn.className = "emoji-btn"; btn.textContent = e;
    btn.onclick = () => { document.getElementById("msg").value += e; toggleEmoji(); document.getElementById("msg").focus(); };
    emojiPicker.appendChild(btn);
});
function toggleEmoji() { emojiPicker.classList.toggle("show"); }
function handleFile(e) {
    const file = e.target.files[0]; if(!file) return;
    if(file.size > 2 * 1024 * 1024) { alert("åœ–ç‰‡å¤ªå¤§äº† (Max 2MB)"); return; }
    const reader = new FileReader();
    reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width, height = img.height;
            if (width > 400) { height *= 400 / width; width = 400; }
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
            chatRef.push({ name: myData.name, uid: me.uid, text: canvas.toDataURL('image/jpeg', 0.7), type: 'image', time: Date.now() });
        }
        img.src = event.target.result;
    }
    reader.readAsDataURL(file); e.target.value = '';
}
function send(){
    let i=document.getElementById("msg"); if(!i.value.trim())return;
    chatRef.push({ name:myData.name, uid:me.uid, text:i.value, type: 'text', time:Date.now() });
    i.value=""; emojiPicker.classList.remove("show");
}

/* ğŸŸ¢ XSS Patch & Image Patch */
chatRef.limitToLast(30).on("value",s=>{
    let b=document.getElementById("chat-box"); b.innerHTML="";
    s.forEach(x=>{
        let m=x.val(), meMsg=m.uid===me.uid;
        let div=document.createElement("div"); div.className=`msg-bubble ${meMsg?'msg-mine':'msg-other'}`;
        let content = m.type === 'image' 
            ? `<img src="${m.text}" class="msg-img" onclick="showImg(this.src)">` 
            : escapeHtml(m.text);
        div.innerHTML=`<div class="msg-name">${m.name}</div>${content}`;
        b.appendChild(div);
    });
    b.scrollTop=b.scrollHeight;
});
function showImg(src) { document.getElementById("imgModalSrc").src = src; document.getElementById("imgModal").style.display = "flex"; }

/* --- Core Logic --- */
function format12H(d){return d.toLocaleTimeString('en-US',{hour12:true,hour:'2-digit',minute:'2-digit',second:'2-digit'});}
function getSlotStatus(h,m){
    const slots=[14,16,18,20,22,0];
    let currentSlot=slots.find(s=>s===h);
    const to12HStr = (hr) => { let suffix = (hr >= 12 && hr < 24) ? "PM" : "AM"; let dH = (hr % 12) || 12; return `${dH}:00 ${suffix}`; };
    const toOpenStr = (hr) => { let openH = (hr === 0) ? 23 : hr - 1; let suffix = (openH >= 12 && openH < 24) ? "PM" : "AM"; let dH = (openH % 12) || 12; return `${dH}:30 ${suffix}`; };
    if(currentSlot!==undefined){ return {phase:'OUT',slot:currentSlot,display:`${to12HStr(currentSlot)} é–‹æ”¾æ™‚æ®µ`}; }
    let target=slots.find(s=>(s===0?24:s)>h)||14;
    let diff=(target===0?24:target)*60-(h*60+m);
    if(diff>0&&diff<=30){ return {phase:'RESERVE',slot:target,display:`é ç´„ä¸­ ${to12HStr(target)}`}; }
    return {phase:'BREAK',nextSlot:target,display:`ä¸‹å€‹æ™‚æ®µ ${to12HStr(target)}`, hint:`${toOpenStr(target)}`};
}

setInterval(()=>{
    if(!engineReady)return;
    const now=new Date(), h=now.getHours(), m=now.getMinutes();
    document.getElementById("clock").textContent=format12H(now);
    currentSlotInfo=getSlotStatus(h,m);
    let dText = currentSlotInfo.display;
    if(currentSlotInfo.phase === 'BREAK') dText += ` (${currentSlotInfo.hint} é–‹æ”¾é ç´„)`;
    document.getElementById("slotDisplay").textContent=dText;
    if(h===1&&m===0&&now.getSeconds()===0&&myData.role==="admin") resetQueue();
    updateButtonStates(); 
    renderOutList(); 
},1000);

queueRef.on("value",s=>{
    cacheQueue=s.val()||{};
    if(engineReady){
        renderStaticLists();
        updateButtonStates();
        renderOutList();
    }
});

function updateButtonStates(){
    if(!me||!cacheQueue)return;
    let r=cacheQueue.reserve||{},o=cacheQueue.out||{},used=cacheQueue.used||{};
    let sorted=Object.entries(r).sort((a,b)=>a[1].time-b[1].time);
    let outCount=Object.keys(o).length;
    let myRank=sorted.findIndex(x=>x[0]===me.uid);
    let alreadyUsed = used[currentSlotInfo.slot]?.[me.uid];

    const hideAll = () => { bReserve.style.display='none'; bOut.style.display='none'; bBack.style.display='none'; bCancel.style.display='none'; };
    hideAll();
    const setBtn = (btn, cls, txt) => { btn.style.display = 'block'; btn.className = `action-btn ${cls}`; btn.textContent = txt; };

    if(alreadyUsed) {
    } else if(o[me.uid]) { setBtn(bBack, 'btn-red', 'æˆ‘å›ä¾†äº†'); } 
    else if(r[me.uid]) {
        setBtn(bCancel, 'btn-red', 'å–æ¶ˆé ç´„');
        if(currentSlotInfo.phase==='OUT' && myRank<=1 && outCount<3){ setBtn(bOut, 'btn-green', 'ç¾åœ¨å‡ºå»'); }
    } else { setBtn(bReserve, 'btn-gold', 'é ç´„æ’éšŠ'); }

    let st=document.getElementById("status");
    if(alreadyUsed) st.innerHTML="<span style='color:#666'>æœ¬æ™‚æ®µå·²äº«ç”¨</span>";
    else if(o[me.uid]) st.innerHTML="<span style='color:var(--success)'>æŠ½è¸ä¸­ ENJOYING...</span>";
    else if(r[me.uid]) {
        if(currentSlotInfo.phase==='OUT'){
            if(myRank<=1&&outCount<3) st.innerHTML="<span style='color:var(--success)'>åé¡é–‹æ”¾ï¼Œè«‹å‡ºç™¼</span>";
            else if(outCount>=3) st.innerHTML="<span style='color:var(--gold)'>æ»¿ä½ç­‰å€™ä¸­...</span>";
            else st.innerHTML=`<span>ç­‰å¾…é †ä½: ${myRank+1}</span>`;
        } else st.innerHTML="<span style='color:var(--gold)'>é ç´„æˆåŠŸ (å¾…é–‹æ”¾)</span>";
    } else {
        if(currentSlotInfo.phase==='BREAK') st.innerHTML="<span style='color:#555'>ç­‰å¾…ä¸‹ä¸€æ™‚æ®µ</span>";
        else if(currentSlotInfo.phase==='RESERVE') st.innerHTML="<span style='color:#2ed573'>é–‹æ”¾é ç´„ä¸­</span>";
        else st.innerHTML="<span style='color:#444'>å°šæœªé ç´„</span>";
    }
    document.getElementById("outCountNum").textContent=outCount;
}

function renderStaticLists(){
    let r=cacheQueue.reserve||{}, sorted=Object.entries(r).sort((a,b)=>a[1].time-b[1].time);
    document.getElementById("queue").innerHTML=sorted.map((u,i)=>{
        let btn=(myData&&myData.role==="admin")?`<button onclick="forceGoOut('${u[0]}')" class="btn-mini success">å»æŠ½</button>`:"";
        
        // ğŸŸ¢ Admin Feature: Reorder Buttons
        let moveBtns = "";
        if(myData && myData.role === "admin") {
            moveBtns = `<button onclick="moveQueue('${u[0]}', -1)" class="btn-arrow" title="ä¸Šç§»">â–²</button><button onclick="moveQueue('${u[0]}', 1)" class="btn-arrow" title="ä¸‹ç§»">â–¼</button>`;
        }

        let rc=i===0?'rank-1':(i===1?'rank-2':'');
        return `<div class="item-card ${rc}">
            <div><span style="font-family:'Rajdhani';color:var(--gold);margin-right:8px;font-weight:bold;">#${i+1}</span><strong>${u[1].name}</strong></div>
            <div style="display:flex;align-items:center;">
                <small style='opacity:0.4;margin-right:5px;font-family:"Rajdhani"'>${new Date(u[1].time).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'})}</small>
                ${btn}
                ${moveBtns}
            </div>
        </div>`;
    }).join('')||"<div style='opacity:0.3;padding:10px;text-align:center;'>ç›®å‰ç©ºé–’</div>";

    let hist=[]; if(cacheQueue.history)Object.values(cacheQueue.history).forEach(h=>hist.push({...h,sortT:h.backTime}));
    let o=cacheQueue.out||{}; 
    Object.entries(o).forEach(([uid,u])=>{if(Math.floor((Date.now()-u.time)/1000)>600)hist.push({name:u.name,outTime:u.time,backTime:null,over:true,sortT:Date.now()});});
    document.getElementById("history").innerHTML=hist.sort((a,b)=>b.sortT-a.sortT).slice(0,20).map(i=>`<div class="item-card" style="padding:8px 12px;min-height:0;border:none;background:rgba(255,255,255,0.02);"><span>${i.name} ${i.over?'<span style="color:var(--danger)">!</span>':''}</span><small style='opacity:0.5;font-family:"Rajdhani"'>${new Date(i.outTime).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'})} - ${i.backTime?new Date(i.backTime).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'}):'OUT'}</small></div>`).join('');
}

function renderOutList(){
    let o=cacheQueue.out||{}; 
    document.getElementById("outList").innerHTML=Object.entries(o).map(([uid,u])=>{
        let s=Math.floor((Date.now()-u.time)/1000);
        let btn=(myData&&myData.role==="admin")?`<button onclick="forceComeBack('${uid}')" class="btn-mini danger">å¬å›</button>`:"";
        return `<div class="item-card" style="border-left-color:var(--success);"><strong>${u.name}</strong><div style="display:flex;align-items:center;gap:8px;"><span class="${s>600?'text-danger':''}" style="font-family:'Rajdhani';color:${s>600?'var(--danger)':'#aaa'}">${Math.floor(s/60)}åˆ† ${s%60}ç§’</span>${btn}</div></div>`;
    }).join('')||"<div style='opacity:0.3;padding:10px;text-align:center;'>ç„¡äººå¤–å‡º</div>";
}

/* --- Misc --- */
function enableNotification(){if(!("Notification" in window))return;Notification.requestPermission().then(p=>{if(p==="granted"){notifyEnabled=true;playBeep();document.getElementById("btnNotify").style.display="none";}});}
if(Notification.permission!=="granted") document.getElementById("btnNotify").style.display="inline-block";
function playBeep(t='normal'){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);if(t==='urgent'){o.frequency.value=880;o.type='square';o.start();setTimeout(()=>o.stop(),100);setTimeout(()=>{const o2=audioCtx.createOscillator(),g2=audioCtx.createGain();o2.connect(g2);g2.connect(audioCtx.destination);o2.frequency.value=880;o2.type='square';o2.start();setTimeout(()=>o2.stop(),100);},150);}else{o.frequency.value=523.25;o.type='sine';g.gain.setValueAtTime(0.05,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.00001,audioCtx.currentTime+0.5);o.start();o.stop(audioCtx.currentTime+0.5);}}
function forceComeBack(uid){if(confirm("å¼·åˆ¶å¬å›ï¼Ÿ"))queueRef.child("out/"+uid).once("value").then(s=>{let u=s.val();if(u){let now=Date.now(),slot=new Date(u.time).getHours();queueRef.child(`used/${slot}/${uid}`).set(true);queueRef.child("history").push({name:u.name,slot,outTime:u.time,backTime:now,over:(now-u.time)>600000});queueRef.child("out/"+uid).remove();addLog(`ADMIN å¬å›: ${u.name}`);}});}
function forceGoOut(uid){if(confirm("å¼·åˆ¶æ´¾ç™¼ï¼Ÿ"))queueRef.child("reserve/"+uid).once("value").then(s=>{let u=s.val();if(u){queueRef.child("out/"+uid).set({name:u.name,time:Date.now()}).then(()=>{queueRef.child("reserve/"+uid).remove();addLog(`ADMIN æ´¾ç™¼: ${u.name}`);});}});}
function forceReload(){db.ref("reload").set(Date.now());}
function resetQueue(){ if(confirm("ç¢ºå®šæ¸…ç©ºã€æ’éšŠã€å¤–å‡ºã€å·²æŠ½éã€‘ç‹€æ…‹ï¼Ÿ")) { queueRef.child("reserve").remove(); queueRef.child("out").remove(); queueRef.child("used").remove(); addLog("ADMIN é‡ç½®ç³»çµ±"); } }
function clearChat(){ if(confirm("æ¸…ç©ºèŠå¤©å®¤ï¼Ÿ")) chatRef.remove(); }
function clearHistory(){ if(confirm("æ¸…ç©ºæ­·å²ç´€éŒ„ï¼Ÿ")) queueRef.child("history").remove(); }
function clearLog(){ if(confirm("æ¸…ç©ºç³»çµ±æ—¥èªŒï¼Ÿ")) logRef.remove(); }
function addLog(t){logRef.push({t,time:Date.now()});}
logRef.limitToLast(15).on("value",s=>{const b=document.getElementById("log");b.innerHTML="";s.forEach(x=>{let d=x.val();let dv=document.createElement("div");dv.innerHTML=`<span style="opacity:0.5;font-family:'Rajdhani'">[${new Date(d.time).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'})}]</span> ${d.t}`;b.appendChild(dv);});b.scrollTop=b.scrollHeight;});
function reserve(){
    if(currentSlotInfo.phase === 'BREAK'){ alert(`å°šæœªé–‹æ”¾é ç´„ï¼\nè«‹æ–¼ ${currentSlotInfo.hint} å†è©¦ã€‚`); return; }
    let h=new Date().getHours(),t=currentSlotInfo.phase==='RESERVE'?currentSlotInfo.slot:h;
    queueRef.child("reserve/"+me.uid).set({name:myData.name,time:Date.now(),slot:t});
    if(Notification.permission!=="granted")enableNotification(); addLog(`${myData.name} é ç´„`);
}
function cancelReserve(){queueRef.child("reserve/"+me.uid).remove();addLog(`${myData.name} å–æ¶ˆ`);}
function goOut(){queueRef.child("out/"+me.uid).set({name:myData.name,time:Date.now()}).then(()=>{queueRef.child("reserve/"+me.uid).remove();addLog(`${myData.name} å‡ºç™¼`);});}
function comeBack(){queueRef.child("out/"+me.uid).once("value").then(s=>{let u=s.val();if(u){let now=Date.now(),slot=new Date(u.time).getHours();queueRef.child(`used/${slot}/${me.uid}`).set(true);queueRef.child("history").push({name:u.name,slot,outTime:u.time,backTime:now,over:(now-u.time)>600000});queueRef.child("out/"+me.uid).remove();addLog(`${myData.name} è¿”å›`);}});}
userRef.on("value",s=>{
    const list=document.getElementById("onlineUserList"); list.innerHTML="";
    s.forEach(u=>{ let d=u.val(); if(d.online){ let isAdmin = d.role === 'admin'; let pill = document.createElement("div"); pill.className = `online-pill online ${isAdmin ? 'admin' : ''}`; pill.innerHTML = `<div class="online-dot"></div>${d.name}`; list.appendChild(pill); }});
});
let fR=true;db.ref("reload").on("value",s=>{if(fR){fR=false;return;}location.reload();});
</script>
</body>
</html>
