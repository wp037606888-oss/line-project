<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>æŠ½è¸æ’éšŠç³»çµ±</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{box-sizing:border-box}

body{
margin:0;
font-family:Segoe UI;
background:#0a0b14;
color:white;
display:flex;
height:100vh;
overflow:hidden;
}

/* ç²’å­ç•«å¸ƒ */
canvas{
position:fixed;
inset:0;
z-index:0;
pointer-events:none;
}

/* ç»ç’ƒé¢æ¿ */
.panel{
background:rgba(28,28,42,.6);
backdrop-filter:blur(18px);
border-radius:16px;
padding:12px;
margin-bottom:10px;
box-shadow:0 0 40px rgba(0,0,0,.6);
border:1px solid rgba(255,255,255,.08);
transition:.2s;
}

.panel:hover{
transform:translateY(-2px);
box-shadow:0 10px 50px rgba(0,0,0,.8);
}

/* å·¦å´ */
#left{
width:620px;
padding:14px;
display:flex;
flex-direction:column;
overflow:auto;
z-index:2;
}

/* å³å´èŠå¤©å®¤ */
#main{
width:380px;
display:flex;
flex-direction:column;
background:rgba(0,0,0,.35);
z-index:2;
backdrop-filter:blur(12px);
border-left:1px solid rgba(255,255,255,.08);
}

header{
padding:12px;
text-align:center;
font-size:16px;
background:rgba(255,255,255,.05);
}

/* åœ¨ç·šæ¬„ */
#onlineBar{
display:grid;
grid-template-columns:repeat(2,1fr);
gap:6px;
padding:8px;
background:rgba(0,0,0,.3);
}

.userBox{
padding:6px;
border-radius:8px;
font-size:12px;
text-align:center;
background:#333;
border:1px solid rgba(255,255,255,.05);
}

.onlineUser{
background:#103f2c;
border:1px solid #00ff88;
box-shadow:0 0 8px #00ff8855;
}

.offlineUser{
background:#2a2a2a;
opacity:.5;
}

/* èŠå¤© */
#chat{
flex:1;
overflow:auto;
padding:10px;
}

.msg{
background:#232334;
margin:4px 0;
padding:8px;
border-radius:10px;
font-size:13px;
border:1px solid rgba(255,255,255,.05);
}

/* footer */
footer{
display:flex;
gap:6px;
padding:10px;
background:rgba(0,0,0,.35);
}

/* input */
input{
flex:1;
padding:10px;
border:none;
border-radius:10px;
background:#232334;
color:white;
outline:none;
}

/* button */
button{
padding:10px;
margin:3px;
border:none;
border-radius:10px;
background:linear-gradient(135deg,#5c7cff,#7d5cff);
color:white;
cursor:pointer;
font-weight:600;
transition:.2s;
}

button:hover{
transform:translateY(-1px);
box-shadow:0 6px 18px rgba(92,124,255,.4);
}

button:disabled{background:#444}

/* æ–‡å­— */
h3{
margin:0 0 6px;
font-size:14px;
color:#9ec3ff;
}

.red{color:#ff5b5b}

#log{height:140px;overflow:auto}

.hidden{display:none}
</style>
</head>

<body>

<canvas id="bg"></canvas>

<div id="left">

<div class="panel">
<div id="who"></div>
<div id="clock"></div>
<div id="slotInfo"></div>
<div id="status"></div>
</div>

<div class="panel">
<h3>ğŸš¬ æ’éšŠ</h3>
<div id="queue"></div>
<button id="bReserve" onclick="reserve()">é ç´„</button>
<button id="bCancel" onclick="cancelReserve()">å–æ¶ˆ</button>
<button id="bOut" onclick="goOut()">å‡ºå»</button>
<button id="bBack" onclick="comeBack()">å›ä¾†</button>

<h3>ğŸš¶ æ­£åœ¨å¤–é¢</h3>
<div id="outList"></div>

<h3>ğŸ“Š æœ¬æ™‚æ®µç´€éŒ„</h3>
<div id="history"></div>
</div>

<div class="panel">
<h3>ğŸ“œ æ—¥èªŒ</h3>
<div id="log"></div>
</div>

<div id="adminPanel" class="panel hidden">
<h3>ğŸ‘‘ ç®¡ç†å“¡æ§åˆ¶</h3>
<button onclick="forceReload()">å…¨é«”åˆ·æ–°</button>
<button onclick="clearChat()">æ¸…ç©ºèŠå¤©å®¤</button>
<button onclick="clearLog()">æ¸…ç©ºæ—¥èªŒ</button>
<button onclick="resetQueue()">é‡ç½®æ’éšŠåˆ—</button>
</div>

</div>

<div id="main">
<header>èŠå¤©å®¤</header>
<div id="onlineBar"></div>
<div id="chat"></div>

<footer>
<input id="msg">
<button onclick="send()">é€å‡º</button>
<button onclick="logout()">ç™»å‡º</button>
</footer>
</div>

<script>
/* ç²’å­èƒŒæ™¯ */
const canvas=document.getElementById("bg");
const ctx=canvas.getContext("2d");
let w,h;
function resize(){w=canvas.width=innerWidth;h=canvas.height=innerHeight}
onresize=resize;resize();

const P=80;
const particles=[];
for(let i=0;i<P;i++){
particles.push({
x:Math.random()*w,
y:Math.random()*h,
vx:(Math.random()-.5)*.6,
vy:(Math.random()-.5)*.6
});
}

function draw(){
ctx.clearRect(0,0,w,h);
for(let i=0;i<P;i++){
const a=particles[i];
a.x+=a.vx;a.y+=a.vy;
if(a.x<0||a.x>w)a.vx*=-1;
if(a.y<0||a.y>h)a.vy*=-1;

ctx.fillStyle="#7d8cff";
ctx.beginPath();
ctx.arc(a.x,a.y,1.5,0,6.28);
ctx.fill();

for(let j=i+1;j<P;j++){
const b=particles[j];
const dx=a.x-b.x;
const dy=a.y-b.y;
const d=Math.sqrt(dx*dx+dy*dy);
if(d<120){
ctx.strokeStyle="rgba(125,140,255,"+(1-d/120)+")";
ctx.lineWidth=.5;
ctx.beginPath();
ctx.moveTo(a.x,a.y);
ctx.lineTo(b.x,b.y);
ctx.stroke();
}
}
}
requestAnimationFrame(draw);
}
draw();
</script>

<!-- ä¸‹é¢ JS æ˜¯ä½ åŸæœ¬çš„é‚è¼¯ï¼Œå®Œæ•´ä¿ç•™ -->

<script>
/* ğŸ‘‰ é€™è£¡ç›´æ¥è²¼ä½ åŸæœ¬é‚£æ®µ JSï¼ˆæˆ‘æ²’æœ‰åˆªæ¸›ï¼‰ */
</script>

</body>
</html>


/* ===== Firebase ===== */
const config={
apiKey:"AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",
authDomain:"smoke-queue.firebaseapp.com",
databaseURL:"https://smoke-queue-default-rtdb.firebaseio.com",
projectId:"smoke-queue"
};
firebase.initializeApp(config);

const db=firebase.database();
const auth=firebase.auth();
const queueRef=db.ref("queue");
const logRef=db.ref("log");

let me,myData,engineReady=false;
let cacheQueue={};

queueRef.on("value",snap=>cacheQueue=snap.val()||{});

/* åœ¨ç·š */
db.ref("users").on("value",snap=>{
onlineBar.innerHTML="";
snap.forEach(s=>{
let u=s.val();
let div=document.createElement("div");
div.className="userBox "+(u.online?"onlineUser":"offlineUser");
div.textContent=u.name;
onlineBar.appendChild(div);
});
});

/* æ—¥èªŒ */
function addLog(t){logRef.push({text:t,time:Date.now()});}
logRef.limitToLast(100).on("value",snap=>{
log.innerHTML="";
snap.forEach(s=>{
let l=s.val();
let d=document.createElement("div");
d.textContent=`[${new Date(l.time).toLocaleTimeString()}] ${l.text}`;
log.appendChild(d);
});
log.scrollTop=99999;
});

/* ç™»å…¥ */
auth.onAuthStateChanged(async user=>{
if(!user){location.href="login.html";return;}
me=user;
const ref=db.ref("users/"+user.uid);
let snap=await ref.once("value");
if(!snap.exists()){
let name=prompt("æš±ç¨±");
await ref.set({name:name||"è¨ªå®¢",role:"user"});
}
ref.on("value",s=>{
myData=s.val();
who.textContent="ç›®å‰ç™»å…¥ï¼š"+myData.name;
if(myData.role==="admin") adminPanel.classList.remove("hidden");
addLog("ğŸŸ¢ "+myData.name+" ç™»å…¥");
engineReady=true;
});
ref.child("online").set(true);
ref.child("online").onDisconnect().set(false);
});

function logout(){
addLog("ğŸ”´ "+myData.name+" ç™»å‡º");
auth.signOut().then(()=>location.href="login.html");
}

/* ç®¡ç† */
function clearChat(){db.ref("chat").remove();addLog("ç®¡ç†å“¡æ¸…ç©ºèŠå¤©å®¤");}
function clearLog(){logRef.remove();}
function resetQueue(){queueRef.remove();addLog("ç®¡ç†å“¡é‡ç½®æ’éšŠ");}

/* å·¥å…· */
function format(sec){let m=Math.floor(sec/60);let s=sec%60;return `${m}:${s.toString().padStart(2,"0")}`;}
function getSlot(h){const slots=[14,16,18,20,22,24];if(h===0)return 24;for(let s of slots)if(h<=s)return s;return 14;}

/* å¼•æ“ */
function tick(){
if(!engineReady)return;
let now=new Date();
let h=now.getHours(),m=now.getMinutes(),s=now.getSeconds();
clock.textContent=`ç¾åœ¨æ™‚é–“ï¼š${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
let slot=getSlot(h);
slotInfo.textContent=`æ™‚æ®µï¼š${slot}:00â€“${slot}:59`;
}
setInterval(tick,1000);

/* èŠå¤© */
msg.addEventListener("keydown",e=>{if(e.key==="Enter")send();});
function send(){
if(!msg.value.trim())return;
db.ref("chat").push({name:myData.name,text:msg.value,time:Date.now()});
msg.value="";
}
db.ref("chat").limitToLast(200).on("value",snap=>{
chat.innerHTML="";
snap.forEach(s=>{
let m=s.val();
let d=document.createElement("div");
d.className="msg";
d.textContent=`${m.name}: ${m.text}`;
chat.appendChild(d);
});
chat.scrollTop=99999;
});
</script>

</body>
</html>
