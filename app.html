<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¬è±ªå¸è¸å®¤ v15.4 </title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* å¼•å…¥é ‚ç´šå­—é«” */
@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500;700&family=Noto+Sans+TC:wght@300;400;500;700&family=Rajdhani:wght@500;600;700&family=Ma+Shan+Zheng&display=swap');

:root {
    --gold: #C5A059;
    --gold-dim: rgba(197, 160, 89, 0.2);
    --gold-dark: #8A6E3E;
    --bg-dark: #08090b;
    --glass: rgba(20, 22, 26, 0.75);
    --glass-border: rgba(255, 255, 255, 0.08);
    --text-main: #ECECEC;
    --success: #4caf50;
    --danger: #d32f2f;
}

* { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

body {
    margin: 0; font-family: "Noto Sans TC", sans-serif;
    background: var(--bg-dark); color: var(--text-main);
    display: flex; height: 100vh; overflow: hidden; font-size: 15px; perspective: 1000px;
}

/* --- èƒŒæ™¯ç‰¹æ•ˆ --- */
.ambient-light {
    position: fixed; top: -20%; left: 50%; width: 100vw; height: 100vh;
    background: radial-gradient(ellipse at center, rgba(197, 160, 89, 0.08) 0%, transparent 60%);
    transform: translateX(-50%); pointer-events: none; z-index: 0;
}
canvas#bg { position: fixed; inset: 0; z-index: 1; pointer-events: none; }

/* --- ä¸»ä½ˆå±€ --- */
#layout { display: flex; width: 100%; height: 100%; z-index: 10; position: relative; padding: 20px; gap: 20px; }
#dashboard { flex: 1.8; display: flex; flex-direction: column; gap: 16px; overflow-y: auto; padding-right: 6px; min-width: 400px; }
#comms { flex: 1; display: flex; flex-direction: column; gap: 0; min-width: 320px; height: 100%; overflow: hidden; position: relative; }

/* --- ç›£æ§ç¶²æ ¼ --- */
.monitor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.monitor-left { display: flex; flex-direction: column; gap: 16px; }
.monitor-right { display: flex; flex-direction: column; }
.monitor-right .glass-panel { flex: 1; display: flex; flex-direction: column; }
.monitor-right .list-container { flex: 1; max-height: none; }

/* --- ç»ç’ƒå¡ç‰‡ --- */
.glass-panel {
    background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
    border: 1px solid var(--glass-border); border-top: 1px solid rgba(255,255,255,0.15); border-radius: 4px; padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; flex-shrink: 0; transition: border-color 0.3s;
}
.glass-panel:hover { border-color: var(--gold-dim); }

/* --- ç‹€æ…‹åˆ— --- */
.status-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
.user-badge { 
    background: linear-gradient(90deg, var(--gold-dim), transparent); padding: 4px 12px; 
    border-radius: 2px; font-size: 14px; border-left: 3px solid var(--gold); 
    color: #fff; letter-spacing: 1px; font-weight: 500; display: flex; align-items: center;
}
.btn-logout { 
    background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #aaa; cursor: pointer; 
    padding: 4px 10px; border-radius: 2px; font-size: 11px; transition: .3s; margin-left: 10px;
}
.btn-logout:hover { border-color: var(--gold); color: var(--gold); }

#clock {
    font-family: 'Rajdhani', sans-serif; font-size: 44px; line-height: 1;
    font-weight: 700; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.15);
    margin: 12px 0 8px; letter-spacing: 2px;
}
#slotDisplay { font-size: 14px; color: var(--gold); letter-spacing: 1px; font-family: 'Noto Serif TC'; font-weight: 500; opacity: 0.9; }
#status { font-size: 16px; font-weight: 700; margin: 5px 0 15px; min-height: 24px; letter-spacing: 1px; color: #ccc; }

/* --- æŒ‰éˆ•ç³»çµ± --- */
.control-grid { display: flex; gap: 12px; margin-top: 15px; flex-wrap: wrap; }
button.action-btn {
    flex: 1; min-width: 120px; padding: 18px 10px; border-radius: 2px; font-size: 14px; font-weight: 500; letter-spacing: 2px;
    cursor: pointer; transition: all 0.3s; font-family: "Noto Sans TC", sans-serif;
    position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); background: linear-gradient(135deg, #2a2d35, #1a1c22); color: #ccc;
}
button.action-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.4); }

.btn-gold { border-color: var(--gold) !important; color: var(--gold) !important; }
.btn-gold:hover { background: var(--gold-dim) !important; color: #fff !important; }
.btn-red:hover { border-color: var(--danger) !important; color: var(--danger) !important; background: rgba(211,47,47,0.1) !important;}
.btn-green:hover { border-color: var(--success) !important; color: var(--success) !important; background: rgba(76,175,80,0.1) !important;}

/* --- åˆ—è¡¨èˆ‡æ¨™é¡Œ --- */
h3 { margin: 0 0 12px 0; font-size: 13px; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; display: flex; align-items: center; gap: 8px; font-family: 'Noto Serif TC', serif; border-bottom: 1px solid rgba(255,255,255,0.06); padding-bottom: 8px; }
.list-container { max-height: 150px; overflow-y: auto; padding-right: 4px; }
.item-card { background: linear-gradient(90deg, rgba(255,255,255,0.03), transparent); margin-bottom: 6px; padding: 10px 14px; border-radius: 2px; border-left: 2px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; font-size: 14px; transition: 0.3s;}
.item-card:hover { background: rgba(255,255,255,0.05); }
.item-card.rank-1 { border-left-color: var(--gold); background: linear-gradient(90deg, var(--gold-dim), transparent); }
.item-card.rank-2 { border-left-color: #c0c0c0; }

/* ğŸŸ¢ é–’ç½®å€’æ•¸ç‰¹æ•ˆ */
.afk-timer {
    color: var(--danger); font-size: 11px; margin-left: 8px; 
    font-family: 'Rajdhani'; font-weight: bold;
    animation: flashRed 1s infinite alternate; display: none;
}
@keyframes flashRed { 0% { opacity: 0.5; text-shadow: 0 0 5px transparent; } 100% { opacity: 1; text-shadow: 0 0 10px var(--danger); } }

.btn-mini { padding: 3px 8px; font-size: 10px; border-radius: 2px; cursor: pointer; margin-left: 8px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: #888; transition: 0.2s;}
.btn-mini:hover { color: #fff; border-color: #fff; }
.btn-mini.danger:hover { background: var(--danger); border-color: var(--danger); }
.btn-mini.success:hover { background: var(--success); border-color: var(--success); color: #000;}

.btn-arrow { width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; background: none; border:none; color:#666; cursor:pointer; margin-left:2px; font-size:10px; transition:0.2s; }
.btn-arrow:hover { color: var(--gold); transform: scale(1.2); }

/* --- èŠå¤©å®¤ --- */
#chat-header { padding: 15px; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--glass-border); display: flex; flex-direction: column; gap: 8px; }
.chat-title { font-weight:700; color:var(--gold); font-family: 'Noto Serif TC'; letter-spacing: 2px; font-size: 13px; }
#chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }

.msg-bubble { max-width: 85%; padding: 8px 12px; border-radius: 4px; font-size: 13px; line-height: 1.5; word-break: break-all; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
.msg-mine { align-self: flex-end; background: linear-gradient(135deg, #2a2d35, #1a1c22); border: 1px solid var(--gold-dark); color: #fff; border-bottom-right-radius: 0; }
.msg-other { align-self: flex-start; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05); color: #ccc; border-bottom-left-radius: 0; }
.msg-name { font-size: 10px; margin-bottom: 3px; opacity: 0.6; font-family: 'Noto Serif TC'; cursor: pointer; transition: 0.2s;}
.msg-name:hover { color: var(--gold); opacity: 1; }
.msg-img { max-width: 100%; border-radius: 2px; cursor: pointer; margin-top: 5px; border: 1px solid rgba(255,255,255,0.1); }

/* å¿«æ·æ¨™ç±¤ */
.chat-tags { display: flex; gap: 5px; margin-top: -5px; margin-bottom: 5px; }
.chat-tag { font-size: 10px; padding: 3px 8px; border-radius: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #888; cursor: pointer; transition: 0.2s; white-space: nowrap;}
.chat-tag:hover { color: var(--gold); border-color: var(--gold); }

/* è¼¸å…¥å€ */
.input-area { padding: 12px; background: rgba(0,0,0,0.4); border-top: 1px solid var(--glass-border); display: flex; gap: 8px; align-items: center; position: relative; flex-wrap: wrap;}
.input-main { display: flex; width: 100%; gap: 8px; align-items: center; }
input#msg { flex: 1; background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.2); border-radius: 0; padding: 8px 5px; color: #fff; transition: .3s; font-family: "Noto Serif TC"; }
input#msg:focus { border-bottom-color: var(--gold); }
.btn-tool { background: transparent; border: none; font-size: 16px; cursor: pointer; padding: 5px; color: #666; transition: .2s; }
.btn-tool:hover { color: var(--gold); }
button.btn-send { background: var(--gold); border: none; color: #000; border-radius: 2px; width: 36px; height: 36px; cursor: pointer; font-weight: bold; flex-shrink: 0; transition: 0.2s;}
button.btn-send:hover { background: #fff; }

/* è¡¨æƒ…é¢æ¿ */
#emojiPicker { 
    position: absolute; bottom: 70px; left: 10px; width: 280px; background: rgba(15,15,20,0.95); 
    border: 1px solid var(--gold-dark); border-radius: 4px; padding: 10px; 
    display: none; grid-template-columns: repeat(6, 1fr); gap: 5px; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 50;
}
#emojiPicker.show { display: grid; }
.emoji-btn { font-size: 20px; background: transparent; border: none; cursor: pointer; padding: 5px; border-radius: 2px; transition:0.2s;}
.emoji-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.1); }

/* --- Admin UI & Modals --- */
#btnAdminFloat { position: fixed; bottom: 80px; left: 20px; z-index: 100; width: 45px; height: 45px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--gold); font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; backdrop-filter: blur(10px); }
#btnAdminFloat:hover { background: var(--gold); color: #000; transform: rotate(90deg); box-shadow: 0 0 20px rgba(197, 160, 89, 0.5); }
#btnGame { position: fixed; bottom: 20px; left: 20px; z-index: 100; width: 45px; height: 45px; border-radius: 50%; background: rgba(0,0,0,0.6); border: 1px solid var(--success); color: var(--success); font-size: 20px; cursor: pointer; display: none; align-items: center; justify-content: center; transition: 0.3s; backdrop-filter: blur(10px); }

#adminModal { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
#adminModal.show { display: flex; opacity: 1; }
.admin-card { width: 420px; background: #0c0c0e; border: 1px solid var(--gold-dark); border-radius: 4px; padding: 30px; box-shadow: 0 0 60px rgba(0,0,0,0.9); transform: translateY(20px); transition: transform 0.3s; }
#adminModal.show .admin-card { transform: translateY(0); }
.admin-section { margin-bottom: 25px; }
.btn-admin-action { padding: 12px; border-radius: 2px; border: 1px solid #333; background: #1a1a1a; color: #ccc; cursor: pointer; transition: 0.2s; font-size: 13px; }
.btn-admin-action:hover { border-color: #fff; color: #fff; background: #222; }

/* --- Toast --- */
#toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
.toast { background: rgba(15, 15, 20, 0.95); border: 1px solid var(--gold-dark); color: #fff; padding: 12px 24px; border-radius: 4px; font-family: 'Noto Sans TC'; font-size: 14px; font-weight: 500; box-shadow: 0 10px 30px rgba(0,0,0,0.8); display: flex; align-items: center; gap: 10px; opacity: 0; transform: translateY(-20px); transition: all 0.4s cubic-bezier(0.22, 1, 0.36, 1); }
.toast.show { opacity: 1; transform: translateY(0); }
.toast.success { border-color: var(--success); }
.toast.success::before { content: 'âœ“'; color: var(--success); font-weight: bold; }
.toast.error { border-color: var(--danger); }
.toast.error::before { content: 'âœ•'; color: var(--danger); font-weight: bold; }
.toast.info::before { content: 'â„¹'; color: var(--gold); font-weight: bold; font-family: serif; }

/* --- Confirm Modal --- */
#confirmModal { position: fixed; inset: 0; z-index: 3000; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; }
#confirmModal.show { display: flex; opacity: 1; }
.confirm-box { background: #111; border: 1px solid #444; border-radius: 4px; padding: 30px; width: 320px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.9); transform: scale(0.95); transition: 0.3s; }
#confirmModal.show .confirm-box { transform: scale(1); }
.confirm-text { color: #fff; font-size: 16px; margin-bottom: 25px; font-family: 'Noto Serif TC'; line-height:1.5;}
.confirm-btns { display: flex; gap: 10px; justify-content: center; }
.confirm-btn { padding: 10px 20px; border-radius: 2px; border: none; cursor: pointer; font-weight: bold; font-family: 'Noto Sans TC'; transition: 0.2s; }
.confirm-btn.yes { background: var(--danger); color: #fff; }
.confirm-btn.yes:hover { filter: brightness(1.2); }
.confirm-btn.no { background: #333; color: #aaa; }
.confirm-btn.no:hover { background: #444; color: #fff; }

/* --- ğŸŸ¢ Alert Modal (å¼·åˆ¶é—œé–‰å½ˆçª—) --- */
#alertModal { position: fixed; inset: 0; z-index: 3000; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; }
#alertModal.show { display: flex; opacity: 1; }
#alertModal .confirm-box { background: #111; border: 1px solid var(--danger); border-radius: 4px; padding: 35px 30px; width: 320px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.9); transform: scale(0.95); transition: 0.3s; }
#alertModal.show .confirm-box { transform: scale(1); }

/* Online List */
#onlineUserList { display: flex; gap: 6px; flex-wrap: wrap; width: 100%; }
.online-pill { padding: 4px 10px; border-radius: 20px; font-size: 11px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #aaa; white-space: nowrap; transition: 0.3s; display: flex; align-items: center; gap: 5px; }
.online-pill.admin { border-color: var(--gold-dark); color: var(--gold); background: rgba(197,160,89,0.05); }
.online-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; }
.online-pill.online .online-dot { background: var(--success); box-shadow: 0 0 5px var(--success); }

::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
#imgModal { position: fixed; inset: 0; z-index: 300; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; }
#imgModal img { max-width: 90%; max-height: 90%; border: 1px solid var(--gold); box-shadow: 0 0 50px rgba(0,0,0,0.5); }

@media (max-width: 900px) {
    #layout { flex-direction: column; padding: 10px; }
    #dashboard { flex: none; width: 100%; min-width: 0; max-height: 60vh; }
    #comms { flex: 1; min-width: 0; height: 40vh; }
    .monitor-grid { grid-template-columns: 1fr; }
}
</style>
</head>

<body>
<div class="ambient-light"></div>
<canvas id="bg"></canvas>

<div id="toast-container"></div>
<div id="confirmModal">
    <div class="confirm-box">
        <div class="confirm-text" id="confirmMsg">ç¢ºèªåŸ·è¡Œæ­¤æ“ä½œï¼Ÿ</div>
        <div class="confirm-btns">
            <button class="confirm-btn no" onclick="closeConfirm(false)">å–æ¶ˆ</button>
            <button class="confirm-btn yes" onclick="closeConfirm(true)">ç¢ºèª</button>
        </div>
    </div>
</div>

<div id="alertModal">
    <div class="confirm-box">
        <div class="confirm-text" id="alertMsg" style="font-size:15px; color:#ddd;">æç¤ºè¨Šæ¯</div>
        <div class="confirm-btns">
            <button class="confirm-btn yes" onclick="closeAlert()" style="width:100%; letter-spacing:2px;">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>
</div>

<div id="imgModal" onclick="this.style.display='none'">
    <img id="imgModalSrc" src="">
</div>

<div id="broadcastBanner" style="position: fixed; top: -200px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 600px; z-index: 9999; background: rgba(10, 10, 10, 0.95); border: 1px solid var(--gold); border-radius: 4px; padding: 25px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.9); transition: top 0.6s cubic-bezier(0.22, 1, 0.36, 1);">
    <h3 style="border:none; justify-content:center; color:var(--gold);">ğŸ“¢ è¬è±ªå¸è¸å®¤å…¬å‘Š</h3>
    <p id="broadcastText" style="font-size:18px; font-weight:700; color:#fff; margin:0; font-family:'Noto Serif TC';">---</p>
</div>

<button id="btnAdminFloat" onclick="openAdmin()" style="display:none;">âš™ï¸</button>
<button id="btnGame" onclick="location.href='game.html'" title="å‰å¾€éŠæ¨‚å ´">ğŸ®</button>

<div id="adminModal" onclick="if(event.target===this)closeAdmin()">
    <div class="admin-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; color:var(--gold); font-family:'Noto Serif TC'">è¡Œæ”¿ç®¡ç†å°</h2>
            <button onclick="closeAdmin()" style="background:none; border:none; color:#666; cursor:pointer;">âœ•</button>
        </div>
        
        <div class="admin-section">
            <h4 style="color:#888; font-size:11px; margin-bottom:10px;">ç‰ˆæœ¬æ¨é€æ§åˆ¶ (ç•¶å‰: v<span id="verDisplay">15.4</span>)</h4>
            <button onclick="publishNewVersion()" style="width:100%; background:var(--gold); color:#000; border:none; padding:12px; font-weight:bold; border-radius:2px; cursor:pointer;">æ¨é€æ›´æ–°çµ¦å…¨é«”è²´è³“</button>
        </div>

        <div class="admin-section">
            <h4 style="color:#888; font-size:11px; margin-bottom:10px;">æ’éšŠç®¡ç†</h4>
            <div style="display:flex; gap:10px;">
                <select id="adminUserSelect" style="flex:1; background:#1a1a1a; color:#fff; padding:10px; border-radius:2px; border:1px solid #333; font-family:'Noto Sans TC';"></select>
                <button onclick="adminForceAdd()" style="background:var(--gold); color:#000; border:none; padding:0 15px; font-weight:bold; border-radius:2px; cursor:pointer;">åŠ å…¥</button>
            </div>
        </div>

        <div class="admin-section">
            <h4 style="color:#888; font-size:11px; margin-bottom:10px;">å»£æ’­ç³»çµ±</h4>
            <div style="display:flex; gap:10px;">
                <input id="broadcastInput" style="flex:1; background:#1a1a1a; border:1px solid #333; padding:10px; color:#fff; border-radius:2px;" placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹...">
                <button onclick="sendBroadcast()" style="background:#444; color:#fff; border:none; padding:0 15px; font-weight:bold; border-radius:2px; cursor:pointer;">ç™¼é€</button>
            </div>
        </div>
        
        <div class="admin-section">
            <h4 style="color:#888; font-size:11px; margin-bottom:10px;">ç³»çµ±ç¶­è­·</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button id="btnTogglePg" class="btn-admin-action" style="grid-column: span 2; border-color:var(--success); color:var(--success);" onclick="togglePlayground()">éŠæ¨‚å ´ç‹€æ…‹: è®€å–ä¸­...</button>
                <button onclick="resetQueue()" class="btn-admin-action" style="border-color:var(--danger); color:var(--danger);">é‡ç½®ç³»çµ±</button>
                <button onclick="clearChat()" class="btn-admin-action">æ¸…ç©ºèŠå¤©å®¤</button>
                <button onclick="clearHistory()" class="btn-admin-action">æ¸…ç©ºæ­·å²ç´€éŒ„</button>
                <button onclick="clearLog()" class="btn-admin-action">æ¸…ç©ºæ—¥èªŒ</button>
                <button onclick="forceReload()" class="btn-admin-action" style="grid-column: span 2;">å…¨é«”å¼·åˆ¶åˆ·æ–°</button>
            </div>
        </div>
    </div>
</div>

<div id="layout">
    <div id="dashboard">
        <div class="glass-panel" style="flex-shrink: 0;">
            <div class="status-header">
                <div style="display: flex; align-items: center;">
                    <span class="user-badge" id="who">é€£ç·šä¸­...</span>
                    <button class="btn-logout" onclick="enableNotification()" id="btnNotify" style="display:none;">ğŸ””</button>
                    <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
                </div>
                <div id="slotDisplay">---</div>
            </div>
            <div id="clock">00:00:00</div>
            <div id="status">ç³»çµ±åˆå§‹åŒ–...</div>
            <div class="control-grid">
                <button id="bReserve" onclick="reserve()" class="action-btn">é ç´„æ’éšŠ</button>
                <button id="bOut" onclick="goOut()" class="action-btn">ç¾åœ¨å‰å¾€</button>
                <button id="bBack" onclick="comeBack()" class="action-btn">ç¢ºèªè¿”å›</button>
                <button id="bCancel" onclick="handleCancelClick()" class="action-btn">å–æ¶ˆé ç´„</button>
            </div>
        </div>

        <div class="monitor-grid">
            <div class="monitor-left">
                <div class="glass-panel">
                    <h3>å¤–å‡ºè²´è³“ (<span id="outCountNum" style="color:var(--success)">0</span>/3)</h3>
                    <div id="outList" class="list-container"></div>
                </div>
                <div class="glass-panel">
                    <h3>æ­·å²ç´€éŒ„</h3>
                    <div id="history" class="list-container"></div>
                </div>
            </div>
            <div class="monitor-right">
                <div class="glass-panel">
                    <h3>å€™ä½åå–®</h3>
                    <div id="queue" class="list-container"></div>
                </div>
            </div>
        </div>

        <div class="glass-panel" style="flex-shrink: 0;">
            <h3>ç³»çµ±æ—¥èªŒ</h3>
            <div id="log" class="list-container" style="font-family: 'Rajdhani', monospace; font-size: 12px; color:#888; max-height:100px;"></div>
        </div>
    </div>

    <div id="comms" class="glass-panel" style="padding:0;">
        <div id="chat-header">
            <div class="chat-title">è¬è±ªå¸è¸å®¤ CHAT</div>
            <div id="onlineUserList"></div>
        </div>
        <div id="chat-box"></div>
        <div id="emojiPicker"></div>
        <div class="input-area">
            <div class="chat-tags" id="chatTags">
                <span class="chat-tag" onclick="insertTag('[æ»¿ä½ç­‰å€™]')">æ»¿ä½</span>
                <span class="chat-tag" onclick="insertTag('[åé¡é‡‹å‡º]')">é–‹æ”¾</span>
                <span class="chat-tag" onclick="insertTag('[è«‹ç•™æ„éŸ³é‡]')">å®‰éœ</span>
            </div>
            <div class="input-main">
                <input type="file" id="imgInput" hidden accept="image/*" onchange="handleFile(event)">
                <button class="btn-tool" onclick="document.getElementById('imgInput').click()" title="å‚³é€åœ–ç‰‡">ğŸ“·</button>
                <button class="btn-tool" onclick="toggleEmoji()" title="è¡¨æƒ…ç¬¦è™Ÿ">ğŸ˜€</button>
                <input id="msg" placeholder="è¼¸å…¥è¨Šæ¯..." onkeydown="if(event.key==='Enter')send()" autocomplete="off">
                <button onclick="send()" class="btn-send">â¤</button>
            </div>
        </div>
    </div>
</div>

<script>
/* ğŸŸ¢ æ‡‰ç”¨ç¨‹å¼ç‰ˆæœ¬æ§åˆ¶ */
const APP_VERSION = 15.4;
document.getElementById('verDisplay').textContent = APP_VERSION.toFixed(1);

/* --- Init --- */
const config={apiKey:"AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",authDomain:"smoke-queue.firebaseapp.com",databaseURL:"https://smoke-queue-default-rtdb.firebaseio.com",projectId:"smoke-queue"};
firebase.initializeApp(config);
const db=firebase.database(), auth=firebase.auth();
const queueRef=db.ref("queue"), userRef=db.ref("users"), chatRef=db.ref("chat"), logRef=db.ref("log"), broadcastRef=db.ref("broadcast"), configRef=db.ref("config");

let me, myData, engineReady=false, cacheQueue={}, currentSlotInfo={phase:'',slot:0}, allUsers={};
let audioCtx=null, notifyEnabled=false, playgroundEnabled = false;

/* --- Toast, Confirm, & Alert --- */
function showToast(msg, type='info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = msg;
    container.appendChild(toast);
    void toast.offsetWidth; toast.classList.add('show');
    setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 400); }, 3000);
}
let confirmResolve = null;
function customConfirm(msg) {
    return new Promise((resolve) => {
        document.getElementById('confirmMsg').innerHTML = msg;
        document.getElementById('confirmModal').classList.add('show');
        confirmResolve = resolve;
    });
}
function closeConfirm(result) { document.getElementById('confirmModal').classList.remove('show'); if(confirmResolve) { confirmResolve(result); confirmResolve = null; } }

// ğŸŸ¢ Alert Modal é‚è¼¯
function customAlert(msg) {
    document.getElementById('alertMsg').innerHTML = msg;
    document.getElementById('alertModal').classList.add('show');
}
function closeAlert() { document.getElementById('alertModal').classList.remove('show'); }

function escapeHtml(text) { if (!text) return text; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

/* --- é¦™æª³æ°£æ³¡èƒŒæ™¯ --- */
const canvas=document.getElementById("bg"), ctx=canvas.getContext("2d");
let w,h,particles=[]; function resize(){w=canvas.width=innerWidth;h=canvas.height=innerHeight;} window.onresize=resize; resize();
for(let i=0;i<40;i++)particles.push({x:Math.random()*w,y:Math.random()*h,vy:Math.random()*0.3+0.1,size:Math.random()*1.5,alpha:Math.random()*0.5+0.1});
function draw(){ctx.clearRect(0,0,w,h);particles.forEach(p=>{p.y-=p.vy;if(p.y<0){p.y=h;p.x=Math.random()*w;}ctx.fillStyle=`rgba(197, 160, 89,${p.alpha})`;ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,6.28);ctx.fill();});requestAnimationFrame(draw);}draw();

/* --- é›²ç«¯ç†±æ›´æ–°ç›£è½ --- */
let firstVerCheck = true;
db.ref("config/system_version").on("value", snap => {
    const dbVer = snap.val(); if (!dbVer) return;
    if (APP_VERSION < dbVer) {
        if (firstVerCheck) { window.location.href = window.location.href.split('?')[0] + "?v=" + dbVer; return; }
        showToast(`ğŸ†• ç³»çµ±å·²å‡ç´šï¼Œ3ç§’å¾Œè‡ªå‹•æ›´æ–°...`, 'info');
        setTimeout(() => { window.location.href = window.location.href.split('?')[0] + "?v=" + dbVer; }, 3000);
    }
    firstVerCheck = false;
});

/* --- å‹•æ…‹å•å€™èª --- */
function getGreeting(name) {
    const hr = new Date().getHours(); let greet = "æ™šå®‰";
    if(hr >= 5 && hr < 12) greet = "æ—©å®‰"; else if(hr >= 12 && hr < 18) greet = "åˆå®‰";
    return `${greet}ï¼Œ${name.toUpperCase()}`;
}

/* --- Auth --- */
auth.onAuthStateChanged(user=>{
    if(!user){location.href="login.html";return;} me=user;
    userRef.child(user.uid).on("value",s=>{
        myData=s.val()||{};
        document.getElementById("who").textContent = getGreeting(myData.name || "GUEST");
        document.getElementById("btnAdminFloat").style.display=(myData.role==="admin")?"flex":"none";
        document.getElementById("chatTags").style.display=(myData.role==="admin")?"flex":"none";
        
        engineReady=true;
        if(myData.role === "admin") { userRef.on("value", snap => { allUsers = snap.val() || {}; if(document.getElementById('adminModal').classList.contains('show')) updateAdminUserSelect(); }); }
        renderStaticLists(); updateButtonStates(); renderOutList(); 
    });
    userRef.child(user.uid+"/online").set(true); userRef.child(user.uid+"/online").onDisconnect().set(false);
});
function logout(){auth.signOut().then(()=>{location.href="login.html";});}

/* --- Admin --- */
function updateAdminUserSelect() {
    const sel = document.getElementById("adminUserSelect"); sel.innerHTML = "<option value=''>é¸æ“‡è²´è³“...</option>";
    Object.entries(allUsers).forEach(([uid, u]) => {
        let isReserved = cacheQueue.reserve && cacheQueue.reserve[uid]; let isOut = cacheQueue.out && cacheQueue.out[uid];
        if(!isReserved && !isOut) { let opt = document.createElement("option"); opt.value = uid; opt.textContent = u.name; sel.appendChild(opt); }
    });
}
function adminForceAdd() {
    const uid = document.getElementById("adminUserSelect").value; if(!uid) return; const u = allUsers[uid];
    if(u) {
        let h=new Date().getHours(), t=currentSlotInfo.phase==='RESERVE'?currentSlotInfo.slot:h;
        queueRef.child("reserve/"+uid).set({ name: u.name, time: Date.now(), slot: t });
        addLog(`ADMIN åŠ å…¥: ${u.name}`); closeAdmin(); showToast(`å·²å°‡ ${u.name} åŠ å…¥æ’éšŠ`, 'success');
    }
}
function moveQueue(uid, direction) {
    if(!myData || myData.role !== 'admin') return;
    let r = cacheQueue.reserve || {}; let sorted = Object.entries(r).sort((a,b) => a[1].time - b[1].time); let idx = sorted.findIndex(x => x[0] === uid);
    if (idx === -1) return; let targetIdx = idx + direction; if (targetIdx < 0 || targetIdx >= sorted.length) return;
    let targetUid = sorted[targetIdx][0], myTime = sorted[idx][1].time, targetTime = sorted[targetIdx][1].time;
    if (myTime === targetTime) { if(direction < 0) targetTime -= 1; else targetTime += 1; }
    queueRef.child('reserve/' + uid).update({ time: targetTime }); queueRef.child('reserve/' + targetUid).update({ time: myTime });
}
async function publishNewVersion() {
    if(await customConfirm(`ç¢ºå®šæ¨é€ <span style="color:var(--gold)">v${APP_VERSION.toFixed(1)}</span> ç³»çµ±æ›´æ–°ï¼Ÿ<br><small>é€™å°‡å¼·åˆ¶åˆ·æ–°æ‰€æœ‰äººçš„ç•«é¢</small>`)) {
        db.ref("config/system_version").set(APP_VERSION);
        addLog(`ADMIN æ¨é€æ›´æ–° v${APP_VERSION.toFixed(1)}`); showToast("æ›´æ–°æŒ‡ä»¤å·²ç™¼é€", 'success'); closeAdmin();
    }
}

configRef.child("playground_status").on("value", s => {
    playgroundEnabled = s.val() || false;
    const btn = document.getElementById("btnGame"), toggleBtn = document.getElementById("btnTogglePg");
    if(playgroundEnabled) { btn.style.display = "flex"; } else { btn.style.display = "none"; }
    if(toggleBtn) { toggleBtn.textContent = playgroundEnabled ? "éŠæ¨‚å ´ç‹€æ…‹: é–‹å•Ÿ" : "éŠæ¨‚å ´ç‹€æ…‹: é—œé–‰"; toggleBtn.style.color = playgroundEnabled ? "var(--success)" : "var(--danger)"; toggleBtn.style.borderColor = playgroundEnabled ? "var(--success)" : "var(--danger)"; }
});
function togglePlayground() { configRef.child("playground_status").set(!playgroundEnabled); showToast(playgroundEnabled?"å·²é—œé–‰éŠæ¨‚å ´":"å·²é–‹å•ŸéŠæ¨‚å ´", 'info');}

function openAdmin(){ document.getElementById('adminModal').classList.add('show'); if(Object.keys(allUsers).length > 0) updateAdminUserSelect(); else userRef.once("value").then(snap => { allUsers = snap.val() || {}; updateAdminUserSelect(); }); }
function closeAdmin(){document.getElementById('adminModal').classList.remove('show');}
function sendBroadcast(){const i=document.getElementById('broadcastInput');if(!i.value.trim())return;broadcastRef.set({text:i.value,t:Date.now()});i.value="";closeAdmin(); showToast("å»£æ’­å·²ç™¼é€", 'success');}
broadcastRef.on("value",s=>{
    const v=s.val(); if(!v||Date.now()-v.t>10000)return;
    const b=document.getElementById('broadcastBanner'); document.getElementById('broadcastText').textContent=v.text;
    b.classList.add('active'); playBeep('urgent'); setTimeout(()=>b.classList.remove('active'),5000);
});

/* --- Chat System --- */
const emojis = ["ğŸ˜€","ğŸ˜‚","ğŸ˜","ğŸ˜","ğŸ¤”","ğŸ˜­","ğŸ˜¡","ğŸ‘","ğŸ‘","ğŸš¬","ğŸ”¥","â˜•","ğŸº","ğŸ’¨","ğŸ‘€","â¤ï¸","âœ…","âŒ"];
const emojiPicker = document.getElementById("emojiPicker");
emojis.forEach(e => { const btn = document.createElement("button"); btn.className = "emoji-btn"; btn.textContent = e; btn.onclick = () => { document.getElementById("msg").value += e; toggleEmoji(); document.getElementById("msg").focus(); }; emojiPicker.appendChild(btn); });
function toggleEmoji() { emojiPicker.classList.toggle("show"); }
function handleFile(e) {
    const file = e.target.files[0]; if(!file) return;
    if(file.size > 2 * 1024 * 1024) { showToast("åœ–ç‰‡ä¸èƒ½è¶…é 2MB", 'error'); return; }
    const reader = new FileReader(); reader.onload = (event) => {
        const img = new Image(); img.onload = () => {
            const canvas = document.createElement('canvas'); let width = img.width, height = img.height;
            if (width > 400) { height *= 400 / width; width = 400; } canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
            chatRef.push({ name: myData.name, uid: me.uid, text: canvas.toDataURL('image/jpeg', 0.7), type: 'image', time: Date.now() });
        }; img.src = event.target.result;
    }; reader.readAsDataURL(file); e.target.value = '';
}
function send(){ let i=document.getElementById("msg"); if(!i.value.trim())return; chatRef.push({ name:myData.name, uid:me.uid, text:i.value, type: 'text', time:Date.now() }); i.value=""; emojiPicker.classList.remove("show"); }

function insertTag(text) { const input = document.getElementById("msg"); input.value += text + " "; input.focus(); }
function mentionUser(name) { const input = document.getElementById("msg"); input.value = `@${name} ` + input.value; input.focus(); }

chatRef.limitToLast(30).on("value",s=>{
    let b=document.getElementById("chat-box"); b.innerHTML="";
    s.forEach(x=>{
        let m=x.val(), meMsg=m.uid===me.uid;
        let div=document.createElement("div"); div.className=`msg-bubble ${meMsg?'msg-mine':'msg-other'}`;
        let content = m.type === 'image' ? `<img src="${m.text}" class="msg-img" onclick="showImg(this.src)">` : escapeHtml(m.text);
        div.innerHTML=`<div class="msg-name" title="æ¨™è¨˜" onclick="mentionUser('${m.name}')">${m.name}</div>${content}`;
        b.appendChild(div);
    });
    b.scrollTop=b.scrollHeight;
});
function showImg(src) { document.getElementById("imgModalSrc").src = src; document.getElementById("imgModal").style.display = "flex"; }

/* --- ğŸŸ¢ æ ¸å¿ƒé‚è¼¯ & å¹½éˆé˜²ç¦¦æ©Ÿåˆ¶ (AFK Defense) --- */
function format12H(d){return d.toLocaleTimeString('en-US',{hour12:true,hour:'2-digit',minute:'2-digit',second:'2-digit'});}
function getSlotStatus(h,m){
    const slots=[14,16,18,20,22,0]; let currentSlot=slots.find(s=>s===h);
    const to12HStr = (hr) => { let suffix = (hr >= 12 && hr < 24) ? "PM" : "AM"; let dH = (hr % 12) || 12; return `${dH}:00 ${suffix}`; };
    const toOpenStr = (hr) => { let openH = (hr === 0) ? 23 : hr - 1; let suffix = (openH >= 12 && openH < 24) ? "PM" : "AM"; let dH = (openH % 12) || 12; return `${dH}:30 ${suffix}`; };
    if(currentSlot!==undefined){ return {phase:'OUT',slot:currentSlot,display:`${to12HStr(currentSlot)} é–‹æ”¾æ™‚æ®µ`}; }
    let target=slots.find(s=>(s===0?24:s)>h)||14; let diff=(target===0?24:target)*60-(h*60+m);
    if(diff>0&&diff<=30){ return {phase:'RESERVE',slot:target,display:`é ç´„ä¸­ ${to12HStr(target)}`}; }
    return {phase:'BREAK',nextSlot:target,display:`ä¸‹å€‹æ™‚æ®µ ${to12HStr(target)}`, hint:`${toOpenStr(target)}`};
}

// ğŸŸ¢ åŸ·è¡Œé–’ç½®é™éšæ‡²ç½° (å½ˆå‡ºå¼·åˆ¶é€šçŸ¥)
function executeAfkPenalty(uid, currentIndex, sorted) {
    let targetIndex = currentIndex + 3; // é™ 3 å
    let newTime;
    
    if (targetIndex >= sorted.length - 1) {
        newTime = sorted[sorted.length - 1][1].time + 1000;
    } else {
        let t1 = sorted[targetIndex][1].time;
        let t2 = sorted[targetIndex + 1][1].time;
        newTime = t1 + (t2 - t1) / 2;
        if(newTime <= t1) newTime = t1 + 1;
    }

    if (cacheQueue.reserve && cacheQueue.reserve[uid] && cacheQueue.reserve[uid].afkDeadline) {
        queueRef.child("reserve/" + uid).update({ time: newTime, afkDeadline: null });
        if (uid === me.uid) {
            // ğŸŸ¢ æ”¹ç”¨è‡ªè¨‚çš„ Alert Modal å¼·åˆ¶æé†’ï¼Œä¸¦åŠ ä¸Šç´…è‰²å¤§åœ–ç¤ºèˆ‡é†’ç›®æ–‡å­—
            customAlert("<div style='font-size:24px;margin-bottom:10px;'>âš ï¸</div><div style='color:var(--danger);font-size:18px;font-weight:bold;margin-bottom:15px;'>é †ä½å»¶å¾Œé€šçŸ¥</div>æ‚¨å·²è¶…é 3 åˆ†é˜æœªç¢ºèªå‰å¾€<br>ç‚ºç¶­æŒæ’éšŠé †æš¢ï¼Œç³»çµ±å·²è‡ªå‹•å°‡æ‚¨çš„é †ä½å»¶å¾Œã€‚");
        }
    }
}

setInterval(()=>{
    if(!engineReady)return; const now=new Date(), h=now.getHours(), m=now.getMinutes();
    document.getElementById("clock").textContent=format12H(now);
    if(myData && myData.name && now.getSeconds() === 0) document.getElementById("who").textContent = getGreeting(myData.name);
    
    currentSlotInfo=getSlotStatus(h,m);
    let dText = currentSlotInfo.display; if(currentSlotInfo.phase === 'BREAK') dText += ` (${currentSlotInfo.hint} é–‹æ”¾é ç´„)`;
    document.getElementById("slotDisplay").textContent=dText;
    if(h===1&&m===0&&now.getSeconds()===0&&myData.role==="admin") resetQueue(true); 

    // --- AFK å¹½éˆæ’éšŠé˜²ç¦¦é‚è¼¯ ---
    let r=cacheQueue.reserve||{};
    let sorted=Object.entries(r).sort((a,b)=>a[1].time-b[1].time);
    let outCount=Object.keys(cacheQueue.out||{}).length;
    let eligibleForOut = (outCount < 3 && sorted.length >= 3 && currentSlotInfo.phase === 'OUT');
    let penaltyExecutedThisTick = false; 

    sorted.forEach((u, i) => {
        let uid = u[0]; let data = u[1];
        let isTop2 = (i === 0 || i === 1);
        
        if (isTop2 && eligibleForOut) {
            if (!data.afkDeadline) {
                if (uid === me.uid || myData.role === 'admin') {
                    queueRef.child("reserve/"+uid).update({afkDeadline: Date.now() + 180000}); // 180ç§’
                }
            } else {
                let timeLeft = data.afkDeadline - Date.now();
                if (timeLeft <= 0) {
                    if (!penaltyExecutedThisTick && (uid === me.uid || myData.role === 'admin')) {
                        penaltyExecutedThisTick = true;
                        executeAfkPenalty(uid, i, sorted);
                    }
                }
            }
        } else {
            if (data.afkDeadline && (uid === me.uid || myData.role === 'admin')) {
                queueRef.child("reserve/"+uid).child("afkDeadline").remove();
            }
        }
        
        let span = document.getElementById(`afk-${uid}`);
        if (span) {
            if (data.afkDeadline) {
                let sLeft = Math.max(0, Math.floor((data.afkDeadline - Date.now())/1000));
                let mStr = String(Math.floor(sLeft/60)).padStart(2,'0');
                let sStr = String(sLeft%60).padStart(2,'0');
                span.innerHTML = `â³ ${mStr}:${sStr}`;
                span.style.display = "inline-block";
            } else {
                span.style.display = "none";
            }
        }
    });

    updateButtonStates(); 
},1000);

queueRef.on("value",s=>{ cacheQueue=s.val()||{}; if(engineReady){ renderStaticLists(); updateButtonStates(); renderOutList(); } });

let cancelConfirming = false;
function handleCancelClick() {
    const btn = document.getElementById('bCancel');
    if (!cancelConfirming) {
        cancelConfirming = true; btn.textContent = "å†æ¬¡é»æ“Šç¢ºèª"; btn.className = "action-btn btn-red";
        setTimeout(() => { if(cancelConfirming) { cancelConfirming = false; btn.textContent = "å–æ¶ˆé ç´„"; btn.className = "action-btn"; } }, 3000);
    } else { cancelConfirming = false; cancelReserve(); }
}

function updateButtonStates(){
    if(!me||!cacheQueue)return;
    let r=cacheQueue.reserve||{},o=cacheQueue.out||{},used=cacheQueue.used||{};
    let sorted=Object.entries(r).sort((a,b)=>a[1].time-b[1].time); let outCount=Object.keys(o).length;
    let myRank=sorted.findIndex(x=>x[0]===me.uid); let alreadyUsed = used[currentSlotInfo.slot]?.[me.uid];

    const hideAll = () => { bReserve.style.display='none'; bOut.style.display='none'; bBack.style.display='none'; bCancel.style.display='none'; }; hideAll();
    const setBtn = (btn, cls, txt) => { btn.style.display = 'block'; if(!cancelConfirming || btn.id !== 'bCancel') { btn.className = `action-btn ${cls}`; btn.textContent = txt; } };

    if(alreadyUsed) {} 
    else if(o[me.uid]) { setBtn(bBack, 'btn-red', 'ç¢ºèªè¿”å›'); } 
    else if(r[me.uid]) { setBtn(bCancel, '', 'å–æ¶ˆé ç´„'); if(currentSlotInfo.phase==='OUT' && myRank<=1 && outCount<3){ setBtn(bOut, 'btn-green', 'ç¾åœ¨å‰å¾€'); } } 
    else { setBtn(bReserve, 'btn-gold', 'é ç´„æ’éšŠ'); }

    let st=document.getElementById("status");
    if(alreadyUsed) st.innerHTML="<span style='color:#666'>æœ¬æ™‚æ®µå·²äº«ç”¨</span>";
    else if(o[me.uid]) st.innerHTML="<span style='color:var(--success)'>ä½¿ç”¨ä¸­ ENJOYING...</span>";
    else if(r[me.uid]) {
        if(currentSlotInfo.phase==='OUT'){
            if(myRank<=1&&outCount<3) {
                let txt = "<span style='color:var(--success)'>åé¡é–‹æ”¾ï¼Œè«‹å‰å¾€</span>";
                if(sorted.length >= 3 && r[me.uid].afkDeadline) {
                    let sLeft = Math.max(0, Math.floor((r[me.uid].afkDeadline - Date.now())/1000));
                    let mStr = String(Math.floor(sLeft/60)).padStart(2,'0'); let sStr = String(sLeft%60).padStart(2,'0');
                    txt = `<span style='color:var(--danger)'>è«‹ç›¡é€Ÿå‰å¾€ (å€’æ•¸ ${mStr}:${sStr})</span>`;
                }
                st.innerHTML = txt;
            }
            else if(outCount>=3) st.innerHTML="<span style='color:var(--gold)'>æ»¿ä½ç­‰å€™ä¸­...</span>";
            else st.innerHTML=`<span>ç­‰å¾…é †ä½: ${myRank+1}</span>`;
        } else {
            let ewt = ""; if (myRank > 0) ewt = ` <span style="font-size:12px; color:#888;">(ç´„ç­‰å€™ ${myRank * 15} åˆ†)</span>`;
            st.innerHTML=`<span style='color:var(--gold)'>é ç´„æˆåŠŸ (é †ä½ ${myRank+1})</span>${ewt}`;
        }
    } else {
        if(currentSlotInfo.phase==='BREAK') st.innerHTML="<span style='color:#555'>ç­‰å¾…ä¸‹ä¸€æ™‚æ®µ</span>";
        else if(currentSlotInfo.phase==='RESERVE') st.innerHTML="<span style='color:#2ed573'>é–‹æ”¾é ç´„ä¸­</span>";
        else st.innerHTML="<span style='color:#444'>å°šæœªé ç´„</span>";
    }
    document.getElementById("outCountNum").textContent=outCount;
}

function renderStaticLists(){
    let r=cacheQueue.reserve||{}, sorted=Object.entries(r).sort((a,b)=>a[1].time-b[1].time);
    document.getElementById("queue").innerHTML=sorted.map((u,i)=>{
        let btn=(myData&&myData.role==="admin")?`<button onclick="forceGoOut('${u[0]}', '${u[1].name}')" class="btn-mini success">æ´¾ç™¼</button>`:"";
        let moveBtns = (myData&&myData.role==="admin")?`<button onclick="moveQueue('${u[0]}', -1)" class="btn-arrow" title="ä¸Šç§»">â–²</button><button onclick="moveQueue('${u[0]}', 1)" class="btn-arrow" title="ä¸‹ç§»">â–¼</button>`:"";
        let rc=i===0?'rank-1':(i===1?'rank-2':'');
        return `<div class="item-card ${rc}"><div><span style="font-family:'Rajdhani';color:var(--gold);margin-right:8px;font-weight:bold;">#${i+1}</span><strong>${u[1].name}</strong><span id="afk-${u[0]}" class="afk-timer"></span></div><div style="display:flex;align-items:center;"><small style='opacity:0.4;margin-right:5px;font-family:"Rajdhani"'>${new Date(u[1].time).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'})}</small>${btn}${moveBtns}</div></div>`;
    }).join('')||"<div style='opacity:0.3;padding:10px;text-align:center;'>ç›®å‰ç©ºé–’</div>";

    let hist=[]; if(cacheQueue.history)Object.values(cacheQueue.history).forEach(h=>hist.push({...h,sortT:h.backTime})); let o=cacheQueue.out||{}; 
    Object.entries(o).forEach(([uid,u])=>{if(Math.floor((Date.now()-u.time)/1000)>600)hist.push({name:u.name,outTime:u.time,backTime:null,over:true,sortT:Date.now()});});
    document.getElementById("history").innerHTML=hist.sort((a,b)=>b.sortT-a.sortT).slice(0,20).map(i=>`<div class="item-card" style="padding:8px 12px;min-height:0;border:none;background:rgba(255,255,255,0.02);"><span>${i.name} ${i.over?'<span style="color:var(--danger)">!</span>':''}</span><small style='opacity:0.5;font-family:"Rajdhani"'>${new Date(i.outTime).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'})} - ${i.backTime?new Date(i.backTime).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'}):'OUT'}</small></div>`).join('');
}

function renderOutList(){
    let o=cacheQueue.out||{}; 
    document.getElementById("outList").innerHTML=Object.entries(o).map(([uid,u])=>{
        let s=Math.floor((Date.now()-u.time)/1000);
        let btn=(myData&&myData.role==="admin")?`<button onclick="forceComeBack('${uid}', '${u.name}')" class="btn-mini danger">å¬å›</button>`:"";
        return `<div class="item-card" style="border-left-color:var(--success);"><strong>${u.name}</strong><div style="display:flex;align-items:center;gap:8px;"><span class="${s>600?'text-danger':''}" style="font-family:'Rajdhani';color:${s>600?'var(--danger)':'#aaa'}">${Math.floor(s/60)}m ${s%60}s</span>${btn}</div></div>`;
    }).join('')||"<div style='opacity:0.3;padding:10px;text-align:center;'>ç„¡äººå¤–å‡º</div>";
}

/* --- Misc & Admin Actions --- */
function enableNotification(){if(!("Notification" in window))return;Notification.requestPermission().then(p=>{if(p==="granted"){notifyEnabled=true;playBeep();document.getElementById("btnNotify").style.display="none";}});}
if(Notification.permission!=="granted") document.getElementById("btnNotify").style.display="inline-block";
function playBeep(t='normal'){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);if(t==='urgent'){o.frequency.value=880;o.type='square';o.start();setTimeout(()=>o.stop(),100);setTimeout(()=>{const o2=audioCtx.createOscillator(),g2=audioCtx.createGain();o2.connect(g2);g2.connect(audioCtx.destination);o2.frequency.value=880;o2.type='square';o2.start();setTimeout(()=>o2.stop(),100);},150);}else{o.frequency.value=523.25;o.type='sine';g.gain.setValueAtTime(0.05,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.00001,audioCtx.currentTime+0.5);o.start();o.stop(audioCtx.currentTime+0.5);}}

async function forceComeBack(uid, name){
    if(await customConfirm(`ç¢ºå®šå¼·åˆ¶å¬å› <span style="color:var(--gold)">${name}</span> ï¼Ÿ`)) {
        queueRef.child("out/"+uid).once("value").then(s=>{let u=s.val();if(u){let now=Date.now(),slot=new Date(u.time).getHours();queueRef.child(`used/${slot}/${uid}`).set(true);queueRef.child("history").push({name:u.name,slot,outTime:u.time,backTime:now,over:(now-u.time)>600000});queueRef.child("out/"+uid).remove();addLog(`ADMIN å¬å›: ${u.name}`); showToast(`å·²å¬å› ${u.name}`, 'success');}});
    }
}
async function forceGoOut(uid, name){
    if(await customConfirm(`å¼·åˆ¶æ´¾ç™¼ <span style="color:var(--success)">${name}</span> å‰å¾€ï¼Ÿ`)){
        queueRef.child("reserve/"+uid).once("value").then(s=>{let u=s.val();if(u){queueRef.child("out/"+uid).set({name:u.name,time:Date.now()}).then(()=>{queueRef.child("reserve/"+uid).remove();addLog(`ADMIN æ´¾ç™¼: ${u.name}`); showToast(`å·²æ´¾ç™¼ ${u.name}`, 'success');});}});
    }
}
async function forceReload(){ 
    if(await customConfirm("ç¢ºå®šå¼·åˆ¶åˆ·æ–°å…¨é«”ç•«é¢ï¼Ÿ")) { db.ref("reload").set(Date.now()); showToast("å·²ç™¼é€åˆ·æ–°æŒ‡ä»¤", 'success'); closeAdmin(); } 
}

async function resetQueue(auto = false){ 
    if(auto || await customConfirm("<span style='color:var(--danger)'>ç¢ºå®šæ¸…ç©ºæ‰€æœ‰æ’éšŠã€å¤–å‡ºç‹€æ…‹ï¼Ÿ</span><br><small>æ­¤æ“ä½œç„¡æ³•å¾©åŸ</small>")) { 
        Promise.all([ queueRef.child("reserve").remove(), queueRef.child("out").remove(), queueRef.child("used").remove() ]).then(() => { addLog("ADMIN é‡ç½®ç³»çµ±"); if(!auto) {showToast("ç³»çµ±ç‹€æ…‹å·²é‡ç½®", 'success'); closeAdmin();} }).catch(e => showToast("æ¬Šé™è¢«æ‹’çµ•", 'error'));
    } 
}
async function clearChat(){ if(await customConfirm("ç¢ºå®šæ¸…ç©ºèŠå¤©å®¤ï¼Ÿ")) chatRef.remove().then(() => {showToast("èŠå¤©å®¤å·²æ¸…ç©º", 'success'); closeAdmin();}).catch(e => showToast("æ¬Šé™è¢«æ‹’çµ•", 'error')); }
async function clearHistory(){ if(await customConfirm("ç¢ºå®šæ¸…ç©ºæ­·å²ç´€éŒ„ï¼Ÿ")) queueRef.child("history").remove().then(() => {showToast("æ­·å²ç´€éŒ„å·²æ¸…ç©º", 'success'); closeAdmin();}).catch(e => showToast("æ¬Šé™è¢«æ‹’çµ•", 'error')); }
async function clearLog(){ if(await customConfirm("ç¢ºå®šæ¸…ç©ºç³»çµ±æ—¥èªŒï¼Ÿ")) logRef.remove().then(() => {showToast("ç³»çµ±æ—¥èªŒå·²æ¸…ç©º", 'success'); closeAdmin();}).catch(e => showToast("æ¬Šé™è¢«æ‹’çµ•", 'error')); }
function addLog(t){logRef.push({t,time:Date.now()});}

logRef.limitToLast(15).on("value",s=>{const b=document.getElementById("log");b.innerHTML="";s.forEach(x=>{let d=x.val();let dv=document.createElement("div");dv.innerHTML=`<span style="opacity:0.5;font-family:'Rajdhani'">[${new Date(d.time).toLocaleTimeString([],{hour12:true,hour:'2-digit',minute:'2-digit'})}]</span> ${d.t}`;b.appendChild(dv);});b.scrollTop=b.scrollHeight;});

function reserve(){ 
    if(currentSlotInfo.phase === 'BREAK'){ showToast(`å°šæœªé–‹æ”¾é ç´„ï¼è«‹æ–¼ ${currentSlotInfo.hint} å†è©¦ã€‚`, 'error'); return; } 
    let h=new Date().getHours(),t=currentSlotInfo.phase==='RESERVE'?currentSlotInfo.slot:h; 
    queueRef.child("reserve/"+me.uid).set({name:myData.name,time:Date.now(),slot:t, afkDeadline: null}); 
    if(Notification.permission!=="granted")enableNotification(); addLog(`${myData.name} é ç´„`); showToast('é ç´„æˆåŠŸ', 'success');
}
function cancelReserve(){queueRef.child("reserve/"+me.uid).remove();addLog(`${myData.name} å–æ¶ˆ`); showToast('å·²å–æ¶ˆé ç´„', 'info');}
function goOut(){
    queueRef.child("reserve/"+me.uid).child("afkDeadline").remove();
    queueRef.child("out/"+me.uid).set({name:myData.name,time:Date.now()}).then(()=>{queueRef.child("reserve/"+me.uid).remove();addLog(`${myData.name} å‡ºç™¼`); showToast('ç¥æ‚¨äº«å—ç¾å¥½æ™‚å…‰', 'success');});
}
function comeBack(){queueRef.child("out/"+me.uid).once("value").then(s=>{let u=s.val();if(u){let now=Date.now(),slot=new Date(u.time).getHours();queueRef.child(`used/${slot}/${me.uid}`).set(true);queueRef.child("history").push({name:u.name,slot,outTime:u.time,backTime:now,over:(now-u.time)>600000});queueRef.child("out/"+me.uid).remove();addLog(`${myData.name} è¿”å›`); showToast('æ­¡è¿å›ä¾†', 'info');}});}

userRef.on("value",s=>{ const list=document.getElementById("onlineUserList"); list.innerHTML=""; s.forEach(u=>{ let d=u.val(); if(d.online){ let pill = document.createElement("div"); pill.className = `online-pill online ${d.role==='admin' ? 'admin' : ''}`; pill.innerHTML = `<div class="online-dot"></div>${d.name}`; list.appendChild(pill); }}); });

let fR=true;db.ref("reload").on("value",s=>{if(fR){fR=false;return;} window.location.href = window.location.href.split('?')[0] + '?v=' + Date.now();});
</script>
</body>
</html>
