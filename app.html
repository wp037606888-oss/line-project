<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>é«˜ç´šç…™éœ§æ’éšŠç³»çµ± v2.1</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* --- å…¨åŸŸè³ªæ„Ÿè¨­å®š --- */
:root {
    --primary: linear-gradient(135deg, #6e8eff, #a277ff);
    --danger: #ff5b5b;
    --success: #00ff88;
    --bg-dark: #0a0b14;
    --panel-bg: rgba(28, 28, 42, 0.7);
    --text-main: #f0f0f0;
    --text-dim: #9ec3ff;
}

* { box-sizing: border-box; transition: all 0.2s ease; }

body {
    margin: 0;
    font-family: "PingFang TC", "Microsoft JhengHei", "Segoe UI", sans-serif;
    background: var(--bg-dark);
    color: var(--text-main);
    display: flex;
    height: 100vh;
    overflow: hidden;
    font-size: 20px; /* å…¨é«”å­—é«”å†æ¬¡æ”¾å¤§ */
}

canvas { position: fixed; inset: 0; pointer-events: none; z-index: 0; }

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-thumb { background: #445; border-radius: 10px; }

/* --- ä½ˆå±€ --- */
#left {
    width: 65%;
    padding: 25px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    z-index: 1;
}

#main {
    width: 35%;
    display: flex;
    flex-direction: column;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(25px);
    border-left: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 1;
}

.panel {
    background: var(--panel-bg);
    backdrop-filter: blur(30px);
    border-radius: 24px;
    padding: 30px;
    margin-bottom: 25px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 15px 45px rgba(0, 0, 0, 0.6);
    animation: fadeUp 0.8s ease;
}

@keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

h3 { 
    margin: 0 0 20px; 
    font-size: 22px; 
    color: var(--text-dim); 
    border-left: 5px solid #7d5cff;
    padding-left: 15px;
}

#status {
    font-size: 28px;
    font-weight: 900;
    margin: 15px 0;
    color: #fff;
    text-shadow: 0 0 20px rgba(110, 142, 255, 0.6);
}

#clock { font-size: 18px; opacity: 0.6; font-family: monospace; }
#who { font-size: 22px; font-weight: 600; color: #fff; }

/* --- æŒ‰éˆ• --- */
.btn-group { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; }

button {
    padding: 14px 28px;
    border: none;
    border-radius: 14px;
    background: var(--primary);
    color: white;
    cursor: pointer;
    font-weight: 700;
    font-size: 18px;
    box-shadow: 0 5px 15px rgba(92, 124, 255, 0.3);
}

button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(92, 124, 255, 0.5); }
button:disabled { background: #333; color: #666; cursor: not-allowed; opacity: 0.6; }
.btn-danger { background: linear-gradient(135deg, #ff5b5b, #ff3e3e); }

/* --- åˆ—è¡¨é …ç›® --- */
.item-row {
    padding: 15px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 19px;
}

.red { color: var(--danger); font-weight: bold; }
.green { color: var(--success); font-weight: bold; }

/* --- èŠå¤©å®¤ --- */
#chat { flex: 1; overflow-y: auto; padding: 20px; }
.msg { background: rgba(255,255,255,0.06); margin-bottom: 10px; padding: 15px; border-radius: 15px; font-size: 18px; }
footer { padding: 20px; display: flex; gap: 10px; background: rgba(0,0,0,0.3); }
input { flex: 1; background: #1a1b26; border: 1px solid #445; border-radius: 12px; padding: 15px; color: #fff; font-size: 18px; }

/* åˆå§‹éš±è—ç®¡ç†å“¡é¢æ¿ */
#adminPanel { display: none; border: 2px solid rgba(255, 187, 0, 0.3); }
</style>
</head>

<body>
<canvas id="bg"></canvas>

<div id="left">
    <div class="panel">
        <div id="who">é€£ç·šä¸­...</div>
        <div id="clock">00:00:00</div>
        <div id="slotInfo" style="font-size: 16px; margin-top: 5px; color: var(--text-dim);">æ™‚æ®µï¼šè¼‰å…¥ä¸­</div>
        <div id="status">ç³»çµ±åˆå§‹åŒ–...</div>
        
        <div class="btn-group">
            <button id="bReserve" onclick="reserve()">é ç´„æ’éšŠ</button>
            <button id="bCancel" class="btn-danger" onclick="cancelReserve()">å–æ¶ˆé ç´„</button>
            <button id="bOut" onclick="goOut()">ç¾åœ¨å‡ºå»</button>
            <button id="bBack" onclick="comeBack()">æˆ‘å›ä¾†äº†</button>
        </div>
    </div>

    <div class="panel">
        <h3>ğŸš¬ æ’éšŠéšŠåˆ—</h3>
        <div id="queue"></div>
    </div>

    <div class="panel">
        <h3>ğŸš¶ æ­£åœ¨å¤–é¢ (<span id="outCountNum">0</span>/3)</h3>
        <div id="outList"></div>
    </div>

    <div class="panel">
        <h3>ğŸ“Š æœ¬æ™‚æ®µç´€éŒ„</h3>
        <div id="history"></div>
    </div>

    <div id="adminPanel" class="panel">
        <h3 style="color: #ffbb00;">ğŸ‘‘ ç®¡ç†å“¡æ§åˆ¶å°</h3>
        <button onclick="forceReload()">å…¨é«”å¼·åˆ¶åˆ·æ–°</button>
        <button onclick="resetQueue()" class="btn-danger">é‡ç½®æ’éšŠæ•¸æ“š</button>
        <button onclick="clearChat()" style="background: #555;">æ¸…ç©ºèŠå¤©å®¤</button>
    </div>
</div>

<div id="main">
    <header style="padding: 20px; text-align: center; font-weight: bold; font-size: 22px; border-bottom: 1px solid rgba(255,255,255,0.1);">äº¤æµç©ºé–“</header>
    <div id="onlineBar" style="padding: 10px; display: flex; flex-wrap: wrap; gap: 8px; background: rgba(0,0,0,0.2);"></div>
    <div id="chat"></div>
    <footer>
        <input id="msg" placeholder="è¼¸å…¥è¨Šæ¯..." onkeydown="if(event.key==='Enter')send()">
        <button onclick="send()">é€å‡º</button>
    </footer>
</div>

<script>
/* --- Firebase åˆå§‹åŒ– (ä½¿ç”¨ä½ çš„è¨­å®š) --- */
const config={
    apiKey: "AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",
    authDomain: "smoke-queue.firebaseapp.com",
    databaseURL: "https://smoke-queue-default-rtdb.firebaseio.com",
    projectId: "smoke-queue"
};
firebase.initializeApp(config);
const db=firebase.database(), auth=firebase.auth();
const queueRef=db.ref("queue"), userRef=db.ref("users"), chatRef=db.ref("chat");

let me, myData, engineReady=false, cacheQueue={};

/* --- æ ¸å¿ƒä¿®å¾©ï¼šè§£æ±ºé‡æ–°æ•´ç†å¾ªç’° --- */
db.ref("reload").on("value", s => {
    let t = s.val();
    if(!t) return;
    let lastReload = sessionStorage.getItem("lastReload");
    // åªæœ‰ç•¶é ç«¯æ™‚é–“æˆ³è¨˜å¤§æ–¼æœ¬åœ°ç´€éŒ„æ™‚ï¼Œæ‰åŸ·è¡Œåˆ·æ–°
    if(lastReload != t) {
        sessionStorage.setItem("lastReload", t);
        location.reload();
    }
});

function forceReload(){
    db.ref("reload").set(Date.now());
}

/* --- æ ¸å¿ƒæ¬Šé™ï¼šç®¡ç†å“¡åˆ¤æ–· --- */
auth.onAuthStateChanged(async user => {
    if(!user){ location.href="login.html"; return; }
    me = user;
    userRef.child(user.uid).on("value", s => {
        myData = s.val() || {};
        who.textContent = "Hi, " + (myData.name || "è¨ªå®¢");
        
        // åš´æ ¼æ¬Šé™æª¢æŸ¥
        if(myData.role === "admin") {
            document.getElementById("adminPanel").style.display = "block";
        } else {
            document.getElementById("adminPanel").style.display = "none";
        }
        engineReady = true;
    });
    // åœ¨ç·šç‹€æ…‹
    userRef.child(user.uid + "/online").set(true);
    userRef.child(user.uid + "/online").onDisconnect().set(false);
});

/* --- æ’éšŠé‚è¼¯å¼•æ“ --- */
function getSlot(h){
    const slots=[14,16,18,20,22,24];
    if(h===0) return 24;
    for(let s of slots) if(h<=s) return s;
    return 14;
}

queueRef.on("value", s => { cacheQueue = s.val() || {}; });

setInterval(() => {
    if(!engineReady) return;
    let now = new Date(), h = now.getHours();
    clock.textContent = now.toLocaleTimeString();
    let slot = getSlot(h);
    slotInfo.textContent = `ç•¶å‰æ™‚æ®µï¼š${slot}:00 ~ ${slot}:59`;
    
    let d = cacheQueue, r = d.reserve || {}, o = d.out || {}, used = d.used || {};
    let sortedQueue = Object.entries(r).sort((a,b)=>a[1].time - b[1].time);
    let outCount = Object.keys(o).length;
    let isFirst = sortedQueue.length > 0 && sortedQueue[0][0] === me.uid;
    let alreadyUsed = used[slot]?.[me.uid];

    // æŒ‰éˆ•ç‹€æ…‹æ§åˆ¶
    bReserve.disabled = (r[me.uid] || o[me.uid] || alreadyUsed);
    bCancel.disabled = !r[me.uid];
    bOut.disabled = !(r[me.uid] && (h==slot || (slot==24&&h==0)) && isFirst && outCount < 3);
    bBack.disabled = !o[me.uid];

    // ç‹€æ…‹å¤§å­—é¡¯ç¤º
    if(alreadyUsed) status.innerHTML = "<span style='color:#666'>æœ¬æ™‚æ®µå·²çµæŸ</span>";
    else if(o[me.uid]) status.innerHTML = "<span class='green'>Enjoy! æ­£åœ¨å¤–é¢</span>";
    else if(r[me.uid]) {
        if(isFirst && outCount < 3) status.innerHTML = "<span class='green'>â˜… è¼ªåˆ°ä½ äº†ï¼Œè«‹å‡ºå» â˜…</span>";
        else if(isFirst) status.innerHTML = "<span style='color:#ffcc00'>æ’ç¬¬ä¸€é †ä½ï¼Œç­‰å€™ä½é‡‹å‡º</span>";
        else status.innerHTML = `<span>æ’éšŠä¸­ï¼Œå‰é¢é‚„æœ‰ ${sortedQueue.findIndex(x=>x[0]===me.uid)} äºº</span>`;
    } else status.innerHTML = "å°šæœªé ç´„";

    outCountNum.textContent = outCount;
    renderAll(sortedQueue, o, d.history, slot);
}, 1000);

/* --- ç²¾ç·»æ¸²æŸ“ --- */
function renderAll(queueArr, outObj, historyObj, slot) {
    // æ¸²æŸ“éšŠåˆ—
    queue.innerHTML = queueArr.length ? "" : "<div style='opacity:0.4'>ç›®å‰æ²’æœ‰äººæ’éšŠ</div>";
    queueArr.forEach((u, i) => {
        let div = document.createElement("div"); div.className="item-row";
        div.innerHTML = `<span>${i+1}. <strong>${u[1].name}</strong></span> <small style='opacity:0.5'>${new Date(u[1].time).toLocaleTimeString()}</small>`;
        queue.appendChild(div);
    });

    // æ¸²æŸ“å¤–é¢
    outList.innerHTML = Object.keys(outObj).length ? "" : "<div style='opacity:0.4'>ç›®å‰å¤–é¢æ²’æœ‰äºº</div>";
    Object.entries(outObj).forEach(([uid, u]) => {
        let sec = Math.floor((Date.now() - u.time)/1000);
        let div = document.createElement("div"); div.className="item-row";
        div.innerHTML = `<span><strong>${u.name}</strong></span> <span class="${sec>600?'red':''}">å·²å¾… ${Math.floor(sec/60)}åˆ†${sec%60}ç§’</span>`;
        outList.appendChild(div);
    });

    // æ¸²æŸ“ç´€éŒ„ (å«è¶…æ™‚è‡ªå‹•åµæ¸¬)
    history.innerHTML = "";
    let list = [];
    if(historyObj) Object.values(historyObj).forEach(h => { if(h.slot === slot) list.push({...h, isOut: false, sortT: h.backTime}); });
    if(outObj) Object.values(outObj).forEach(u => {
        let sec = Math.floor((Date.now() - u.time)/1000);
        if(sec > 600) list.push({name: u.name, outTime: u.time, backTime: null, over: true, sortT: Date.now()});
    });
    list.sort((a,b)=>b.sortT - a.sortT);
    list.forEach(item => {
        let div = document.createElement("div"); div.className="item-row";
        let outT = new Date(item.outTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        let backT = item.backTime ? new Date(item.backTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "<span class='red'>æœªæ­¸</span>";
        div.innerHTML = `<span><strong>${item.name}</strong> ${item.over?'<span class="red">[è¶…æ™‚]</span>':''}</span> <small style='opacity:0.7'>${outT} ~ ${backT}</small>`;
        history.appendChild(div);
    });
}

/* --- æŒ‰éˆ•å‹•ä½œ --- */
function reserve(){
    let slot = getSlot(new Date().getHours());
    queueRef.child("reserve/"+me.uid).set({name: myData.name, time: Date.now(), slot});
}
function cancelReserve(){ queueRef.child("reserve/"+me.uid).remove(); }
function goOut(){
    queueRef.child("out/"+me.uid).set({name: myData.name, time: Date.now()}).then(()=>queueRef.child("reserve/"+me.uid).remove());
}
function comeBack(){
    queueRef.child("out/"+me.uid).once("value").then(s => {
        let u = s.val(); if(!u) return;
        let now = Date.now(), sec = Math.floor((now - u.time)/1000);
        let slot = getSlot(new Date(u.time).getHours());
        queueRef.child(`used/${slot}/${me.uid}`).set(true);
        queueRef.child("history").push({ name: u.name, slot, outTime: u.time, backTime: now, over: sec > 600 });
        queueRef.child("out/"+me.uid).remove();
    });
}

/* --- èŠå¤©åŠŸèƒ½ --- */
function send(){
    let input = document.getElementById("msg");
    if(!input.value.trim()) return;
    chatRef.push({name: myData.name, text: input.value, time: Date.now()});
    input.value = "";
}
chatRef.limitToLast(30).on("value", s => {
    let box = document.getElementById("chat"); box.innerHTML="";
    s.forEach(x => {
        let m = x.val(), div = document.createElement("div"); div.className="msg";
        div.innerHTML = `<b style="color:#a277ff">${m.name}:</b> ${m.text}`;
        box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
});

/* --- ç®¡ç†å“¡åŠŸèƒ½å¯¦ä½œ --- */
function resetQueue() { if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ’éšŠèˆ‡æ™‚æ®µç´€éŒ„å—ï¼Ÿ")) queueRef.remove(); }
function clearChat() { if(confirm("ç¢ºå®šè¦æ¸…ç©ºèŠå¤©å®¤å—ï¼Ÿ")) chatRef.remove(); }

/* --- åœ¨ç·šåå–® --- */
userRef.on("value", s => {
    let bar = document.getElementById("onlineBar"); bar.innerHTML="";
    s.forEach(u => {
        let d = u.val(), span = document.createElement("span");
        span.style = `padding: 5px 12px; border-radius: 20px; font-size: 14px; border: 1px solid ${d.online?'#00ff88':'#444'}; color: ${d.online?'#00ff88':'#888'}`;
        span.textContent = d.name; bar.appendChild(span);
    });
});

/* --- èƒŒæ™¯å‹•ç•« --- */
const canvas=document.getElementById("bg"), ctx=canvas.getContext("2d");
let w,h, particles=[];
function resize(){w=canvas.width=innerWidth; h=canvas.height=innerHeight;}
window.onresize=resize; resize();
for(let i=0;i<50;i++) particles.push({x:Math.random()*w, y:Math.random()*h, vx:(Math.random()-.5)*.3, vy:(Math.random()-.5)*.3});
function draw(){
    ctx.clearRect(0,0,w,h);
    particles.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy;
        if(p.x<0||p.x>w) p.vx*=-1; if(p.y<0||p.y>h) p.vy*=-1;
        ctx.fillStyle="rgba(110,142,255,0.3)"; ctx.beginPath(); ctx.arc(p.x,p.y,1.5,0,7); ctx.fill();
    });
    requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
