<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>尊爵吸菸室 - 身分驗證 v7.5</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
<link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />

<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');

:root {
    --gold: #ffd700;
    --gold-dim: rgba(255, 215, 0, 0.3);
    --gold-gradient: linear-gradient(135deg, #ffd700, #ffaa00);
    --bg-dark: #05060a;
    --glass: rgba(20, 21, 30, 0.7);
    --border: rgba(255, 255, 255, 0.08);
}

* { box-sizing: border-box; outline: none; }

body {
    margin: 0; height: 100vh; font-family: "Noto Sans TC", sans-serif;
    background: var(--bg-dark); display: flex; justify-content: center; align-items: center;
    overflow: hidden; color: #fff; perspective: 1000px;
}

/* 背景畫布 */
canvas { position: fixed; inset: 0; z-index: 0; }
.overlay { position: fixed; inset: 0; background: radial-gradient(circle at center, transparent 0%, #000 90%); z-index: 1; pointer-events: none; }
.noise { position: fixed; inset: 0; z-index: 1; opacity: 0.03; background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJuIj48ZmVUdXJidWxlbmNlIHR5cGU9ImZyYWN0YWxOb2lzZSIgYmFzZUZyZXF1ZW5jeT0iMC42IiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI24pIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4='); pointer-events: none; }

/* 登入卡片 */
.card-wrapper { position: relative; z-index: 10; transition: transform 0.1s ease-out; transform-style: preserve-3d; }
.card {
    background: var(--glass); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
    padding: 50px 40px; width: 380px; border-radius: 24px; border: 1px solid var(--border);
    box-shadow: 0 40px 100px rgba(0,0,0,0.8), inset 0 0 0 1px rgba(255,255,255,0.05);
    position: relative; overflow: hidden; animation: fadeUp 1s cubic-bezier(0.2, 0.8, 0.2, 1);
    text-align: center;
}
.card::before {
    content: ''; position: absolute; inset: -1px; border-radius: 24px; padding: 1px;
    background: linear-gradient(45deg, transparent, rgba(255, 215, 0, 0.3), transparent);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none;
}
.glow-spot {
    position: absolute; top: -50px; left: 50%; transform: translateX(-50%);
    width: 150px; height: 150px; background: var(--gold); filter: blur(80px); opacity: 0.15; pointer-events: none;
}

h1 {
    margin: 0 0 10px; font-family: "Noto Sans TC", sans-serif; font-weight: 700; font-size: 28px;
    background: linear-gradient(to bottom, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    letter-spacing: 4px;
}
p.subtitle { margin: 0 0 30px; font-size: 13px; color: #888; letter-spacing: 2px; font-weight: 300; }

/* Google 按鈕客製化 */
.firebaseui-container { background: transparent; max-width: 100%; }
.firebaseui-card-content { padding: 0 !important; }
.firebaseui-idp-button { 
    max-width: 100%; width: 100%; border-radius: 12px; height: 50px; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.3s;
}
.firebaseui-idp-button:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
.firebaseui-idp-text { font-family: "Noto Sans TC" !important; font-weight: 700 !important; }
ul.firebaseui-idp-list { list-style: none; padding: 0; margin: 0; }
li.firebaseui-list-item { margin-bottom: 0 !important; text-align: center; }

/* Loading */
#loader { display: none; color: var(--gold); margin-top: 20px; font-family: 'Rajdhani'; letter-spacing: 2px; }

@keyframes fadeUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

</style>
</head>

<body>

<canvas id="bg"></canvas>
<div class="overlay"></div>
<div class="noise"></div>

<div class="card-wrapper" id="cardWrapper">
    <div class="card" id="card">
        <div class="glow-spot"></div>
        <h1>尊爵吸菸室</h1>
        <p class="subtitle">頂級排隊管理系統 v7.5</p>

        <div id="firebaseui-auth-container"></div>
        <div id="loader">VERIFYING...</div>
        
        <div style="margin-top:25px; font-size:12px; color:#555; letter-spacing:1px;">
            僅限授權人員進入
        </div>
    </div>
</div>

<script>
/* --- 粒子系統 --- */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
let w, h;
function resize() { w = canvas.width = innerWidth; h = canvas.height = innerHeight; }
window.onresize = resize; resize();

const particles = [];
for (let i = 0; i < 60; i++) {
    particles.push({
        x: Math.random() * w, y: Math.random() * h,
        vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.5,
        size: Math.random() * 2 + 0.5, alpha: Math.random() * 0.5 + 0.1
    });
}
function draw() {
    ctx.clearRect(0, 0, w, h);
    ctx.lineWidth = 0.5;
    for (let i = 0; i < 60; i++) {
        let p = particles[i];
        p.x += p.vx; p.y += p.vy;
        if (p.x < 0 || p.x > w) p.vx *= -1;
        if (p.y < 0 || p.y > h) p.vy *= -1;
        ctx.fillStyle = `rgba(255, 215, 0, ${p.alpha})`;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
        for (let j = i + 1; j < 60; j++) {
            let p2 = particles[j];
            let dist = Math.hypot(p.x - p2.x, p.y - p2.y);
            if (dist < 150) {
                ctx.strokeStyle = `rgba(255, 215, 0, ${0.15 * (1 - dist / 150)})`;
                ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
            }
        }
    }
    requestAnimationFrame(draw);
}
draw();

/* --- 3D 視差 --- */
const wrapper = document.getElementById('cardWrapper');
const card = document.getElementById('card');
document.addEventListener('mousemove', (e) => {
    const xAxis = (window.innerWidth / 2 - e.pageX) / 25;
    const yAxis = (window.innerHeight / 2 - e.pageY) / 25;
    wrapper.style.transform = `rotateY(${xAxis}deg) rotateX(${yAxis}deg)`;
});
wrapper.addEventListener('mouseenter', () => { card.style.transition = 'none'; });
wrapper.addEventListener('mouseleave', () => { card.style.transition = 'all 0.5s ease'; wrapper.style.transform = `rotateY(0deg) rotateX(0deg)`; });

/* --- Firebase Auth (v7.5 Security Logic) --- */
const config = {
    apiKey: "AIzaSyBs8g_RPs1qYdAa8_U6Uqzo3L7VZJvTWSE",
    authDomain: "smoke-queue.firebaseapp.com",
    databaseURL: "https://smoke-queue-default-rtdb.firebaseio.com",
    projectId: "smoke-queue"
};
firebase.initializeApp(config);

const ui = new firebaseui.auth.AuthUI(firebase.auth());
const uiConfig = {
    callbacks: {
        signInSuccessWithAuthResult: function(authResult, redirectUrl) {
            document.getElementById('firebaseui-auth-container').style.display = 'none';
            document.getElementById('loader').style.display = 'block';
            
            var user = authResult.user;
            // 核心安全寫入：確保新用戶有 online: false
            firebase.database().ref('users/' + user.uid).transaction(function(currentData) {
                if (currentData === null) {
                    return {
                        name: user.displayName,
                        email: user.email,
                        role: 'user',
                        online: false // 必須欄位
                    };
                } else {
                    if(currentData.role === undefined) currentData.role = 'user';
                    currentData.name = user.displayName;
                    currentData.email = user.email;
                    return currentData;
                }
            }).then(function() {
                window.location.assign('app.html');
            }).catch(function(error) {
                console.error(error);
                alert("驗證寫入失敗：" + error.message);
                document.getElementById('loader').style.display = 'none';
                document.getElementById('firebaseui-auth-container').style.display = 'block';
            });
            return false;
        },
        uiShown: function() {
            document.getElementById('loader').style.display = 'none';
        }
    },
    signInFlow: 'popup',
    signInOptions: [firebase.auth.GoogleAuthProvider.PROVIDER_ID],
    tosUrl: '#',
    privacyPolicyUrl: '#'
};

ui.start('#firebaseui-auth-container', uiConfig);

</script>
</body>
</html>
